<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Support - Monthly Performance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Add jsPDF and html2canvas libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* Updated Professional Color Palette */
            --primary-color: #0066cc; /* Professional Blue */
            --secondary-color: #00b8d4; /* Bright Cyan */
            --accent-color: #00c853; /* Vibrant Green */
            --warning-color: #ff9100; /* Bright Orange */
            --danger-color: #d32f2f; /* Deep Red */
            --light-gray: #f5f7fa;
            --dark-gray: #1a202c; /* Deep slate */
            --success-color: #00c853;
            --background-color: #f0f4f8; /* Soft blue-gray background */
            --card-background: #ffffff;
            --border-color: #cbd5e0;
            --text-color: #1a202c;
            --text-muted: #4a5568;
            --sky-blue-light: #e0f2fe;
            --sky-blue-medium: #7dd3fc;
            
            /* Modern design system */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--background-color);
            background-image: 
                radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.04) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.04) 0px, transparent 50%);
            min-height: 100vh;
            font-size: 0.7rem;
            color: var(--text-color);
            line-height: 1.5;
        }
        
        .navbar {
            background: linear-gradient(135deg, #0066cc 0%, #00b8d4 100%) !important;
            border-bottom: 3px solid #0052a3;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(12px);
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: -0.5px;
            color: #ffffff !important;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .navbar-brand .brand-icon {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: var(--shadow-md);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .navbar-brand .brand-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        
        .card { 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); 
            margin-bottom: 20px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            background-color: var(--card-background);
        }
        
        .card:hover { 
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* NEW: Data load period info banner */
        .data-load-info {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            padding: 16px 24px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid #7dd3fc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .data-load-info .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .data-load-info .info-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: #0369a1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-load-info .info-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: #0c4a6e;
            background: white;
            padding: 4px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-load-info .filter-status {
            font-size: 0.7rem;
            color: #0369a1;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .data-load-info .filter-status i {
            font-size: 0.85rem;
        }
        
        /* Modern Sidebar Styles - Slide-in Panel */
        .sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            width: 250px;
            height: 80vh;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-right: 3px solid var(--primary-color);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            transition: left 0.3s ease-in-out;
            z-index: 1050;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            padding: 15px;
            background: linear-gradient(135deg, #0066cc 0%, #00b8d4 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-header h5 {
            margin: 0;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-toggle {
            position: fixed;
            left: 20px;
            top: 80px;
            width: 44px;
            height: 44px;
            background: #1a202c;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1040;
            color: white;
            font-size: 1rem;
        }
        
        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 14px rgba(0, 0, 0, 0.4);
            background: #2d3748;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0px 0;
            overflow-x: hidden;
        }
        
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .nav-section-title {
            padding: 8px 20px;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-top: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .nav-section-title i {
            font-size: 0.7rem;
            margin-right: 6px;
            opacity: 0.8;
        }
        
        .sidebar .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            margin: 4px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.65rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
            text-decoration: none;
            position: relative;
            white-space: nowrap;
        }
        
        .sidebar .nav-link:hover {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.08), rgba(0, 184, 212, 0.08));
            border-color: rgba(0, 102, 204, 0.2);
            transform: translateX(4px);
        }
        
        .sidebar .nav-link.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }
        
        .sidebar .nav-link i {
            font-size: 1rem;
            width: 24px;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .nav-link-text {
            flex: 1;
        }
        
        /* Sidebar overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1049;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(2px);
        }
        
        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Side Panel Filters */
        .filter-side-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--card-background);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            transition: right 0.3s ease-in-out;
            z-index: 1050;
            overflow-y: auto;
            border-left: 3px solid var(--primary-color);
        }
        
        .filter-side-panel.open {
            right: 0;
        }
        
        .filter-panel-header {
            padding: 20px;
            background: linear-gradient(135deg, #0066cc 0%, #00b8d4 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .filter-panel-header h5 {
            margin: 0;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .filter-panel-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .filter-panel-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .filter-panel-body {
            padding: 20px;
        }
        
        .filter-toggle-fab {
            position: fixed;
            right: 20px;
            top: 80px;
            width: 44px;
            height: 44px;
            background: #1a202c;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            z-index: 1040;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .filter-toggle-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 14px rgba(0, 0, 0, 0.4);
            background: #2d3748;
        }
        
        .filter-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1045;
            display: none;
            transition: opacity 0.3s;
        }
        
        .filter-panel-overlay.show {
            display: block;
        }
        
        .filter-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
            display: block;
        }
        
        .main-view-tabs .nav-link { 
            font-size: 0.95rem; 
            font-weight: 600;
            color: var(--text-muted); 
            margin-right: 6px; 
            border-radius: 8px 8px 0 0; 
            padding: 10px 16px;
            background-color: var(--light-gray);
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .main-view-tabs .nav-link:hover {
            background-color: var(--sky-blue-light);
            color: var(--primary-color);
        }
        
        .main-view-tabs .nav-link.active { 
            background: var(--card-background); 
            color: var(--primary-color); 
            border-bottom: 3px solid var(--primary-color);
            border-top: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.1);
        }
        
        .view-content { 
            border: 1px solid var(--border-color); 
            border-top: none; 
            background: var(--card-background); 
            padding: 20px; 
            border-radius: 0 0 8px 8px; 
            min-height: 600px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }
        
        .kpi-section-title { 
            font-size: 0.7rem; 
            font-weight: 700; 
            color: var(--primary-color); 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 6px; 
            margin-bottom: 10px; 
            margin-top: 12px; 
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .kpi-card { 
            background: var(--card-background); 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
            padding: 16px; 
            border-left: 4px solid var(--primary-color); 
            cursor: pointer; 
            height: 100%; 
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: scaleX(0);
            transition: transform 0.25s ease;
        }
        
        .kpi-card:hover::before {
            transform: scaleX(1);
        }
        
        .kpi-card:hover { 
            background-color: var(--sky-blue-light); 
            transform: translateY(-4px); 
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15); 
        }
        
        .kpi-title { 
            font-size: 0.65rem; 
            color: var(--text-muted); 
            font-weight: 700; 
            text-transform: uppercase; 
            margin-bottom: 4px; 
            opacity: 0.9; 
            line-height: 1.2;
            letter-spacing: 0.4px;
        }
        
        .kpi-value { 
            font-size: 1.4rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            margin: 8px 0;
            line-height: 1;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
        }
        
        .kpi-status-tag { 
            font-size: 0.6rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            padding: 3px 8px; 
            border-radius: 12px; 
            margin-bottom: 6px;
            display: inline-block;
            letter-spacing: 0.4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .kpi-recommendation {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 8px;
            opacity: 0.85;
            line-height: 1.3;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
        }
        
        /* RAG colors - KEEPING THESE AS IS for compliance */
        .bg-urgent { background-color: var(--danger-color); color: white; }
        .bg-action-needed, .bg-monitor { background-color: var(--warning-color); color: var(--text-color); }
        .bg-good { background-color: var(--success-color); color: white; }
        .bg-info-tag { background-color: var(--secondary-color); color: white; }
        .bg-below-target { background-color: var(--danger-color); color: white; }
        .bg-needs-attention { background-color: var(--warning-color); color: var(--text-color); }
        .bg-on-track { background-color: var(--success-color); color: white; }
        .bg-metric { background-color: var(--secondary-color); color: white; }
        
        .accordion-item { 
            margin-bottom: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03); 
            overflow: hidden;
        }
        
        /* RAG colors for accordion headers based on status - KEEPING THESE */
        .accordion-item.good .accordion-button {
            background-color: rgba(25, 135, 84, 0.1);
            border-left: 4px solid var(--success-color);
        }
        
        .accordion-item.warning .accordion-button {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid var(--warning-color);
        }
        
        .accordion-item.danger .accordion-button {
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 4px solid var(--danger-color);
        }
        
        .accordion-item.info .accordion-button {
            background-color: rgba(13, 202, 240, 0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .accordion-header { border-radius: 8px 8px 0 0; }
        
        .accordion-button { 
            font-size: 0.95rem; 
            font-weight: 600; 
            color: var(--primary-color); 
            background-color: var(--sky-blue-light); 
            border-bottom: 1px solid var(--border-color); 
            padding: 14px 16px;
        }
        
        .accordion-button:not(.collapsed) { 
            background: var(--card-background); 
            color: var(--primary-color); 
            box-shadow: inset 0 -1px 0 var(--border-color); 
        }
        
        .accordion-button:focus { 
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); 
            border-color: var(--primary-color);
        }
        
        .accordion-body { padding: 16px; }
        
        .scorecard-table th { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            font-size: 0.7rem; 
            vertical-align: middle; 
            padding: 10px 6px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        
        .scorecard-table td { 
            font-size: 0.75rem; 
            padding: 10px 6px; 
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        
        /* RAG cells - KEEPING THESE */
        .critical-cell { 
            background-color: rgba(220, 53, 69, 0.1); 
            color: var(--danger-color); 
            font-weight: 700;
            border-left: 3px solid var(--danger-color);
            font-size: 0.72rem;
        }
        
        .high-cell { 
            background-color: rgba(255, 193, 7, 0.1); 
            color: #d39e00; 
            border-left: 3px solid var(--warning-color);
            font-size: 0.72rem;
        }
        
        .success-cell { 
            background-color: rgba(25, 135, 84, 0.1); 
            color: var(--success-color); 
            border-left: 3px solid var(--success-color);
            font-size: 0.72rem;
        }
        
        .compliance-gauge { 
            height: 8px; 
            border-radius: 4px; 
            background-color: var(--light-gray);
            overflow: hidden;
        }
        
        .metric-card { 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
            background: var(--card-background);
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .metric-card .card-body { 
            text-align: center; 
            padding: 24px 12px;
        }
        
        .metric-value { 
            font-size: 2.2rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .metric-label { 
            font-size: 0.7rem; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.8px; 
            font-weight: 600;
        }
        
        .detailed-case-table th { 
            background-color: var(--sky-blue-light); 
            font-weight: 600;
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.4px;
            white-space: nowrap;
        }
        
        .detailed-case-table td {
            font-size: 0.7rem;
            padding: 10px 8px;
            vertical-align: middle;
        }
        
        .owner-tag { 
            background: var(--sky-blue-light); 
            padding: 3px 10px; 
            border-radius: 12px; 
            font-size: 0.7rem; 
            font-weight: 600;
            color: var(--primary-color);
            display: inline-block;
            white-space: nowrap;
        }
        
        .upload-area {
            text-align: center; 
            border: 2px dashed var(--border-color); 
            padding: 60px 40px; 
            cursor: pointer;
            border-radius: var(--radius-lg);
            background: var(--card-background);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.03), rgba(13, 202, 240, 0.03));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
        
        .upload-area:hover::before {
            opacity: 1;
        }
        
        .upload-area.dragover {
            border-color: var(--secondary-color);
            background: var(--sky-blue-light);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            font-weight: 600;
            padding: 10px 24px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
        }
        
        .btn-primary:hover {
            background: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
        }
        
        .btn-success {
            background: var(--success-color);
            border: none;
            box-shadow: 0 2px 8px rgba(25, 135, 84, 0.2);
            font-weight: 600;
            padding: 10px 24px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            background: #157347;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }
        
        .filter-badge {
            background: var(--secondary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 4px;
            display: inline-flex;
            align-items: center;
        }
        
        .tab-content {
            background: var(--card-background);
            border-radius: 0 0 8px 8px;
            border: 1px solid var(--border-color);
            border-top: none;
            padding: 20px;
        }
        
        .nav-tabs {
            border-bottom: 2px solid var(--border-color);
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 6px 6px 0 0;
            margin-right: 4px;
            font-weight: 500;
            color: var(--text-muted);
            padding: 8px 16px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: var(--sky-blue-light);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--card-background);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 8px 8px 0 0;
            padding: 16px;
        }
        
        .progress-bar {
            border-radius: 4px;
        }
        
        .table-hover tbody tr:hover {
            background-color: var(--sky-blue-light);
            cursor: pointer;
        }
        
        .badge {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
        }
        
        .form-select, .form-control {
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            padding: 10px 14px;
            font-size: 0.85rem;
            transition: all 0.2s;
            background-color: var(--card-background);
        }
        
        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
            background-color: var(--card-background);
        }
        
        .alert {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
            font-size: 0.85rem;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.98);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .loading-spinner.active {
            display: flex;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
            border-width: 3px;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            padding: 10px;
            background-color: var(--sky-blue-light);
            border-radius: 6px;
        }
        
        .filter-tag {
            background: var(--secondary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 1px 3px rgba(13, 202, 240, 0.2);
        }
        
        .filter-tag .close {
            color: white;
            opacity: 0.8;
            cursor: pointer;
            margin-left: 6px;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .filter-tag .close:hover {
            opacity: 1;
        }
        
        .drilldown-table th {
            background: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            padding: 10px 8px;
            white-space: nowrap;
        }
        
        .drilldown-table td {
            font-size: 0.7rem;
            padding: 10px 8px;
            vertical-align: middle;
        }
        
        .drilldown-table {
            font-size: 0.85rem;
        }
        
        .compact-view {
            font-size: 0.7rem;
        }
        
        .compact-view .table th,
        .compact-view .table td {
            padding: 8px 6px;
        }
        
        .compact-view .btn-sm {
            padding: 3px 8px;
            font-size: 0.75rem;
        }
        
        /* Grid View Styles */
        .grid-view-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .case-card {
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 16px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
            height: 100%;
        }
        
        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .case-card.critical {
            border-left-color: var(--danger-color);
        }
        
        .case-card.warning {
            border-left-color: var(--warning-color);
        }
        
        .case-card.success {
            border-left-color: var(--success-color);
        }
        
        .case-id {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .case-title {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .case-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .case-meta-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .case-meta-item i {
            margin-right: 6px;
            width: 14px;
            color: var(--primary-color);
        }
        
        .case-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .case-tag {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* RAG case tags - KEEPING THESE */
        .case-tag.urgent {
            background-color: rgba(220, 53, 69, 0.12);
            color: var(--danger-color);
        }
        
        .case-tag.warning {
            background-color: rgba(255, 193, 7, 0.12);
            color: #d39e00;
        }
        
        .case-tag.info {
            background-color: rgba(13, 202, 240, 0.12);
            color: var(--secondary-color);
        }
        
        .case-tag.success {
            background-color: rgba(25, 135, 84, 0.12);
            color: var(--success-color);
        }
        
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        
        .view-toggle-btn {
            background: var(--light-gray);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        
        .view-toggle-btn:hover, .view-toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        /* PDF Download Button */
        .pdf-download-btn {
            background: var(--danger-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        
        .pdf-download-btn:hover {
            background: #bb2d3b;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
            color: white;
        }
        
        /* Tab export buttons */
        .tab-export-btn {
            background: var(--success-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 10px;
        }
        
        .tab-export-btn:hover {
            background: #157347;
            color: white;
        }
        
        /* Monthly Performance Styles */
        .period-comparison-card {
            background: var(--card-background);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--secondary-color);
            height: 100%;
        }
        
        .period-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .period-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .period-range {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .trend-indicator {
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            margin-left: 8px;
        }
        
        .trend-up {
            color: var(--success-color);
        }
        
        .trend-down {
            color: var(--danger-color);
        }
        
        .executive-summary-card {
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            border-top: 4px solid var(--primary-color);
            transition: all 0.2s;
            height: 100%;
        }
        
        .executive-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .executive-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .executive-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .executive-subtext {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .monthly-breakdown-table th {
            background-color: var(--sky-blue-light);
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        .customer-analysis-table th {
            background-color: var(--sky-blue-light);
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        .satisfaction-score {
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            display: inline-block;
        }
        
        /* RAG scores - KEEPING THESE */
        .score-excellent {
            background-color: rgba(25, 135, 84, 0.15);
            color: var(--success-color);
        }
        
        .score-good {
            background-color: rgba(13, 202, 240, 0.15);
            color: var(--secondary-color);
        }
        
        .score-average {
            background-color: rgba(255, 193, 7, 0.15);
            color: #d39e00;
        }
        
        .score-poor {
            background-color: rgba(220, 53, 69, 0.15);
            color: var(--danger-color);
        }
        
        /* Compliance Trend Cards */
        .compliance-trend-card {
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            height: 100%;
            transition: all 0.3s;
            border-top: 4px solid var(--primary-color);
        }
        
        .compliance-trend-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .compliance-trend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .compliance-trend-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0;
        }
        
        .compliance-trend-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .compliance-trend-chart {
            height: 120px;
            margin-top: 15px;
        }
        
        .compliance-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stats-card {
            background: var(--card-background);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary-color);
        }
        
        .stats-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .stats-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        
        .stats-change {
            font-size: 0.75rem;
            margin-top: 5px;
        }
        
        .stats-change.positive {
            color: var(--success-color);
        }
        
        .stats-change.negative {
            color: var(--danger-color);
        }
        
        /* Compliance Drilldown Section */
        .drilldown-section {
            margin-top: 30px;
        }
        
        .drilldown-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .drilldown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .drilldown-item {
            background: var(--card-background);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--accent-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .drilldown-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        .drilldown-item-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .drilldown-item-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        
        .drilldown-item-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        @media (max-width: 1400px) {
            .scorecard-table th,
            .scorecard-table td {
                font-size: 0.68rem;
                padding: 8px 4px;
            }
            
            .kpi-value {
                font-size: 1.6rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .period-value {
                font-size: 2rem;
            }
            
            .executive-value {
                font-size: 1.8rem;
            }
            
            .compliance-trend-value {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 1200px) {
            .grid-view-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .scorecard-table th,
            .scorecard-table td {
                font-size: 0.65rem;
            }
            
            .compliance-stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .grid-view-container {
                grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            }
            
            .global-filters .col-md-2 {
                margin-bottom: 10px;
            }
            
            .view-content {
                padding: 15px;
            }
            
            .accordion-body {
                padding: 12px;
            }
            
            .period-value {
                font-size: 1.8rem;
            }
            
            .executive-value {
                font-size: 1.6rem;
            }
            
            .compliance-trend-value {
                font-size: 1.8rem;
            }
            
            .compliance-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .drilldown-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Print Button Styles */
        .btn-print {
            background: var(--success-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px;
            border-radius: 6px;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
            width: 38px;
            height: 38px;
            position: relative;
        }
        
        .btn-print:hover {
            background: #00a844;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 200, 83, 0.3);
        }
        
        .btn-print svg {
            width: 20px;
            height: 20px;
        }
        
        .pdf-download-btn {
            background: var(--danger-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px;
            border-radius: 6px;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
            width: 38px;
            height: 38px;
        }
        
        .pdf-download-btn:hover {
            background: #b71c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
        }
        
        .btn-export-icon {
            background: var(--primary-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px;
            border-radius: 6px;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
            width: 38px;
            height: 38px;
        }
        
        .btn-export-icon:hover {
            background: #0052a3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
        }
        
        /* Tooltip for icon buttons */
        .icon-btn-tooltip {
            position: relative;
        }
        
        .icon-btn-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: var(--dark-gray);
            color: white;
            font-size: 0.7rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .icon-btn-tooltip:hover::after {
            opacity: 1;
        }
        
        /* Monthly Accounts Review - A4 Report Styles */
        .mar-report-sheet {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Centered Title Section */
        .mar-title-section {
            text-align: center;
            padding: 30px 45px 20px 45px;
            border-bottom: 2px solid #0f172a;
            flex-shrink: 0;
        }

        .mar-main-title {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }

        /* First Banner: Logo and Report Period */
        .mar-top-banner {
            padding: 25px 45px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #f8fafc, #ffffff);
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .mar-logo img {
            height: 48px;
        }

        .mar-report-period {
            text-align: right;
        }

        .mar-period-label {
            font-size: 10px;
            font-weight: 800;
            color: #64748b;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .mar-period-value {
            background: #0f172a;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            display: inline-block;
        }

        /* Second Banner: Customer Name and TAM */
        .mar-customer-banner {
            padding: 25px 45px 20px 45px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .mar-customer-name {
            margin: 0 0 10px 0;
            font-size: 26px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.5px;
        }

        .mar-tam-info {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            background: #f1f5f9;
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .mar-kpi-grid {
            padding: 30px 45px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            flex-shrink: 0;
        }

        .mar-kpi-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }

        .mar-kpi-label {
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .mar-kpi-value {
            font-size: 30px;
            font-weight: 800;
            color: #0f172a;
            line-height: 1;
        }

        .mar-kpi-sub {
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
        }

        .mar-kpi-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            opacity: 0.1;
        }

        .mar-content-grid {
            padding: 10px 45px 20px 45px;
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 30px;
            flex-shrink: 0;
        }

        .mar-section-header {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            font-size: 12px;
        }

        .mar-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 700;
            color: #64748b;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }

        .mar-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            font-weight: 500;
            color: #1e293b;
        }

        .mar-table th:last-child,
        .mar-table td:last-child {
            border-right: none;
        }

        .mar-table tr:last-child td {
            border-bottom: none;
        }

        .mar-num {
            text-align: right;
            font-feature-settings: "tnum";
            font-weight: 700;
        }

        .mar-row-total td {
            background: #f1f5f9;
            font-weight: 800;
            color: #0f172a;
        }

        /* Charts Section */
        .mar-charts-section {
            padding: 20px 45px;
            flex-shrink: 0;
        }

        .mar-chart-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }

        .mar-chart-container {
            height: 250px;
            position: relative;
        }

        .mar-open-cases-grid {
            padding: 20px 45px 30px 45px;
            flex-shrink: 0;
        }

        .mar-open-cases-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
        }

        .mar-bottom-section {
            padding: 0 45px 30px 45px;
            flex-shrink: 0;
            margin-top: auto;
        }

        .mar-footer {
            text-align: center;
            border-top: 2px solid #0f172a;
            padding-top: 20px;
            color: #0f172a;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        /* SLA Status Colors */
        #mar-card-sla.border-success {
            border-top: 4px solid #10b981;
        }

        #mar-card-sla.border-warning {
            border-top: 4px solid #f59e0b;
        }

        #mar-card-sla.border-danger {
            border-top: 4px solid #ef4444;
        }

        .txt-success {
            color: #10b981;
        }

        .txt-warning {
            color: #f59e0b;
        }

        .txt-danger {
            color: #ef4444;
        }
        
        .btn-print Styles for A4 */
        @media print {
            body {
                background: white !important;
                font-size: 10pt;
            }
            
            .navbar, .btn, .global-filters, .nav-tabs,
            .btn-print, .pdf-download-btn, #clear-filters-btn,
            button, .accordion-button {
                display: none !important;
            }
            
            .tab-content {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
            }
            
            .card {
                page-break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                margin-bottom: 10px !important;
            }
            
            .kpi-card {
                page-break-inside: avoid;
            }
            
            .accordion-collapse {
                display: block !important;
                height: auto !important;
            }
            
            .accordion-body {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: avoid;
                font-size: 9pt !important;
            }
            
            .kpi-section-title, h1, h2, h3, h4, h5, h6 {
                page-break-after: avoid;
            }
            
            .accordion-item {
                page-break-inside: avoid;
                border: none !important;
                margin-bottom: 10px !important;
            }
            
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Monthly Accounts Review Print Styles */
            .no-print {
                display: none !important;
            }
            
            /* Hide all dashboard elements when printing Monthly Accounts Review */
            body.printing-mar .navbar,
            body.printing-mar .global-filters,
            body.printing-mar .nav-tabs,
            body.printing-mar .data-load-info,
            body.printing-mar .active-filters-container {
                display: none !important;
            }
            
            body.printing-mar .tab-content {
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .mar-report-sheet {
                box-shadow: none !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                page-break-after: always;
            }
            
            .mar-title-section {
                padding: 20px 40px 15px 40px !important;
                page-break-after: avoid;
            }
            
            .mar-top-banner {
                padding: 20px 40px !important;
                page-break-after: avoid;
            }
            
            .mar-customer-banner {
                padding: 20px 40px 15px 40px !important;
                page-break-after: avoid;
            }
            
            .mar-kpi-grid {
                padding: 25px 40px !important;
                gap: 15px !important;
                page-break-inside: avoid;
            }
            
            .mar-content-grid {
                padding: 10px 40px 15px 40px !important;
                page-break-inside: avoid;
            }
            
            .mar-charts-section {
                padding: 15px 40px !important;
                page-break-inside: avoid;
            }
            
            .mar-open-cases-grid {
                padding: 15px 40px 20px 40px !important;
                page-break-inside: avoid;
            }
            
            .mar-bottom-section {
                padding: 15px 40px 20px 40px !important;
                margin-top: auto;
            }
            
            .mar-table td,
            .mar-table th {
                padding: 10px 12px !important;
            }
            
            .mar-period-value {
                background-color: #0f172a !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .mar-row-total td {
                background-color: #f1f5f9 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #mar-card-sla.border-success,
            #mar-card-sla.border-warning,
            #mar-card-sla.border-danger {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .mar-title-section {
                border-bottom-color: #0f172a !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .mar-footer {
                border-top-color: #0f172a !important;
                color: #0f172a !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .mar-chart-container canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            @page {
                size: A4;
                margin: 10mm;
            }
            /* Sidebar Styles */
        .sidebar-menu {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            position: sticky;
            top: 20px;
        }

        .sidebar-menu .nav-link {
            color: var(--text-muted);
            padding: 10px 10px;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .sidebar-menu .nav-link:hover {
            background-color: var(--sky-blue-light);
            color: var(--primary-color);
        }

        .sidebar-menu .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .sidebar-menu .nav-link i {
            margin-right: 10px;
            font-size: 1rem;
        }
        
        .section-banner {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
        }

        .section-banner h4 {
            margin: 0;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
        }

        /* Sidebar Layout */
        .dashboard-container {
            display: block;
            margin-top: 0;
        }

        .main-content {
            padding: 20px;
            min-height: calc(100vh - 56px);
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            .sidebar-toggle {
                display: none !important;
            }
            
            .main-content {
                padding: 15px;
            }
        }

        /* Resolution Code Table Styles */
        .res-code-table th {
            background-color: var(--sky-blue-light);
            color: var(--primary-color);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        
        .res-code-table td {
            vertical-align: middle;
            font-size: 0.8rem;
        }
    }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <div class="logo-container d-flex align-items-center">
                <div class="navbar-brand">
                    <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" alt="MSP Logo" style="height: 32px; margin-right: 12px;">
                   <!--  <div class="brand-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                    </div> -->
                    MSP Support - Monthly Performance Dashboard
                </div>
            </div>
            <div class="d-flex align-items-center">
                <span id="last-updated" class="me-3 small text-muted"></span>
                <span id="total-cases" class="badge" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; box-shadow: var(--shadow-sm); font-family: 'JetBrains Mono', monospace;">0 Cases Loaded</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        
        <div class="row mb-3" id="upload-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="upload-area" id="drop-area" style="text-align:center;">
                            <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" alt="Logo" style="height: 40px; margin-bottom: 12px; opacity: 0.8;">
                            <h5 class="mb-2">Upload MSP-MonthlyReview - Based on Logged Date</h5>
                            <p class="text-muted mb-3">Drag & Drop Excel/CSV or Click to Browse</p>
                            <button class="btn btn-lg btn-primary">
                                <i class="bi bi-cloud-upload me-2"></i>Select File
                            </button>
                            <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                        </div>
                        <div id="file-info" class="mt-3" style="display: none;">
                            <div class="alert alert-success d-flex justify-content-between align-items-center shadow-sm">
                                <div>
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                                    <span id="file-name" class="fw-bold"></span> 
                                    <span id="row-count" class="badge bg-secondary ms-2"></span>
                                </div>
                                <button class="btn btn-sm btn-success" id="process-data-btn">
                                    <i class="bi bi-play-circle me-1"></i> Process Data
                                </button>
                            </div>
                        </div>
                        
                        <!-- OR Divider -->
                        <div class="d-flex align-items-center my-4">
                            <hr class="flex-grow-1">
                            <span class="px-3 text-muted fw-bold" style="font-size: 0.9rem;">OR</span>
                            <hr class="flex-grow-1">
                        </div>
                        
                        <!-- Repository File Selection -->
                        <div class="text-center">
                            <h6 class="mb-3" style="color: var(--primary-color); font-weight: 600;">
                                <i class="bi bi-folder2-open me-2"></i>Select Data File from Repository
                            </h6>
                            <p class="text-muted small mb-3">Choose an Excel file from the repository to load</p>
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <select class="form-select form-select-lg mb-3" id="repository-file-select">
                                        <option value="">-- Select an Excel file --</option>
                                        <!-- Add your Excel file names from MSPData folder -->
                                        <option value="MSPData/MSPMonthlyReview_2025.xlsx">MSP Monthly Review 2025</option>
										<!-- Add more files as needed with MSPData/ prefix -->
                                        <option value="MSPData/MSPMonthlyReview_2025-2026.xlsx">MSP Monthly Review 2025-2026</option>
										<!-- Add more files as needed with MSPData/ prefix 
                                        <option value="MSPData/MSPMonthlyReview_January2026.xlsx">MSP January 2026</option>
                                        Add more files as needed with MSPData/ prefix -->
                                    </select>
                                    <button class="btn btn-lg btn-primary" id="load-repository-file-btn" disabled>
                                        <i class="bi bi-check-circle me-2"></i>Load Selected File
                                    </button>
                                    <p class="text-muted small mt-3" id="repository-note">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span id="repo-status">Checking connection...</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-section" style="display: none;">
            
            <!-- Sidebar Overlay -->
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>
            
            <!-- NEW: Data Load Period Info Banner -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="data-load-info">
                        <div class="d-flex align-items-center gap-4 flex-wrap">
                            <div class="info-item">
                                <span class="info-label"><i class="bi bi-calendar-range"></i> Data Load Period:</span>
                                <span class="info-value" id="dataLoadPeriod">Loading...</span>
                            </div>
                            <div class="filter-status" id="filterStatus">
                                <i class="bi bi-funnel"></i>
                                <span>Reviewing Over All Owners and Accounts/Customers</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="window.print()" title="Print Report">
                                <i class="bi bi-printer-fill me-1"></i>Print Report
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="download-pdf-btn-banner" title="Download PDF">
                                <i class="bi bi-file-pdf-fill me-1"></i>Download PDF
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportFullData()" title="Export Data">
                                <i class="bi bi-download me-1"></i>Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- REMOVED: Time Period Selector Section -->
            
            <!-- Filter Toggle FAB Button -->
            <button class="filter-toggle-fab" id="filter-toggle-fab" onclick="toggleFilterPanel()">
                <i class="bi bi-funnel-fill"></i>
            </button>
            
            <!-- Filter Panel Overlay -->
            <div class="filter-panel-overlay" id="filter-panel-overlay" onclick="toggleFilterPanel()"></div>
            
            <!-- Side Filter Panel -->
            <div class="filter-side-panel" id="filter-side-panel">
                <div class="filter-panel-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-funnel-fill me-2"></i>Global Filters</h5>
                        <button class="filter-panel-close" onclick="toggleFilterPanel()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="filter-panel-body">
                    <div class="mb-3">
                        <label class="filter-label">Owner</label>
                        <select class="form-select form-select-sm" id="global-filter-owner">
                            <option value="">All Owners</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="filter-label">Submitted By</label>
                        <select class="form-select form-select-sm" id="global-filter-submittedby">
                            <option value="">All Submitted By</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="filter-label">Service Type</label>
                        <select class="form-select form-select-sm" id="global-filter-service">
                            <option value="">All Service Types</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="filter-label">Status</label>
                        <select class="form-select form-select-sm" id="global-filter-status">
                            <option value="">All Statuses</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="filter-label">SLA Status</label>
                        <select class="form-select form-select-sm" id="global-filter-sla">
                            <option value="">All SLA Status</option>
                            <option value="Violated">SLA Violated</option>
                            <option value="Non-Violated">SLA Non-Violated</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="filter-label"><i class="bi bi-calendar-range me-1"></i>Timescale</label>
                        <select class="form-select form-select-sm" id="global-filter-timescale">
                            <option value="all">All Time (Default)</option>
                            <option value="current-month">Current Month</option>
                            <option value="last-month">Last Month</option>
                            <option value="last-month-include-current">Last Month + Current Month</option>
                            <option value="last-2-months">Last 2 Months</option>
                            <option value="last-2-months-include-current">Last 2 Months + Current Month</option>
                            <option value="last-3-months">Last 3 Months</option>
                            <option value="last-3-months-include-current">Last 3 Months + Current Month</option>
                            <option value="last-4-months">Last 4 Months</option>
                            <option value="last-4-months-include-current">Last 4 Months + Current Month</option>
                            <option value="last-5-months">Last 5 Months</option>
                            <option value="last-5-months-include-current">Last 5 Months + Current Month</option>
                            <option value="last-6-months">Last 6 Months</option>
                            <option value="last-6-months-include-current">Last 6 Months + Current Month</option>
                            <option value="last-7-months">Last 7 Months</option>
                            <option value="last-7-months-include-current">Last 7 Months + Current Month</option>
                            <option value="last-8-months">Last 8 Months</option>
                            <option value="last-8-months-include-current">Last 8 Months + Current Month</option>
                            <option value="last-9-months">Last 9 Months</option>
                            <option value="last-9-months-include-current">Last 9 Months + Current Month</option>
                            <option value="last-10-months">Last 10 Months</option>
                            <option value="last-10-months-include-current">Last 10 Months + Current Month</option>
                            <option value="last-11-months">Last 11 Months</option>
                            <option value="last-11-months-include-current">Last 11 Months + Current Month</option>
                            <option value="current-year">Current Year</option>
                            <option value="last-year">Last Year</option>
                        </select>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex flex-column gap-2">
                        <button class="btn btn-sm btn-outline-danger w-100" id="clear-filters-btn">
                            <i class="bi bi-x-circle me-1"></i>Clear All Filters
                        </button>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="filter-tags" id="active-filters-tags" style="display: none;">
                        <!-- Active filter tags will appear here -->
                    </div>
                    
                    <div class="mt-3 small text-muted">
                        <div><i class="bi bi-info-circle me-1"></i><span id="active-filters-count">0 filters active</span></div>
                        <div class="mt-1"><span id="filtered-cases-count">Showing 0 of 0 cases</span></div>
                    </div>
                </div>
            </div>

    <div class="dashboard-container">
        <!-- Sidebar Toggle FAB Button -->
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" title="Open Menu">
            <i class="bi bi-list"></i>
        </button>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar Navigation Panel -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h5><i class="bi bi-menu-button-wide"></i> MSP Support Review</h5>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="nav-section-title"><i class="bi bi-house-door-fill me-1"></i>MAIN VIEWS</div>
                <div class="nav flex-column" id="mainViewTabs" role="tablist">
                    <a class="nav-link active" id="view-dashboard-tab" data-bs-toggle="tab" data-bs-target="#view-dashboard" role="tab" onclick="updateBannerTitle('Dashboard View'); toggleSidebar();">
                        <i class="bi bi-grid-1x2"></i>
                        <span class="nav-link-text">Dashboard View</span>
                    </a>
                    <a class="nav-link" id="view-performance-tab" data-bs-toggle="tab" data-bs-target="#view-performance" role="tab" onclick="updateBannerTitle('Performance View'); toggleSidebar();">
                        <i class="bi bi-list-columns-reverse"></i>
                        <span class="nav-link-text">Performance View</span>
                    </a>
                    <a class="nav-link" id="view-monthly-tab" data-bs-toggle="tab" data-bs-target="#view-monthly" role="tab" onclick="updateBannerTitle('Monthly Performance'); toggleSidebar();">
                        <i class="bi bi-graph-up"></i>
                        <span class="nav-link-text">Monthly Performance</span>
                    </a>
                    <a class="nav-link" id="view-monthly-comparison-tab" data-bs-toggle="tab" data-bs-target="#view-monthly-comparison" role="tab" onclick="updateBannerTitle('Monthly Performance Comparison'); toggleSidebar();">
                        <i class="bi bi-bar-chart-line"></i>
                        <span class="nav-link-text">Monthly Comparison</span>
                    </a>
                    <a class="nav-link" id="view-category-analysis-tab" data-bs-toggle="tab" data-bs-target="#view-category-analysis" role="tab" onclick="updateBannerTitle('Category Analysis'); toggleSidebar();">
                        <i class="bi bi-tags-fill"></i>
                        <span class="nav-link-text">Category Analysis</span>
                    </a>
                    <a class="nav-link" id="view-resolution-code-tab" data-bs-toggle="tab" data-bs-target="#view-resolution-code" role="tab" onclick="updateBannerTitle('Resolution Code Review'); toggleSidebar();">
                        <i class="bi bi-check2-square"></i>
                        <span class="nav-link-text">Resolution Code Review</span>
                    </a>
                    <a class="nav-link" id="view-resolution-review-tab" data-bs-toggle="tab" data-bs-target="#view-resolution-review" role="tab" onclick="updateBannerTitle('Resolution Review'); toggleSidebar(); updateResolutionReviewTab();">
                        <i class="bi bi-clipboard-check"></i>
                        <span class="nav-link-text">Resolution Review</span>
                    </a>
                    <a class="nav-link" id="view-monthly-accounts-tab" data-bs-toggle="tab" data-bs-target="#view-monthly-accounts" role="tab" onclick="updateBannerTitle('Monthly Accounts Review'); toggleSidebar();">
                        <i class="bi bi-file-earmark-text"></i>
                        <span class="nav-link-text">Monthly Accounts Review</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Dynamic Section Banner -->
            <div class="section-banner" id="currentSectionBanner">
                <h4 id="currentSectionTitle"><i class="bi bi-grid-1x2 me-2"></i>Dashboard View</h4>
            </div>

            <div class="tab-content view-content" id="mainViewTabsContent">
                
                <div class="tab-pane fade show active" id="view-dashboard" role="tabpanel">
                    
                    <div class="accordion" id="kpiAccordion">
                    
                        <div class="accordion-item" id="accordion-section-1">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                    <i class="bi bi-list-task me-2"></i>1. Overall Case Volume
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-total-closed-card">
                                                <span class="kpi-status-tag bg-metric" id="kpi-total-closed-tag">METRIC</span>
                                                <div class="kpi-title">Total Closed Cases</div>
                                                <div class="kpi-value" id="kpi-total-closed">0</div>
                                                <div class="kpi-recommendation" id="kpi-total-closed-rec">Total closed cases (SR + INC).</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-closed-sr-card">
                                                <span class="kpi-status-tag bg-metric" id="kpi-closed-sr-tag">METRIC</span>
                                                <div class="kpi-title">Total Closed SR</div>
                                                <div class="kpi-value" id="kpi-closed-sr">0</div>
                                                <div class="kpi-recommendation" id="kpi-closed-sr-rec">Closed Service Requests.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-closed-inc-card">
                                                <span class="kpi-status-tag bg-metric" id="kpi-closed-inc-tag">METRIC</span>
                                                <div class="kpi-title">Total Closed INC</div>
                                                <div class="kpi-value" id="kpi-closed-inc">0</div>
                                                <div class="kpi-recommendation" id="kpi-closed-inc-rec">Closed Incident Management cases.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Section for Open Cases -->
                        <div class="accordion-item" id="accordion-section-2">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    <i class="bi bi-inbox-fill me-2"></i>2. Outstanding Open Cases
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-open-total-card">
                                                <span class="kpi-status-tag bg-metric" id="kpi-open-total-tag">METRIC</span>
                                                <div class="kpi-title">Total Open Cases</div>
                                                <div class="kpi-value" id="kpi-open-total">0</div>
                                                <div class="kpi-recommendation" id="kpi-open-total-rec">Total cases currently open.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-open-sr-card">
                                                <span class="kpi-status-tag bg-metric" id="kpi-open-sr-tag">METRIC</span>
                                                <div class="kpi-title">Total Open SR</div>
                                                <div class="kpi-value" id="kpi-open-sr">0</div>
                                                <div class="kpi-recommendation" id="kpi-open-sr-rec">Open Service Requests.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-open-inc-card">
                                                <span class="kpi-status-tag bg-metric" id="kpi-open-inc-tag">METRIC</span>
                                                <div class="kpi-title">Total Open INC</div>
                                                <div class="kpi-value" id="kpi-open-inc">0</div>
                                                <div class="kpi-recommendation" id="kpi-open-inc-rec">Open Incident Management cases.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Original Section 2 becomes Section 3 -->
                        <div class="accordion-item" id="accordion-section-3">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    <i class="bi bi-alarm-fill me-2"></i>3. SLA Compliance
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-overall-sla-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-overall-sla-tag">ON TRACK</span>
                                                <div class="kpi-title">Overall SLA Compliance</div>
                                                <div class="kpi-value" id="kpi-overall-sla">0%</div>
                                                <div class="kpi-recommendation" id="kpi-overall-sla-rec">[(Total Cases - SLA Violated)  Total Cases]  100</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-sr-sla-compliance-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-sr-sla-compliance-tag">ON TRACK</span>
                                                <div class="kpi-title">SR SLA Compliance</div>
                                                <div class="kpi-value" id="kpi-sr-sla-compliance">0%</div>
                                                <div class="kpi-recommendation" id="kpi-sr-sla-compliance-rec">Service Request SLA compliance rate.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-inc-sla-compliance-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-inc-sla-compliance-tag">ON TRACK</span>
                                                <div class="kpi-title">INC SLA Compliance</div>
                                                <div class="kpi-value" id="kpi-inc-sla-compliance">0%</div>
                                                <div class="kpi-recommendation" id="kpi-inc-sla-compliance-rec">Incident Management SLA compliance rate.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-2 mt-3">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-sla-sr-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-sla-sr-tag">ON TRACK</span>
                                                <div class="kpi-title">SLA Violated  SR</div>
                                                <div class="kpi-value" id="kpi-sla-sr">0</div>
                                                <div class="kpi-recommendation" id="kpi-sla-sr-rec">Service Requests with SLA violations.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-sla-inc-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-sla-inc-tag">ON TRACK</span>
                                                <div class="kpi-title">SLA Violated  INC</div>
                                                <div class="kpi-value" id="kpi-sla-inc">0</div>
                                                <div class="kpi-recommendation" id="kpi-sla-inc-rec">Incident Management cases with SLA violations.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-edoc-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-edoc-tag">ON TRACK</span>
                                                <div class="kpi-title">SR EDOC Breach</div>
                                                <div class="kpi-value" id="kpi-edoc">0</div>
                                                <div class="kpi-recommendation" id="kpi-edoc-rec">SR cases that breached Expected Date of Closure.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-2 mt-3">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-subsequent-sla-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-subsequent-sla-tag">ON TRACK</span>
                                                <div class="kpi-title">Subsequent SLA Miss</div>
                                                <div class="kpi-value" id="kpi-subsequent-sla">0</div>
                                                <div class="kpi-recommendation" id="kpi-subsequent-sla-rec">Closed cases with subsequent SLA misses.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-cpe-calls-card">
                                                <span class="kpi-status-tag bg-metric" id="kpi-cpe-calls-tag">METRIC</span>
                                                <div class="kpi-title">Number of CPE Calls</div>
                                                <div class="kpi-value" id="kpi-cpe-calls">0</div>
                                                <div class="kpi-recommendation" id="kpi-cpe-calls-rec">Cases with corresponding internal tickets.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Original Section 3 becomes Section 4 -->
                        <div class="accordion-item" id="accordion-section-4">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                    <i class="bi bi-hourglass-split me-2"></i>4. Closure Aging
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-fcr-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-fcr-tag">ON TRACK</span>
                                                <div class="kpi-title">First Contact Resolution</div>
                                                <div class="kpi-value" id="kpi-fcr">0</div>
                                                <div class="kpi-recommendation" id="kpi-fcr-rec">Cases resolved within 2 days.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-inc-less15-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-inc-less15-tag">ON TRACK</span>
                                                <div class="kpi-title">Aging <15 Days Closed INC</div>
                                                <div class="kpi-value" id="kpi-inc-less15">0</div>
                                                <div class="kpi-recommendation" id="kpi-inc-less15-rec">Closed INC cases aged less than 15 days.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-inc-more15-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-inc-more15-tag">ON TRACK</span>
                                                <div class="kpi-title">Aging >15 Days Closed INC</div>
                                                <div class="kpi-value" id="kpi-inc-more15">0</div>
                                                <div class="kpi-recommendation" id="kpi-inc-more15-rec">Closed INC cases aged more than 15 days.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-2 mt-3">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sr-less15-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-sr-less15-tag">ON TRACK</span>
                                                <div class="kpi-title">Aging <15 Days Closed SR</div>
                                                <div class="kpi-value" id="kpi-sr-less15">0</div>
                                                <div class="kpi-recommendation" id="kpi-sr-less15-rec">Closed SR cases aged less than 15 days.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sr-more15-card">
                                                <span class="kpi-status-tag bg-on-track" id="kpi-sr-more15-tag">ON TRACK</span>
                                                <div class="kpi-title">Aging >15 Days Closed SR</div>
                                                <div class="kpi-value" id="kpi-sr-more15">0</div>
                                                <div class="kpi-recommendation" id="kpi-sr-more15-rec">Closed SR cases aged more than 15 days.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <h6 class="mt-4 mb-2" style="color: var(--primary-color);">
                        <i class="bi bi-person-lines-fill me-2"></i>Team Performance Scorecard
                    </h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">
                            Click on any row to filter by that owner
                        </div>
                        <button class="btn btn-sm btn-success" onclick="exportScorecardToExcel()">
                            <i class="bi bi-download me-1"></i> Export Scorecard
                        </button>
                    </div>
                    <div class="card p-2 overflow-auto">
                        <table class="table table-sm table-striped table-hover scorecard-table compact-view" id="owner-scorecard-table" style="min-width: 1400px;">
                            <thead>
                                <tr>
                                    <th>Owner</th>
                                    <th>Overall SLA %</th>
                                    <th>Total Closed Cases</th>
                                    <th>Closed SR</th>
                                    <th>Closed INC</th>
                                    <th>Total Open Cases</th>
                                    <th>Open SR</th>
                                    <th>Open INC</th>
                                    <th>SLA Viol.  SR</th>
                                    <th>SLA Viol.  INC</th>
                                    <th>FCR</th>
                                    <th>Subsequent SLA Miss</th>
                                    <th>CPE Calls</th>
                                    <th>Risk Gauge</th>
                                </tr>
                            </thead>
                            <tbody id="owner-scorecard-body">
                                <tr><td colspan="14" class="text-center text-muted py-3">Processing data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="view-performance" role="tabpanel">
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body">
                                    <div class="metric-value" id="total-closed-cases">0</div>
                                    <div class="metric-label">Total Closed Cases</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body">
                                    <div class="metric-value" id="overall-sla-rate">0%</div>
                                    <div class="metric-label">Overall SLA Compliance</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body">
                                    <div class="metric-value" id="fcr-rate">0%</div>
                                    <div class="metric-label">FCR Rate</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body">
                                    <div class="metric-value" id="cpe-calls-metric">0</div>
                                    <div class="metric-label">CPE Calls</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-pie-chart-fill me-2" style="color: var(--primary-color);"></i>Cases by Service Type</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="serviceTypeChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-bar-chart-fill me-2" style="color: var(--primary-color);"></i>Closure Aging Distribution</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="closureAgingChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Performance Tab -->
                    <ul class="nav nav-tabs" id="performanceTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="customer-tab" data-bs-toggle="tab" data-bs-target="#customer" type="button">
                                <i class="bi bi-people-fill me-1" style="color: var(--primary-color);"></i>Customer Performance
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="engineer-tab" data-bs-toggle="tab" data-bs-target="#engineer" type="button">
                                <i class="bi bi-person-badge-fill me-1" style="color: var(--primary-color);"></i>Engineer Performance
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="performanceTabsContent">
                        
                        <!-- Customer Performance Tab -->
                        <div class="tab-pane fade show active" id="customer" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-table me-2" style="color: var(--primary-color);"></i>Customer Performance Analysis</h6>
                                            <button class="btn btn-sm btn-success" onclick="exportCustomerPerformance()">
                                                <i class="bi bi-download me-1"></i> Export to Excel
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-striped table-hover customer-analysis-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Submitted By</th>
                                                            <th>Total Cases</th>
                                                            <th>Closed Cases</th>
                                                            <th>SLA Compliance</th>
                                                            <th>Avg Resolution Days - 24/7</th>
                                                            <th>FCR Rate</th>
                                                            <th>CPE Calls</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="customer-analysis-body">
                                                        <!-- Will be populated dynamically -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Engineer Performance Tab -->
                        <div class="tab-pane fade" id="engineer" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-table me-2" style="color: var(--primary-color);"></i>Engineer Performance Analysis</h6>
                                            <button class="btn btn-sm btn-success" onclick="exportEngineerPerformance()">
                                                <i class="bi bi-download me-1"></i> Export to Excel
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-striped table-hover engineer-analysis-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Owner</th>
                                                            <th>Total Cases</th>
                                                            <th>Closed Cases</th>
                                                            <th>SLA Compliance</th>
                                                            <th>FCR</th>
                                                            <th>Avg Resolution Days - 24/7</th>
                                                            <th>Subsequent SLA Miss</th>
                                                            <th>CPE Calls</th>
                                                            <th>Performance Score</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="engineer-analysis-body">
                                                        <!-- Will be populated dynamically -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Performance Tab Content - MODIFIED -->
                <div class="tab-pane fade" id="view-monthly" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 style="color: var(--primary-color);">
                                    <i class="bi bi-speedometer2 me-2"></i>Monthly Performance Analysis
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportMonthlyPerformance()">
                                        <i class="bi bi-download me-1"></i> Export Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Trend View -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="mb-3" style="color: var(--primary-color);">
                                <i class="bi bi-graph-up-arrow me-2"></i>Compliance Trends
                            </h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="compliance-trend-card" onclick="openComplianceDrillDown('sla')">
                                        <div class="compliance-trend-header">
                                            <h6 class="compliance-trend-title">SLA Compliance</h6>
                                            <span class="badge bg-success" id="sla-trend-badge">+2.5%</span>
                                        </div>
                                        <div class="compliance-trend-value" id="sla-compliance-trend">95.8%</div>
                                        <div class="compliance-trend-chart">
                                            <canvas id="slaTrendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="compliance-trend-card" onclick="openComplianceDrillDown('fcr')">
                                        <div class="compliance-trend-header">
                                            <h6 class="compliance-trend-title">First Contact Resolution</h6>
                                            <span class="badge bg-success" id="fcr-trend-badge">+1.2%</span>
                                        </div>
                                        <div class="compliance-trend-value" id="fcr-trend">87.3%</div>
                                        <div class="compliance-trend-chart">
                                            <canvas id="fcrTrendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="compliance-trend-card" onclick="openComplianceDrillDown('aging')">
                                        <div class="compliance-trend-header">
                                            <h6 class="compliance-trend-title">Aging Compliance</h6>
                                            <span class="badge bg-danger" id="aging-trend-badge">-0.8%</span>
                                        </div>
                                        <div class="compliance-trend-value" id="aging-compliance-trend">92.1%</div>
                                        <div class="compliance-trend-chart">
                                            <canvas id="agingTrendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logged vs Closed Chart -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-bar-chart-steps me-2" style="color: var(--primary-color);"></i>Monthly Logged vs Closed Cases</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="loggedClosedChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Statistics Grid -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="mb-3" style="color: var(--primary-color);">
                                <i class="bi bi-bar-chart me-2"></i>Monthly Performance Statistics
                            </h6>
                            <div class="compliance-stats-grid" id="compliance-stats-grid">
                                <!-- Stats cards will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Drilldown Section -->
                    <div class="drilldown-section">
                        <h6 class="drilldown-section-title">
                            <i class="bi bi-search me-2"></i>Compliance Drilldown Analysis
                        </h6>
                        <div class="drilldown-grid" id="compliance-drilldown-grid">
                            <!-- Drilldown items will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Monthly Breakdown Table -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-table me-2" style="color: var(--primary-color);"></i>Monthly Performance Breakdown</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped table-hover monthly-breakdown-table">
                                            <thead>
                                                <tr>
                                                    <th>Month</th>
                                                    <th>Total Cases</th>
                                                    <th>SLA Compliance</th>
                                                    <th>FCR Rate</th>
                                                    <th>Aging >15 Days</th>
                                                    <th>SR EDOC Breach</th>
                                                    <th>Email Compliance</th>
                                                    <th>Subsequent SLA Miss</th>
                                                    <th>Details</th>
                                                </tr>
                                            </thead>
                                            <tbody id="monthly-breakdown-body">
                                                <!-- Will be populated dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Performance Comparison Tab Content - NEW SECTION -->
                <div class="tab-pane fade" id="view-monthly-comparison" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 style="color: var(--primary-color);">
                                    <i class="bi bi-bar-chart-line me-2"></i>Monthly Performance Comparison - Trend Analysis
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportMonthlyComparison()">
                                        <i class="bi bi-download me-1"></i> Export Comparison
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.85rem;">
                                Compare compliance metrics across all available months to identify trends and patterns
                            </p>
                        </div>
                    </div>

                    <!-- Trend Charts Row 1 -->
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-graph-up-arrow me-2"></i>#1 - Overall Logged vs Closed
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="overallLoggedClosedChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-shield-check me-2"></i>#2 - SLA Compliance
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="slaComplianceTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trend Charts Row 2 -->
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-clipboard-check me-2"></i>#3 - SR Logged vs Closed
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="srLoggedClosedChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-exclamation-triangle me-2"></i>#4 - INC Logged vs Closed
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="incLoggedClosedChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trend Charts Row 3 -->
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-hourglass-split me-2"></i>#5 - Average Resolution Trend (Days)
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="avgResolutionTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-speedometer me-2"></i>#6 - Overall Performance Trend
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="overallPerformanceTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trend Charts Row 4 - NEW -->
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-telephone-inbound me-2"></i>#7 - CPE Logged Trend
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="cpeLoggedTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-lightning-charge me-2"></i>#8 - FCR Trend
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="monthlyFcrTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Comparison Summary Table -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-table me-2"></i>Monthly Comparison Summary Table
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="monthlyComparisonTable">
                                            <thead>
                                                <tr>
                                                    <th>Month</th>
                                                    <th>Logged Cases</th>
                                                    <th>Closed Cases</th>
                                                    <th>Subsequent SLA Miss</th>
                                                    <th>SLA Compliance %</th>
                                                    <th>Avg Resolution Days - 24/7</th>
                                                    <th>Performance Score</th>
                                                </tr>
                                            </thead>
                                            <tbody id="monthlyComparisonTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resolution Code Review Tab Content - NEW SECTION -->
                <div class="tab-pane fade" id="view-resolution-code" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 style="color: var(--primary-color);">
                                    <i class="bi bi-check2-square me-2"></i>Resolution Code Review
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportResolutionCodeAnalysis()">
                                        <i class="bi bi-download me-1"></i> Export Analysis
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.75rem;">
                                Comprehensive analysis of resolution patterns with SOP recommendations for L0 and L1 calls
                            </p>
                        </div>
                    </div>

                    <!-- Insights Card -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid var(--primary-color);">
                                <div class="card-body">
                                    <h6 style="color: var(--primary-color); font-weight: 700; font-size: 0.85rem; margin-bottom: 12px;">
                                        <i class="bi bi-lightbulb me-2"></i>Key Insights & SOP Recommendations
                                    </h6>
                                    <ul id="resolutionInsights" style="margin: 0; padding-left: 20px; font-size: 0.75rem; color: var(--text-color);">
                                        <li>Load data to view insights and recommendations</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="row mb-4">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700; font-size: 0.85rem;">
                                        <i class="bi bi-pie-chart-fill me-2"></i>Resolution Code Distribution
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="resolutionCodePieChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700; font-size: 0.85rem;">
                                        <i class="bi bi-bar-chart-fill me-2"></i>Top 10 Resolution Codes
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="resolutionCodeBarChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700; font-size: 0.85rem;">
                                        <i class="bi bi-clock-history me-2"></i>Avg Resolution Time by Code
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="resolutionTimeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700; font-size: 0.85rem;">
                                        <i class="bi bi-check-circle-fill me-2"></i>SLA Compliance by Resolution Code
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="resolutionSLAChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tables Row -->
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700;">
                                        Resolution Code Analysis
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover res-code-table mb-0" id="resolutionCodeTable">
                                            <thead>
                                                <tr>
                                                    <th>Resolution Code</th>
                                                    <th>Count</th>
                                                    <th>% of Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resolutionCodeTableBody">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700;">
                                        Sub Resolution Code Analysis
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover res-code-table mb-0" id="subResolutionCodeTable">
                                            <thead>
                                                <tr>
                                                    <th>Sub Resolution Code</th>
                                                    <th>Count</th>
                                                    <th>% of Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="subResolutionCodeTableBody">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category Analysis Tab Content - NEW SECTION -->
                <div class="tab-pane fade" id="view-category-analysis" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 style="color: var(--primary-color);">
                                    <i class="bi bi-tags-fill me-2"></i>Category & Feature Analysis
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportCategoryAnalysis()">
                                        <i class="bi bi-download me-1"></i> Export Analysis
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.75rem;">
                                Analyze performance by Support Category, Feature, and Sub Feature
                            </p>
                        </div>
                    </div>

                    <!-- Support Category Analysis -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-folder-fill me-2"></i>Support Category Distribution
                                    </h6>
                                    <div class="chart-container" style="height: 350px;">
                                        <canvas id="supportCategoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Analysis -->
                    <div class="row mb-4">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-star-fill me-2"></i>Top 10 Features by Volume
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="topFeaturesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Top 10 Features by SLA Violations
                                    </h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="topFeaturesSLAChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category Performance Table -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-table me-2"></i>Category Performance Summary
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="categoryPerformanceTable">
                                            <thead>
                                                <tr>
                                                    <th>Support Category</th>
                                                    <th>Total Cases</th>
                                                    <th>Closed Cases</th>
                                                    <th>SLA Violations</th>
                                                    <th>SLA Compliance %</th>
                                                    <th>Avg Resolution (Days)</th>
                                                    <th>Top Feature</th>
                                                </tr>
                                            </thead>
                                            <tbody id="categoryPerformanceTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Performance Table -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-list-ul me-2"></i>Feature Performance Summary
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="featurePerformanceTable">
                                            <thead>
                                                <tr>
                                                    <th>Feature</th>
                                                    <th>Total Cases</th>
                                                    <th>Closed Cases</th>
                                                    <th>SLA Violations</th>
                                                    <th>SLA Compliance %</th>
                                                    <th>Avg Resolution (Days)</th>
                                                    <th>Top Sub Feature</th>
                                                </tr>
                                            </thead>
                                            <tbody id="featurePerformanceTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resolution Review Tab Content - NEW SECTION -->
                <div class="tab-pane fade" id="view-resolution-review" role="tabpanel">
                    
                    <!-- Export Button Bar -->
                    <div class="d-flex justify-content-end mb-3 no-print">
                        <button class="btn btn-success" onclick="exportResolutionReview()">
                            <i class="bi bi-file-earmark-excel me-2"></i>Export to Excel
                        </button>
                    </div>

                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card text-center">
                                <div class="card-body">
                                    <div style="font-size: 2rem; color: var(--primary-color);">
                                        <i class="bi bi-card-list"></i>
                                    </div>
                                    <h6 class="mt-2" style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Unique Problem Statements</h6>
                                    <h3 id="uniqueProblemStatements" style="color: var(--primary-color); font-weight: 700;">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card text-center">
                                <div class="card-body">
                                    <div style="font-size: 2rem; color: var(--success-color);">
                                        <i class="bi bi-list-check"></i>
                                    </div>
                                    <h6 class="mt-2" style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Unique Resolution Steps</h6>
                                    <h3 id="uniqueResolutionSteps" style="color: var(--success-color); font-weight: 700;">0</h3>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Charts Row -->
                    <div class="row mb-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-bar-chart-fill me-2"></i>Top 10 Problem Statements
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="problemStatementsChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-bar-chart-fill me-2"></i>Top 10 Resolution Steps
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="resolutionStepsChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Tables -->
                    <div class="row mb-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-table me-2"></i>Problem Statement Analysis
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
                                                <tr>
                                                    <th style="width: 60%;">Problem Statement</th>
                                                    <th style="width: 20%;">Count</th>
                                                    <th style="width: 20%;">% of Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="problemStatementTableBody">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-table me-2"></i>Resolution Steps Analysis
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
                                                <tr>
                                                    <th style="width: 60%;">Resolution Summary (Steps)</th>
                                                    <th style="width: 20%;">Count</th>
                                                    <th style="width: 20%;">% of Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resolutionStepsTableBody">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights and Recommendations -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="bi bi-lightbulb me-2"></i>Key Insights & Recommendations
                                    </h6>
                                </div>
                                <div class="card-body" id="insightsContent">
                                    <!-- Insights will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Accounts Review Tab Content - NEW SECTION -->
                <div class="tab-pane fade" id="view-monthly-accounts" role="tabpanel">
                    
                    <!-- Print Button Bar -->
                    <div class="d-flex justify-content-end mb-3 no-print">
                        <button class="btn btn-primary" onclick="printMonthlyAccountsReport()">
                            <i class="bi bi-printer me-2"></i>Print Report
                        </button>
                    </div>

                    <!-- A4 Report Sheet -->
                    <div class="mar-report-sheet" id="marReportSheet">
                        
                        <!-- Centered Title -->
                        <div class="mar-title-section">
                            <h2 class="mar-main-title">Monthly Accounts Review - <span id="mar-title-year">2025</span></h2>
                        </div>
                        
                        <!-- First Banner: Logo and Report Period -->
                        <div class="mar-top-banner">
                            <div class="mar-logo">
                                <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" alt="SapphireIMS">
                            </div>
                            <div class="mar-report-period">
                                <div class="mar-period-label">COMPLIANCE REPORT PERIOD</div>
                                <div class="mar-period-value" id="mar-report-period">December 2025</div>
                            </div>
                        </div>

                        <!-- Second Banner: Customer Name and TAM -->
                        <div class="mar-customer-banner">
                            <h1 class="mar-customer-name" id="mar-customer-name">Customer Name</h1>
                            <div class="mar-tam-info">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <span>Technical Account Manager: <strong id="mar-tam-name">Adavayya Vastrad</strong></span>
                            </div>
                        </div>

                        <!-- KPI Cards -->
                        <div class="mar-kpi-grid">
                            <div class="mar-kpi-card" id="mar-card-sla">
                                <div class="mar-kpi-label">SLA Compliance</div>
                                <div class="mar-kpi-value" id="mar-sla-value">0%</div>
                                <div class="mar-kpi-sub" id="mar-sla-text">On Track</div>
                                <svg class="mar-kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="mar-kpi-card">
                                <div class="mar-kpi-label">CSAT Score</div>
                                <div class="mar-kpi-value" id="mar-csat-value">N/A</div>
                                <div class="mar-kpi-sub" style="color: #64748b; font-weight: 500;">
                                    <span id="mar-csat-count">0</span> Surveys
                                </div>
                                <svg class="mar-kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </div>
                            <div class="mar-kpi-card">
                                <div class="mar-kpi-label">Tickets Logged</div>
                                <div class="mar-kpi-value" id="mar-logged-value">0</div>
                                <div class="mar-kpi-sub" style="color: #64748b; font-weight: 500;">All Categories</div>
                                <svg class="mar-kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                </svg>
                            </div>
                            <div class="mar-kpi-card">
                                <div class="mar-kpi-label">Tickets Resolved</div>
                                <div class="mar-kpi-value" id="mar-resolved-value">0</div>
                                <div class="mar-kpi-sub" style="color: #64748b; font-weight: 500;">This Period</div>
                                <svg class="mar-kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>

                        <!-- Content Grid with Tables and Charts -->
                        <div class="mar-content-grid">
                            <div>
                                <div class="mar-section-header">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                    </svg>
                                    Ticket Volume Analysis
                                </div>
                                <table class="mar-table">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th class="mar-num">Open</th>
                                            <th class="mar-num">Logged</th>
                                            <th class="mar-num">Resolved</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Incident</td>
                                            <td class="mar-num" id="mar-inc-open">0</td>
                                            <td class="mar-num" id="mar-inc-logged">0</td>
                                            <td class="mar-num" id="mar-inc-resolved">0</td>
                                        </tr>
                                        <tr>
                                            <td>Service Req</td>
                                            <td class="mar-num" id="mar-sr-open">0</td>
                                            <td class="mar-num" id="mar-sr-logged">0</td>
                                            <td class="mar-num" id="mar-sr-resolved">0</td>
                                        </tr>
                                        <tr class="mar-row-total">
                                            <td>Total</td>
                                            <td class="mar-num" id="mar-total-open">0</td>
                                            <td class="mar-num" id="mar-total-logged">0</td>
                                            <td class="mar-num" id="mar-total-resolved">0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div>
                                <div class="mar-section-header">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Performance (Avg Days)
                                </div>
                                <table class="mar-table">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th class="mar-num">Incident</th>
                                            <th class="mar-num">SR</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Actual (24/7)</td>
                                            <td class="mar-num" id="mar-time-inc-247">0</td>
                                            <td class="mar-num" id="mar-time-sr-247">0</td>
                                        </tr>
                                        <tr>
                                            <td>SLA Target</td>
                                            <td class="mar-num" id="mar-time-inc-sla">0</td>
                                            <td class="mar-num" id="mar-time-sr-sla">0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="mar-charts-section">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="mar-chart-box">
                                        <div class="mar-section-header">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                            Overall Volume Trend (Logged vs Closed)
                                        </div>
                                        <div class="mar-chart-container">
                                            <canvas id="marOverallVolumeChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-12">
                                    <div class="mar-chart-box">
                                        <div class="mar-section-header">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                            </svg>
                                            Average Resolution Trend
                                        </div>
                                        <div class="mar-chart-container">
                                            <canvas id="marAvgResolutionChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-12">
                                    <div class="mar-chart-box">
                                        <div class="mar-section-header">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            SLA Compliance Trend
                                        </div>
                                        <div class="mar-chart-container">
                                            <canvas id="marSLAComplianceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Open Cases Overview -->
                        <div class="mar-open-cases-grid">
                            <div class="mar-open-cases-box">
                                <div class="mar-section-header" style="margin-bottom: 10px;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Open Cases Overview
                                </div>
                                <table class="mar-table">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th class="mar-num">Count</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Total Open Calls</td>
                                            <td class="mar-num" id="mar-total-open-cases">0</td>
                                            <td id="mar-open-cases-status">No Open Cases</td>
                                        </tr>
                                        <tr>
                                            <td>Incident (INC) Open</td>
                                            <td class="mar-num" id="mar-inc-open-cases">0</td>
                                            <td id="mar-inc-open-status">-</td>
                                        </tr>
                                        <tr>
                                            <td>Service Request (SR) Open</td>
                                            <td class="mar-num" id="mar-sr-open-cases">0</td>
                                            <td id="mar-sr-open-status">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="mar-bottom-section">
                            <footer class="mar-footer">
                                GENERATED BY SAPPHIREIMS CUSTOMER SUCCESS  MSP Support
                            </footer>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
        </div>
    </div>

    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border"></div>
        <div class="mt-2 fw-bold" style="color: var(--primary-color);">Processing data...</div>
    </div>

    <div class="modal fade" id="drillDownModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="drillDownTitle">Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge" style="background: var(--primary-color); font-size: 0.75rem;" id="drillDownCount">0 Cases</span>
                        <button class="btn btn-sm btn-success" onclick="exportDrillDownToExcel()">
                            <i class="bi bi-download me-1"></i> Export List
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-bordered drilldown-table compact-view">
                            <thead>
                                <tr id="drillDownHeader">
                                    <!-- Headers will be dynamically populated -->
                                </tr>
                            </thead>
                            <tbody id="drillDownBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="caseDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="caseDetailTitle">Case Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="case-detail-content">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let rawData = [];
        let processedData = [];
        let filteredData = [];
        let drillDownData = [];
        let drillDownTitleForExport = '';
        let drillDownExportData = [];
        let globalFilters = { owner: '', submittedby: '', service: '', status: '', sla: '', timescale: 'all' };
        let charts = {};
        let scorecardData = [];
        let currentView = 'list'; // 'list' or 'grid'
        let tabDataCache = {
            'actions': [],
            'cases': [],
            'sla': [],
            'aging': []
        };
        
        // Monthly Performance Variables
        let monthlyPerformanceData = {};
        let monthlyBreakdownData = {};

        // Column mapping for drill-downs - UPDATED for issues #1 and #2
        const drillDownColumns = {
            'totalClosed': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingDays', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'resolveTime', label: 'Resolution Date' }
            ],
            'closedSR': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingDays', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'resolveTime', label: 'Resolution Date' }
            ],
            'closedINC': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingDays', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'resolveTime', label: 'Resolution Date' }
            ],
            'openTotal': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingDays', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'openSR': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingDays', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'openINC': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingDays', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'slaSR': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'slaINC': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'fcr': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Resolution Time (Days)' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'incLess15': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'resolveTime', label: 'Resolution Date' }
            ],
            'incMore15': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'resolveTime', label: 'Resolution Date' }
            ],
            'srLess15': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'resolveTime', label: 'Resolution Date' }
            ],
            'srMore15': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'resolveTime', label: 'Resolution Date' }
            ],
            'subsequentSLA': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'updatePendingSupportCounter', label: 'Update Pending Counter' }
            ],
            'cpeCalls': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'correspondingInternalTicket', label: 'Corresponding Internal Ticket' }
            ],
            // New drilldown keys for compliance issues
            'slaCompliance': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'followupCompliance': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Follow-up Date' }
            ],
            'emailCompliance': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'emailCompliance', label: 'Email Compliance Status' }
            ],
            'edocCompliance': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'expectedResolution', label: 'Expected Resolution Date' }
            ],
            'subsequentSLAMiss': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'service', label: 'Service Type' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging (Days)' },
                { key: 'slaStatus', label: 'SLA Status' },
                { key: 'subsequentSLABreachCount', label: 'Subsequent SLA Miss Count' }
            ]
        };

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const uploadButton = dropArea.querySelector('button');

            uploadButton.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('click', () => fileInput.click());
            
            dropArea.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                dropArea.classList.add('dragover');
                dropArea.style.borderColor = 'var(--secondary-color)';
            });
            
            dropArea.addEventListener('dragleave', () => { 
                dropArea.classList.remove('dragover');
                dropArea.style.borderColor = 'var(--border-color)'; 
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                dropArea.style.borderColor = 'var(--border-color)';
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.onchange = (e) => { 
                if (e.target.files[0]) {
                    handleFileUpload(e.target.files[0]);
                }
            };
            
            // Repository file dropdown handler for GitHub Pages
            const repositoryFileSelect = document.getElementById('repository-file-select');
            const loadRepositoryFileBtn = document.getElementById('load-repository-file-btn');
            const repoStatus = document.getElementById('repo-status');
            
            // Check if we're running on a web server (http/https) or locally (file://)
            const isWebServer = window.location.protocol === 'http:' || window.location.protocol === 'https:';
            
            if (isWebServer) {
                repoStatus.textContent = 'Repository connected - Select a file from dropdown';
                repoStatus.style.color = 'var(--success-color)';
            } else {
                repoStatus.textContent = 'Local mode - Repository dropdown disabled. Use manual upload above.';
                repoStatus.style.color = 'var(--warning-color)';
                repositoryFileSelect.disabled = true;
            }
            
            if (repositoryFileSelect && loadRepositoryFileBtn) {
                // Enable/disable load button based on selection
                repositoryFileSelect.addEventListener('change', function() {
                    loadRepositoryFileBtn.disabled = !this.value || !isWebServer;
                });
                
                // Load selected repository file
                loadRepositoryFileBtn.addEventListener('click', function() {
                    const filePath = repositoryFileSelect.value;
                    if (!filePath) {
                        alert('Please select a file from the dropdown.');
                        return;
                    }
                    
                    if (!isWebServer) {
                        alert('Repository loading only works when hosted on a web server (like GitHub Pages).\nPlease use the manual upload option above.');
                        return;
                    }
                    
                    showLoading(true);
                    repoStatus.textContent = 'Loading file...';
                    
                    // Fetch the file from the repository
                    fetch(filePath)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`File not found: ${filePath}`);
                            }
                            return response.arrayBuffer();
                        })
                        .then(data => {
                            const arr = new Uint8Array(data);
                            const workbook = XLSX.read(arr, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const sheetData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            
                            if (!sheetData || sheetData.length < 2) {
                                throw new Error('The selected file is empty or has no valid data.');
                            }
                            
                            // Set file name for display
                            const fileName = filePath.split('/').pop();
                            document.getElementById('file-name').textContent = fileName;
                            document.getElementById('file-info').style.display = 'block';
                            
                            // Process data using the same function as manual upload
                            repoStatus.textContent = `Processing ${sheetData.length - 1} rows...`;
                            
                            // Call processExcelData to transform the data (same as manual upload)
                            processExcelData(sheetData);
                            
                            // The processExcelData function will handle everything and show dashboard automatically
                        })
                        .catch(error => {
                            console.error('Error loading repository file:', error);
                            repoStatus.textContent = ' Error loading file';
                            repoStatus.style.color = 'var(--danger-color)';
                            alert(`Error loading file: ${error.message}\n\nMake sure the file exists in the MSPData folder.`);
                            showLoading(false);
                        });
                });
            }

            document.getElementById('process-data-btn').onclick = processData;
            document.getElementById('clear-filters-btn').onclick = clearAllFilters;
            
            // Wire up PDF download buttons (both in banner and side panel if present)
            const pdfBtnBanner = document.getElementById('download-pdf-btn-banner');
            if (pdfBtnBanner) pdfBtnBanner.onclick = downloadDashboardPDF;
            
            const pdfBtnPanel = document.getElementById('download-pdf-btn');
            if (pdfBtnPanel) pdfBtnPanel.onclick = downloadDashboardPDF;

            // Set up filter event listeners
            document.getElementById('global-filter-service').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-owner').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-status').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-sla').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-submittedby').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-timescale').addEventListener('change', updateGlobalFilters);
            
            // Setup tab filter listeners
            setupTabFilterListeners();
            
            // Initialize monthly performance display
            updateMonthlyPerformance();
            updateMonthlyComparison();
            updateCategoryAnalysis();
            updateResolutionCodeAnalysis();
        }

        function setupTabFilterListeners() {
            // Only setup listeners for remaining tabs
            ['filter-service', 'filter-owner', 'filter-status'].forEach(id => {
                if(document.getElementById(id)) {
                    document.getElementById(id).addEventListener('change', () => {
                        if(id === 'filter-service' || id === 'filter-owner' || id === 'filter-status') {
                            filterCases();
                        }
                    });
                }
            });
        }

        function handleFileUpload(file) {
            const fileName = file.name;
            document.getElementById('file-name').textContent = fileName;
            document.getElementById('file-info').style.display = 'block';

            showLoading(true);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                if(fileName.endsWith('.csv')) {
                    parseCSV(e.target.result);
                } else {
                    parseExcel(e.target.result);
                }
            };
            
            if(fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseExcel(data) {
            try {
                const wb = XLSX.read(data, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                processExcelData(XLSX.utils.sheet_to_json(ws, { header: 1 }));
            } catch (error) {
                showLoading(false);
                alert("Error parsing Excel file: " + error.message);
                console.error("Excel parsing error:", error);
            }
        }

        function parseCSV(data) {
            try {
                processExcelData(data.split('\n').map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim())));
            } catch (error) {
                showLoading(false);
                alert("Error parsing CSV file: " + error.message);
                console.error("CSV parsing error:", error);
            }
        }

        function processExcelData(data) {
            if (!data || data.length < 2) {
                showLoading(false);
                alert("No data found or file format is incorrect.");
                return;
            }

            const headers = data[0].map(h => h ? h.toString().trim() : '');
            rawData = data.slice(1).map(row => {
                const rowObj = {};
                headers.forEach((header, index) => {
                    rowObj[header] = row[index];
                });
                return rowObj;
            }).filter(row => Object.values(row).some(v => v && v.toString().trim() !== ''));

            document.getElementById('row-count').textContent = `${rawData.length} rows loaded`;
            
            const parseNum = (val) => {
                if (val === null || val === undefined || val === '' || val === '--' || val === 'NULL') return 0;
                if (typeof val === 'string' && val.includes('Day(s)')) {
                    const dayMatch = val.match(/(\d+)\s*Day\(s\)/);
                    const hourMatch = val.match(/(\d+)\s*Hour\(s\)/);
                    const minMatch = val.match(/(\d+)\s*Min\(s\)/);
                    const days = dayMatch ? parseInt(dayMatch[1]) : 0;
                    const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
                    const mins = minMatch ? parseInt(minMatch[1]) : 0;
                    return days + (hours / 24) + (mins / 1440);
                }
                const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
                return isNaN(num) ? 0 : num;
            };
            
            const parseAgingDays = (val) => {
                const num = parseNum(val);
                return Math.round(num);
            };
            
            const isDateValid = (dStr) => {
                if (!dStr || dStr === '--' || dStr === 'NULL' || dStr === '0002-11-30 00:00' || dStr === 'Na' || dStr === 'NA') return false;
                const date = new Date(dStr);
                return !isNaN(date.getTime());
            };
            
            const isPastOrToday = (dStr) => {
                if (!isDateValid(dStr)) return false;
                const date = new Date(dStr);
                const today = new Date();
                date.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                return date <= today;
            };
            
            const findCol = (possibleNames) => {
                for (const name of possibleNames) {
                    const found = headers.find(h => h && h.toString().toLowerCase().includes(name.toLowerCase()));
                    if (found) return found;
                }
                return possibleNames[0];
            };

            const colMap = {
                // Column B is 'Request ID'
                incidentId: findCol(['Request ID', 'RequestID', 'Incident ID', 'Ticket ID', 'Case ID']),
                title: findCol(['Title', 'Subject', 'Description']),
                submittedBy: findCol(['Submitted By', 'SubmittedBy', 'Reporter']),
                currentStatus: findCol(['Current Status', 'CurrentStatus', 'Status', 'State']),
                service: findCol(['Service', 'Service Type', 'Type']),
                owner: findCol(['Request Owner', 'Owner', 'Assigned To', 'Engineer']),
                aging15Status: findCol(['Aging >15 days Status', 'Aging Status', 'Aging >15']),
                expectedResponseTime: findCol(['Expected Response Time', 'Response Time']),
                expectedResolutionTime: findCol(['Expected Resolution Time', 'Resolution Time']),
                expectedSLAClosureTime: findCol(['Expected SLA Closure Time', 'SLA Closure']),
                srEDOC: findCol(['SR EDOC', 'EDOC', 'Expected Date of Closure']),
                slaStatus: findCol(['SLA Violation Status', 'SLA Status', 'SLA']),
                slaViolationStatus: findCol(['SLA Violation Status', 'Violation Status']),
                agingRoundoff: findCol(['Aging (Roundoff)', 'Aging(Roundoff)', 'Aging', 'Age (Days)']),
                nextFollowUpDate: findCol(['Next Follow-up Date', 'Follow-up Date', 'Next Followup']),
                emailResponseCompliance: findCol(['Email Response Compliance', 'Email Compliance']),
                updatePendingSupportCounter: findCol(['Update Pending From Support Counter', 'Pending Counter']),
                ageingLastModified: findCol(['Ageing from Last modified time', 'Last Modified Aging']),
                steps: findCol(['Steps to be followed', 'Steps', 'Resolution Steps']),
                submissionTime: findCol(['Submission Time', 'Submission time', 'Created Date', 'Created Time']),
                resolveTime: findCol(['Resolve Time', 'Resolution Date', 'Closed Date']),
                correspondingInternalTicket: findCol(['Corresponding Internal Ticket', 'Internal Ticket', 'CPE Ticket']),
                supportCategory: findCol(['Support Category', 'SupportCategory', 'Category']),
                feature: findCol(['Feature', 'Product Feature']),
                subFeature: findCol(['Sub Feature', 'SubFeature', 'Sub-Feature']),
                tat247: findCol(['TAT (247)', 'TAT(247)', 'TAT (24/7)', 'TAT(24/7)', 'TAT(24//7)', 'TAT 24/7', 'TAT 24//7', 'TAT ( 24/7 )', 'TAT ( 24//7 )']),
                tatSLA: findCol(['TAT (SLA)', 'TAT(SLA)', 'TAT SLA', 'TAT( SLA )', 'TAT ( SLA )']),
                resolutionCode: findCol(['Resolution Code', 'ResolutionCode']),
                subResolutionCode: findCol(['Sub Resolution Code', 'SubResolutionCode']),
                problemStatement: findCol(['Problem Statement / Requirement', 'Problem Statement', 'Requirement']),
                resolutionSummary: findCol(['Resolution Summary (Steps)', 'Resolution Summary', 'Resolution Steps']),
                severityLevel: findCol(['Severity Level', 'Severity', 'Priority'])
            };

            processedData = rawData.map(row => {
                const service = row[colMap.service] || '';
                const slaViolationStatus = row[colMap.slaViolationStatus] || 'Non-Violated';
                const agingRoundoff = row[colMap.agingRoundoff] || '0';
                const aging15Status = row[colMap.aging15Status] || 'Non-Violated';
                const emailCompliance = row[colMap.emailResponseCompliance] || '';
                const srEDOC = row[colMap.srEDOC] || '';
                const nextFollowUp = row[colMap.nextFollowUpDate] || '';
                const expectedResponseTime = row[colMap.expectedResponseTime] || '';
                const submissionTime = row[colMap.submissionTime] || '';
                const resolveTime = row[colMap.resolveTime] || '';
                const correspondingInternalTicket = row[colMap.correspondingInternalTicket] || '';
                // Issue #1 & #2: Get the actual values from columns
                const incidentId = row[colMap.incidentId] || 'N/A';
                const slaStatus = row[colMap.slaStatus] || 'N/A';
                
                const agingDays = parseAgingDays(agingRoundoff);
                const subsequentSLACount = parseNum(row[colMap.updatePendingSupportCounter] || '0');
                const agingFromLastModified = parseNum(row[colMap.ageingLastModified] || '0');

                const isSR = service === 'Service Request';
                const isINC = service === 'Incident Management';
                const isSlaViolated = slaViolationStatus === 'Violated';
                const isAging15Violated = aging15Status === 'Violated';
                const isFollowUpMissed = (!isDateValid(nextFollowUp) || isPastOrToday(nextFollowUp));
                
                const isSubsequentResponseMissed = isDateValid(expectedResponseTime) && 
                                                   isPastOrToday(expectedResponseTime) && 
                                                   isINC;
                
                const isSubsequentSLABreach = subsequentSLACount > 0;
                const isEdocBreached = (isSR && isPastOrToday(srEDOC));
                const isOldest25 = agingDays > 25;
                const isIdle1 = agingFromLastModified > 0;
                const isIdle3 = agingFromLastModified > 1;
                
                // Determine if case is closed - FIXED: Check for specific statuses
                const isClosed = row[colMap.currentStatus] === 'Close' || 
                                row[colMap.currentStatus] === 'Resolve - Pending User Confirmation';
                
                // Parse submission date for monthly analysis
                const submissionDate = isDateValid(submissionTime) ? new Date(submissionTime) : new Date();
                const monthYear = `${submissionDate.getMonth()+1}-${submissionDate.getFullYear()}`;

                return {
                    incidentId: incidentId,
                    slaStatus: slaStatus,
                    owner: row[colMap.owner] || 'Unassigned',
                    title: row[colMap.title] || 'No Title',
                    currentStatus: row[colMap.currentStatus] || 'Unknown',
                    service: service,
                    submittedBy: row[colMap.submittedBy] || 'Unknown',
                    agingDays: agingDays,
                    agingFromLastModified: agingFromLastModified,
                    slaViolationStatus: slaViolationStatus,
                    nextFollowUp: nextFollowUp,
                    subsequentResponse: expectedResponseTime,
                    emailCompliance: emailCompliance,
                    expectedResolution: srEDOC,
                    subsequentSLABreachCount: subsequentSLACount,
                    submissionDate: submissionDate,
                    monthYear: monthYear,
                    isClosed: isClosed,
                    resolveTime: resolveTime,
                    correspondingInternalTicket: correspondingInternalTicket,
                    supportCategory: row[colMap.supportCategory] || 'Uncategorized',
                    feature: row[colMap.feature] || 'N/A',
                    subFeature: row[colMap.subFeature] || 'N/A',
                    tat247: parseNum(row[colMap.tat247] || '0'),
                    tatSLA: parseNum(row[colMap.tatSLA] || '0'),
                    resolutionCode: row[colMap.resolutionCode] || 'N/A',
                    subResolutionCode: row[colMap.subResolutionCode] || 'N/A',
                    problemStatement: row[colMap.problemStatement] || '',
                    resolutionSummary: row[colMap.resolutionSummary] || '',
                    severityLevel: row[colMap.severityLevel] || '',
                    
                    // For drill-down exports
                    aging15Status: aging15Status,
                    agingRoundoff: agingRoundoff,
                    expectedResponseTime: expectedResponseTime,
                    updatePendingSupportCounter: row[colMap.updatePendingSupportCounter] || '0',
                    ageingLastModified: row[colMap.ageingLastModified] || '0',
                    
                    isSR,
                    isINC,
                    isSlaViolated,
                    isAging15Violated,
                    isFollowUpMissed,
                    isSubsequentResponseMissed,
                    isSubsequentSLABreach,
                    isEdocBreached,
                    isOldest25,
                    isIdle1,
                    isIdle3,
                    
                    _raw: row
                };
            });

            // Debug: Check if TAT columns are being read
            console.log('Column Mapping - TAT247:', colMap.tat247);
            console.log('Column Mapping - TATSLA:', colMap.tatSLA);
            console.log('Sample TAT values from first 3 rows:');
            processedData.slice(0, 3).forEach((d, i) => {
                console.log(`Row ${i}: tat247=${d.tat247}, tatSLA=${d.tatSLA}, isClosed=${d.isClosed}, service=${d.service}`);
            });

            filteredData = [...processedData];
            showLoading(false);
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('total-cases').textContent = `${processedData.length} Cases Loaded`;
            document.getElementById('last-updated').textContent = `Last Updated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;

            populateFilterDropdowns();
            updateDashboard();
            
            // Initialize monthly performance
            updateMonthlyPerformance();
            updateMonthlyComparison();
            updateCategoryAnalysis();
            updateResolutionCodeAnalysis();
        }

        function populateFilterDropdowns() {
            const getUniqueValues = (key) => [...new Set(processedData.map(d => d[key]).filter(Boolean).sort())];

            const dropdowns = {
                'global-filter-owner': getUniqueValues('owner'),
                'global-filter-submittedby': getUniqueValues('submittedBy'),
                'global-filter-service': getUniqueValues('service'),
                'global-filter-status': getUniqueValues('currentStatus'),
                'filter-owner': getUniqueValues('owner'),
                'filter-service': getUniqueValues('service'),
                'filter-status': getUniqueValues('currentStatus')
            };

            for (const id in dropdowns) {
                const select = document.getElementById(id);
                if (select) {
                    const originalValue = select.value;
                    const label = id.split('-').pop();
                    const labelText = label === 'owner' ? 'Owners' : 
                                   label === 'service' ? 'Service Types' : 
                                   label === 'status' ? 'Statuses' : 
                                   label === 'submittedby' ? 'Submitted By' :
                                   'Options';
                    
                    select.innerHTML = `<option value="">All ${labelText}</option>`;
                    dropdowns[id].forEach(value => {
                        select.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                    if (originalValue && dropdowns[id].includes(originalValue)) {
                        select.value = originalValue;
                    }
                }
            }
        }

        function getTimescaleDateRange(timescaleValue) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed
            
            let startDate = null;
            let endDate = null;
            
            switch(timescaleValue) {
                case 'all':
                    return { startDate: null, endDate: null }; // No filtering
                    
                case 'current-month':
                    startDate = new Date(currentYear, currentMonth, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0); // Last day of current month
                    break;
                    
                case 'last-month':
                    startDate = new Date(currentYear, currentMonth - 1, 1);
                    endDate = new Date(currentYear, currentMonth, 0); // Last day of last month
                    break;
                    
                case 'last-month-include-current':
                    startDate = new Date(currentYear, currentMonth - 1, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-2-months':
                    startDate = new Date(currentYear, currentMonth - 2, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-2-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 2, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-3-months':
                    startDate = new Date(currentYear, currentMonth - 3, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-3-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 3, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-4-months':
                    startDate = new Date(currentYear, currentMonth - 4, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-4-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 4, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-5-months':
                    startDate = new Date(currentYear, currentMonth - 5, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-5-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 5, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-6-months':
                    startDate = new Date(currentYear, currentMonth - 6, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-6-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 6, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-7-months':
                    startDate = new Date(currentYear, currentMonth - 7, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-7-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 7, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-8-months':
                    startDate = new Date(currentYear, currentMonth - 8, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-8-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 8, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-9-months':
                    startDate = new Date(currentYear, currentMonth - 9, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-9-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 9, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-10-months':
                    startDate = new Date(currentYear, currentMonth - 10, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-10-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 10, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'last-11-months':
                    startDate = new Date(currentYear, currentMonth - 11, 1);
                    endDate = new Date(currentYear, currentMonth, 0);
                    break;
                    
                case 'last-11-months-include-current':
                    startDate = new Date(currentYear, currentMonth - 11, 1);
                    endDate = new Date(currentYear, currentMonth + 1, 0);
                    break;
                    
                case 'current-year':
                    startDate = new Date(currentYear, 0, 1); // Jan 1 of current year
                    endDate = new Date(currentYear, 11, 31); // Dec 31 of current year
                    break;
                    
                case 'last-year':
                    startDate = new Date(currentYear - 1, 0, 1); // Jan 1 of last year
                    endDate = new Date(currentYear - 1, 11, 31); // Dec 31 of last year
                    break;
                    
                default:
                    return { startDate: null, endDate: null };
            }
            
            return { startDate, endDate };
        }
        
        function updateGlobalFilters() {
            showLoading(true);
            
            globalFilters.owner = document.getElementById('global-filter-owner').value;
            globalFilters.submittedby = document.getElementById('global-filter-submittedby').value;
            globalFilters.service = document.getElementById('global-filter-service').value;
            globalFilters.status = document.getElementById('global-filter-status').value;
            globalFilters.sla = document.getElementById('global-filter-sla').value;
            globalFilters.timescale = document.getElementById('global-filter-timescale').value;
            
            // Get date range for timescale filter
            const { startDate, endDate } = getTimescaleDateRange(globalFilters.timescale);
            
            // Debug logging for timescale
            if (startDate && endDate) {
                console.log('Timescale Filter Active:', globalFilters.timescale);
                console.log('Date Range:', startDate.toLocaleDateString(), 'to', endDate.toLocaleDateString());
            }

            // Filter by global filters
            filteredData = processedData.filter(d => {
                if (globalFilters.owner && d.owner !== globalFilters.owner) return false;
                if (globalFilters.submittedby && d.submittedBy !== globalFilters.submittedby) return false;
                if (globalFilters.service && d.service !== globalFilters.service) return false;
                if (globalFilters.status && d.currentStatus !== globalFilters.status) return false;
                if (globalFilters.sla === 'Violated' && !d.isSlaViolated) return false;
                if (globalFilters.sla === 'Non-Violated' && d.isSlaViolated) return false;
                
                // Timescale filtering - compare only dates, ignore time
                if (startDate && endDate && d.submissionDate) {
                    // Create date-only versions (set time to midnight for accurate comparison)
                    const caseDateOnly = new Date(d.submissionDate.getFullYear(), d.submissionDate.getMonth(), d.submissionDate.getDate());
                    const startDateOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    const endDateOnly = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
                    
                    if (caseDateOnly < startDateOnly || caseDateOnly > endDateOnly) return false;
                }
                
                return true;
            });
            
            // Debug: Show how many cases matched the filter
            console.log(`Filtered ${filteredData.length} cases out of ${processedData.length} total cases`);

            updateActiveFiltersDisplay();
            
            updateDashboard();
            
            // Update monthly performance with current filters
            updateMonthlyPerformance();
            updateMonthlyComparison();
            updateCategoryAnalysis();
            updateResolutionCodeAnalysis();
            
            // Update Monthly Accounts Review
            loadMonthlyAccountsReview();
            
            // Auto-hide filters after applying
            const content = document.getElementById('global-filters-content');
            const button = document.getElementById('filters-toggle-btn');
            const buttonText = document.getElementById('filter-toggle-text');
            if (content && content.classList.contains('show')) {
                setTimeout(() => {
                    content.classList.remove('show');
                    button.classList.remove('active');
                    buttonText.textContent = 'Show Filters';
                }, 300);
            }
            
            showLoading(false);
        }

        function updateActiveFiltersDisplay() {
            const activeFilters = [];
            if (globalFilters.owner) activeFilters.push({key: 'owner', label: 'Owner', value: globalFilters.owner});
            if (globalFilters.submittedby) activeFilters.push({key: 'submittedby', label: 'Submitted By', value: globalFilters.submittedby});
            if (globalFilters.service) activeFilters.push({key: 'service', label: 'Service Type', value: globalFilters.service});
            if (globalFilters.status) activeFilters.push({key: 'status', label: 'Status', value: globalFilters.status});
            if (globalFilters.sla) activeFilters.push({key: 'sla', label: 'SLA Status', value: globalFilters.sla});
            if (globalFilters.timescale && globalFilters.timescale !== 'all') {
                // Format the timescale display text
                const timescaleText = document.getElementById('global-filter-timescale').selectedOptions[0].text;
                activeFilters.push({key: 'timescale', label: 'Timescale', value: timescaleText});
            }

            const activeFiltersTags = document.getElementById('active-filters-tags');
            const activeFiltersCount = document.getElementById('active-filters-count');
            const filteredCasesCount = document.getElementById('filtered-cases-count');

            if (activeFilters.length > 0) {
                activeFiltersTags.innerHTML = activeFilters.map(filter => `
                    <div class="filter-tag">
                        <i class="bi bi-funnel"></i>
                        ${filter.label}: ${filter.value}
                        <span class="close" onclick="removeFilter('${filter.key}')">&times;</span>
                    </div>
                `).join('');
                activeFiltersTags.style.display = 'flex';
            } else {
                activeFiltersTags.style.display = 'none';
            }

            activeFiltersCount.textContent = `${activeFilters.length} filter${activeFilters.length !== 1 ? 's' : ''} active`;
            filteredCasesCount.textContent = `Showing ${filteredData.length} of ${processedData.length} cases`;
        }

        function removeFilter(filterKey) {
            document.getElementById(`global-filter-${filterKey}`).value = '';
            updateGlobalFilters();
        }

        function clearAllFilters() {
            document.getElementById('global-filter-owner').value = '';
            document.getElementById('global-filter-submittedby').value = '';
            document.getElementById('global-filter-service').value = '';
            document.getElementById('global-filter-status').value = '';
            document.getElementById('global-filter-sla').value = '';
            document.getElementById('global-filter-timescale').value = 'all';
            
            globalFilters.owner = '';
            globalFilters.submittedby = '';
            globalFilters.service = '';
            globalFilters.status = '';
            globalFilters.sla = '';
            globalFilters.timescale = 'all';
            
            filteredData = [...processedData];
            
            updateActiveFiltersDisplay();
            updateDashboard();
            
            // Update monthly performance
            updateMonthlyPerformance();
            updateMonthlyComparison();
            updateCategoryAnalysis();
            updateResolutionCodeAnalysis();
        }

        function updateOwnerFilter(owner) {
            document.getElementById('global-filter-owner').value = owner;
            updateGlobalFilters();
        }

        function updateCard(kpiId, value, recommendation) {
            document.getElementById(kpiId).textContent = value;
            document.getElementById(`${kpiId}-tag`).textContent = recommendation.status;
            document.getElementById(`${kpiId}-tag`).className = `kpi-status-tag ${recommendation.tag}`;
            document.getElementById(`${kpiId}-rec`).textContent = recommendation.rec;
            
            const card = document.getElementById(`${kpiId}-card`);
            card.onclick = function() {
                let drillDownKey;
                switch(kpiId) {
                    // Section 1: Overall Case Volume
                    case 'kpi-total-closed': drillDownKey = 'totalClosed'; break;
                    case 'kpi-closed-sr': drillDownKey = 'closedSR'; break;
                    case 'kpi-closed-inc': drillDownKey = 'closedINC'; break;
                    
                    // Section 2: Outstanding Open Cases
                    case 'kpi-open-total': drillDownKey = 'openTotal'; break;
                    case 'kpi-open-sr': drillDownKey = 'openSR'; break;
                    case 'kpi-open-inc': drillDownKey = 'openINC'; break;
                    
                    // Section 3: SLA Compliance
                    case 'kpi-overall-sla': drillDownKey = 'slaViolated'; break;
                    case 'kpi-sr-sla-compliance': drillDownKey = 'slaSR'; break;
                    case 'kpi-inc-sla-compliance': drillDownKey = 'slaINC'; break;
                    case 'kpi-sla-sr': drillDownKey = 'slaSR'; break;
                    case 'kpi-sla-inc': drillDownKey = 'slaINC'; break;
                    case 'kpi-edoc': drillDownKey = 'edocBreach'; break;
                    case 'kpi-subsequent-sla': drillDownKey = 'subsequentSLA'; break;
                    case 'kpi-cpe-calls': drillDownKey = 'cpeCalls'; break;
                    
                    // Section 4: Closure Aging
                    case 'kpi-fcr': drillDownKey = 'fcr'; break;
                    case 'kpi-inc-less15': drillDownKey = 'incLess15'; break;
                    case 'kpi-inc-more15': drillDownKey = 'incMore15'; break;
                    case 'kpi-sr-less15': drillDownKey = 'srLess15'; break;
                    case 'kpi-sr-more15': drillDownKey = 'srMore15'; break;
                    
                    default: drillDownKey = 'totalOpen';
                }
                openDrillDown(drillDownKey, recommendation.status);
            };
        }

        function updateDashboard() {
            // Check if filteredData is empty due to filters
            if (filteredData.length === 0 && processedData.length > 0) {
                // Show message about no data for selected filters
                document.getElementById('owner-scorecard-body').innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center text-muted py-4">
                            <i class="bi bi-funnel text-warning" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">No records found for current filters</h6>
                            <p class="small">Try adjusting your filter settings or clear all filters.</p>
                        </td>
                    </tr>
                `;
                
                // Update KPI cards to show 0
                document.querySelectorAll('.kpi-value').forEach(el => el.textContent = '0');
                document.querySelectorAll('.kpi-status-tag').forEach(el => {
                    el.textContent = 'METRIC';
                    el.className = 'kpi-status-tag bg-metric';
                });
                document.querySelectorAll('.kpi-recommendation').forEach(el => {
                    el.textContent = 'No data available for selected filters.';
                });
                
                // Update performance view metrics
                document.getElementById('total-closed-cases').textContent = '0';
                document.getElementById('overall-sla-rate').textContent = '0%';
                document.getElementById('fcr-rate').textContent = '0%';
                document.getElementById('cpe-calls-metric').textContent = '0';
                
                return;
            }
            
            renderKPIDashboard();
            renderPerformanceView();
            updateDataLoadPeriod();
            updateFilterStatus();
            initializeMonthlyAccountsReview(); // Initialize Monthly Accounts Review dropdown
        }

        function updateDataLoadPeriod() {
            const dates = rawData
                .map(row => {
                    // Get submission time from column - check various possible column names
                    const submissionTime = row['Submission Time'] || row['Submission time'] || 
                                         row['Created Date'] || row['Created Time'] || 
                                         row['SubmissionTime'] || row['CreatedDate'];
                    if (submissionTime && submissionTime !== '--' && submissionTime !== 'NULL') {
                        const date = new Date(submissionTime);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    return null;
                })
                .filter(d => d !== null)
                .sort((a, b) => a - b);
            
            if (dates.length > 0) {
                const minDate = dates[0];
                const maxDate = dates[dates.length - 1];
                
                const formatDate = (date) => {
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${monthNames[date.getMonth()]}-${date.getFullYear()}`;
                };
                
                const periodText = `${formatDate(minDate)} to ${formatDate(maxDate)}`;
                document.getElementById('dataLoadPeriod').textContent = periodText;
            } else {
                document.getElementById('dataLoadPeriod').textContent = 'No Date Range Available';
            }
        }

        function updateFilterStatus() {
            const ownerFilter = globalFilters.owner;
            const submittedByFilter = globalFilters.submittedby;
            const filterStatusElement = document.getElementById('filterStatus');
            
            let statusText = '';
            
            if (ownerFilter || submittedByFilter) {
                const parts = [];
                
                if (ownerFilter) {
                    parts.push(`Owner: <strong>${ownerFilter}</strong>`);
                }
                
                if (submittedByFilter) {
                    parts.push(`Account/Customer: <strong>${submittedByFilter}</strong>`);
                }
                
                statusText = '<i class="bi bi-funnel-fill"></i> <span>Reviewing ' + parts.join(' | ') + '</span>';
            } else {
                statusText = '<i class="bi bi-funnel"></i> <span>Reviewing Over All Owners and Accounts/Customers</span>';
            }
            
            filterStatusElement.innerHTML = statusText;
        }

        function toggleFilterPanel() {
            const panel = document.getElementById('filter-side-panel');
            const overlay = document.getElementById('filter-panel-overlay');
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                overlay.classList.remove('show');
            } else {
                panel.classList.add('open');
                overlay.classList.add('show');
            }
        }

        function renderKPIDashboard() {
            if (!filteredData.length) {
                document.getElementById('owner-scorecard-body').innerHTML = '<tr><td colspan="14" class="text-center text-muted py-3">No data found for selected filters.</td></tr>';
                return;
            }

            // Section 1: Overall Case Volume
            const closedSR = filteredData.filter(d => d.isClosed && d.isSR).length;
            const closedINC = filteredData.filter(d => d.isClosed && d.isINC).length;
            const totalClosed = closedSR + closedINC;
            
            // Section 2: Outstanding Open Cases
            const openSR = filteredData.filter(d => !d.isClosed && d.isSR).length;
            const openINC = filteredData.filter(d => !d.isClosed && d.isINC).length;
            const totalOpen = openSR + openINC;

            // Section 3: SLA Compliance
            const totalCases = filteredData.length;
            const slaViolatedSR = filteredData.filter(d => d.isSlaViolated && d.isSR).length;
            const slaViolatedINC = filteredData.filter(d => d.isSlaViolated && d.isINC).length;
            const totalSlaViolated = slaViolatedSR + slaViolatedINC;
            const overallSLA = totalCases > 0 ? (((totalCases - totalSlaViolated) / totalCases) * 100).toFixed(1) : 100;
            
            // Calculate SR and INC SLA Compliance percentages
            const totalSR = filteredData.filter(d => d.isSR).length;
            const totalINC = filteredData.filter(d => d.isINC).length;
            const srSLACompliance = totalSR > 0 ? (((totalSR - slaViolatedSR) / totalSR) * 100).toFixed(1) : 100;
            const incSLACompliance = totalINC > 0 ? (((totalINC - slaViolatedINC) / totalINC) * 100).toFixed(1) : 100;
            
            // Fix for subsequent SLA miss - check if closed and subsequentSLABreachCount > 0
            const subsequentSLAMiss = filteredData.filter(d => d.isClosed && d.subsequentSLABreachCount > 0).length;
            
            // Fix for CPE calls - check if correspondingInternalTicket is not empty
            const cpeCalls = filteredData.filter(d => {
                const ticket = d.correspondingInternalTicket;
                return ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0';
            }).length;
            
            // SR EDOC Breach count
            const edocBreach = filteredData.filter(d => d.isSR && d.isEdocBreached).length;

            // Section 4: Closure Aging
            const fcr = filteredData.filter(d => d.isClosed && d.agingDays < 2).length;
            const incLess15 = filteredData.filter(d => d.isClosed && d.isINC && d.agingDays < 15).length;
            const incMore15 = filteredData.filter(d => d.isClosed && d.isINC && d.agingDays >= 15).length;
            const srLess15 = filteredData.filter(d => d.isClosed && d.isSR && d.agingDays < 15).length;
            const srMore15 = filteredData.filter(d => d.isClosed && d.isSR && d.agingDays >= 15).length;

            // Update Section 1 cards
            const totalClosedRec = { status: 'METRIC', tag: 'bg-metric', rec: `Total closed cases: ${totalClosed} (SR: ${closedSR}, INC: ${closedINC})` };
            const closedSRRec = { status: 'METRIC', tag: 'bg-metric', rec: `Closed Service Requests: ${closedSR}` };
            const closedINCRec = { status: 'METRIC', tag: 'bg-metric', rec: `Closed Incident Management cases: ${closedINC}` };

            updateCard('kpi-total-closed', totalClosed, totalClosedRec);
            updateCard('kpi-closed-sr', closedSR, closedSRRec);
            updateCard('kpi-closed-inc', closedINC, closedINCRec);

            // Update Section 2 cards
            const openTotalRec = { status: 'METRIC', tag: 'bg-metric', rec: `Total open cases: ${totalOpen} (SR: ${openSR}, INC: ${openINC})` };
            const openSRRec = { status: 'METRIC', tag: 'bg-metric', rec: `Open Service Requests: ${openSR}` };
            const openINCRec = { status: 'METRIC', tag: 'bg-metric', rec: `Open Incident Management cases: ${openINC}` };

            updateCard('kpi-open-total', totalOpen, openTotalRec);
            updateCard('kpi-open-sr', openSR, openSRRec);
            updateCard('kpi-open-inc', openINC, openINCRec);

            // Section 3 recommendations
            let overallSLARec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `Overall SLA Compliance: ${overallSLA}%` };
            if (parseFloat(overallSLA) < 95) overallSLARec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `SLA compliance below 95% (${overallSLA}%). Review violations.` };
            if (parseFloat(overallSLA) < 80) overallSLARec = { status: 'BELOW TARGET', tag: 'bg-below-target', rec: `CRITICAL: SLA compliance below 80% (${overallSLA}%). Immediate action required.` };

            let slaSRRec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `SLA Violated SR: ${slaViolatedSR}` };
            if (slaViolatedSR > 0) slaSRRec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `${slaViolatedSR} SR cases with SLA violations.` };
            if (slaViolatedSR > 5) slaSRRec = { status: 'BELOW TARGET', tag: 'bg-below-target', rec: `CRITICAL: ${slaViolatedSR} SR cases with SLA violations. Immediate action required.` };

            let slaINCRec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `SLA Violated INC: ${slaViolatedINC}` };
            if (slaViolatedINC > 0) slaINCRec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `${slaViolatedINC} INC cases with SLA violations.` };
            if (slaViolatedINC > 5) slaINCRec = { status: 'BELOW TARGET', tag: 'bg-below-target', rec: `CRITICAL: ${slaViolatedINC} INC cases with SLA violations. Immediate action required.` };

            let subsequentSLARec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `Subsequent SLA Miss: ${subsequentSLAMiss}` };
            if (subsequentSLAMiss > 0) subsequentSLARec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `${subsequentSLAMiss} closed cases with subsequent SLA misses.` };

            let cpeCallsRec = { status: 'METRIC', tag: 'bg-metric', rec: `Number of CPE Calls: ${cpeCalls}` };
            
            // New SR and INC SLA Compliance recommendations
            let srSLAComplianceRec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `SR SLA Compliance: ${srSLACompliance}%` };
            if (parseFloat(srSLACompliance) < 95) srSLAComplianceRec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `SR SLA compliance below 95% (${srSLACompliance}%). Review violations.` };
            if (parseFloat(srSLACompliance) < 80) srSLAComplianceRec = { status: 'BELOW TARGET', tag: 'bg-below-target', rec: `SR SLA compliance below 80% (${srSLACompliance}%).` };
            
            let incSLAComplianceRec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `INC SLA Compliance: ${incSLACompliance}%` };
            if (parseFloat(incSLACompliance) < 95) incSLAComplianceRec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `INC SLA compliance below 95% (${incSLACompliance}%). Review violations.` };
            if (parseFloat(incSLACompliance) < 80) incSLAComplianceRec = { status: 'BELOW TARGET', tag: 'bg-below-target', rec: `INC SLA compliance below 80% (${incSLACompliance}%).` };
            
            // EDOC Breach recommendation
            let edocRec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `SR EDOC Breach: ${edocBreach} cases` };
            if (edocBreach > 0) edocRec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `${edocBreach} SR cases breached Expected Date of Closure.` };
            if (edocBreach > 5) edocRec = { status: 'BELOW TARGET', tag: 'bg-below-target', rec: `CRITICAL: ${edocBreach} SR cases breached EDOC.` };

            // Update Section 3 cards
            updateCard('kpi-overall-sla', overallSLA + '%', overallSLARec);
            updateCard('kpi-sr-sla-compliance', srSLACompliance + '%', srSLAComplianceRec);
            updateCard('kpi-inc-sla-compliance', incSLACompliance + '%', incSLAComplianceRec);
            updateCard('kpi-sla-sr', slaViolatedSR, slaSRRec);
            updateCard('kpi-sla-inc', slaViolatedINC, slaINCRec);
            updateCard('kpi-edoc', edocBreach, edocRec);
            updateCard('kpi-subsequent-sla', subsequentSLAMiss, subsequentSLARec);
            updateCard('kpi-cpe-calls', cpeCalls, cpeCallsRec);

            // Section 4 recommendations
            let fcrRec = { status: 'ON TRACK', tag: 'bg-on-track', rec: `First Contact Resolution: ${fcr} cases resolved within 2 days.` };
            if (fcr === 0 && totalClosed > 0) fcrRec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: 'No cases resolved within 2 days. Review resolution process.' };

            let incLess15Rec = { status: 'METRIC', tag: 'bg-metric', rec: `Closed INC cases aged <15 days: ${incLess15}` };
            let incMore15Rec = { status: 'METRIC', tag: 'bg-metric', rec: `Closed INC cases aged >15 days: ${incMore15}` };
            if (incMore15 > 0) incMore15Rec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `${incMore15} INC cases took more than 15 days to close.` };

            let srLess15Rec = { status: 'METRIC', tag: 'bg-metric', rec: `Closed SR cases aged <15 days: ${srLess15}` };
            let srMore15Rec = { status: 'METRIC', tag: 'bg-metric', rec: `Closed SR cases aged >15 days: ${srMore15}` };
            if (srMore15 > 0) srMore15Rec = { status: 'NEEDS ATTENTION', tag: 'bg-needs-attention', rec: `${srMore15} SR cases took more than 15 days to close.` };

            // Update Section 4 cards
            updateCard('kpi-fcr', fcr, fcrRec);
            updateCard('kpi-inc-less15', incLess15, incLess15Rec);
            updateCard('kpi-inc-more15', incMore15, incMore15Rec);
            updateCard('kpi-sr-less15', srLess15, srLess15Rec);
            updateCard('kpi-sr-more15', srMore15, srMore15Rec);
            
            updateSectionRAGStatus(1, [totalClosedRec, closedSRRec, closedINCRec]);
            updateSectionRAGStatus(2, [openTotalRec, openSRRec, openINCRec]);
            updateSectionRAGStatus(3, [overallSLARec, srSLAComplianceRec, incSLAComplianceRec, slaSRRec, slaINCRec, edocRec, subsequentSLARec, cpeCallsRec]);
            updateSectionRAGStatus(4, [fcrRec, incLess15Rec, incMore15Rec, srLess15Rec, srMore15Rec]);
            
            renderOwnerScorecard();
        }

        function updateSectionRAGStatus(sectionNumber, cardRecommendations) {
            const sectionElement = document.getElementById(`accordion-section-${sectionNumber}`);
            if (!sectionElement) return;
            
            let overallStatus = 'good';
            
            for (const rec of cardRecommendations) {
                if (rec.status === 'BELOW TARGET' || rec.status === 'URGENT') {
                    overallStatus = 'danger';
                    break;
                } else if ((rec.status === 'NEEDS ATTENTION' || rec.status === 'ACTION NEEDED' || rec.status === 'MONITOR') && overallStatus !== 'danger') {
                    overallStatus = 'warning';
                } else if (rec.status === 'METRIC' && overallStatus === 'good') {
                    overallStatus = 'info';
                } else if (rec.status === 'INFO' && overallStatus === 'good') {
                    overallStatus = 'info';
                }
            }
            
            sectionElement.classList.remove('good', 'warning', 'danger', 'info');
            sectionElement.classList.add(overallStatus);
        }

        function renderOwnerScorecard() {
            const counts = {};
            filteredData.forEach(d => {
                if(!counts[d.owner]) counts[d.owner] = { 
                    total: 0,
                    closed: 0,
                    closedSR: 0,
                    closedINC: 0,
                    open: 0,
                    openSR: 0,
                    openINC: 0,
                    violations: 0,
                    slaSR: 0,
                    slaINC: 0,
                    fcr: 0,
                    subsequentSLA: 0,
                    cpeCalls: 0
                };
                counts[d.owner].total++;
                if(d.isClosed) {
                    counts[d.owner].closed++;
                    if(d.isSR) counts[d.owner].closedSR++;
                    if(d.isINC) counts[d.owner].closedINC++;
                    if(d.agingDays < 2) counts[d.owner].fcr++;
                    if(d.subsequentSLABreachCount > 0) counts[d.owner].subsequentSLA++;
                } else {
                    counts[d.owner].open++;
                    if(d.isSR) counts[d.owner].openSR++;
                    if(d.isINC) counts[d.owner].openINC++;
                }
                if(d.isSlaViolated) counts[d.owner].violations++;
                if(d.isSR && d.isSlaViolated) counts[d.owner].slaSR++;
                if(d.isINC && d.isSlaViolated) counts[d.owner].slaINC++;
                
                // Fix for CPE calls
                const ticket = d.correspondingInternalTicket;
                if (ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0') {
                    counts[d.owner].cpeCalls++;
                }
            });

            scorecardData = [];
            const scorecardHtml = Object.keys(counts).sort().map(o => {
                const stats = counts[o];
                const complianceRate = stats.total > 0 ? (((stats.total - stats.violations) / stats.total) * 100).toFixed(1) : 100.0;

                scorecardData.push({
                    'Owner': o,
                    'Overall SLA %': complianceRate,
                    'Total Closed Cases': stats.closed,
                    'Closed SR': stats.closedSR,
                    'Closed INC': stats.closedINC,
                    'Total Open Cases': stats.open,
                    'Open SR': stats.openSR,
                    'Open INC': stats.openINC,
                    'SLA Viol.  SR': stats.slaSR,
                    'SLA Viol.  INC': stats.slaINC,
                    'FCR': stats.fcr,
                    'Subsequent SLA Miss': stats.subsequentSLA,
                    'CPE Calls': stats.cpeCalls
                });

                return `
                    <tr class="align-middle" onclick="updateOwnerFilter('${o}')" style="cursor: pointer;">
                        <td class="fw-bold">${o}</td>
                        <td class="${complianceRate < 80 ? 'critical-cell' : complianceRate < 95 ? 'high-cell' : 'success-cell'} fw-bold">${complianceRate}%</td>
                        <td>${stats.closed}</td>
                        <td>${stats.closedSR}</td>
                        <td>${stats.closedINC}</td>
                        <td>${stats.open}</td>
                        <td>${stats.openSR}</td>
                        <td>${stats.openINC}</td>
                        <td class="${stats.slaSR > 0 ? 'critical-cell' : ''}">${stats.slaSR}</td>
                        <td class="${stats.slaINC > 0 ? 'critical-cell' : ''}">${stats.slaINC}</td>
                        <td class="${stats.fcr > 0 ? 'success-cell' : ''}">${stats.fcr}</td>
                        <td class="${stats.subsequentSLA > 0 ? 'critical-cell' : ''}">${stats.subsequentSLA}</td>
                        <td class="${stats.cpeCalls > 0 ? 'high-cell' : ''}">${stats.cpeCalls}</td>
                        <td>
                            <div class="progress compliance-gauge">
                                <div class="progress-bar ${complianceRate < 80 ? 'bg-danger' : complianceRate < 95 ? 'bg-warning' : 'bg-success'}" role="progressbar" style="width: ${complianceRate}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('owner-scorecard-body').innerHTML = scorecardHtml || '<tr><td colspan="14" class="text-center text-muted py-3">No data found for selected filters.</td></tr>';
        }

        function openDrillDown(kpi, title) {
            drillDownTitleForExport = title;
            document.getElementById('drillDownTitle').textContent = title;

            switch(kpi) {
                // Section 1
                case 'totalClosed':
                    drillDownData = filteredData.filter(d => d.isClosed);
                    break;
                case 'closedSR':
                    drillDownData = filteredData.filter(d => d.isClosed && d.isSR);
                    break;
                case 'closedINC':
                    drillDownData = filteredData.filter(d => d.isClosed && d.isINC);
                    break;
                    
                // Section 2
                case 'openTotal':
                    drillDownData = filteredData.filter(d => !d.isClosed);
                    break;
                case 'openSR':
                    drillDownData = filteredData.filter(d => !d.isClosed && d.isSR);
                    break;
                case 'openINC':
                    drillDownData = filteredData.filter(d => !d.isClosed && d.isINC);
                    break;
                    
                // Section 3
                case 'slaViolated':
                    drillDownData = filteredData.filter(d => d.isSlaViolated);
                    break;
                case 'slaSR':
                    drillDownData = filteredData.filter(d => d.isSR && d.isSlaViolated);
                    break;
                case 'slaINC':
                    drillDownData = filteredData.filter(d => d.isINC && d.isSlaViolated);
                    break;
                case 'edocBreach':
                    drillDownData = filteredData.filter(d => d.isEdocBreached);
                    break;
                case 'subsequentSLA':
                    drillDownData = filteredData.filter(d => d.isClosed && d.subsequentSLABreachCount > 0);
                    break;
                case 'cpeCalls':
                    drillDownData = filteredData.filter(d => {
                        const ticket = d.correspondingInternalTicket;
                        return ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0';
                    });
                    break;
                    
                // Section 4
                case 'fcr':
                    drillDownData = filteredData.filter(d => d.isClosed && d.agingDays < 2);
                    break;
                case 'incLess15':
                    drillDownData = filteredData.filter(d => d.isClosed && d.isINC && d.agingDays < 15);
                    break;
                case 'incMore15':
                    drillDownData = filteredData.filter(d => d.isClosed && d.isINC && d.agingDays >= 15);
                    break;
                case 'srLess15':
                    drillDownData = filteredData.filter(d => d.isClosed && d.isSR && d.agingDays < 15);
                    break;
                case 'srMore15':
                    drillDownData = filteredData.filter(d => d.isClosed && d.isSR && d.agingDays >= 15);
                    break;
                    
                // Compliance drilldowns
                case 'aging15':
                    drillDownData = filteredData.filter(d => d.isAging15Violated);
                    break;
                case 'slaCompliance':
                    drillDownData = filteredData.filter(d => d.isSlaViolated);
                    break;
                case 'followupCompliance':
                    drillDownData = filteredData.filter(d => d.isFollowUpMissed);
                    break;
                case 'emailCompliance':
                    drillDownData = filteredData.filter(d => d.emailCompliance && (d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup')));
                    break;
                case 'edocCompliance':
                    drillDownData = filteredData.filter(d => d.isEdocBreached);
                    break;
                case 'subsequentSLAMiss':
                    drillDownData = filteredData.filter(d => d.isSubsequentSLABreach);
                    break;
                    
                default:
                    drillDownData = [];
            }
            
            document.getElementById('drillDownCount').textContent = `${drillDownData.length} Cases`;
            
            drillDownExportData = drillDownData.map(d => {
                const exportRow = {};
                if (drillDownColumns[kpi]) {
                    drillDownColumns[kpi].forEach(col => {
                        if (col.key === 'correspondingInternalTicket') {
                            exportRow[col.label] = d.correspondingInternalTicket || '';
                        } else if (col.key === 'resolveTime') {
                            exportRow[col.label] = d.resolveTime || '';
                        } else if (col.key === 'slaStatus') {
                            exportRow[col.label] = d.slaStatus || 'N/A'; // Issue #2: Use actual SLA status
                        } else if (col.key === 'incidentId') {
                            exportRow[col.label] = d.incidentId || 'N/A'; // Issue #1: Use actual Incident ID
                        } else {
                            exportRow[col.label] = d[col.key] || '';
                        }
                    });
                } else {
                    exportRow['Incident ID'] = d.incidentId || 'N/A'; // Issue #1
                    exportRow['Title'] = d.title;
                    exportRow['Owner'] = d.owner;
                    exportRow['Submitted By'] = d.submittedBy;
                    exportRow['Status'] = d.currentStatus;
                    exportRow['Aging'] = d.agingDays;
                    exportRow['SLA Status'] = d.slaStatus || 'N/A'; // Issue #2
                    exportRow['Next Follow-up'] = d.nextFollowUp || '--';
                }
                return exportRow;
            });
            
            const header = document.getElementById('drillDownHeader');
            if (drillDownColumns[kpi]) {
                header.innerHTML = drillDownColumns[kpi].map(col => 
                    `<th>${col.label}</th>`
                ).join('');
            } else {
                header.innerHTML = `
                    <th>Incident ID</th>
                    <th>Title</th>
                    <th>Owner</th>
                    <th>Submitted By</th>
                    <th>Status</th>
                    <th>Aging</th>
                    <th>SLA Status</th>
                    <th>Next Follow-up</th>
                `;
            }
            
            const drillDownHtml = drillDownData.map((d, index) => {
                const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                
                if (drillDownColumns[kpi]) {
                    const cells = drillDownColumns[kpi].map(col => {
                        let value = '';
                        if (col.key === 'incidentId') {
                            value = d.incidentId || 'N/A'; // Issue #1
                        } else if (col.key === 'slaStatus') {
                            value = d.slaStatus || 'N/A'; // Issue #2
                        } else {
                            value = d[col.key] || '';
                        }
                        
                        // Convert to string to avoid errors
                        value = String(value);
                        
                        let cellClass = '';
                        
                        // Make Incident ID bold
                        if (col.key === 'incidentId') {
                            cellClass = 'fw-bold';
                        } else if (col.key === 'agingDays' || col.key === 'agingRoundoff') {
                            const agingValue = parseInt(value) || 0;
                            if (agingValue > 25) cellClass = 'text-danger fw-bold';
                            else if (agingValue > 15) cellClass = 'text-warning';
                        } else if (col.key === 'slaStatus' || col.key === 'slaViolationStatus') {
                            if (value === 'Violated') cellClass = 'text-danger fw-bold';
                            else cellClass = 'text-success';
                        } else if (col.key === 'emailCompliance') {
                            if (value.includes('Missed') || value.includes('No Followup')) cellClass = 'text-danger';
                        }
                        
                        return `<td class="${cellClass}" title="${value}">${value.length > 30 ? value.substring(0, 30) + '...' : value}</td>`;
                    }).join('');
                    
                    return `<tr onclick="viewCaseDetail(${globalIndex})" style="cursor: pointer;">${cells}</tr>`;
                } else {
                    return `
                        <tr onclick="viewCaseDetail(${globalIndex})" style="cursor: pointer;">
                            <td class="fw-bold" title="${d.incidentId || 'N/A'}">${(d.incidentId || 'N/A').length > 15 ? (d.incidentId || 'N/A').substring(0, 15) + '...' : (d.incidentId || 'N/A')}</td>
                            <td title="${d.title}">${d.title.length > 40 ? d.title.substring(0, 40) + '...' : d.title}</td>
                            <td><span class="owner-tag">${d.owner}</span></td>
                            <td>${d.submittedBy}</td>
                            <td>${d.currentStatus}</td>
                            <td class="${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</td>
                            <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaStatus || 'N/A'}</td>
                            <td class="${d.isFollowUpMissed ? 'text-danger fw-bold' : ''}" title="${d.nextFollowUp || '--'}">${d.nextFollowUp ? (d.nextFollowUp.length > 20 ? d.nextFollowUp.substring(0, 20) + '...' : d.nextFollowUp) : '--'}</td>
                        </tr>
                    `;
                }
            }).join('');

            document.getElementById('drillDownBody').innerHTML = drillDownHtml || '<tr><td colspan="8" class="text-center text-muted py-3">No cases found.</td></tr>';

            new bootstrap.Modal(document.getElementById('drillDownModal')).show();
        }

        function renderPerformanceView() {
            const totalCases = filteredData.length;
            const closedCases = filteredData.filter(d => d.isClosed).length;
            const slaViolatedCount = filteredData.filter(d => d.isSlaViolated).length;
            const overallSlaRate = totalCases > 0 ? ((totalCases - slaViolatedCount) / totalCases * 100).toFixed(1) : 100.0;
            const fcrCount = filteredData.filter(d => d.isClosed && d.agingDays < 2).length;
            const fcrRate = closedCases > 0 ? (fcrCount / closedCases * 100).toFixed(1) : 0;
            const cpeCalls = filteredData.filter(d => {
                const ticket = d.correspondingInternalTicket;
                return ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0';
            }).length;

            document.getElementById('total-closed-cases').textContent = closedCases;
            document.getElementById('overall-sla-rate').textContent = `${overallSlaRate}%`;
            document.getElementById('fcr-rate').textContent = `${fcrRate}%`;
            document.getElementById('cpe-calls-metric').textContent = cpeCalls;

            renderPerformanceCharts();
            renderCustomerAnalysis();
            renderEngineerAnalysis();
        }

        function renderPerformanceCharts() {
            Object.values(charts).forEach(chart => chart && chart.destroy());

            // Service Type Chart
            const serviceCounts = {
                'Service Request': filteredData.filter(d => d.isSR).length,
                'Incident Management': filteredData.filter(d => d.isINC).length
            };
            
            const serviceColors = ['#0d6efd', '#0dcaf0'];
            charts.serviceTypeChart = new Chart(document.getElementById('serviceTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(serviceCounts),
                    datasets: [{
                        data: Object.values(serviceCounts),
                        backgroundColor: serviceColors,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            // Closure Aging Distribution Chart
            const closedCases = filteredData.filter(d => d.isClosed);
            const agingBrackets = { '<2 days': 0, '2-7 days': 0, '8-15 days': 0, '16-30 days': 0, '>30 days': 0 };
            
            closedCases.forEach(d => {
                if(d.agingDays < 2) agingBrackets['<2 days']++;
                else if(d.agingDays <= 7) agingBrackets['2-7 days']++;
                else if(d.agingDays <= 15) agingBrackets['8-15 days']++;
                else if(d.agingDays <= 30) agingBrackets['16-30 days']++;
                else agingBrackets['>30 days']++;
            });
            
            charts.closureAgingChart = new Chart(document.getElementById('closureAgingChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(agingBrackets),
                    datasets: [{
                        label: 'Number of Cases',
                        data: Object.values(agingBrackets),
                        backgroundColor: ['#20c997', '#0dcaf0', '#ffc107', '#fd7e14', '#dc3545'],
                        borderColor: ['#20c997', '#0dcaf0', '#ffc107', '#fd7e14', '#dc3545'],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderCustomerAnalysis() {
            const customerStats = {};
            
            filteredData.forEach(d => {
                if(!customerStats[d.submittedBy]) {
                    customerStats[d.submittedBy] = {
                        total: 0,
                        closed: 0,
                        slaViolated: 0,
                        tat247Values: [],
                        fcr: 0,
                        cpeCalls: 0
                    };
                }
                customerStats[d.submittedBy].total++;
                if(d.isClosed) {
                    customerStats[d.submittedBy].closed++;
                    customerStats[d.submittedBy].tat247Values.push(parseFloat(d.tat247) || 0);
                    if(d.agingDays < 2) customerStats[d.submittedBy].fcr++;
                }
                if(d.isSlaViolated) customerStats[d.submittedBy].slaViolated++;
                
                const ticket = d.correspondingInternalTicket;
                if (ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0') {
                    customerStats[d.submittedBy].cpeCalls++;
                }
            });
            
            const customerRows = Object.keys(customerStats).sort().map(customer => {
                const stats = customerStats[customer];
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const avgResolutionTime = stats.tat247Values.length > 0 ? (stats.tat247Values.reduce((a, b) => a + b, 0) / stats.tat247Values.length).toFixed(1) : 0;
                const fcrRate = stats.closed > 0 ? ((stats.fcr / stats.closed) * 100).toFixed(1) : 0;
                
                return `
                    <tr>
                        <td>${customer}</td>
                        <td>${stats.total}</td>
                        <td>${stats.closed}</td>
                        <td class="${parseFloat(slaCompliance) >= 95 ? 'text-success' : parseFloat(slaCompliance) >= 80 ? 'text-warning' : 'text-danger'} fw-bold">${slaCompliance}%</td>
                        <td>${avgResolutionTime} days</td>
                        <td class="${parseFloat(fcrRate) >= 85 ? 'text-success' : parseFloat(fcrRate) >= 70 ? 'text-warning' : 'text-danger'}">${fcrRate}%</td>
                        <td>${stats.cpeCalls}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('customer-analysis-body').innerHTML = customerRows || 
                '<tr><td colspan="7" class="text-center text-muted py-3">No customer data available.</td></tr>';
        }

        function renderEngineerAnalysis() {
            const engineerStats = {};
            
            filteredData.forEach(d => {
                if(!engineerStats[d.owner]) {
                    engineerStats[d.owner] = {
                        total: 0,
                        closed: 0,
                        slaViolated: 0,
                        fcr: 0,
                        subsequentSLA: 0,
                        cpeCalls: 0,
                        tat247Values: []
                    };
                }
                engineerStats[d.owner].total++;
                engineerStats[d.owner].tat247Values.push(parseFloat(d.tat247) || 0);
                if(d.isClosed) {
                    engineerStats[d.owner].closed++;
                    if(d.agingDays < 2) engineerStats[d.owner].fcr++;
                    if(d.subsequentSLABreachCount > 0) engineerStats[d.owner].subsequentSLA++;
                }
                if(d.isSlaViolated) engineerStats[d.owner].slaViolated++;
                
                const ticket = d.correspondingInternalTicket;
                if (ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0') {
                    engineerStats[d.owner].cpeCalls++;
                }
            });
            
            const engineerRows = Object.keys(engineerStats).sort().map(engineer => {
                const stats = engineerStats[engineer];
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const fcrRate = stats.closed > 0 ? ((stats.fcr / stats.closed) * 100).toFixed(1) : 0;
                const avgResolutionTime = stats.tat247Values.length > 0 ? (stats.tat247Values.reduce((a, b) => a + b, 0) / stats.tat247Values.length).toFixed(1) : 0;
                
                // Calculate performance score (0-100)
                let performanceScore = 0;
                if (stats.total > 0) {
                    // SLA Compliance weight: 40%
                    performanceScore += (parseFloat(slaCompliance) * 0.4);
                    
                    // FCR Rate weight: 30%
                    performanceScore += (parseFloat(fcrRate) * 0.3);
                    
                    // Closure Rate weight: 20%
                    const closureRate = stats.total > 0 ? ((stats.closed / stats.total) * 100) : 0;
                    performanceScore += (closureRate * 0.2);
                    
                    // Penalty for subsequent SLA misses: -1% per miss
                    performanceScore -= (stats.subsequentSLA * 1);
                    
                    // Penalty for CPE calls: -0.5% per call
                    performanceScore -= (stats.cpeCalls * 0.5);
                    
                    // Ensure score is between 0 and 100
                    performanceScore = Math.max(0, Math.min(100, performanceScore));
                }
                
                const scoreClass = performanceScore >= 90 ? 'score-excellent' :
                                 performanceScore >= 80 ? 'score-good' :
                                 performanceScore >= 70 ? 'score-average' : 'score-poor';
                
                return `
                    <tr>
                        <td>${engineer}</td>
                        <td>${stats.total}</td>
                        <td>${stats.closed}</td>
                        <td class="${parseFloat(slaCompliance) >= 95 ? 'text-success' : parseFloat(slaCompliance) >= 80 ? 'text-warning' : 'text-danger'} fw-bold">${slaCompliance}%</td>
                        <td class="${parseFloat(fcrRate) >= 85 ? 'text-success' : parseFloat(fcrRate) >= 70 ? 'text-warning' : 'text-danger'}">${fcrRate}%</td>
                        <td class="${parseFloat(avgResolutionTime) > 15 ? 'text-danger' : parseFloat(avgResolutionTime) > 10 ? 'text-warning' : 'text-success'}">${avgResolutionTime}</td>
                        <td class="${stats.subsequentSLA > 0 ? 'text-danger' : 'text-success'}">${stats.subsequentSLA}</td>
                        <td>${stats.cpeCalls}</td>
                        <td><span class="satisfaction-score ${scoreClass}">${performanceScore.toFixed(1)}</span></td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('engineer-analysis-body').innerHTML = engineerRows || 
                '<tr><td colspan="9" class="text-center text-muted py-3">No engineer data available.</td></tr>';
        }

        function viewCaseDetail(idx) {
            const d = processedData[idx];
            document.getElementById('caseDetailTitle').textContent = `${d.incidentId}: ${d.title}`;
            document.getElementById('case-detail-content').innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>${d.incidentId}: ${d.title}</h6>
                        <p class="text-muted">${d.service} | Submitted by: ${d.submittedBy}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="owner-tag">${d.owner}</span>
                        <span class="badge ${d.isSlaViolated ? 'bg-danger' : 'bg-success'} ms-2">${d.slaViolationStatus}</span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>Basic Information</h6>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Status:</strong></div>
                            <div class="col-6">${d.currentStatus}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Service Type:</strong></div>
                            <div class="col-6">${d.service}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Submitted By:</strong></div>
                            <div class="col-6">${d.submittedBy}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Email Compliance:</strong></div>
                            <div class="col-6"><span class="fw-bold ${d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup') ? 'text-danger' : 'text-success'}">${d.emailCompliance || 'Compliant'}</span></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-clock-history me-2" style="color: var(--primary-color);"></i>Timeline & Compliance</h6>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Aging (Days):</strong></div>
                            <div class="col-6 ${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Idle Since Modified:</strong></div>
                            <div class="col-6 ${d.agingFromLastModified > 1 ? 'text-danger fw-bold' : ''}">${d.agingFromLastModified} days</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Next Follow-up:</strong></div>
                            <div class="col-6 ${d.isFollowUpMissed ? 'text-danger fw-bold' : 'text-success'}">${d.nextFollowUp || '--'}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Expected Resolution:</strong></div>
                            <div class="col-6 ${d.isEdocBreached ? 'text-danger fw-bold' : 'text-success'}">${d.expectedResolution || '--'}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Sub. SLA Miss Count:</strong></div>
                            <div class="col-6 ${d.isSubsequentSLABreach ? 'text-danger fw-bold' : 'text-success'}">${d.subsequentSLABreachCount}</div>
                        </div>
                    </div>
                </div>
                <hr>
                <h6><i class="bi bi-card-checklist me-2" style="color: var(--primary-color);"></i>Risk Indicators</h6>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            ${d.isOldest25 ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Aged > 25 Days</li>' : ''}
                            ${d.isEdocBreached ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>EDOC Breached</li>' : ''}
                            ${d.isSlaViolated ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>SLA Violated</li>' : ''}
                            ${d.isFollowUpMissed ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Follow-up Date Missed</li>' : ''}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            ${d.isSubsequentResponseMissed ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Subsequent Response Missed (including today)</li>' : ''}
                            ${d.isSubsequentSLABreach ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Subsequent SLA Breach</li>' : ''}
                            ${d.isIdle3 ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Idle > 2 Days</li>' : ''}
                            ${d.isAging15Violated ? '<li class="text-warning"><i class="bi bi-exclamation-triangle-fill me-2"></i>Aging > 15 Days</li>' : ''}
                        </ul>
                    </div>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('caseDetailModal')).show();
        }

        /* ============================================
           MONTHLY PERFORMANCE FUNCTIONS
           ============================================ */
        
        function updateMonthlyPerformance() {
            if (processedData.length === 0) return;
            
            calculateMonthlyComplianceMetrics();
            renderComplianceTrendCharts();
            renderLoggedClosedChart(); // Issue #3: Added new chart
            renderComplianceStatsGrid();
            renderComplianceDrilldownGrid();
            renderMonthlyBreakdownTable();
        }
        
        function calculateMonthlyComplianceMetrics() {
            const currentData = filteredData;
            
            // Calculate all compliance metrics
            const metrics = {
                totalCases: currentData.length,
                slaComplianceRate: calculateSLAComplianceRate(currentData),
                fcrRate: calculateFCRRate(currentData),
                agingComplianceRate: calculateAgingComplianceRate(currentData),
                emailComplianceRate: calculateEmailComplianceRate(currentData),
                followupComplianceRate: calculateFollowupComplianceRate(currentData),
                edocComplianceRate: calculateEDOCComplianceRate(currentData),
                subsequentSLAComplianceRate: calculateSubsequentSLAComplianceRate(currentData),
                
                // Detailed counts for drilldown
                slaViolated: currentData.filter(d => d.isSlaViolated).length,
                fcrMissed: currentData.filter(d => d.isClosed && d.agingDays >= 2).length,
                agingViolated: currentData.filter(d => d.isAging15Violated).length,
                emailViolated: currentData.filter(d => d.emailCompliance && (d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup'))).length,
                followupMissed: currentData.filter(d => d.isFollowUpMissed).length,
                edocBreached: currentData.filter(d => d.isEdocBreached).length,
                subsequentSLAMissed: currentData.filter(d => d.isSubsequentSLABreach).length,
                
                // Issue #5: Calculate aging metrics
                incLess15: currentData.filter(d => d.isClosed && d.isINC && d.agingDays < 15).length,
                incMore15: currentData.filter(d => d.isClosed && d.isINC && d.agingDays >= 15).length,
                srLess15: currentData.filter(d => d.isClosed && d.isSR && d.agingDays < 15).length,
                srMore15: currentData.filter(d => d.isClosed && d.isSR && d.agingDays >= 15).length
            };
            
            monthlyPerformanceData = metrics;
            
            // Calculate monthly breakdown
            calculateMonthlyBreakdown();
        }
        
        function calculateSLAComplianceRate(data) {
            const total = data.length;
            const violated = data.filter(d => d.isSlaViolated).length;
            return total > 0 ? ((total - violated) / total * 100).toFixed(1) : 100;
        }
        
        function calculateFCRRate(data) {
            const closedCases = data.filter(d => d.isClosed);
            const fcrCases = closedCases.filter(d => d.agingDays < 2);
            return closedCases.length > 0 ? (fcrCases.length / closedCases.length * 100).toFixed(1) : 100;
        }
        
        function calculateAgingComplianceRate(data) {
            // Issue #5: Calculate aging compliance based on the new formula
            const totalClosed = data.filter(d => d.isClosed).length;
            const incLess15 = data.filter(d => d.isClosed && d.isINC && d.agingDays < 15).length;
            const incMore15 = data.filter(d => d.isClosed && d.isINC && d.agingDays >= 15).length;
            const srLess15 = data.filter(d => d.isClosed && d.isSR && d.agingDays < 15).length;
            const srMore15 = data.filter(d => d.isClosed && d.isSR && d.agingDays >= 15).length;
            
            const totalAgingCompliant = incLess15 + srLess15;
            const totalCasesWithAging = incLess15 + incMore15 + srLess15 + srMore15;
            
            return totalCasesWithAging > 0 ? (totalAgingCompliant / totalCasesWithAging * 100).toFixed(1) : 100;
        }
        
        function calculateEmailComplianceRate(data) {
            const total = data.length;
            const emailViolated = data.filter(d => d.emailCompliance && (d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup'))).length;
            return total > 0 ? ((total - emailViolated) / total * 100).toFixed(1) : 100;
        }
        
        function calculateFollowupComplianceRate(data) {
            const total = data.length;
            const followupMissed = data.filter(d => d.isFollowUpMissed).length;
            return total > 0 ? ((total - followupMissed) / total * 100).toFixed(1) : 100;
        }
        
        function calculateEDOCComplianceRate(data) {
            const srCases = data.filter(d => d.isSR);
            const edocBreached = srCases.filter(d => d.isEdocBreached).length;
            return srCases.length > 0 ? ((srCases.length - edocBreached) / srCases.length * 100).toFixed(1) : 100;
        }
        
        function calculateSubsequentSLAComplianceRate(data) {
            const total = data.length;
            const subsequentMissed = data.filter(d => d.isSubsequentSLABreach).length;
            return total > 0 ? ((total - subsequentMissed) / total * 100).toFixed(1) : 100;
        }
        
        function calculateMonthlyBreakdown() {
            const monthlyDataLogged = {};  // Track by submission date
            const monthlyDataClosed = {};  // Track by resolve date
            
            // First pass: Count logged cases by submission month
            filteredData.forEach(d => {
                // Use submission date (Column S) for logged cases
                const monthKey = d.monthYear;  // Already based on submissionTime
                if (!monthlyDataLogged[monthKey]) {
                    monthlyDataLogged[monthKey] = {
                        loggedCases: 0
                    };
                }
                monthlyDataLogged[monthKey].loggedCases++;
            });
            
            // Second pass: Count closed cases by resolve month
            filteredData.forEach(d => {
                if (d.isClosed && d.resolveTime && d.resolveTime !== '--' && d.resolveTime !== 'NULL') {
                    // Parse resolve date (Column T)
                    const resolveDate = new Date(d.resolveTime);
                    if (!isNaN(resolveDate.getTime())) {
                        const monthKey = `${resolveDate.getMonth()+1}-${resolveDate.getFullYear()}`;
                        if (!monthlyDataClosed[monthKey]) {
                            monthlyDataClosed[monthKey] = {
                                closedCases: 0
                            };
                        }
                        monthlyDataClosed[monthKey].closedCases++;
                    }
                }
            });
            
            // Third pass: Calculate all other metrics by submission month
            const monthlyData = {};
            filteredData.forEach(d => {
                const monthKey = d.monthYear;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        total: 0,
                        slaViolated: 0,
                        fcrMissed: 0,
                        agingViolated: 0,
                        emailViolated: 0,
                        followupMissed: 0,
                        edocBreached: 0,
                        subsequentSLAMissed: 0,
                        closedCases: 0,
                        loggedCases: 0,
                        actuallyClosedCases: 0,
                        incLess15: 0,
                        incMore15: 0,
                        srLess15: 0,
                        srMore15: 0
                    };
                }
                
                monthlyData[monthKey].total++;
                monthlyData[monthKey].loggedCases = monthlyDataLogged[monthKey]?.loggedCases || 0;
                
                if (d.isClosed) {
                    monthlyData[monthKey].closedCases++;
                    if (d.currentStatus === 'Close' || d.currentStatus === 'Resolve - Pending User Confirmation') {
                        monthlyData[monthKey].actuallyClosedCases++;
                    }
                    
                    if (d.isINC) {
                        if (d.agingDays < 15) {
                            monthlyData[monthKey].incLess15++;
                        } else {
                            monthlyData[monthKey].incMore15++;
                        }
                    } else if (d.isSR) {
                        if (d.agingDays < 15) {
                            monthlyData[monthKey].srLess15++;
                        } else {
                            monthlyData[monthKey].srMore15++;
                        }
                    }
                }
                
                if (d.isSlaViolated) monthlyData[monthKey].slaViolated++;
                if (d.isClosed && d.agingDays >= 2) monthlyData[monthKey].fcrMissed++;
                if (d.isAging15Violated) monthlyData[monthKey].agingViolated++;
                if (d.emailCompliance && (d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup'))) {
                    monthlyData[monthKey].emailViolated++;
                }
                if (d.isFollowUpMissed) monthlyData[monthKey].followupMissed++;
                if (d.isEdocBreached) monthlyData[monthKey].edocBreached++;
                if (d.isSubsequentSLABreach) monthlyData[monthKey].subsequentSLAMissed++;
            });
            
            // Store both datasets
            monthlyBreakdownData = monthlyData;
            window.monthlyDataClosed = monthlyDataClosed;  // Store for chart rendering
        }
        
        function renderComplianceTrendCharts() {
            // Destroy existing charts
            if (charts.slaTrendChart) charts.slaTrendChart.destroy();
            if (charts.fcrTrendChart) charts.fcrTrendChart.destroy();
            if (charts.agingTrendChart) charts.agingTrendChart.destroy();
            
            // Get monthly data for trends
            const months = Object.keys(monthlyBreakdownData).sort((a, b) => {
                const [aMonth, aYear] = a.split('-').map(Number);
                const [bMonth, bYear] = b.split('-').map(Number);
                if (aYear !== bYear) return aYear - bYear;
                return aMonth - bMonth;
            });
            
            const monthLabels = months.map(m => {
                const [month, year] = m.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            
            const slaRates = months.map(m => {
                const data = monthlyBreakdownData[m];
                return data.total > 0 ? ((data.total - data.slaViolated) / data.total * 100).toFixed(1) : 100;
            });
            
            const fcrRates = months.map(m => {
                const data = monthlyBreakdownData[m];
                return data.closedCases > 0 ? 
                    ((data.closedCases - data.fcrMissed) / data.closedCases * 100).toFixed(1) : 100;
            });
            
            // Issue #5: Calculate aging rates based on new formula
            const agingRates = months.map(m => {
                const data = monthlyBreakdownData[m];
                const totalCasesWithAging = data.incLess15 + data.incMore15 + data.srLess15 + data.srMore15;
                const totalAgingCompliant = data.incLess15 + data.srLess15;
                return totalCasesWithAging > 0 ? (totalAgingCompliant / totalCasesWithAging * 100).toFixed(1) : 100;
            });
            
            // Update trend values
            document.getElementById('sla-compliance-trend').textContent = `${monthlyPerformanceData.slaComplianceRate}%`;
            document.getElementById('fcr-trend').textContent = `${monthlyPerformanceData.fcrRate}%`;
            document.getElementById('aging-compliance-trend').textContent = `${monthlyPerformanceData.agingComplianceRate}%`;
            
            // Create SLA Trend Chart
            const slaCtx = document.getElementById('slaTrendChart').getContext('2d');
            charts.slaTrendChart = new Chart(slaCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'SLA Compliance %',
                        data: slaRates,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 80,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Create FCR Trend Chart
            const fcrCtx = document.getElementById('fcrTrendChart').getContext('2d');
            charts.fcrTrendChart = new Chart(fcrCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'FCR Rate %',
                        data: fcrRates,
                        borderColor: '#20c997',
                        backgroundColor: 'rgba(32, 201, 151, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 80,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Create Aging Trend Chart
            const agingCtx = document.getElementById('agingTrendChart').getContext('2d');
            charts.agingTrendChart = new Chart(agingCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Aging Compliance %',
                        data: agingRates,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 80,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Issue #3: New function for Logged vs Closed chart
        function renderLoggedClosedChart() {
            if (charts.loggedClosedChart) charts.loggedClosedChart.destroy();
            
            // Get all unique months from both logged and closed data
            const allMonths = new Set([
                ...Object.keys(monthlyBreakdownData),
                ...Object.keys(window.monthlyDataClosed || {})
            ]);
            
            const months = Array.from(allMonths).sort((a, b) => {
                const [aMonth, aYear] = a.split('-').map(Number);
                const [bMonth, bYear] = b.split('-').map(Number);
                if (aYear !== bYear) return aYear - bYear;
                return aMonth - bMonth;
            });
            
            const monthLabels = months.map(m => {
                const [month, year] = m.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            
            // Logged cases by submission month (Column S)
            const loggedData = months.map(m => monthlyBreakdownData[m]?.loggedCases || 0);
            // Closed cases by resolve month (Column T)
            const closedData = months.map(m => (window.monthlyDataClosed && window.monthlyDataClosed[m]?.closedCases) || 0);
            
            const loggedClosedCtx = document.getElementById('loggedClosedChart').getContext('2d');
            charts.loggedClosedChart = new Chart(loggedClosedCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Logged Cases (by Submission Date)',
                            data: loggedData,
                            backgroundColor: 'rgba(0, 102, 204, 0.1)',
                            borderColor: '#0066cc',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#0066cc',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Closed Cases (by Resolve Date)',
                            data: closedData,
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            borderColor: '#00c853',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#00c853',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Cases',
                                font: {
                                    size: 12,
                                    weight: '600',
                                    family: "'Plus Jakarta Sans', sans-serif"
                                }
                            },
                            ticks: {
                                font: {
                                    family: "'Plus Jakarta Sans', sans-serif"
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: "'Plus Jakarta Sans', sans-serif"
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: '600',
                                    family: "'Plus Jakarta Sans', sans-serif"
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleFont: {
                                size: 13,
                                weight: '700',
                                family: "'Plus Jakarta Sans', sans-serif"
                            },
                            bodyFont: {
                                size: 12,
                                family: "'Plus Jakarta Sans', sans-serif"
                            },
                            padding: 12,
                            borderColor: 'rgba(229, 231, 235, 0.2)',
                            borderWidth: 1
                        }
                    }
                }
            });
        }
        
        function renderComplianceStatsGrid() {
            const metrics = monthlyPerformanceData;
            
            const statsHtml = `
                <div class="stats-card">
                    <div class="stats-title">SLA Compliance</div>
                    <div class="stats-value">${metrics.slaComplianceRate}%</div>
                    <div class="stats-change ${parseFloat(metrics.slaComplianceRate) >= 95 ? 'positive' : 'negative'}">
                        ${parseFloat(metrics.slaComplianceRate) >= 95 ? ' On Target' : ' Needs Improvement'}
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-title">First Contact Resolution</div>
                    <div class="stats-value">${metrics.fcrRate}%</div>
                    <div class="stats-change ${parseFloat(metrics.fcrRate) >= 85 ? 'positive' : 'negative'}">
                        ${parseFloat(metrics.fcrRate) >= 85 ? ' Good' : ' Below Target'}
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-title">Aging Compliance</div>
                    <div class="stats-value">${metrics.agingComplianceRate}%</div>
                    <div class="stats-change ${parseFloat(metrics.agingComplianceRate) >= 90 ? 'positive' : 'negative'}">
                        ${parseFloat(metrics.agingComplianceRate) >= 90 ? ' Healthy' : ' Attention Needed'}
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-title">Email Compliance</div>
                    <div class="stats-value">${metrics.emailComplianceRate}%</div>
                    <div class="stats-change ${parseFloat(metrics.emailComplianceRate) >= 95 ? 'positive' : 'negative'}">
                        ${parseFloat(metrics.emailComplianceRate) >= 95 ? ' Excellent' : ' Review Required'}
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-title">EDOC Compliance</div>
                    <div class="stats-value">${metrics.edocComplianceRate}%</div>
                    <div class="stats-change ${parseFloat(metrics.edocComplianceRate) >= 95 ? 'positive' : 'negative'}">
                        ${parseFloat(metrics.edocComplianceRate) >= 95 ? ' Meeting Deadlines' : ' Schedule Issues'}
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-title">Subsequent SLA</div>
                    <div class="stats-value">${metrics.subsequentSLAComplianceRate}%</div>
                    <div class="stats-change ${parseFloat(metrics.subsequentSLAComplianceRate) >= 95 ? 'positive' : 'negative'}">
                        ${parseFloat(metrics.subsequentSLAComplianceRate) >= 95 ? ' Compliant' : ' Follow-up Needed'}
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-title">Total Cases</div>
                    <div class="stats-value">${metrics.totalCases}</div>
                    <div class="stats-change positive">
                        Current Period
                    </div>
                </div>
            `;
            
            document.getElementById('compliance-stats-grid').innerHTML = statsHtml;
        }
        
        function renderComplianceDrilldownGrid() {
            const metrics = monthlyPerformanceData;
            
            const drilldownHtml = `
                <div class="drilldown-item" onclick="openComplianceDrillDown('sla')">
                    <div class="drilldown-item-title">SLA Violations</div>
                    <div class="drilldown-item-value">${metrics.slaViolated}</div>
                    <div class="drilldown-item-desc">Cases with SLA violations</div>
                </div>
                <div class="drilldown-item" onclick="openComplianceDrillDown('fcr')">
                    <div class="drilldown-item-title">FCR Missed</div>
                    <div class="drilldown-item-value">${metrics.fcrMissed}</div>
                    <div class="drilldown-item-desc">Cases not resolved within 2 days</div>
                </div>
                <div class="drilldown-item" onclick="openComplianceDrillDown('aging')">
                    <div class="drilldown-item-title">Aging >15 Days</div>
                    <div class="drilldown-item-value">${metrics.agingViolated}</div>
                    <div class="drilldown-item-desc">Cases aging beyond 15 days</div>
                </div>
                <div class="drilldown-item" onclick="openComplianceDrillDown('edoc')">
                    <div class="drilldown-item-title">EDOC Breaches</div>
                    <div class="drilldown-item-value">${metrics.edocBreached}</div>
                    <div class="drilldown-item-desc">SR cases beyond expected closure date</div>
                </div>
                <div class="drilldown-item" onclick="openComplianceDrillDown('subsequent')">
                    <div class="drilldown-item-title">Subsequent SLA Missed</div>
                    <div class="drilldown-item-value">${metrics.subsequentSLAMissed}</div>
                    <div class="drilldown-item-desc">Cases with subsequent SLA breaches</div>
                </div>
                <div class="drilldown-item" onclick="openComplianceDrillDown('all')">
                    <div class="drilldown-item-title">Total Compliance Issues</div>
                    <div class="drilldown-item-value">${metrics.slaViolated + metrics.fcrMissed + metrics.agingViolated}</div>
                    <div class="drilldown-item-desc">All compliance issues combined</div>
                </div>
            `;
            
            document.getElementById('compliance-drilldown-grid').innerHTML = drilldownHtml;
        }
        
        function renderMonthlyBreakdownTable() {
            const months = Object.keys(monthlyBreakdownData).sort((a, b) => {
                const [aMonth, aYear] = a.split('-').map(Number);
                const [bMonth, bYear] = b.split('-').map(Number);
                if (aYear !== bYear) return bYear - aYear;
                return bMonth - aMonth;
            });
            
            let breakdownHtml = '';
            
            months.forEach(monthKey => {
                const data = monthlyBreakdownData[monthKey];
                const [month, year] = monthKey.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthName = monthNames[parseInt(month) - 1];
                
                const slaRate = data.total > 0 ? 
                    (((data.total - data.slaViolated) / data.total) * 100).toFixed(1) : 100;
                
                const fcrRate = data.closedCases > 0 ? 
                    (((data.closedCases - data.fcrMissed) / data.closedCases) * 100).toFixed(1) : 100;
                
                const emailRate = data.total > 0 ? 
                    (((data.total - data.emailViolated) / data.total) * 100).toFixed(1) : 100;
                
                breakdownHtml += `
                    <tr>
                        <td>${monthName} ${year}</td>
                        <td>${data.total}</td>
                        <td class="${parseFloat(slaRate) >= 95 ? 'text-success' : 
                                    parseFloat(slaRate) >= 80 ? 'text-warning' : 'text-danger'} fw-bold">
                            ${slaRate}%
                        </td>
                        <td class="${parseFloat(fcrRate) >= 85 ? 'text-success' : 
                                    parseFloat(fcrRate) >= 70 ? 'text-warning' : 'text-danger'}">
                            ${fcrRate}%
                        </td>
                        <td class="${data.agingViolated > 0 ? 'text-warning' : 'text-success'}">
                            ${data.agingViolated}
                        </td>
                        <td class="${data.edocBreached > 0 ? 'text-danger' : 'text-success'}">
                            ${data.edocBreached}
                        </td>
                        <td class="${parseFloat(emailRate) >= 95 ? 'text-success' : 
                                    parseFloat(emailRate) >= 80 ? 'text-warning' : 'text-danger'}">
                            ${emailRate}%
                        </td>
                        <td class="${data.subsequentSLAMissed > 0 ? 'text-danger' : 'text-success'}">
                            ${data.subsequentSLAMissed}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewMonthComplianceDetails('${monthKey}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('monthly-breakdown-body').innerHTML = breakdownHtml || 
                '<tr><td colspan="9" class="text-center text-muted py-3">No monthly data available.</td></tr>';
        }
        
        function openComplianceDrillDown(type) {
            let drillDownKey, title;
            
            switch(type) {
                case 'sla':
                    drillDownKey = 'slaCompliance';
                    title = 'SLA Compliance Issues';
                    break;
                case 'fcr':
                    drillDownKey = 'fcr';
                    title = 'First Contact Resolution Missed';
                    break;
                case 'aging':
                    drillDownKey = 'aging15';
                    title = 'Aging > 15 Days Cases';
                    break;
                case 'email':
                    drillDownKey = 'emailCompliance';
                    title = 'Email Compliance Issues';
                    break;
                case 'followup':
                    drillDownKey = 'followupCompliance';
                    title = 'Follow-up Compliance Issues';
                    break;
                case 'edoc':
                    drillDownKey = 'edocCompliance';
                    title = 'EDOC Compliance Issues';
                    break;
                case 'subsequent':
                    drillDownKey = 'subsequentSLAMiss';
                    title = 'Subsequent SLA Missed';
                    break;
                case 'all':
                    // For all compliance issues, we need to combine multiple categories
                    openAllComplianceDrillDown();
                    return;
                default:
                    drillDownKey = 'slaCompliance';
                    title = 'Compliance Issues';
            }
            
            openDrillDown(drillDownKey, title);
        }
        
        function openAllComplianceDrillDown() {
            // Combine all compliance issues
            const allIssues = filteredData.filter(d => 
                d.isSlaViolated || 
                d.isAging15Violated || 
                d.isFollowUpMissed || 
                d.isEdocBreached || 
                d.isSubsequentSLABreach ||
                (d.emailCompliance && (d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup')))
            );
            
            drillDownData = allIssues;
            drillDownTitleForExport = 'All Compliance Issues';
            
            drillDownExportData = allIssues.map(d => ({
                'Incident ID': d.incidentId || 'N/A',
                'Title': d.title,
                'Owner': d.owner,
                'Submitted By': d.submittedBy,
                'Service Type': d.service,
                'Status': d.currentStatus,
                'Aging (Days)': d.agingDays,
                'SLA Status': d.slaStatus || 'N/A',
                'Compliance Issues': getComplianceIssues(d)
            }));
            
            document.getElementById('drillDownTitle').textContent = 'All Compliance Issues';
            document.getElementById('drillDownCount').textContent = `${allIssues.length} Cases`;
            
            const header = document.getElementById('drillDownHeader');
            header.innerHTML = `
                <th>Incident ID</th>
                <th>Title</th>
                <th>Owner</th>
                <th>Submitted By</th>
                <th>Service Type</th>
                <th>Status</th>
                <th>Aging (Days)</th>
                <th>SLA Status</th>
                <th>Compliance Issues</th>
            `;
            
            const drillDownHtml = allIssues.map((d, index) => {
                const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                return `
                    <tr onclick="viewCaseDetail(${globalIndex})" style="cursor: pointer;">
                        <td class="fw-bold" title="${d.incidentId || 'N/A'}">${d.incidentId || 'N/A'}</td>
                        <td title="${d.title}">${d.title.length > 40 ? d.title.substring(0, 40) + '...' : d.title}</td>
                        <td><span class="owner-tag">${d.owner}</span></td>
                        <td>${d.submittedBy}</td>
                        <td>${d.service}</td>
                        <td>${d.currentStatus}</td>
                        <td class="${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</td>
                        <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaStatus || 'N/A'}</td>
                        <td class="text-danger">${getComplianceIssues(d)}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('drillDownBody').innerHTML = drillDownHtml;
            new bootstrap.Modal(document.getElementById('drillDownModal')).show();
        }
        
        function getComplianceIssues(d) {
            const issues = [];
            if (d.isSlaViolated) issues.push('SLA');
            if (d.isAging15Violated) issues.push('Aging>15');
            if (d.isFollowUpMissed) issues.push('Follow-up');
            if (d.isEdocBreached) issues.push('EDOC');
            if (d.isSubsequentSLABreach) issues.push('Sub SLA');
            if (d.emailCompliance && (d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup'))) {
                issues.push('Email');
            }
            return issues.join(', ');
        }
        
        function viewMonthComplianceDetails(monthKey) {
            const [month, year] = monthKey.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[parseInt(month) - 1];
            
            // Filter data for this month
            const monthData = filteredData.filter(d => d.monthYear === monthKey);
            drillDownData = monthData;
            drillDownTitleForExport = `${monthName} ${year} - All Cases`;
            
            drillDownExportData = monthData.map(d => ({
                'Incident ID': d.incidentId || 'N/A',
                'Title': d.title,
                'Owner': d.owner,
                'Submitted By': d.submittedBy,
                'Service Type': d.service,
                'Status': d.currentStatus,
                'Aging (Days)': d.agingDays,
                'SLA Status': d.slaStatus || 'N/A',
                'Compliance Status': getComplianceStatus(d)
            }));
            
            document.getElementById('drillDownTitle').textContent = `${monthName} ${year} - ${monthData.length} Cases`;
            document.getElementById('drillDownCount').textContent = `${monthData.length} Cases`;
            
            const header = document.getElementById('drillDownHeader');
            header.innerHTML = `
                <th>Incident ID</th>
                <th>Title</th>
                <th>Owner</th>
                <th>Submitted By</th>
                <th>Service Type</th>
                <th>Status</th>
                <th>Aging (Days)</th>
                <th>SLA Status</th>
                <th>Compliance Status</th>
            `;
            
            const drillDownHtml = monthData.map((d, index) => {
                const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                const complianceStatus = getComplianceStatus(d);
                return `
                    <tr onclick="viewCaseDetail(${globalIndex})" style="cursor: pointer;">
                        <td class="fw-bold" title="${d.incidentId || 'N/A'}">${d.incidentId || 'N/A'}</td>
                        <td title="${d.title}">${d.title.length > 40 ? d.title.substring(0, 40) + '...' : d.title}</td>
                        <td><span class="owner-tag">${d.owner}</span></td>
                        <td>${d.submittedBy}</td>
                        <td>${d.service}</td>
                        <td>${d.currentStatus}</td>
                        <td class="${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</td>
                        <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaStatus || 'N/A'}</td>
                        <td class="${complianceStatus === 'Compliant' ? 'text-success' : 'text-danger'}">
                            ${complianceStatus}
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('drillDownBody').innerHTML = drillDownHtml;
            new bootstrap.Modal(document.getElementById('drillDownModal')).show();
        }
        
        function getComplianceStatus(d) {
            if (d.isSlaViolated || d.isAging15Violated || d.isFollowUpMissed || 
                d.isEdocBreached || d.isSubsequentSLABreach ||
                (d.emailCompliance && (d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup')))) {
                return 'Non-Compliant';
            }
            return 'Compliant';
        }

        /* ============================================
           EXPORT FUNCTIONS
           ============================================ */
        
        function exportScorecardToExcel() {
            if(!scorecardData.length) {
                alert("Scorecard data not ready or filtered to zero results.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(scorecardData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Scorecard_Export");
            XLSX.writeFile(wb, `MSP_Scorecard_Export_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function exportDrillDownToExcel() {
            if(!drillDownExportData.length) {
                alert("No data to export.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(drillDownExportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DrillDownExport");
            XLSX.writeFile(wb, `${drillDownTitleForExport.replace(/[^a-zA-Z0-9]/g,'_')}_Export_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }
        
        function exportFullData() {
            if(!filteredData.length) {
                alert("No data to export.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(filteredData.map(d => d._raw));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "FilteredData");
            XLSX.writeFile(wb, `MSP_Filtered_Data_Export_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function exportMonthlyPerformance() {
            const metrics = monthlyPerformanceData;
            const exportData = [{
                'Report Period': 'Current Analysis',
                'Total Cases': metrics.totalCases,
                'SLA Compliance Rate': metrics.slaComplianceRate + '%',
                'First Contact Resolution Rate': metrics.fcrRate + '%',
                'Aging Compliance Rate': metrics.agingComplianceRate + '%',
                'Email Compliance Rate': metrics.emailComplianceRate + '%',
                'Follow-up Compliance Rate': metrics.followupComplianceRate + '%',
                'EDOC Compliance Rate': metrics.edocComplianceRate + '%',
                'Subsequent SLA Compliance Rate': metrics.subsequentSLAComplianceRate + '%',
                'SLA Violations': metrics.slaViolated,
                'FCR Missed': metrics.fcrMissed,
                'Aging >15 Days': metrics.agingViolated,
                'Email Compliance Issues': metrics.emailViolated,
                'Follow-up Missed': metrics.followupMissed,
                'EDOC Breaches': metrics.edocBreached,
                'Subsequent SLA Missed': metrics.subsequentSLAMissed,
                'INC <15 Days': metrics.incLess15,
                'INC >15 Days': metrics.incMore15,
                'SR <15 Days': metrics.srLess15,
                'SR >15 Days': metrics.srMore15
            }];
            
            // Add monthly breakdown
            const months = Object.keys(monthlyBreakdownData).sort((a, b) => {
                const [aMonth, aYear] = a.split('-').map(Number);
                const [bMonth, bYear] = b.split('-').map(Number);
                if (aYear !== bYear) return bYear - aYear;
                return bMonth - aMonth;
            });
            
            months.forEach(monthKey => {
                const data = monthlyBreakdownData[monthKey];
                const [month, year] = monthKey.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[parseInt(month) - 1];
                
                const slaRate = data.total > 0 ? 
                    (((data.total - data.slaViolated) / data.total) * 100).toFixed(1) : 100;
                
                const fcrRate = data.closedCases > 0 ? 
                    (((data.closedCases - data.fcrMissed) / data.closedCases) * 100).toFixed(1) : 100;
                
                exportData.push({
                    'Report Period': `${monthName} ${year}`,
                    'Total Cases': data.total,
                    'Logged Cases': data.loggedCases,
                    'Closed Cases': data.actuallyClosedCases,
                    'SLA Compliance Rate': slaRate + '%',
                    'First Contact Resolution Rate': fcrRate + '%',
                    'Aging Compliance Rate': data.total > 0 ? 
                        (((data.total - data.agingViolated) / data.total) * 100).toFixed(1) + '%' : '100%',
                    'Email Compliance Rate': data.total > 0 ? 
                        (((data.total - data.emailViolated) / data.total) * 100).toFixed(1) + '%' : '100%',
                    'Follow-up Compliance Rate': data.total > 0 ? 
                        (((data.total - data.followupMissed) / data.total) * 100).toFixed(1) + '%' : '100%',
                    'EDOC Compliance Rate': data.total > 0 ? 
                        (((data.total - data.edocBreached) / data.total) * 100).toFixed(1) + '%' : '100%',
                    'Subsequent SLA Compliance Rate': data.total > 0 ? 
                        (((data.total - data.subsequentSLAMissed) / data.total) * 100).toFixed(1) + '%' : '100%',
                    'SLA Violations': data.slaViolated,
                    'FCR Missed': data.fcrMissed,
                    'Aging >15 Days': data.agingViolated,
                    'Email Compliance Issues': data.emailViolated,
                    'Follow-up Missed': data.followupMissed,
                    'EDOC Breaches': data.edocBreached,
                    'Subsequent SLA Missed': data.subsequentSLAMissed,
                    'INC <15 Days': data.incLess15,
                    'INC >15 Days': data.incMore15,
                    'SR <15 Days': data.srLess15,
                    'SR >15 Days': data.srMore15
                });
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Monthly_Performance");
            XLSX.writeFile(wb, `MSP_Monthly_Performance_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function updateMonthlyComparison() {
            if (!filteredData || filteredData.length === 0) return;
            
            // Use filteredData instead of processedData to respect global filters
            // Use the same logic as calculateMonthlyBreakdown to ensure consistency
            const monthlyDataLogged = {};
            const monthlyDataClosed = {};
            const monthlyStats = {};
            
            // First pass: Count logged cases by submission month
            filteredData.forEach(d => {
                const monthKey = d.monthYear;
                if (!monthlyDataLogged[monthKey]) {
                    monthlyDataLogged[monthKey] = { loggedCases: 0, cpeLogged: 0 };
                }
                monthlyDataLogged[monthKey].loggedCases++;
                if (d.correspondingInternalTicket && d.correspondingInternalTicket !== 'N/A' && d.correspondingInternalTicket !== '') {
                    monthlyDataLogged[monthKey].cpeLogged++;
                }
            });
            
            // Second pass: Count closed cases by resolve month
            filteredData.forEach(d => {
                if (d.isClosed && d.resolveTime && d.resolveTime !== '--' && d.resolveTime !== 'NULL') {
                    const resolveDate = new Date(d.resolveTime);
                    if (!isNaN(resolveDate.getTime())) {
                        const monthKey = `${resolveDate.getMonth()+1}-${resolveDate.getFullYear()}`;
                        if (!monthlyDataClosed[monthKey]) {
                            monthlyDataClosed[monthKey] = { closedCases: 0, fcrCompliant: 0 };
                        }
                        monthlyDataClosed[monthKey].closedCases++;
                        if (d.agingDays < 2) monthlyDataClosed[monthKey].fcrCompliant++;
                    }
                }
            });
            
            // Third pass: Calculate all metrics by submission month
            filteredData.forEach(d => {
                const monthKey = d.monthYear;
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        total: 0,
                        loggedCases: 0,
                        closedCases: 0,
                        cpeLogged: 0,
                        fcrCompliant: 0,
                        slaViolated: 0,
                        subsequentSLA: 0,
                        totalAgingDays: 0,
                        incLogged: 0,
                        incClosed: 0,
                        srLogged: 0,
                        srClosed: 0,
                        closedForPerformance: 0,
                        // Add TAT tracking for new chart
                        tat247Values: [],
                        tatSLAValues: []
                    };
                }
                
                const stats = monthlyStats[monthKey];
                stats.total++;
                stats.loggedCases = monthlyDataLogged[monthKey]?.loggedCases || 0;
                stats.cpeLogged = monthlyDataLogged[monthKey]?.cpeLogged || 0;
                stats.closedCases = monthlyDataClosed[monthKey]?.closedCases || 0;
                stats.fcrCompliant = monthlyDataClosed[monthKey]?.fcrCompliant || 0;
                
                if (d.isSlaViolated) stats.slaViolated++;
                if (d.isClosed && d.subsequentSLABreachCount > 0) stats.subsequentSLA++;
                stats.totalAgingDays += d.agingDays || 0;
                
                // Track INC and SR separately
                if (d.isINC) {
                    stats.incLogged++;
                    if (d.isClosed) stats.incClosed++;
                }
                if (d.isSR) {
                    stats.srLogged++;
                    if (d.isClosed) stats.srClosed++;
                }
                
                // Count closed cases in this submission month for performance calculation
                if (d.isClosed) {
                    stats.closedForPerformance++;
                    // Collect TAT values for closed cases
                    stats.tat247Values.push(parseFloat(d.tat247) || 0);
                    if (d.tatSLA && parseFloat(d.tatSLA) > 0) {
                        stats.tatSLAValues.push(parseFloat(d.tatSLA));
                    }
                }
            });
            
            // Sort months chronologically
            const months = Object.keys(monthlyStats).sort((a, b) => {
                const [aMonth, aYear] = a.split('-').map(Number);
                const [bMonth, bYear] = b.split('-').map(Number);
                if (aYear !== bYear) return aYear - bYear;
                return aMonth - bMonth;
            });
            
            // Prepare data arrays for charts
            const monthLabels = months.map(m => {
                const [month, year] = m.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            
            const overallLoggedData = [];
            const overallClosedData = [];
            const slaComplianceData = [];
            const srLoggedData = [];
            const srClosedData = [];
            const incLoggedData = [];
            const incClosedData = [];
            const avgResolutionData = [];
            const performanceScoreData = [];
            const avg247Data = [];  // New: TAT(247) average data
            const avgSLAData = [];  // New: TAT(SLA) average data
            const cpeLoggedData = [];
            const fcrTrendData = [];
            
            const tableBody = document.getElementById('monthlyComparisonTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            months.forEach((monthKey, index) => {
                const stats = monthlyStats[monthKey];
                
                // Calculate metrics
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const avgResolution = stats.closedForPerformance > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                
                // Calculate TAT(247) average: SUM / COUNT
                const avg247 = stats.tat247Values.length > 0 
                    ? (stats.tat247Values.reduce((a, b) => a + b, 0) / stats.tat247Values.length).toFixed(1)
                    : 0;
                
                // Calculate TAT(SLA) average: AVERAGE of non-zero values
                const avgSLA = stats.tatSLAValues.length > 0
                    ? (stats.tatSLAValues.reduce((a, b) => a + b, 0) / stats.tatSLAValues.length).toFixed(1)
                    : 0;

                // FCR Calculation: (FCR Compliant Closed / Total Closed) * 100
                const fcrRate = stats.closedCases > 0 ? ((stats.fcrCompliant / stats.closedCases) * 100).toFixed(1) : 0;
                
                // Calculate performance score with Subsequent SLA Miss penalty
                let performanceScore = 0;
                if (stats.total > 0) {
                    const closureRate = stats.total > 0 ? ((stats.closedForPerformance / stats.total) * 100) : 0;
                    
                    // Base score: SLA Compliance (60%) + Closure Rate (40%)
                    performanceScore = (parseFloat(slaCompliance) * 0.6) + (closureRate * 0.4);
                    
                    // Penalty for subsequent SLA misses: -1% per miss
                    performanceScore -= (stats.subsequentSLA * 1);
                    
                    // Ensure score is between 0 and 100
                    performanceScore = Math.max(0, Math.min(100, performanceScore));
                }
                
                // Push data for charts
                overallLoggedData.push(stats.loggedCases);
                overallClosedData.push(stats.closedCases);
                slaComplianceData.push(parseFloat(slaCompliance));
                srLoggedData.push(stats.srLogged);
                srClosedData.push(stats.srClosed);
                incLoggedData.push(stats.incLogged);
                incClosedData.push(stats.incClosed);
                avgResolutionData.push(parseFloat(avgResolution));
                performanceScoreData.push(performanceScore);
                avg247Data.push(parseFloat(avg247));  // New: Push TAT(247) data
                avgSLAData.push(parseFloat(avgSLA));   // New: Push TAT(SLA) data
                cpeLoggedData.push(stats.cpeLogged);
                fcrTrendData.push(parseFloat(fcrRate));
                
                // Add table row
                const row = `
                    <tr>
                        <td><strong>${monthLabels[index]}</strong></td>
                        <td>${stats.loggedCases}</td>
                        <td>${stats.closedCases}</td>
                        <td>${stats.subsequentSLA}</td>
                        <td><span class="badge ${parseFloat(slaCompliance) >= 90 ? 'bg-success' : parseFloat(slaCompliance) >= 80 ? 'bg-warning' : 'bg-danger'}">${slaCompliance}%</span></td>
                        <td>${avg247} days</td>
                        <td><strong style="color: ${performanceScore >= 80 ? 'var(--success-color)' : performanceScore >= 65 ? 'var(--warning-color)' : 'var(--danger-color)'}">${performanceScore.toFixed(1)}</strong></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            // Destroy existing charts before creating new ones
            const chartIds = [
                'overallLoggedClosedChart', 'slaComplianceTrendChart', 'srLoggedClosedChart', 
                'incLoggedClosedChart', 'avgResolutionTrendChart', 'overallPerformanceTrendChart',
                'cpeLoggedTrendChart', 'monthlyFcrTrendChart'
            ];
            
            chartIds.forEach(id => {
                const chartInstance = Chart.getChart(id);
                if (chartInstance) {
                    chartInstance.destroy();
                }
            });

            if (window.comparisonCharts) {
                Object.values(window.comparisonCharts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        try {
                            // Check if chart is already destroyed (Chart.js 3+ properties)
                            if (chart.ctx) chart.destroy();
                        } catch(e) {
                            console.warn('Error destroying chart:', e);
                        }
                    }
                });
            }
            window.comparisonCharts = {};
            
            // Chart 1: Overall Logged vs Closed
            const overallLoggedClosedCtx = document.getElementById('overallLoggedClosedChart');
            if (overallLoggedClosedCtx) {
                window.comparisonCharts.overallLoggedClosed = new Chart(overallLoggedClosedCtx, {
                    type: 'bar',
                    data: {
                        labels: monthLabels,
                        datasets: [
                            {
                                label: 'Logged Cases',
                                data: overallLoggedData,
                                backgroundColor: 'rgba(0, 102, 204, 0.7)',
                                borderColor: '#0066cc',
                                borderWidth: 2,
                                type: 'bar',
                                order: 2
                            },
                            {
                                label: 'Closed Cases',
                                data: overallClosedData,
                                borderColor: '#00c853',
                                backgroundColor: 'rgba(0, 200, 83, 0.2)',
                                tension: 0.4,
                                fill: false,
                                borderWidth: 4,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                type: 'line',
                                order: 1,
                                pointBackgroundColor: '#00c853',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '600' },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                                padding: 12,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Cases',
                                    font: { size: 13, weight: '600' }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 2: SLA Compliance
            const slaComplianceCtx = document.getElementById('slaComplianceTrendChart');
            if (slaComplianceCtx) {
                const gradient = slaComplianceCtx.getContext('2d').createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(0, 200, 83, 0.4)');
                gradient.addColorStop(1, 'rgba(0, 200, 83, 0.05)');
                
                window.comparisonCharts.slaCompliance = new Chart(slaComplianceCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'SLA Compliance %',
                            data: slaComplianceData,
                            borderColor: '#00c853',
                            backgroundColor: gradient,
                            tension: 0.4,
                            fill: true,
                            borderWidth: 4,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#00c853',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 3,
                            pointHoverBorderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '600' },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                                padding: 12
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: false,
                                min: 75,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Compliance %',
                                    font: { size: 13, weight: '600' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 3: SR Logged vs Closed
            const srLoggedClosedCtx = document.getElementById('srLoggedClosedChart');
            if (srLoggedClosedCtx) {
                window.comparisonCharts.srLoggedClosed = new Chart(srLoggedClosedCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [
                            {
                                label: 'SR Logged',
                                data: srLoggedData,
                                borderColor: '#ff9100',
                                backgroundColor: 'rgba(255, 145, 0, 0)',
                                tension: 0.3,
                                fill: false,
                                borderWidth: 3,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                borderDash: [8, 4],
                                pointStyle: 'rect',
                                pointBackgroundColor: '#ff9100',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'SR Closed',
                                data: srClosedData,
                                borderColor: '#00b8d4',
                                backgroundColor: 'rgba(0, 184, 212, 0.2)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 4,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                pointStyle: 'circle',
                                pointBackgroundColor: '#00b8d4',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '600' },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Service Requests',
                                    font: { size: 13, weight: '600' }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 4: INC Logged vs Closed
            const incLoggedClosedCtx = document.getElementById('incLoggedClosedChart');
            if (incLoggedClosedCtx) {
                window.comparisonCharts.incLoggedClosed = new Chart(incLoggedClosedCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [
                            {
                                label: 'INC Logged',
                                data: incLoggedData,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211, 47, 47, 0)',
                                tension: 0,
                                fill: false,
                                borderWidth: 3,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                stepped: 'before',
                                pointStyle: 'triangle',
                                pointBackgroundColor: '#d32f2f',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'INC Closed',
                                data: incClosedData,
                                borderColor: '#7B1FA2',
                                backgroundColor: 'rgba(123, 31, 162, 0.25)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 4,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                pointStyle: 'circle',
                                pointBackgroundColor: '#7B1FA2',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '600' },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Incidents',
                                    font: { size: 13, weight: '600' }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 5: Average Resolution Time Trend (Dual Line: 24/7 vs Actual SLA)
            const avgResolutionCtx = document.getElementById('avgResolutionTrendChart');
            if (avgResolutionCtx) {
                window.comparisonCharts.avgResolution = new Chart(avgResolutionCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [
                            {
                                label: '24/7 Performance (Avg Days)',
                                data: avg247Data,
                                borderColor: '#ff9100',
                                backgroundColor: 'rgba(255, 145, 0, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#ff9100',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'Actual SLA Performance (Avg Days)',
                                data: avgSLAData,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211, 47, 47, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#d32f2f',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '600' },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' days';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Days',
                                    font: { size: 13, weight: '600' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + ' days';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0,
                                    autoSkip: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 6: Overall Performance Score Trend
            const perfScoreCtx = document.getElementById('overallPerformanceTrendChart');
            if (perfScoreCtx) {
                window.comparisonCharts.performanceScore = new Chart(perfScoreCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'Performance Score',
                            data: performanceScoreData,
                            borderColor: '#7B1FA2',
                            backgroundColor: 'rgba(123, 31, 162, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '600' },
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Score'
                                }
                            }
                        }
                    }
                });
            }

            // Chart 7: CPE Logged Trend
            const cpeLoggedCtx = document.getElementById('cpeLoggedTrendChart');
            if (cpeLoggedCtx) {
                window.comparisonCharts.cpeLogged = new Chart(cpeLoggedCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'CPE Logged',
                            data: cpeLoggedData,
                            borderColor: '#0066cc',
                            backgroundColor: 'rgba(0, 102, 204, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Count' } }
                        }
                    }
                });
            }

            // Chart 8: FCR Trend
            const fcrTrendCtx = document.getElementById('monthlyFcrTrendChart');
            if (fcrTrendCtx) {
                window.comparisonCharts.fcrTrend = new Chart(fcrTrendCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'FCR %',
                            data: fcrTrendData,
                            borderColor: '#00c853',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: { 
                                mode: 'index', 
                                intersect: false,
                                callbacks: { label: function(c) { return c.dataset.label + ': ' + c.parsed.y + '%'; } }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                max: 100, 
                                title: { display: true, text: 'Percentage' },
                                ticks: { callback: function(v) { return v + '%'; } }
                            }
                        }
                    }
                });
            }
        }

        function exportMonthlyComparison() {
            const monthlyStats = {};
            const monthlyDataLogged = {};
            const monthlyDataClosed = {};
            
            // Count logged cases by submission month
            filteredData.forEach(d => {
                const monthKey = d.monthYear;
                if (!monthlyDataLogged[monthKey]) {
                    monthlyDataLogged[monthKey] = { loggedCases: 0 };
                }
                monthlyDataLogged[monthKey].loggedCases++;
            });
            
            // Count closed cases by resolve month
            filteredData.forEach(d => {
                if (d.isClosed && d.resolveTime && d.resolveTime !== '--' && d.resolveTime !== 'NULL') {
                    const resolveDate = new Date(d.resolveTime);
                    if (!isNaN(resolveDate.getTime())) {
                        const monthKey = `${resolveDate.getMonth()+1}-${resolveDate.getFullYear()}`;
                        if (!monthlyDataClosed[monthKey]) {
                            monthlyDataClosed[monthKey] = { closedCases: 0 };
                        }
                        monthlyDataClosed[monthKey].closedCases++;
                    }
                }
            });
            
            // Calculate all metrics by submission month
            filteredData.forEach(d => {
                const monthKey = d.monthYear;
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        total: 0,
                        loggedCases: 0,
                        closedCases: 0,
                        slaViolated: 0,
                        subsequentSLA: 0,
                        totalAgingDays: 0,
                        incLogged: 0,
                        incClosed: 0,
                        srLogged: 0,
                        srClosed: 0
                    };
                }
                
                const stats = monthlyStats[monthKey];
                stats.total++;
                stats.loggedCases = monthlyDataLogged[monthKey]?.loggedCases || 0;
                stats.closedCases = monthlyDataClosed[monthKey]?.closedCases || 0;
                
                if (d.isSlaViolated) stats.slaViolated++;
                if (d.isClosed && d.subsequentSLABreachCount > 0) stats.subsequentSLA++;
                stats.totalAgingDays += d.agingDays || 0;
                
                if (d.isINC) {
                    stats.incLogged++;
                    if (d.isClosed) stats.incClosed++;
                }
                if (d.isSR) {
                    stats.srLogged++;
                    if (d.isClosed) stats.srClosed++;
                }
            });
            
            // Sort months chronologically
            const months = Object.keys(monthlyStats).sort((a, b) => {
                const [aMonth, aYear] = a.split('-').map(Number);
                const [bMonth, bYear] = b.split('-').map(Number);
                if (aYear !== bYear) return aYear - bYear;
                return aMonth - bMonth;
            });
            
            const exportData = months.map(monthKey => {
                const stats = monthlyStats[monthKey];
                const [month, year] = monthKey.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = `${monthNames[parseInt(month) - 1]} ${year}`;
                
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const avgResolution = stats.total > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                
                let performanceScore = 0;
                if (stats.total > 0) {
                    const closureRate = stats.total > 0 ? ((stats.closedCases / stats.loggedCases) * 100) : 0;
                    
                    // Base score: SLA Compliance (60%) + Closure Rate (40%)
                    performanceScore = (parseFloat(slaCompliance) * 0.6) + (closureRate * 0.4);
                    
                    // Penalty for subsequent SLA misses: -1% per miss
                    performanceScore -= (stats.subsequentSLA * 1);
                    
                    // Ensure score is between 0 and 100
                    performanceScore = Math.max(0, Math.min(100, performanceScore));
                }
                
                return {
                    'Month': monthName,
                    'Logged Cases': stats.loggedCases,
                    'Closed Cases': stats.closedCases,
                    'Subsequent SLA Miss': stats.subsequentSLA,
                    'SLA Compliance %': slaCompliance,
                    'Avg Resolution (Days)': avgResolution,
                    'SR Logged': stats.srLogged,
                    'SR Closed': stats.srClosed,
                    'INC Logged': stats.incLogged,
                    'INC Closed': stats.incClosed,
                    'Performance Score': performanceScore.toFixed(1)
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Monthly_Comparison");
            XLSX.writeFile(wb, `MSP_Monthly_Comparison_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function updateCategoryAnalysis() {
            if (!filteredData || filteredData.length === 0) return;
            
            // Use filteredData instead of processedData to respect global filters
            // Analyze by Support Category
            const categoryStats = {};
            filteredData.forEach(d => {
                const category = d.supportCategory || 'Uncategorized';
                if (!categoryStats[category]) {
                    categoryStats[category] = {
                        total: 0,
                        closed: 0,
                        slaViolated: 0,
                        totalAgingDays: 0,
                        features: {}
                    };
                }
                
                const stats = categoryStats[category];
                stats.total++;
                if (d.isClosed) stats.closed++;
                if (d.isSlaViolated) stats.slaViolated++;
                stats.totalAgingDays += d.agingDays || 0;
                
                // Track features within category
                const feature = d.feature || 'N/A';
                stats.features[feature] = (stats.features[feature] || 0) + 1;
            });
            
            // Analyze by Feature
            const featureStats = {};
            filteredData.forEach(d => {
                const feature = d.feature || 'N/A';
                if (!featureStats[feature]) {
                    featureStats[feature] = {
                        total: 0,
                        closed: 0,
                        slaViolated: 0,
                        totalAgingDays: 0,
                        subFeatures: {}
                    };
                }
                
                const stats = featureStats[feature];
                stats.total++;
                if (d.isClosed) stats.closed++;
                if (d.isSlaViolated) stats.slaViolated++;
                stats.totalAgingDays += d.agingDays || 0;
                
                // Track sub features
                const subFeature = d.subFeature || 'N/A';
                stats.subFeatures[subFeature] = (stats.subFeatures[subFeature] || 0) + 1;
            });
            
            // Destroy existing charts
            const catChartIds = ['supportCategoryChart', 'topFeaturesChart', 'topFeaturesSLAChart'];
            catChartIds.forEach(id => {
                const chartInstance = Chart.getChart(id);
                if (chartInstance) chartInstance.destroy();
            });

            if (window.categoryCharts) {
                Object.values(window.categoryCharts).forEach(chart => {
                    if (chart && chart.ctx) chart.destroy();
                });
            }
            window.categoryCharts = {};
            
            // Support Category Chart - Changed to Pie Chart with % and numbers
            const categoryLabels = Object.keys(categoryStats).sort();
            const categoryCounts = categoryLabels.map(cat => categoryStats[cat].total);
            const totalCategoryCases = categoryCounts.reduce((a, b) => a + b, 0);
            
            // Create pie chart data with percentages
            const categoryColors = ['#0066cc', '#00c853', '#ff9100', '#00b8d4', '#d32f2f', '#7B1FA2', '#FF4081', '#FF9800', '#4CAF50', '#2196F3'];
            
            const supportCategoryCtx = document.getElementById('supportCategoryChart');
            if (supportCategoryCtx) {
                window.categoryCharts.supportCategory = new Chart(supportCategoryCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryLabels.map((label, index) => {
                            const count = categoryCounts[index];
                            const percentage = totalCategoryCases > 0 ? ((count / totalCategoryCases) * 100).toFixed(1) : 0;
                            return `${label} (${count} - ${percentage}%)`;
                        }),
                        datasets: [{
                            data: categoryCounts,
                            backgroundColor: categoryColors.slice(0, categoryLabels.length),
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'right',
                                labels: {
                                    font: { 
                                        size: 11,
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label.split(' (')[0]}: ${value} cases (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Top 10 Features by Volume
            const topFeatures = Object.entries(featureStats)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            const topFeaturesCtx = document.getElementById('topFeaturesChart');
            if (topFeaturesCtx) {
                window.categoryCharts.topFeatures = new Chart(topFeaturesCtx, {
                    type: 'bar',
                    data: {
                        labels: topFeatures.map(f => f[0]),
                        datasets: [{
                            label: 'Total Cases',
                            data: topFeatures.map(f => f[1].total),
                            backgroundColor: '#00c853'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Top 10 Features by SLA Violations
            const topFeaturesSLA = Object.entries(featureStats)
                .sort((a, b) => b[1].slaViolated - a[1].slaViolated)
                .slice(0, 10);
            
            const topFeaturesSLACtx = document.getElementById('topFeaturesSLAChart');
            if (topFeaturesSLACtx) {
                window.categoryCharts.topFeaturesSLA = new Chart(topFeaturesSLACtx, {
                    type: 'bar',
                    data: {
                        labels: topFeaturesSLA.map(f => f[0]),
                        datasets: [{
                            label: 'SLA Violations',
                            data: topFeaturesSLA.map(f => f[1].slaViolated),
                            backgroundColor: '#d32f2f'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Category Performance Table
            const categoryTableBody = document.getElementById('categoryPerformanceTableBody');
            if (categoryTableBody) {
                categoryTableBody.innerHTML = '';
                
                Object.keys(categoryStats).sort().forEach(category => {
                    const stats = categoryStats[category];
                    const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                    const avgResolution = stats.total > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                    const topFeature = Object.entries(stats.features).sort((a, b) => b[1] - a[1])[0];
                    
                    const row = `
                        <tr>
                            <td><strong>${category}</strong></td>
                            <td>${stats.total}</td>
                            <td>${stats.closed}</td>
                            <td>${stats.slaViolated}</td>
                            <td><span class="badge ${parseFloat(slaCompliance) >= 90 ? 'bg-success' : parseFloat(slaCompliance) >= 80 ? 'bg-warning' : 'bg-danger'}">${slaCompliance}%</span></td>
                            <td>${avgResolution} days</td>
                            <td>${topFeature ? topFeature[0] : 'N/A'}</td>
                        </tr>
                    `;
                    categoryTableBody.innerHTML += row;
                });
            }
            
            // Feature Performance Table
            const featureTableBody = document.getElementById('featurePerformanceTableBody');
            if (featureTableBody) {
                featureTableBody.innerHTML = '';
                
                Object.keys(featureStats).sort().forEach(feature => {
                    const stats = featureStats[feature];
                    const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                    const avgResolution = stats.total > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                    const topSubFeature = Object.entries(stats.subFeatures).sort((a, b) => b[1] - a[1])[0];
                    
                    const row = `
                        <tr>
                            <td><strong>${feature}</strong></td>
                            <td>${stats.total}</td>
                            <td>${stats.closed}</td>
                            <td>${stats.slaViolated}</td>
                            <td><span class="badge ${parseFloat(slaCompliance) >= 90 ? 'bg-success' : parseFloat(slaCompliance) >= 80 ? 'bg-warning' : 'bg-danger'}">${slaCompliance}%</span></td>
                            <td>${avgResolution} days</td>
                            <td>${topSubFeature ? topSubFeature[0] : 'N/A'}</td>
                        </tr>
                    `;
                    featureTableBody.innerHTML += row;
                });
            }
        }

        function exportCategoryAnalysis() {
            const categoryStats = {};
            const featureStats = {};
            
            filteredData.forEach(d => {
                const category = d.supportCategory || 'Uncategorized';
                if (!categoryStats[category]) {
                    categoryStats[category] = { total: 0, closed: 0, slaViolated: 0, totalAgingDays: 0 };
                }
                categoryStats[category].total++;
                if (d.isClosed) categoryStats[category].closed++;
                if (d.isSlaViolated) categoryStats[category].slaViolated++;
                categoryStats[category].totalAgingDays += d.agingDays || 0;
                
                const feature = d.feature || 'N/A';
                if (!featureStats[feature]) {
                    featureStats[feature] = { total: 0, closed: 0, slaViolated: 0, totalAgingDays: 0 };
                }
                featureStats[feature].total++;
                if (d.isClosed) featureStats[feature].closed++;
                if (d.isSlaViolated) featureStats[feature].slaViolated++;
                featureStats[feature].totalAgingDays += d.agingDays || 0;
            });
            
            const exportData = [];
            
            // Category data
            Object.keys(categoryStats).sort().forEach(category => {
                const stats = categoryStats[category];
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const avgResolution = stats.total > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                
                exportData.push({
                    'Type': 'Category',
                    'Name': category,
                    'Total Cases': stats.total,
                    'Closed Cases': stats.closed,
                    'SLA Violations': stats.slaViolated,
                    'SLA Compliance %': slaCompliance,
                    'Avg Resolution (Days)': avgResolution
                });
            });
            
            // Feature data
            Object.keys(featureStats).sort().forEach(feature => {
                const stats = featureStats[feature];
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const avgResolution = stats.total > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                
                exportData.push({
                    'Type': 'Feature',
                    'Name': feature,
                    'Total Cases': stats.total,
                    'Closed Cases': stats.closed,
                    'SLA Violations': stats.slaViolated,
                    'SLA Compliance %': slaCompliance,
                    'Avg Resolution (Days)': avgResolution
                });
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Category_Analysis");
            XLSX.writeFile(wb, `MSP_Category_Analysis_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function exportCustomerPerformance() {
            const customerStats = {};
            
            filteredData.forEach(d => {
                if(!customerStats[d.submittedBy]) {
                    customerStats[d.submittedBy] = {
                        total: 0,
                        closed: 0,
                        slaViolated: 0,
                        cpeCalls: 0,
                        totalAgingDays: 0
                    };
                }
                customerStats[d.submittedBy].total++;
                customerStats[d.submittedBy].totalAgingDays += parseFloat(d.agingDays) || 0;
                if(d.isClosed) customerStats[d.submittedBy].closed++;
                if(d.isSlaViolated) customerStats[d.submittedBy].slaViolated++;
                
                const ticket = d.correspondingInternalTicket;
                if (ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0') {
                    customerStats[d.submittedBy].cpeCalls++;
                }
            });
            
            const exportData = Object.keys(customerStats).sort().map(customer => {
                const stats = customerStats[customer];
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const avgResolutionTime = stats.total > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                const fcrRate = stats.closed > 0 ? ((filteredData.filter(d => d.submittedBy === customer && d.isClosed && d.agingDays < 2).length / stats.closed) * 100).toFixed(1) : 0;
                
                return {
                    'Submitted By': customer,
                    'Total Cases': stats.total,
                    'Closed Cases': stats.closed,
                    'SLA Compliance': slaCompliance + '%',
                    'Avg Resolution Days - 24/7': avgResolutionTime,
                    'FCR Rate': fcrRate + '%',
                    'CPE Calls': stats.cpeCalls
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Customer_Performance");
            XLSX.writeFile(wb, `Customer_Performance_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function exportEngineerPerformance() {
            const engineerStats = {};
            
            filteredData.forEach(d => {
                if(!engineerStats[d.owner]) {
                    engineerStats[d.owner] = {
                        total: 0,
                        closed: 0,
                        slaViolated: 0,
                        fcr: 0,
                        subsequentSLA: 0,
                        cpeCalls: 0,
                        totalAgingDays: 0
                    };
                }
                engineerStats[d.owner].total++;
                engineerStats[d.owner].totalAgingDays += parseFloat(d.agingDays) || 0;
                if(d.isClosed) {
                    engineerStats[d.owner].closed++;
                    if(d.agingDays < 2) engineerStats[d.owner].fcr++;
                    if(d.subsequentSLABreachCount > 0) engineerStats[d.owner].subsequentSLA++;
                }
                if(d.isSlaViolated) engineerStats[d.owner].slaViolated++;
                
                const ticket = d.correspondingInternalTicket;
                if (ticket && ticket.toString().trim() !== '' && ticket.toString().trim() !== '0') {
                    engineerStats[d.owner].cpeCalls++;
                }
            });
            
            const exportData = Object.keys(engineerStats).sort().map(engineer => {
                const stats = engineerStats[engineer];
                const slaCompliance = stats.total > 0 ? (((stats.total - stats.slaViolated) / stats.total) * 100).toFixed(1) : 100;
                const fcrRate = stats.closed > 0 ? ((stats.fcr / stats.closed) * 100).toFixed(1) : 0;
                const avgResolutionTime = stats.total > 0 ? (stats.totalAgingDays / stats.total).toFixed(1) : 0;
                
                // Calculate performance score (0-100)
                let performanceScore = 0;
                if (stats.total > 0) {
                    // SLA Compliance weight: 40%
                    performanceScore += (parseFloat(slaCompliance) * 0.4);
                    
                    // FCR Rate weight: 30%
                    performanceScore += (parseFloat(fcrRate) * 0.3);
                    
                    // Closure Rate weight: 20%
                    const closureRate = stats.total > 0 ? ((stats.closed / stats.total) * 100) : 0;
                    performanceScore += (closureRate * 0.2);
                    
                    // Penalty for subsequent SLA misses: -1% per miss
                    performanceScore -= (stats.subsequentSLA * 1);
                    
                    // Penalty for CPE calls: -0.5% per call
                    performanceScore -= (stats.cpeCalls * 0.5);
                    
                    // Ensure score is between 0 and 100
                    performanceScore = Math.max(0, Math.min(100, performanceScore));
                }
                
                return {
                    'Owner': engineer,
                    'Total Cases': stats.total,
                    'Closed Cases': stats.closed,
                    'SLA Compliance': slaCompliance + '%',
                    'FCR Rate': fcrRate + '%',
                    'Avg Resolution Days - 24/7': avgResolutionTime,
                    'Subsequent SLA Miss': stats.subsequentSLA,
                    'CPE Calls': stats.cpeCalls,
                    'Performance Score': performanceScore.toFixed(1)
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Engineer_Performance");
            XLSX.writeFile(wb, `Engineer_Performance_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }
        
        function filterCases() {
            // This function handles tab-specific filtering
            // Implementation depends on specific tab requirements
        }
        
        function downloadDashboardPDF() {
            showLoading(true);
            
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Get the active tab content
                const activeTab = document.querySelector('.tab-pane.active');
                if (!activeTab) {
                    showLoading(false);
                    alert('No active view to export');
                    return;
                }
                
                // Get the tab name for the title
                const activeTabButton = document.querySelector('.nav-link.active');
                const tabName = activeTabButton ? activeTabButton.textContent.trim() : 'Dashboard';
                
                // Clone the active tab to avoid modifying the original
                const clonedTab = activeTab.cloneNode(true);
                
                // Make all nested tab content visible for PDF (remove fade/show classes)
                const nestedTabPanes = clonedTab.querySelectorAll('.tab-pane');
                nestedTabPanes.forEach(pane => {
                    pane.classList.remove('fade');
                    pane.classList.add('show', 'active');
                    pane.style.display = 'block';
                    pane.style.opacity = '1';
                });
                
                // Make all accordion content visible
                const accordionCollapses = clonedTab.querySelectorAll('.accordion-collapse');
                accordionCollapses.forEach(collapse => {
                    collapse.classList.add('show');
                    collapse.style.display = 'block';
                });
                
                // Remove all buttons and interactive elements from clone
                const elementsToRemove = clonedTab.querySelectorAll('.btn, button, .no-print, input, select');
                elementsToRemove.forEach(el => el.remove());
                
                // Temporarily add clone to document for rendering
                clonedTab.style.position = 'absolute';
                clonedTab.style.left = '-9999px';
                clonedTab.style.width = '1200px';
                clonedTab.style.background = 'white';
                clonedTab.style.padding = '20px';
                clonedTab.style.overflow = 'visible';
                clonedTab.style.height = 'auto';
                document.body.appendChild(clonedTab);
                
                // Give browser time to render all content
                setTimeout(() => {
                    // Use html2canvas to capture the content
                    html2canvas(clonedTab, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: clonedTab.scrollWidth,
                        height: clonedTab.scrollHeight,
                        windowWidth: clonedTab.scrollWidth,
                        windowHeight: clonedTab.scrollHeight
                    }).then(canvas => {
                        // Remove the cloned element
                        document.body.removeChild(clonedTab);
                        
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 190; // Leave margins
                        const pageHeight = 277; // A4 height minus margins
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        // Add header with logo and title on first page
                        pdf.setFillColor(0, 102, 204);
                        pdf.rect(0, 0, 210, 25, 'F');
                        
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(20);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('MSP Support Dashboard', 105, 12, { align: 'center' });
                        
                        pdf.setFontSize(12);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(tabName, 105, 19, { align: 'center' });
                        
                        let heightLeft = imgHeight;
                        let position = 30; // Start below header
                        
                        // Add first page content
                        if (heightLeft + position > pageHeight) {
                            // Content is taller than one page
                            const firstPageHeight = pageHeight - position;
                            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                            heightLeft -= (pageHeight - position);
                            
                            // Add subsequent pages
                            while (heightLeft > 0) {
                                pdf.addPage();
                                position = heightLeft - imgHeight + 10;
                                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                                heightLeft -= pageHeight;
                            }
                        } else {
                            // Content fits in one page
                            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        }
                        
                        // Generate filename with current date and tab name
                        const dateStr = new Date().toLocaleDateString().replace(/\//g,'-');
                        const sanitizedTabName = tabName.replace(/[^a-z0-9]/gi, '_');
                        const filename = `MSP_${sanitizedTabName}_${dateStr}.pdf`;
                        pdf.save(filename);
                        
                        showLoading(false);
                    }).catch(error => {
                        // Clean up clone if still exists
                        if (document.body.contains(clonedTab)) {
                            document.body.removeChild(clonedTab);
                        }
                        console.error('PDF generation error:', error);
                        alert('Error generating PDF. Please try again.');
                        showLoading(false);
                    });
                }, 500); // Give time for content to render
            } catch(error) {
                console.error('PDF setup error:', error);
                alert('Error generating PDF. Please try again.');
                showLoading(false);
            }
        }
        
        function processData() {
            // Already implemented in the main flow
        }

        // Monthly Accounts Review Functions
        let marOverallVolumeChart = null;
        let marAvgResolutionChart = null;
        let marSLAComplianceChart = null;
        let marCustomerData = {};

        function initializeMonthlyAccountsReview() {
            // This function will be called when data is loaded
            // It will use the global filters to determine which customer to show
            loadMonthlyAccountsReview();
        }

        function loadMonthlyAccountsReview() {
            // Determine which filter is active and get its value
            let filterName = 'All Customers';
            let customerData = filteredData;
            
            // Check which filter is active (in priority order)
            if (globalFilters.owner) {
                filterName = `Owner: ${globalFilters.owner}`;
                customerData = filteredData.filter(d => d.owner === globalFilters.owner);
            } else if (globalFilters.submittedby) {
                filterName = `Customer: ${globalFilters.submittedby}`;
                customerData = filteredData.filter(d => d.submittedBy === globalFilters.submittedby);
            } else if (globalFilters.service) {
                filterName = `Service: ${globalFilters.service}`;
                customerData = filteredData.filter(d => d.service === globalFilters.service);
            } else if (globalFilters.status) {
                filterName = `Status: ${globalFilters.status}`;
                customerData = filteredData.filter(d => d.currentStatus === globalFilters.status);
            }
            
            if (customerData.length === 0) {
                // No data for this filter
                updateMarReport({
                    totalLogged: 0,
                    incLogged: 0,
                    srLogged: 0,
                    totalClosed: 0,
                    incClosed: 0,
                    srClosed: 0,
                    totalOpen: 0,
                    incOpen: 0,
                    srOpen: 0,
                    slaViolated: 0,
                    avgIncResolution247: '0.0',
                    avgSRResolution247: '0.0',
                    avgIncResolutionSLA: '0.0',
                    avgSRResolutionSLA: '0.0',
                    slaCompliance: 100,
                    csatScore: null,
                    csatCount: 0,
                    monthlyBreakdown: {}
                }, filterName);
                return;
            }
            
            marCustomerData = calculateCustomerMetrics(customerData);
            updateMarReport(marCustomerData, filterName);
        }

        function calculateCustomerMetrics(customerData) {
            const metrics = {
                // Total counts
                totalLogged: customerData.length,
                incLogged: customerData.filter(d => d.isINC).length,
                srLogged: customerData.filter(d => d.isSR).length,
                
                // Closed counts - must be "Close" or "Resolve - Pending User Confirmation"
                totalClosed: customerData.filter(d => d.isClosed).length,
                incClosed: customerData.filter(d => d.isClosed && d.isINC).length,
                srClosed: customerData.filter(d => d.isClosed && d.isSR).length,
                
                // Open counts - excluding "Close", "Resolve - Pending User Confirmation", and empty statuses
                totalOpen: customerData.filter(d => !d.isClosed && d.currentStatus && d.currentStatus.trim() !== '').length,
                incOpen: customerData.filter(d => !d.isClosed && d.isINC && d.currentStatus && d.currentStatus.trim() !== '').length,
                srOpen: customerData.filter(d => !d.isClosed && d.isSR && d.currentStatus && d.currentStatus.trim() !== '').length,
                
                // SLA violations among CLOSED cases only
                slaViolatedClosed: customerData.filter(d => d.isClosed && d.isSlaViolated).length,
                slaViolated: customerData.filter(d => d.isSlaViolated).length,
                
                // Get CLOSED cases for calculations
                closedSRCases: customerData.filter(d => d.isClosed && d.isSR),
                closedINCCases: customerData.filter(d => d.isClosed && d.isINC),
                
                // CSAT data (placeholder)
                csatScore: null,
                csatCount: 0
            };
            
            // Calculate 24/7 Performance (AVG Days) - SUMIFS / COUNTIFS as per Excel formula
            // For SR: SUM(TAT247 values) / COUNT(closed SR cases)
            const srTat247Sum = metrics.closedSRCases.reduce((sum, d) => sum + (parseFloat(d.tat247) || 0), 0);
            const srClosedCount = metrics.closedSRCases.length;
            metrics.avgSRResolution247 = srClosedCount > 0 ? (srTat247Sum / srClosedCount).toFixed(1) : '0.0';
            
            // For INC: SUM(TAT247 values) / COUNT(closed INC cases)
            const incTat247Sum = metrics.closedINCCases.reduce((sum, d) => sum + (parseFloat(d.tat247) || 0), 0);
            const incClosedCount = metrics.closedINCCases.length;
            metrics.avgIncResolution247 = incClosedCount > 0 ? (incTat247Sum / incClosedCount).toFixed(1) : '0.0';
            
            // Calculate Actual SLA Performance (AVG Days) - AVERAGE as per Excel formula
            // For SR: AVERAGE(TAT(SLA) values for closed SR)
            const srTatSLAValues = metrics.closedSRCases.map(d => parseFloat(d.tatSLA) || 0).filter(v => v > 0);
            metrics.avgSRResolutionSLA = srTatSLAValues.length > 0
                ? (srTatSLAValues.reduce((a, b) => a + b, 0) / srTatSLAValues.length).toFixed(1)
                : '0.0';
            
            // For INC: AVERAGE(TAT(SLA) values for closed INC)
            const incTatSLAValues = metrics.closedINCCases.map(d => parseFloat(d.tatSLA) || 0).filter(v => v > 0);
            metrics.avgIncResolutionSLA = incTatSLAValues.length > 0
                ? (incTatSLAValues.reduce((a, b) => a + b, 0) / incTatSLAValues.length).toFixed(1)
                : '0.0';
            
            // Calculate SLA compliance percentage - using CLOSED cases only in denominator
            metrics.slaCompliance = metrics.totalClosed > 0 
                ? (((metrics.totalClosed - metrics.slaViolatedClosed) / metrics.totalClosed) * 100).toFixed(1)
                : 100;
            
            // Calculate monthly breakdown for charts - EXACTLY like Monthly Performance Comparison
            const monthlyDataLogged = {};  // Track by submission date
            const monthlyDataClosed = {};  // Track by resolve date
            
            // First pass: Count logged cases by submission month
            customerData.forEach(d => {
                const monthKey = d.monthYear;  // Already based on submissionTime
                if (!monthlyDataLogged[monthKey]) {
                    monthlyDataLogged[monthKey] = {
                        loggedCases: 0,
                        incLogged: 0,
                        srLogged: 0
                    };
                }
                monthlyDataLogged[monthKey].loggedCases++;
                if (d.isINC) monthlyDataLogged[monthKey].incLogged++;
                if (d.isSR) monthlyDataLogged[monthKey].srLogged++;
            });
            
            // Second pass: Count closed cases by resolve month
            customerData.forEach(d => {
                if (d.isClosed && d.resolveTime && d.resolveTime !== '--' && d.resolveTime !== 'NULL') {
                    const resolveDate = new Date(d.resolveTime);
                    if (!isNaN(resolveDate.getTime())) {
                        const monthKey = `${resolveDate.getMonth()+1}-${resolveDate.getFullYear()}`;
                        if (!monthlyDataClosed[monthKey]) {
                            monthlyDataClosed[monthKey] = {
                                closedCases: 0,
                                incClosed: 0,
                                srClosed: 0
                            };
                        }
                        monthlyDataClosed[monthKey].closedCases++;
                        if (d.isINC) monthlyDataClosed[monthKey].incClosed++;
                        if (d.isSR) monthlyDataClosed[monthKey].srClosed++;
                    }
                }
            });
            
            // Third pass: Calculate performance metrics by submission month
            const monthlyData = {};
            customerData.forEach(d => {
                const monthKey = d.monthYear;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        total: 0,
                        loggedCases: 0,
                        incLogged: 0,
                        srLogged: 0,
                        closedCases: 0,
                        incClosed: 0,
                        srClosed: 0,
                        totalAgingDays: 0,
                        slaViolated: 0,
                        slaViolatedClosed: 0,
                        incResolutionTimes247: [],
                        srResolutionTimes247: [],
                        incResolutionTimesSLA: [],
                        srResolutionTimesSLA: []
                    };
                }
                
                // Increment counters for this submission month
                monthlyData[monthKey].total++;
                monthlyData[monthKey].loggedCases = monthlyDataLogged[monthKey]?.loggedCases || 0;
                monthlyData[monthKey].incLogged = monthlyDataLogged[monthKey]?.incLogged || 0;
                monthlyData[monthKey].srLogged = monthlyDataLogged[monthKey]?.srLogged || 0;
                
                // Add aging days for ALL cases (not just closed) - THIS IS KEY for avg resolution calculation
                monthlyData[monthKey].totalAgingDays += parseFloat(d.agingDays) || 0;
                
                // Track SLA violations
                if (d.isSlaViolated) {
                    monthlyData[monthKey].slaViolated++;
                    if (d.isClosed) {
                        monthlyData[monthKey].slaViolatedClosed++;
                    }
                }
                
                // Collect resolution times for closed cases only - using TAT columns
                if (d.isClosed) {
                    if (d.isINC) {
                        monthlyData[monthKey].incResolutionTimes247.push(parseFloat(d.tat247) || 0);
                        monthlyData[monthKey].incResolutionTimesSLA.push(parseFloat(d.tatSLA) || 0);
                    } else if (d.isSR) {
                        monthlyData[monthKey].srResolutionTimes247.push(parseFloat(d.tat247) || 0);
                        monthlyData[monthKey].srResolutionTimesSLA.push(parseFloat(d.tatSLA) || 0);
                    }
                }
            });
            
            // Add closed counts from resolve date tracking
            Object.keys(monthlyDataClosed).forEach(monthKey => {
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        total: 0,
                        loggedCases: 0,
                        incLogged: 0,
                        srLogged: 0,
                        closedCases: 0,
                        incClosed: 0,
                        srClosed: 0,
                        totalAgingDays: 0,
                        slaViolated: 0,
                        slaViolatedClosed: 0,
                        incResolutionTimes247: [],
                        srResolutionTimes247: [],
                        incResolutionTimesSLA: [],
                        srResolutionTimesSLA: []
                    };
                }
                monthlyData[monthKey].closedCases = monthlyDataClosed[monthKey].closedCases;
                monthlyData[monthKey].incClosed = monthlyDataClosed[monthKey].incClosed;
                monthlyData[monthKey].srClosed = monthlyDataClosed[monthKey].srClosed;
            });
            
            // Calculate average resolution times per month
            Object.keys(monthlyData).forEach(monthKey => {
                const data = monthlyData[monthKey];
                
                // Calculate 24/7 Performance averages using SUM/COUNT (SUMIFS/COUNTIFS)
                // For INC: SUM of TAT247 values / COUNT of closed INC
                const incTat247Sum = data.incResolutionTimes247.reduce((a, b) => a + b, 0);
                data.avgIncResolution247 = data.incResolutionTimes247.length > 0
                    ? (incTat247Sum / data.incResolutionTimes247.length).toFixed(1)
                    : 0;
                
                // For SR: SUM of TAT247 values / COUNT of closed SR
                const srTat247Sum = data.srResolutionTimes247.reduce((a, b) => a + b, 0);
                data.avgSRResolution247 = data.srResolutionTimes247.length > 0
                    ? (srTat247Sum / data.srResolutionTimes247.length).toFixed(1)
                    : 0;
                
                // Calculate Actual SLA Performance averages using AVERAGE function
                // For INC: AVERAGE of TAT(SLA) values (excluding zeros)
                const incTatSLANonZero = data.incResolutionTimesSLA.filter(v => v > 0);
                data.avgIncResolutionSLA = incTatSLANonZero.length > 0
                    ? (incTatSLANonZero.reduce((a, b) => a + b, 0) / incTatSLANonZero.length).toFixed(1)
                    : 0;
                
                // For SR: AVERAGE of TAT(SLA) values (excluding zeros)
                const srTatSLANonZero = data.srResolutionTimesSLA.filter(v => v > 0);
                data.avgSRResolutionSLA = srTatSLANonZero.length > 0
                    ? (srTatSLANonZero.reduce((a, b) => a + b, 0) / srTatSLANonZero.length).toFixed(1)
                    : 0;
                
                // Keep the resolution times arrays for chart usage
                // Don't delete them - they're needed for the trend charts
            });
            
            metrics.monthlyBreakdown = monthlyData;
            
            return metrics;
        }

        function updateMarReport(metrics, customerName) {
            // Get data period - use filteredData when timescale is not "All Time", otherwise use rawData
            const useFilteredDates = globalFilters.timescale && globalFilters.timescale !== 'all';
            const dataSource = useFilteredDates ? filteredData : rawData;
            
            const dates = dataSource
                .map(row => {
                    // For filteredData (processed data), use submissionDate directly
                    if (useFilteredDates && row.submissionDate) {
                        return row.submissionDate;
                    }
                    // For rawData, parse from submission time column
                    const submissionTime = row['Submission Time'] || row['Submission time'] || 
                                         row['Created Date'] || row['Created Time'] || 
                                         row['SubmissionTime'] || row['CreatedDate'];
                    if (submissionTime && submissionTime !== '--' && submissionTime !== 'NULL') {
                        const date = new Date(submissionTime);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    return null;
                })
                .filter(d => d !== null)
                .sort((a, b) => a - b);
            
            let yearText = '2025';
            let periodText = 'December 2025';
            
            if (dates.length > 0) {
                const minDate = dates[0];
                const maxDate = dates[dates.length - 1];
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
                
                // Get year range
                const minYear = minDate.getFullYear();
                const maxYear = maxDate.getFullYear();
                yearText = minYear === maxYear ? minYear.toString() : `${minYear}-${maxYear}`;
                
                // Get month-year range for report period
                const minMonthYear = `${monthNames[minDate.getMonth()]} ${minDate.getFullYear()}`;
                const maxMonthYear = `${monthNames[maxDate.getMonth()]} ${maxDate.getFullYear()}`;
                periodText = minMonthYear === maxMonthYear ? minMonthYear : `${minMonthYear} - ${maxMonthYear}`;
            }
            
            // Update title year
            document.getElementById('mar-title-year').textContent = yearText;
            
            // Update report period
            document.getElementById('mar-report-period').textContent = periodText;
            
            // Update customer name
            document.getElementById('mar-customer-name').textContent = customerName;
            
            // Update TAM name
            document.getElementById('mar-tam-name').textContent = 'Adavayya Vastrad';
            
            // Update KPIs
            updateMarKPIs(metrics);
            
            // Update tables
            updateMarTables(metrics);
            
            // Update charts
            updateMarCharts(metrics);
            
            // Update open cases overview
            updateMarOpenCases(metrics);
        }

        function updateMarKPIs(metrics) {
            // SLA Compliance
            const slaCard = document.getElementById('mar-card-sla');
            const slaValue = document.getElementById('mar-sla-value');
            const slaText = document.getElementById('mar-sla-text');
            
            slaValue.textContent = metrics.slaCompliance + '%';
            slaCard.className = 'mar-kpi-card'; // Reset classes
            
            if (metrics.slaCompliance >= 95) {
                slaText.textContent = 'Excellent';
                slaText.className = 'mar-kpi-sub txt-success';
                slaCard.classList.add('border-success');
            } else if (metrics.slaCompliance >= 85) {
                slaText.textContent = 'Good';
                slaText.className = 'mar-kpi-sub txt-warning';
                slaCard.classList.add('border-warning');
            } else {
                slaText.textContent = 'Action Required';
                slaText.className = 'mar-kpi-sub txt-danger';
                slaCard.classList.add('border-danger');
            }
            
            // CSAT Score
            document.getElementById('mar-csat-value').textContent = metrics.csatScore || 'N/A';
            document.getElementById('mar-csat-count').textContent = metrics.csatCount;
            
            // Tickets Logged
            document.getElementById('mar-logged-value').textContent = metrics.totalLogged;
            
            // Tickets Resolved
            document.getElementById('mar-resolved-value').textContent = metrics.totalClosed;
        }

        function updateMarTables(metrics) {
            // Ticket Volume Analysis Table
            document.getElementById('mar-inc-open').textContent = metrics.incOpen;
            document.getElementById('mar-inc-logged').textContent = metrics.incLogged;
            document.getElementById('mar-inc-resolved').textContent = metrics.incClosed;
            
            document.getElementById('mar-sr-open').textContent = metrics.srOpen;
            document.getElementById('mar-sr-logged').textContent = metrics.srLogged;
            document.getElementById('mar-sr-resolved').textContent = metrics.srClosed;
            
            document.getElementById('mar-total-open').textContent = metrics.totalOpen;
            document.getElementById('mar-total-logged').textContent = metrics.totalLogged;
            document.getElementById('mar-total-resolved').textContent = metrics.totalClosed;
            
            // Performance (Avg Days) Table
            document.getElementById('mar-time-inc-247').textContent = metrics.avgIncResolution247;
            document.getElementById('mar-time-inc-sla').textContent = metrics.avgIncResolutionSLA;
            document.getElementById('mar-time-sr-247').textContent = metrics.avgSRResolution247;
            document.getElementById('mar-time-sr-sla').textContent = metrics.avgSRResolutionSLA;
        }

        function updateMarCharts(metrics) {
            // Get sorted months for all charts
            const monthlyData = metrics.monthlyBreakdown || {};
            
            // Filter months based on timescale selection
            let filteredMonthlyData = monthlyData;
            if (globalFilters.timescale && globalFilters.timescale !== 'all') {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth(); // 0-indexed (0 = Jan, 1 = Feb, etc.)
                
                let startMonth = null;
                let startYear = null;
                let endMonth = null;
                let endYear = null;
                
                switch(globalFilters.timescale) {
                    case 'current-month':
                        startMonth = currentMonth;
                        startYear = currentYear;
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-month':
                        const lastMonth = new Date(currentYear, currentMonth - 1, 1);
                        startMonth = lastMonth.getMonth();
                        startYear = lastMonth.getFullYear();
                        endMonth = lastMonth.getMonth();
                        endYear = lastMonth.getFullYear();
                        break;
                        
                    case 'last-month-include-current':
                        const lastMonthIncl = new Date(currentYear, currentMonth - 1, 1);
                        startMonth = lastMonthIncl.getMonth();
                        startYear = lastMonthIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-2-months':
                        const last2Months = new Date(currentYear, currentMonth - 2, 1);
                        startMonth = last2Months.getMonth();
                        startYear = last2Months.getFullYear();
                        const endLast2 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast2.getMonth();
                        endYear = endLast2.getFullYear();
                        break;
                        
                    case 'last-2-months-include-current':
                        const last2MonthsIncl = new Date(currentYear, currentMonth - 2, 1);
                        startMonth = last2MonthsIncl.getMonth();
                        startYear = last2MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-3-months':
                        const last3Months = new Date(currentYear, currentMonth - 3, 1);
                        startMonth = last3Months.getMonth();
                        startYear = last3Months.getFullYear();
                        const endLast3 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast3.getMonth();
                        endYear = endLast3.getFullYear();
                        break;
                        
                    case 'last-3-months-include-current':
                        const last3MonthsIncl = new Date(currentYear, currentMonth - 3, 1);
                        startMonth = last3MonthsIncl.getMonth();
                        startYear = last3MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-4-months':
                        const last4Months = new Date(currentYear, currentMonth - 4, 1);
                        startMonth = last4Months.getMonth();
                        startYear = last4Months.getFullYear();
                        const endLast4 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast4.getMonth();
                        endYear = endLast4.getFullYear();
                        break;
                        
                    case 'last-4-months-include-current':
                        const last4MonthsIncl = new Date(currentYear, currentMonth - 4, 1);
                        startMonth = last4MonthsIncl.getMonth();
                        startYear = last4MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-5-months':
                        const last5Months = new Date(currentYear, currentMonth - 5, 1);
                        startMonth = last5Months.getMonth();
                        startYear = last5Months.getFullYear();
                        const endLast5 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast5.getMonth();
                        endYear = endLast5.getFullYear();
                        break;
                        
                    case 'last-5-months-include-current':
                        const last5MonthsIncl = new Date(currentYear, currentMonth - 5, 1);
                        startMonth = last5MonthsIncl.getMonth();
                        startYear = last5MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-6-months':
                        const last6Months = new Date(currentYear, currentMonth - 6, 1);
                        startMonth = last6Months.getMonth();
                        startYear = last6Months.getFullYear();
                        const endLast6 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast6.getMonth();
                        endYear = endLast6.getFullYear();
                        break;
                        
                    case 'last-6-months-include-current':
                        const last6MonthsIncl = new Date(currentYear, currentMonth - 6, 1);
                        startMonth = last6MonthsIncl.getMonth();
                        startYear = last6MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-7-months':
                        const last7Months = new Date(currentYear, currentMonth - 7, 1);
                        startMonth = last7Months.getMonth();
                        startYear = last7Months.getFullYear();
                        const endLast7 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast7.getMonth();
                        endYear = endLast7.getFullYear();
                        break;
                        
                    case 'last-7-months-include-current':
                        const last7MonthsIncl = new Date(currentYear, currentMonth - 7, 1);
                        startMonth = last7MonthsIncl.getMonth();
                        startYear = last7MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-8-months':
                        const last8Months = new Date(currentYear, currentMonth - 8, 1);
                        startMonth = last8Months.getMonth();
                        startYear = last8Months.getFullYear();
                        const endLast8 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast8.getMonth();
                        endYear = endLast8.getFullYear();
                        break;
                        
                    case 'last-8-months-include-current':
                        const last8MonthsIncl = new Date(currentYear, currentMonth - 8, 1);
                        startMonth = last8MonthsIncl.getMonth();
                        startYear = last8MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-9-months':
                        const last9Months = new Date(currentYear, currentMonth - 9, 1);
                        startMonth = last9Months.getMonth();
                        startYear = last9Months.getFullYear();
                        const endLast9 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast9.getMonth();
                        endYear = endLast9.getFullYear();
                        break;
                        
                    case 'last-9-months-include-current':
                        const last9MonthsIncl = new Date(currentYear, currentMonth - 9, 1);
                        startMonth = last9MonthsIncl.getMonth();
                        startYear = last9MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-10-months':
                        const last10Months = new Date(currentYear, currentMonth - 10, 1);
                        startMonth = last10Months.getMonth();
                        startYear = last10Months.getFullYear();
                        const endLast10 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast10.getMonth();
                        endYear = endLast10.getFullYear();
                        break;
                        
                    case 'last-10-months-include-current':
                        const last10MonthsIncl = new Date(currentYear, currentMonth - 10, 1);
                        startMonth = last10MonthsIncl.getMonth();
                        startYear = last10MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'last-11-months':
                        const last11Months = new Date(currentYear, currentMonth - 11, 1);
                        startMonth = last11Months.getMonth();
                        startYear = last11Months.getFullYear();
                        const endLast11 = new Date(currentYear, currentMonth, 0);
                        endMonth = endLast11.getMonth();
                        endYear = endLast11.getFullYear();
                        break;
                        
                    case 'last-11-months-include-current':
                        const last11MonthsIncl = new Date(currentYear, currentMonth - 11, 1);
                        startMonth = last11MonthsIncl.getMonth();
                        startYear = last11MonthsIncl.getFullYear();
                        endMonth = currentMonth;
                        endYear = currentYear;
                        break;
                        
                    case 'current-year':
                        startMonth = 0; // January
                        startYear = currentYear;
                        endMonth = 11; // December
                        endYear = currentYear;
                        break;
                        
                    case 'last-year':
                        startMonth = 0; // January
                        startYear = currentYear - 1;
                        endMonth = 11; // December
                        endYear = currentYear - 1;
                        break;
                }
                
                // Filter months that fall within the range
                if (startMonth !== null && endMonth !== null) {
                    filteredMonthlyData = {};
                    Object.keys(monthlyData).forEach(monthKey => {
                        const [month, year] = monthKey.split('-').map(Number);
                        const monthIndex = month - 1; // Convert to 0-indexed
                        
                        // Check if this month falls within the range
                        const monthDate = new Date(year, monthIndex, 1);
                        const startDate = new Date(startYear, startMonth, 1);
                        const endDate = new Date(endYear, endMonth, 1);
                        
                        if (monthDate >= startDate && monthDate <= endDate) {
                            filteredMonthlyData[monthKey] = monthlyData[monthKey];
                        }
                    });
                }
            }
            
            const sortedMonths = Object.keys(filteredMonthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('-').map(Number);
                const [monthB, yearB] = b.split('-').map(Number);
                return yearA !== yearB ? yearA - yearB : monthA - monthB;
            });
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = sortedMonths.map(key => {
                const [month, year] = key.split('-');
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            
            // Chart 1: Overall Volume Trend (Logged vs Closed) - EXACTLY like Monthly Performance Comparison
            const overallVolumeCtx = document.getElementById('marOverallVolumeChart');
            if (overallVolumeCtx) {
                if (marOverallVolumeChart) {
                    marOverallVolumeChart.destroy();
                }
                
                const loggedData = sortedMonths.map(key => filteredMonthlyData[key]?.loggedCases || 0);
                const closedData = sortedMonths.map(key => filteredMonthlyData[key]?.closedCases || 0);
                
                marOverallVolumeChart = new Chart(overallVolumeCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Logged Cases (by Submission Date)',
                                data: loggedData,
                                backgroundColor: 'rgba(0, 102, 204, 0.1)',
                                borderColor: '#0066cc',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#0066cc',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'Closed Cases (by Resolve Date)',
                                data: closedData,
                                backgroundColor: 'rgba(0, 200, 83, 0.1)',
                                borderColor: '#00c853',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#00c853',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: '600',
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    },
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Cases',
                                    font: {
                                        size: 12,
                                        weight: '600',
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    }
                                },
                                ticks: {
                                    font: {
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 2: Average Resolution Trend - Show 24/7 vs Actual SLA with CORRECT formulas
            const avgResolutionCtx = document.getElementById('marAvgResolutionChart');
            if (avgResolutionCtx) {
                if (marAvgResolutionChart) {
                    marAvgResolutionChart.destroy();
                }
                
                // Calculate 24/7 Performance using SUMIFS/COUNTIFS formula
                // SUM(TAT247 for closed INC) / COUNT(closed INC)
                const avg247INC = sortedMonths.map(key => {
                    const data = filteredMonthlyData[key];
                    if (!data || !data.incResolutionTimes247 || data.incResolutionTimes247.length === 0) return 0;
                    const sum = data.incResolutionTimes247.reduce((a, b) => a + b, 0);
                    return (sum / data.incResolutionTimes247.length).toFixed(1);
                });
                
                const avg247SR = sortedMonths.map(key => {
                    const data = filteredMonthlyData[key];
                    if (!data || !data.srResolutionTimes247 || data.srResolutionTimes247.length === 0) return 0;
                    const sum = data.srResolutionTimes247.reduce((a, b) => a + b, 0);
                    return (sum / data.srResolutionTimes247.length).toFixed(1);
                });
                
                // Calculate Actual SLA Performance using AVERAGE formula (excluding zeros)
                const avgSLAINC = sortedMonths.map(key => {
                    const data = filteredMonthlyData[key];
                    if (!data || !data.incResolutionTimesSLA) return 0;
                    const nonZero = data.incResolutionTimesSLA.filter(v => v > 0);
                    if (nonZero.length === 0) return 0;
                    return (nonZero.reduce((a, b) => a + b, 0) / nonZero.length).toFixed(1);
                });
                
                const avgSLASR = sortedMonths.map(key => {
                    const data = filteredMonthlyData[key];
                    if (!data || !data.srResolutionTimesSLA) return 0;
                    const nonZero = data.srResolutionTimesSLA.filter(v => v > 0);
                    if (nonZero.length === 0) return 0;
                    return (nonZero.reduce((a, b) => a + b, 0) / nonZero.length).toFixed(1);
                });
                
                // Calculate combined weighted average for 24/7 (based on count of cases)
                const avg247Combined = sortedMonths.map((key, idx) => {
                    const incVal = parseFloat(avg247INC[idx]) || 0;
                    const srVal = parseFloat(avg247SR[idx]) || 0;
                    const data = filteredMonthlyData[key];
                    const incCount = data?.incResolutionTimes247?.length || 0;
                    const srCount = data?.srResolutionTimes247?.length || 0;
                    const totalCount = incCount + srCount;
                    if (totalCount === 0) return 0;
                    return ((incVal * incCount + srVal * srCount) / totalCount).toFixed(1);
                });
                
                // Calculate combined weighted average for Actual SLA (based on count of non-zero cases)
                const avgSLACombined = sortedMonths.map((key, idx) => {
                    const incVal = parseFloat(avgSLAINC[idx]) || 0;
                    const srVal = parseFloat(avgSLASR[idx]) || 0;
                    const data = filteredMonthlyData[key];
                    const incCount = data?.incResolutionTimesSLA?.filter(v => v > 0).length || 0;
                    const srCount = data?.srResolutionTimesSLA?.filter(v => v > 0).length || 0;
                    const totalCount = incCount + srCount;
                    if (totalCount === 0) return 0;
                    return ((incVal * incCount + srVal * srCount) / totalCount).toFixed(1);
                });
                
                marAvgResolutionChart = new Chart(avgResolutionCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '24/7 Performance (Avg Days)',
                                data: avg247Combined,
                                borderColor: '#ff9100',
                                backgroundColor: 'rgba(255, 145, 0, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#ff9100',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'Actual SLA Performance (Avg Days)',
                                data: avgSLACombined,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211, 47, 47, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#d32f2f',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: '600',
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' days';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Days',
                                    font: {
                                        size: 12,
                                        weight: '600',
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + ' days';
                                    },
                                    font: {
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    },
                                    maxRotation: 45,
                                    minRotation: 0,
                                    autoSkip: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 3: SLA Compliance Trend - Using CLOSED cases in denominator
            const slaComplianceCtx = document.getElementById('marSLAComplianceChart');
            if (slaComplianceCtx) {
                if (marSLAComplianceChart) {
                    marSLAComplianceChart.destroy();
                }
                
                const slaComplianceData = sortedMonths.map(key => {
                    const data = filteredMonthlyData[key];
                    const totalClosed = (data?.closedCases || 0);
                    const slaViolatedClosed = (data?.slaViolatedClosed || 0);
                    return totalClosed > 0 ? ((totalClosed - slaViolatedClosed) / totalClosed * 100).toFixed(1) : 100;
                });
                
                marSLAComplianceChart = new Chart(slaComplianceCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'SLA Compliance %',
                            data: slaComplianceData,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#0d6efd',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: '600',
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    },
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 80,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Percentage',
                                    font: {
                                        size: 12,
                                        weight: '600',
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: {
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: "'Plus Jakarta Sans', sans-serif"
                                    },
                                    maxRotation: 45,
                                    minRotation: 0,
                                    autoSkip: false
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateMarOpenCases(metrics) {
            // Total Open Cases
            document.getElementById('mar-total-open-cases').textContent = metrics.totalOpen;
            document.getElementById('mar-inc-open-cases').textContent = metrics.incOpen;
            document.getElementById('mar-sr-open-cases').textContent = metrics.srOpen;
            
            // Status for total open
            const openStatus = document.getElementById('mar-open-cases-status');
            if (metrics.totalOpen === 0) {
                openStatus.textContent = 'No Open Cases';
                openStatus.style.color = '#10b981';
                openStatus.style.fontWeight = '600';
            } else if (metrics.totalOpen <= 3) {
                openStatus.textContent = 'Healthy';
                openStatus.style.color = '#10b981';
                openStatus.style.fontWeight = '600';
            } else if (metrics.totalOpen <= 10) {
                openStatus.textContent = 'Moderate';
                openStatus.style.color = '#f59e0b';
                openStatus.style.fontWeight = '600';
            } else {
                openStatus.textContent = 'Attention Needed';
                openStatus.style.color = '#ef4444';
                openStatus.style.fontWeight = '700';
            }
            
            // Status for INC open
            const incOpenStatus = document.getElementById('mar-inc-open-status');
            if (metrics.incOpen === 0) {
                incOpenStatus.textContent = 'No Open INC';
                incOpenStatus.style.color = '#10b981';
            } else if (metrics.incOpen <= 2) {
                incOpenStatus.textContent = 'Low';
                incOpenStatus.style.color = '#10b981';
            } else if (metrics.incOpen <= 5) {
                incOpenStatus.textContent = 'Medium';
                incOpenStatus.style.color = '#f59e0b';
            } else {
                incOpenStatus.textContent = 'High';
                incOpenStatus.style.color = '#ef4444';
            }
            
            // Status for SR open
            const srOpenStatus = document.getElementById('mar-sr-open-status');
            if (metrics.srOpen === 0) {
                srOpenStatus.textContent = 'No Open SR';
                srOpenStatus.style.color = '#10b981';
            } else if (metrics.srOpen <= 2) {
                srOpenStatus.textContent = 'Low';
                srOpenStatus.style.color = '#10b981';
            } else if (metrics.srOpen <= 5) {
                srOpenStatus.textContent = 'Medium';
                srOpenStatus.style.color = '#f59e0b';
            } else {
                srOpenStatus.textContent = 'High';
                srOpenStatus.style.color = '#ef4444';
            }
        }

        function printMonthlyAccountsReport() {
            const reportSheet = document.getElementById('marReportSheet');
            if (!reportSheet) return;
            
            // Convert charts to images before printing
            const charts = reportSheet.querySelectorAll('canvas');
            const chartImages = [];
            
            charts.forEach((canvas, index) => {
                const imgData = canvas.toDataURL('image/png');
                chartImages.push({
                    id: canvas.id,
                    data: imgData,
                    width: canvas.width,
                    height: canvas.height
                });
            });
            
            const printWindow = window.open('', '', 'width=1200,height=800');
            printWindow.document.write('<html><head><title>Monthly Accounts Review Report</title>');
            
            // Copy all styles
            const styles = document.querySelectorAll('style, link[rel="stylesheet"]');
            styles.forEach(style => {
                printWindow.document.write(style.outerHTML);
            });
            
            printWindow.document.write(`
                <style>
                    @media print {
                        body { 
                            margin: 0; 
                            padding: 0; 
                            background: white; 
                        }
                        @page { 
                            size: A4 portrait; 
                            margin: 15mm; 
                        }
                        .no-print { 
                            display: none !important; 
                        }
                        canvas { 
                            display: none !important; 
                        }
                        .chart-print-image { 
                            display: block !important; 
                            max-width: 100%; 
                            height: auto; 
                        }
                        
                        /* Page 1: Up to Overall Volume Trend */
                        .page-1 {
                            page-break-after: always;
                        }
                        
                        /* Page 2: Average Resolution Trend onwards */
                        .page-2 {
                            page-break-before: always;
                        }
                        
                        /* Prevent breaking inside chart boxes */
                        .mar-chart-box {
                            page-break-inside: avoid;
                        }
                    }
                    @media screen {
                        .chart-print-image { 
                            display: none; 
                        }
                    }
                    body { 
                        margin: 0; 
                        padding: 20px; 
                        background: white; 
                        font-family: 'Plus Jakarta Sans', sans-serif;
                    }
                    .no-print { 
                        display: none !important; 
                    }
                </style>
            `);
            
            printWindow.document.write('</head><body>');
            
            // Clone the report sheet
            const clonedReport = reportSheet.cloneNode(true);
            
            // Find the charts section and split it
            const chartsSection = clonedReport.querySelector('.mar-charts-section');
            if (chartsSection) {
                // Find all chart rows
                const chartRows = chartsSection.querySelectorAll('.row');
                
                // First row (Overall Volume) should be on Page 1
                if (chartRows[0]) {
                    chartRows[0].classList.add('page-1');
                }
                
                // Remaining rows (Avg Resolution, SLA Compliance) should be on Page 2
                for (let i = 1; i < chartRows.length; i++) {
                    if (i === 1) {
                        chartRows[i].classList.add('page-2');
                    }
                }
            }
            
            // Replace canvas elements with images
            chartImages.forEach(chart => {
                const canvasElement = clonedReport.querySelector(`#${chart.id}`);
                if (canvasElement) {
                    const img = printWindow.document.createElement('img');
                    img.src = chart.data;
                    img.className = 'chart-print-image';
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    canvasElement.parentNode.replaceChild(img, canvasElement);
                }
            });
            
            printWindow.document.write(clonedReport.outerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                setTimeout(() => printWindow.close(), 500);
            }, 500);
        }
        // Sidebar & UI Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        
        function toggleMobileSidebar() {
            toggleSidebar();
        }

        function updateBannerTitle(title) {
            const bannerTitle = document.getElementById('currentSectionTitle');
            // Update icon based on title
            let icon = 'bi-grid-1x2';
            if(title.includes('Performance View')) icon = 'bi-list-columns-reverse';
            else if(title.includes('Monthly Performance')) icon = 'bi-graph-up';
            else if(title.includes('Monthly Comparison')) icon = 'bi-bar-chart-line';
            else if(title.includes('Resolution Code')) icon = 'bi-check2-square';
            else if(title.includes('Category')) icon = 'bi-tags-fill';
            else if(title.includes('Accounts')) icon = 'bi-file-earmark-text';
            
            bannerTitle.innerHTML = `<i class="bi ${icon} me-2"></i>${title}`;
        }

        // Resolution Code Analysis
        function updateResolutionCodeAnalysis() {
            // Filter by Current Status: only "Close" and "Resolve - Pending User Confirmation"
            const statusFilteredData = filteredData.filter(d => {
                const status = d.currentStatus ? String(d.currentStatus).trim() : '';
                return status === 'Close' || status === 'Resolve - Pending User Confirmation';
            });
            
            const resCodeCounts = {};
            const subResCodeCounts = {};
            const resCodeTimes = {};
            const resCodeSLA = {};
            const total = statusFilteredData.length;

            statusFilteredData.forEach(d => {
                const resCode = d.resolutionCode ? String(d.resolutionCode).trim() : '';
                const subResCode = d.subResolutionCode ? String(d.subResolutionCode).trim() : '';
                
                // Ignore blank, 'N/A', and '-' values for resolution code
                if (resCode && resCode !== 'N/A' && resCode !== '' && resCode !== '-') {
                    resCodeCounts[resCode] = (resCodeCounts[resCode] || 0) + 1;
                    
                    if (!resCodeTimes[resCode]) {
                        resCodeTimes[resCode] = [];
                        resCodeSLA[resCode] = { compliant: 0, total: 0 };
                    }
                    
                    // Use tat247 for resolution time if available
                    const resolutionTime = d.tat247 || d.resolutionTime || 0;
                    resCodeTimes[resCode].push(resolutionTime);
                    
                    resCodeSLA[resCode].total++;
                    // Check SLA compliance - use isSlaViolated if available
                    if (d.isSlaViolated === false || d.slaViolationStatus === 'Non-Violated') {
                        resCodeSLA[resCode].compliant++;
                    } else if (d.slaCompliance) {
                        // Fallback for other data formats
                        const slaComp = String(d.slaCompliance).toLowerCase();
                        if (slaComp === 'yes' || slaComp === '1' || slaComp === 'true') {
                            resCodeSLA[resCode].compliant++;
                        }
                    }
                }
                
                // Ignore blank, 'N/A', and '-' values for sub resolution code
                if (subResCode && subResCode !== 'N/A' && subResCode !== '' && subResCode !== '-') {
                    subResCodeCounts[subResCode] = (subResCodeCounts[subResCode] || 0) + 1;
                }
            });

            // Generate insights
            const sortedResCodes = Object.entries(resCodeCounts).sort((a, b) => b[1] - a[1]);
            const topCode = sortedResCodes[0];
            const l0l1Codes = sortedResCodes.filter(([code]) => {
                const codeStr = String(code).toLowerCase();
                return codeStr.includes('l0') || codeStr.includes('l1') || 
                       codeStr.includes('level 0') || codeStr.includes('level 1');
            });
            
            const insights = [];
            if (topCode) {
                const pct = ((topCode[1] / total) * 100).toFixed(1);
                insights.push(`<strong>${topCode[0]}</strong> is the most common resolution code (${topCode[1]} tickets, ${pct}% of total)`);
            }
            
            if (l0l1Codes.length > 0) {
                insights.push(`<strong>L0/L1 codes identified:</strong> ${l0l1Codes.slice(0, 5).map(([code, count]) => `${code} (${count})`).join(', ')}`);
                insights.push(`<strong>SOP Recommendation:</strong> Review L0/L1 resolution codes for SOP creation opportunities to improve first-call resolution and reduce escalations`);
                insights.push(`<strong>Action Items:</strong> Document common L0/L1 scenarios, create knowledge base articles, and develop training materials for support team`);
            }
            
            const lowSLACodes = Object.entries(resCodeSLA)
                .map(([code, data]) => ({
                    code,
                    sla: (data.compliant / data.total) * 100,
                    count: data.total
                }))
                .filter(item => item.sla < 80 && item.count >= 5)
                .sort((a, b) => a.sla - b.sla)
                .slice(0, 3);
            
            if (lowSLACodes.length > 0) {
                insights.push(`<strong>Low SLA codes requiring attention:</strong> ${lowSLACodes.map(item => `${item.code} (${item.sla.toFixed(1)}% SLA)`).join(', ')}`);
                insights.push(`<strong>Recommendation:</strong> Investigate root causes for low SLA compliance and develop targeted improvement plans`);
            }
            
            const highVolumeCodes = sortedResCodes.slice(0, 5).filter(([code, count]) => (count / total) * 100 >= 10);
            if (highVolumeCodes.length > 0) {
                insights.push(`<strong>High volume codes:</strong> ${highVolumeCodes.map(([code, count]) => `${code} (${((count/total)*100).toFixed(1)}%)`).join(', ')} - Consider automation opportunities`);
            }
            
            const insightsEl = document.getElementById('resolutionInsights');
            if (insightsEl) {
                insightsEl.innerHTML = insights.map(i => `<li style="margin-bottom: 6px;">${i}</li>`).join('');
            }

            // Update charts
            const top10Codes = sortedResCodes.slice(0, 10);
            
            // Pie Chart - Distribution
            const pieCtx = document.getElementById('resolutionCodePieChart');
            if (pieCtx) {
                if (charts.resolutionCodePieChart) charts.resolutionCodePieChart.destroy();
                charts.resolutionCodePieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: top10Codes.map(c => c[0]),
                        datasets: [{
                            data: top10Codes.map(c => c[1]),
                            backgroundColor: [
                                'rgba(0, 102, 204, 0.8)',
                                'rgba(0, 184, 212, 0.8)',
                                'rgba(0, 200, 83, 0.8)',
                                'rgba(255, 145, 0, 0.8)',
                                'rgba(211, 47, 47, 0.8)',
                                'rgba(156, 39, 176, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(96, 125, 139, 0.8)',
                                'rgba(233, 30, 99, 0.8)',
                                'rgba(63, 81, 181, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { font: { size: 10 } } }
                        }
                    }
                });
            }

            // Bar Chart - Top 10
            const barCtx = document.getElementById('resolutionCodeBarChart');
            if (barCtx) {
                if (charts.resolutionCodeBarChart) charts.resolutionCodeBarChart.destroy();
                charts.resolutionCodeBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: top10Codes.map(c => c[0]),
                        datasets: [{
                            label: 'Count',
                            data: top10Codes.map(c => c[1]),
                            backgroundColor: 'rgba(0, 102, 204, 0.7)',
                            borderColor: 'rgba(0, 102, 204, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Resolution Time Chart
            const avgTimes = top10Codes.map(([code]) => {
                const times = resCodeTimes[code];
                return times.length > 0 ? (times.reduce((sum, t) => sum + t, 0) / times.length).toFixed(1) : 0;
            });

            const timeCtx = document.getElementById('resolutionTimeChart');
            if (timeCtx) {
                if (charts.resolutionTimeChart) charts.resolutionTimeChart.destroy();
                charts.resolutionTimeChart = new Chart(timeCtx, {
                    type: 'bar',
                    data: {
                        labels: top10Codes.map(c => c[0]),
                        datasets: [{
                            label: 'Avg Days',
                            data: avgTimes,
                            backgroundColor: 'rgba(255, 145, 0, 0.7)',
                            borderColor: 'rgba(255, 145, 0, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }

            // SLA Compliance Chart
            const slaPercentages = top10Codes.map(([code]) => {
                const data = resCodeSLA[code];
                return data.total > 0 ? ((data.compliant / data.total) * 100).toFixed(1) : 100;
            });

            const slaCtx = document.getElementById('resolutionSLAChart');
            if (slaCtx) {
                if (charts.resolutionSLAChart) charts.resolutionSLAChart.destroy();
                charts.resolutionSLAChart = new Chart(slaCtx, {
                    type: 'bar',
                    data: {
                        labels: top10Codes.map(c => c[0]),
                        datasets: [{
                            label: 'SLA %',
                            data: slaPercentages,
                            backgroundColor: slaPercentages.map(pct => 
                                parseFloat(pct) >= 90 ? 'rgba(0, 200, 83, 0.7)' :
                                parseFloat(pct) >= 80 ? 'rgba(255, 145, 0, 0.7)' :
                                'rgba(211, 47, 47, 0.7)'
                            ),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }

            // Render Resolution Code Table
            const resTableBody = document.getElementById('resolutionCodeTableBody');
            if (resTableBody) {
                resTableBody.innerHTML = '';
                Object.entries(resCodeCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([code, count]) => {
                        const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                        resTableBody.innerHTML += `
                            <tr>
                                <td>${code}</td>
                                <td>${count}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" style="width: ${pct}%" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span>${pct}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
            }

            // Render Sub Resolution Code Table
            const subResTableBody = document.getElementById('subResolutionCodeTableBody');
            if (subResTableBody) {
                subResTableBody.innerHTML = '';
                Object.entries(subResCodeCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([code, count]) => {
                        const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                        subResTableBody.innerHTML += `
                            <tr>
                                <td>${code}</td>
                                <td>${count}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" style="width: ${pct}%" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span>${pct}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
            }
        }

        function exportResolutionCodeAnalysis() {
            // Filter by Current Status: only "Close" and "Resolve - Pending User Confirmation"
            const statusFilteredData = filteredData.filter(d => {
                const status = d.currentStatus ? String(d.currentStatus).trim() : '';
                return status === 'Close' || status === 'Resolve - Pending User Confirmation';
            });
            
            const wb = XLSX.utils.book_new();
            
            // Resolution Code Sheet (excluding blank and "-")
            const resData = [];
            const resCodeCounts = {};
            statusFilteredData.forEach(d => {
                const resCode = d.resolutionCode ? String(d.resolutionCode).trim() : '';
                // Ignore blank, 'N/A', and '-' values
                if (resCode && resCode !== 'N/A' && resCode !== '' && resCode !== '-') {
                    resCodeCounts[resCode] = (resCodeCounts[resCode] || 0) + 1;
                }
            });
            
            resData.push(['Resolution Code', 'Count', '% of Total']);
            const total = statusFilteredData.length;
            
            Object.entries(resCodeCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([code, count]) => {
                    const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    resData.push([code, count, pct + '%']);
                });
                
            const wsRes = XLSX.utils.aoa_to_sheet(resData);
            XLSX.utils.book_append_sheet(wb, wsRes, "Resolution Codes");
            
            // Sub Resolution Code Sheet (excluding blank and "-")
            const subResData = [];
            const subResCodeCounts = {};
            statusFilteredData.forEach(d => {
                const code = d.subResolutionCode ? String(d.subResolutionCode).trim() : '';
                // Ignore blank, 'N/A', and '-' values
                if (code && code !== 'N/A' && code !== '' && code !== '-') {
                    subResCodeCounts[code] = (subResCodeCounts[code] || 0) + 1;
                }
            });
            
            subResData.push(['Sub Resolution Code', 'Count', '% of Total']);
            
            Object.entries(subResCodeCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([code, count]) => {
                    const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    subResData.push([code, count, pct + '%']);
                });
                
            const wsSubRes = XLSX.utils.aoa_to_sheet(subResData);
            XLSX.utils.book_append_sheet(wb, wsSubRes, "Sub Resolution Codes");
            
            XLSX.writeFile(wb, `Resolution_Code_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Resolution Review Functions
        function updateResolutionReviewTab() {
            if (!filteredData || filteredData.length === 0) {
                console.log('Resolution Review: No filtered data available');
                return;
            }
            
            console.log('Resolution Review: Processing', filteredData.length, 'records');
            
            // Filter by Current Status: only "Close" and "Resolve - Pending User Confirmation"
            const statusFilteredData = filteredData.filter(d => {
                const status = d.currentStatus ? String(d.currentStatus).trim() : '';
                return status === 'Close' || status === 'Resolve - Pending User Confirmation';
            });
            
            console.log('Resolution Review: After status filter:', statusFilteredData.length, 'records');
            
            // Collect problem statements and resolution steps (excluding blank and "-")
            const problemStatements = {};
            const resolutionSteps = {};
            let validProblemCount = 0;
            let validStepsCount = 0;
            
            statusFilteredData.forEach(d => {
                const problemStatement = d.problemStatement ? String(d.problemStatement).trim() : '';
                const resolutionStep = d.resolutionSummary ? String(d.resolutionSummary).trim() : '';
                
                // Count all problem statements and steps - ignore blank and "-"
                if (problemStatement && problemStatement !== 'N/A' && problemStatement !== '' && problemStatement !== '-') {
                    problemStatements[problemStatement] = (problemStatements[problemStatement] || 0) + 1;
                    validProblemCount++;
                }
                if (resolutionStep && resolutionStep !== 'N/A' && resolutionStep !== '' && resolutionStep !== '-') {
                    resolutionSteps[resolutionStep] = (resolutionSteps[resolutionStep] || 0) + 1;
                    validStepsCount++;
                }
            });
            
            console.log('Resolution Review: Valid problems:', validProblemCount, 'Valid steps:', validStepsCount);
            console.log('Resolution Review: Unique problems:', Object.keys(problemStatements).length, 'Unique steps:', Object.keys(resolutionSteps).length);
            
            const totalCalls = statusFilteredData.length;
            
            // Update summary cards
            document.getElementById('uniqueProblemStatements').textContent = Object.keys(problemStatements).length;
            document.getElementById('uniqueResolutionSteps').textContent = Object.keys(resolutionSteps).length;
            
            // Sort and get top 10
            const sortedProblems = Object.entries(problemStatements).sort((a, b) => b[1] - a[1]);
            const sortedSteps = Object.entries(resolutionSteps).sort((a, b) => b[1] - a[1]);
            const top10Problems = sortedProblems.slice(0, 10);
            const top10Steps = sortedSteps.slice(0, 10);
            
            // Update Problem Statements Chart
            const problemChartCtx = document.getElementById('problemStatementsChart');
            if (problemChartCtx) {
                if (window.problemStatementsChart && typeof window.problemStatementsChart.destroy === 'function') {
                    window.problemStatementsChart.destroy();
                }
                window.problemStatementsChart = new Chart(problemChartCtx, {
                    type: 'bar',
                    data: {
                        labels: top10Problems.map(([text]) => text.substring(0, 40) + (text.length > 40 ? '...' : '')),
                        datasets: [{
                            label: 'Count',
                            data: top10Problems.map(([, count]) => count),
                            backgroundColor: 'rgba(0, 102, 204, 0.7)',
                            borderColor: 'rgba(0, 102, 204, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true } }
                    }
                });
            }
            
            // Update Resolution Steps Chart
            const stepsChartCtx = document.getElementById('resolutionStepsChart');
            if (stepsChartCtx) {
                if (window.resolutionStepsChart && typeof window.resolutionStepsChart.destroy === 'function') {
                    window.resolutionStepsChart.destroy();
                }
                window.resolutionStepsChart = new Chart(stepsChartCtx, {
                    type: 'bar',
                    data: {
                        labels: top10Steps.map(([text]) => text.substring(0, 40) + (text.length > 40 ? '...' : '')),
                        datasets: [{
                            label: 'Count',
                            data: top10Steps.map(([, count]) => count),
                            backgroundColor: 'rgba(0, 200, 83, 0.7)',
                            borderColor: 'rgba(0, 200, 83, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true } }
                    }
                });
            }
            
            // Update Problem Statement Table
            const problemTableBody = document.getElementById('problemStatementTableBody');
            if (problemTableBody) {
                problemTableBody.innerHTML = '';
                sortedProblems.forEach(([text, count]) => {
                    const pct = totalCalls > 0 ? ((count / totalCalls) * 100).toFixed(2) : 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td title="${text}" style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${text}</td>
                        <td style="font-weight: 600;">${count}</td>
                        <td style="font-weight: 600; color: var(--primary-color); font-family: 'JetBrains Mono', monospace;">${pct}%</td>
                    `;
                    problemTableBody.appendChild(tr);
                });
            }
            
            // Update Resolution Steps Table
            const stepsTableBody = document.getElementById('resolutionStepsTableBody');
            if (stepsTableBody) {
                stepsTableBody.innerHTML = '';
                sortedSteps.forEach(([text, count]) => {
                    const pct = totalCalls > 0 ? ((count / totalCalls) * 100).toFixed(2) : 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td title="${text}" style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${text}</td>
                        <td style="font-weight: 600;">${count}</td>
                        <td style="font-weight: 600; color: var(--primary-color); font-family: 'JetBrains Mono', monospace;">${pct}%</td>
                    `;
                    stepsTableBody.appendChild(tr);
                });
            }
            
            // Generate Insights
            generateResolutionReviewInsights(sortedProblems, sortedSteps, totalCalls);
        }
        
        function generateResolutionReviewInsights(problems, steps, totalCalls) {
            const insightsContent = document.getElementById('insightsContent');
            if (!insightsContent) return;
            
            // AI Sentiment Analysis - Analyze patterns in problems and resolutions
            const aiAnalysis = performAISentimentAnalysis(problems, steps, totalCalls);
            
            let insights = '<div style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border-left: 4px solid var(--warning-color); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            insights += '<div style="font-weight: 700; color: #e65100; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;"><i class="bi bi-lightbulb-fill"></i>AI-Powered Analysis & Key Findings</div>';
            insights += '<ul style="margin-bottom: 0; padding-left: 20px;">';
            
            // Display AI analysis findings
            aiAnalysis.findings.forEach(finding => {
                insights += `<li style="margin-bottom: 6px;">${finding}</li>`;
            });
            
            insights += '</ul></div>';
            
            // AI-Generated Recommendations
            insights += '<div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border-left: 4px solid var(--primary-color); padding: 15px; border-radius: 8px;">';
            insights += '<div style="font-weight: 700; color: #006064; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;"><i class="bi bi-check-circle-fill"></i>AI-Generated Recommendations</div>';
            insights += '<ul style="margin-bottom: 0; padding-left: 20px;">';
            
            // Display AI recommendations
            aiAnalysis.recommendations.forEach(rec => {
                insights += `<li style="margin-bottom: 6px;">${rec}</li>`;
            });
            
            insights += '</ul></div>';
            
            // Sentiment Summary
            insights += '<div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-left: 4px solid #9c27b0; padding: 15px; border-radius: 8px; margin-top: 15px;">';
            insights += '<div style="font-weight: 700; color: #6a1b9a; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;"><i class="bi bi-graph-up"></i>Pattern Analysis Summary</div>';
            insights += `<p style="margin-bottom: 8px;"><strong>Overall Sentiment:</strong> ${aiAnalysis.sentiment.overall}</p>`;
            insights += `<p style="margin-bottom: 8px;"><strong>Problem Complexity:</strong> ${aiAnalysis.sentiment.problemComplexity}</p>`;
            insights += `<p style="margin-bottom: 8px;"><strong>Resolution Effectiveness:</strong> ${aiAnalysis.sentiment.resolutionEffectiveness}</p>`;
            insights += `<p style="margin-bottom: 0;"><strong>Priority Action:</strong> ${aiAnalysis.sentiment.priorityAction}</p>`;
            insights += '</div>';
            
            insightsContent.innerHTML = insights;
        }
        
        function performAISentimentAnalysis(problems, steps, totalCalls) {
            const analysis = {
                findings: [],
                recommendations: [],
                sentiment: {
                    overall: '',
                    problemComplexity: '',
                    resolutionEffectiveness: '',
                    priorityAction: ''
                }
            };
            
            // Analyze problem concentration
            const uniqueProblems = problems.length;
            const top3Problems = problems.slice(0, 3);
            const top3Count = top3Problems.reduce((sum, [, count]) => sum + count, 0);
            const top3Percentage = totalCalls > 0 ? (top3Count / totalCalls) * 100 : 0;
            
            // Analyze resolution patterns
            const uniqueSteps = steps.length;
            const top3Steps = steps.slice(0, 3);
            const top3StepsCount = top3Steps.reduce((sum, [, count]) => sum + count, 0);
            const top3StepsPercentage = totalCalls > 0 ? (top3StepsCount / totalCalls) * 100 : 0;
            
            // Finding 1: Problem concentration analysis
            if (top3Percentage > 60) {
                analysis.findings.push(`<strong>High Problem Concentration:</strong> The top 3 problem statements account for ${top3Percentage.toFixed(1)}% of all closed/resolved tickets, indicating <span style="color: #d32f2f;">concentrated pain points</span> that require immediate attention.`);
            } else if (top3Percentage > 40) {
                analysis.findings.push(`<strong>Moderate Problem Concentration:</strong> The top 3 problems represent ${top3Percentage.toFixed(1)}% of tickets, showing <span style="color: #ff9100;">moderate focus areas</span> with room for process improvements.`);
            } else {
                analysis.findings.push(`<strong>Diverse Problem Landscape:</strong> Top 3 problems account for only ${top3Percentage.toFixed(1)}% of tickets, indicating <span style="color: #0066cc;">high variety</span> in support issues requiring comprehensive knowledge base.`);
            }
            
            // Finding 2: Top problem insight
            if (problems.length > 0) {
                const topProblem = problems[0];
                const topPct = totalCalls > 0 ? ((topProblem[1] / totalCalls) * 100).toFixed(1) : 0;
                const problemText = topProblem[0].length > 100 ? topProblem[0].substring(0, 100) + '...' : topProblem[0];
                analysis.findings.push(`<strong>Most Critical Issue:</strong> "${problemText}" dominates with ${topProblem[1]} occurrences (${topPct}%), suggesting a <span style="color: #d32f2f;">systemic issue</span> requiring root cause analysis.`);
            }
            
            // Finding 3: Resolution effectiveness
            if (top3StepsPercentage > 50) {
                analysis.findings.push(`<strong>Standardized Resolutions:</strong> Top 3 resolution steps handle ${top3StepsPercentage.toFixed(1)}% of cases, indicating <span style="color: #00c853;">strong standardization potential</span> and effective documentation.`);
            } else if (top3StepsPercentage > 30) {
                analysis.findings.push(`<strong>Moderate Resolution Patterns:</strong> Top 3 steps cover ${top3StepsPercentage.toFixed(1)}% of cases, showing <span style="color: #ff9100;">opportunity for standardization</span> in common scenarios.`);
            } else {
                analysis.findings.push(`<strong>Varied Resolution Approaches:</strong> Top 3 steps represent only ${top3StepsPercentage.toFixed(1)}% of cases, indicating <span style="color: #0066cc;">diverse resolution methods</span> that may benefit from consolidation.`);
            }
            
            // Finding 4: Problem-resolution correlation
            const problemStepRatio = uniqueSteps > 0 ? uniqueProblems / uniqueSteps : 0;
            if (problemStepRatio > 1.5) {
                analysis.findings.push(`<strong>Resolution Gap Detected:</strong> ${uniqueProblems} unique problems with only ${uniqueSteps} resolution approaches (ratio: ${problemStepRatio.toFixed(2)}:1) suggests <span style="color: #d32f2f;">insufficient documentation</span> of resolution procedures.`);
            } else if (problemStepRatio < 0.7) {
                analysis.findings.push(`<strong>Over-Documented Resolutions:</strong> ${uniqueSteps} resolution steps for ${uniqueProblems} problems (ratio: ${problemStepRatio.toFixed(2)}:1) indicates <span style="color: #ff9100;">potential for consolidation</span> and simplification.`);
            } else {
                analysis.findings.push(`<strong>Balanced Documentation:</strong> Good correlation between ${uniqueProblems} problems and ${uniqueSteps} resolution steps (ratio: ${problemStepRatio.toFixed(2)}:1) shows <span style="color: #00c853;">healthy documentation practices</span>.`);
            }
            
            // Finding 5: Scale analysis
            if (uniqueProblems > 100) {
                analysis.findings.push(`<strong>High Complexity Environment:</strong> ${uniqueProblems} unique problem types detected, requiring <span style="color: #d32f2f;">comprehensive knowledge management</span> and advanced search capabilities.`);
            } else if (uniqueProblems > 50) {
                analysis.findings.push(`<strong>Moderate Complexity:</strong> ${uniqueProblems} problem types identified, suitable for <span style="color: #ff9100;">categorized SOP development</span> and structured training.`);
            } else {
                analysis.findings.push(`<strong>Manageable Scope:</strong> ${uniqueProblems} problem types present, ideal for <span style="color: #00c853;">focused SOP creation</span> and quick wins in standardization.`);
            }
            
            // Generate recommendations based on analysis
            
            // Recommendation 1: Based on concentration
            if (top3Percentage > 60) {
                analysis.recommendations.push(`<strong>Immediate Action - Root Cause Analysis:</strong> The top 3 problems (${top3Percentage.toFixed(0)}% of volume) require urgent investigation. Create dedicated task force to identify underlying causes and implement preventive measures within 2 weeks.`);
            } else if (top3Percentage > 40) {
                analysis.recommendations.push(`<strong>Priority Focus - SOP Development:</strong> Develop comprehensive SOPs for the top 5-10 problem statements covering ${Math.round(top3Percentage + 15)}% of volume, targeting completion within 1 month.`);
            } else {
                analysis.recommendations.push(`<strong>Strategic Approach - Knowledge Base Enhancement:</strong> Build searchable knowledge base with AI-powered search for ${uniqueProblems} problem types, prioritizing top 20% by volume.`);
            }
            
            // Recommendation 2: Resolution standardization
            if (top3StepsPercentage > 50) {
                analysis.recommendations.push(`<strong>Automation Opportunity:</strong> Top resolution steps (${top3StepsPercentage.toFixed(0)}% of cases) are excellent candidates for workflow automation, chatbot integration, or self-service portal. Expected ROI: 40-60% reduction in handling time.`);
            } else {
                analysis.recommendations.push(`<strong>Standardization Initiative:</strong> Consolidate and document resolution approaches to increase consistency. Target: Reduce resolution step variations by 30% through standardized procedures and templates.`);
            }
            
            // Recommendation 3: Training focus
            const topProblemsList = problems.slice(0, 5).map(([text]) => text.length > 50 ? text.substring(0, 50) + '...' : text).join('; ');
            analysis.recommendations.push(`<strong>Targeted Training Program:</strong> Conduct monthly training sessions focusing on top 5 problems: "${topProblemsList}". Include hands-on scenarios and resolution simulations to improve first-call resolution rate.`);
            
            // Recommendation 4: Quality assurance
            if (problemStepRatio > 1.5) {
                analysis.recommendations.push(`<strong>Documentation Enhancement Required:</strong> Problem-to-resolution ratio (${problemStepRatio.toFixed(2)}:1) indicates gaps. Mandate resolution documentation for all closed tickets and conduct quarterly documentation audits.`);
            } else if (problemStepRatio < 0.7) {
                analysis.recommendations.push(`<strong>Documentation Consolidation Needed:</strong> Simplify resolution procedures by merging similar steps. Conduct documentation review to eliminate redundancies and improve clarity.`);
            } else {
                analysis.recommendations.push(`<strong>Maintain Best Practices:</strong> Current documentation ratio (${problemStepRatio.toFixed(2)}:1) is optimal. Continue quarterly reviews to maintain quality and relevance of SOPs.`);
            }
            
            // Recommendation 5: Continuous improvement
            analysis.recommendations.push(`<strong>Performance Metrics & Monitoring:</strong> Implement real-time dashboards tracking: (1) Top 10 problem/resolution trends, (2) First-call resolution rates by category, (3) Documentation usage analytics. Review monthly and adjust strategies quarterly.`);
            
            // Recommendation 6: Customer experience
            if (totalCalls > 500) {
                analysis.recommendations.push(`<strong>Proactive Communication Strategy:</strong> With ${totalCalls} closed/resolved tickets, establish proactive notification system for known issues, reducing reactive support volume by an estimated 15-25%.`);
            }
            
            // Determine overall sentiment
            if (top3Percentage > 60 || uniqueProblems > 100) {
                analysis.sentiment.overall = " Needs Immediate Attention - High concentration or complexity detected";
                analysis.sentiment.priorityAction = "Establish dedicated improvement team within 1 week";
            } else if (top3Percentage > 40 || uniqueProblems > 50) {
                analysis.sentiment.overall = " Moderate - Room for significant improvements";
                analysis.sentiment.priorityAction = "Initiate standardization project within 2 weeks";
            } else {
                analysis.sentiment.overall = " Good - Well-distributed and manageable";
                analysis.sentiment.priorityAction = "Continue optimization and maintain best practices";
            }
            
            // Problem complexity assessment
            if (uniqueProblems > 100) {
                analysis.sentiment.problemComplexity = "High (100+ unique types) - Requires advanced KM system";
            } else if (uniqueProblems > 50) {
                analysis.sentiment.problemComplexity = "Moderate (50-100 types) - Structured SOPs needed";
            } else {
                analysis.sentiment.problemComplexity = "Low (<50 types) - Manageable with focused documentation";
            }
            
            // Resolution effectiveness
            if (top3StepsPercentage > 50) {
                analysis.sentiment.resolutionEffectiveness = "High - Strong standardization (Top 3: " + top3StepsPercentage.toFixed(0) + "%)";
            } else if (top3StepsPercentage > 30) {
                analysis.sentiment.resolutionEffectiveness = "Moderate - Some patterns evident (Top 3: " + top3StepsPercentage.toFixed(0) + "%)";
            } else {
                analysis.sentiment.resolutionEffectiveness = "Low - Highly varied approaches (Top 3: " + top3StepsPercentage.toFixed(0) + "%)";
            }
            
            return analysis;
        }
        
        function exportResolutionReview() {
            if (!filteredData || filteredData.length === 0) {
                alert('No data available to export. Please load an Excel file first.');
                return;
            }
            
            // Filter by Current Status: only "Close" and "Resolve - Pending User Confirmation"
            const statusFilteredData = filteredData.filter(d => {
                const status = d.currentStatus ? String(d.currentStatus).trim() : '';
                return status === 'Close' || status === 'Resolve - Pending User Confirmation';
            });
            
            // Collect data (excluding blank and "-" rows)
            const problemStatements = {};
            const resolutionSteps = {};
            
            statusFilteredData.forEach(d => {
                const problemStatement = d.problemStatement ? String(d.problemStatement).trim() : '';
                const resolutionStep = d.resolutionSummary ? String(d.resolutionSummary).trim() : '';
                
                if (problemStatement && problemStatement !== 'N/A' && problemStatement !== '' && problemStatement !== '-') {
                    problemStatements[problemStatement] = (problemStatements[problemStatement] || 0) + 1;
                }
                if (resolutionStep && resolutionStep !== 'N/A' && resolutionStep !== '' && resolutionStep !== '-') {
                    resolutionSteps[resolutionStep] = (resolutionSteps[resolutionStep] || 0) + 1;
                }
            });
            
            const totalCalls = statusFilteredData.length;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Problem Statement Analysis
            const problemData = [['Problem Statement', 'Count', '% of Total']];
            Object.entries(problemStatements).sort((a, b) => b[1] - a[1]).forEach(([text, count]) => {
                const pct = totalCalls > 0 ? ((count / totalCalls) * 100).toFixed(2) : 0;
                problemData.push([text, count, pct + '%']);
            });
            const wsProblem = XLSX.utils.aoa_to_sheet(problemData);
            XLSX.utils.book_append_sheet(wb, wsProblem, 'Problem Statements');
            
            // Sheet 2: Resolution Steps Analysis
            const stepsData = [['Resolution Summary (Steps)', 'Count', '% of Total']];
            Object.entries(resolutionSteps).sort((a, b) => b[1] - a[1]).forEach(([text, count]) => {
                const pct = totalCalls > 0 ? ((count / totalCalls) * 100).toFixed(2) : 0;
                stepsData.push([text, count, pct + '%']);
            });
            const wsSteps = XLSX.utils.aoa_to_sheet(stepsData);
            XLSX.utils.book_append_sheet(wb, wsSteps, 'Resolution Steps');
            
            // Sheet 3: Summary
            const summaryData = [
                ['Metric', 'Value'],
                ['Total Calls', totalCalls],
                ['Unique Problem Statements', Object.keys(problemStatements).length],
                ['Unique Resolution Steps', Object.keys(resolutionSteps).length]
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
            
            // Export file
            const timestamp = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Resolution_Review_Analysis_${timestamp}.xlsx`);
        }

        // Auto-close mobile sidebar when menu item clicked
        document.addEventListener('DOMContentLoaded', function() {
            // Select all nav links from all sections
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 992) {
                        setTimeout(() => {
                            const sidebar = document.getElementById('sidebar');
                            const overlay = document.getElementById('sidebarOverlay');
                            if (sidebar && sidebar.classList.contains('mobile-open')) {
                                sidebar.classList.remove('mobile-open');
                                if (overlay) overlay.classList.remove('show');
                            }
                        }, 300);
                    }
                });
            });
        });
    </script>
</body>
</html>
