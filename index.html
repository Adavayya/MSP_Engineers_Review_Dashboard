<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Support Engineers - Daily Review Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --light-gray: #f8f9fa;
        }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f7fa; }
        
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); margin-bottom: 10px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .global-filters { background-color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .main-view-tabs .nav-link { font-size: 1.1rem; color: #555; margin-right: 5px; border-radius: 10px 10px 0 0; }
        .main-view-tabs .nav-link.active { background-color: var(--primary-color); color: white; border-bottom: none; }
        .view-content { border: 1px solid #dee2e6; border-top: none; background: white; padding: 25px; border-radius: 0 0 10px 10px; min-height: 600px; }

        .kpi-section-title { font-size: 0.8rem; font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--light-gray); padding-bottom: 5px; margin-bottom: 10px; margin-top: 15px; }
        
        .kpi-card { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            padding: 15px; 
            border-left: 8px solid var(--primary-color); 
            cursor: pointer; 
            height: 100%; 
            transition: all 0.2s; 
        }
        .kpi-card:hover { background-color: #f8faff; transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .kpi-title { font-size: 0.7rem; color: var(--primary-color); font-weight: 700; text-transform: uppercase; margin-bottom: 3px; opacity: 0.8; line-height: 1.2; }
        .kpi-value { font-size: 1.8rem; font-weight: 700; color: #000; }
        
        .kpi-status-tag { 
            font-size: 0.65rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            padding: 2px 5px; 
            border-radius: 4px; 
            margin-bottom: 5px;
            display: inline-block;
        }

        .kpi-recommendation {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 5px;
            opacity: 0.8;
            line-height: 1.3;
        }

        .bg-urgent { background-color: #c0392b; color: white; }
        .bg-action-needed, .bg-monitor { background-color: #f39c12; color: white; }
        .bg-good { background-color: #27ae60; color: white; }
        .bg-info-tag { background-color: #3498db; color: white; }

        .accordion-item { margin-bottom: 15px; border-radius: 8px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .accordion-header { border-radius: 8px 8px 0 0; }
        .accordion-button { font-size: 1rem; font-weight: 600; color: var(--primary-color); background-color: var(--light-gray); border-bottom: 1px solid #ddd; }
        .accordion-button:not(.collapsed) { background-color: var(--primary-color); color: white; box-shadow: inset 0 -1px 0 rgba(0,0,0,.125); }
        .accordion-button:focus { box-shadow: none; }
        .accordion-body { padding: 15px; }

        .scorecard-table th { background-color: var(--primary-color); color: white; border: none; font-size: 0.7rem; vertical-align: middle; padding: 6px; }
        .scorecard-table td { font-size: 0.75rem; padding: 6px; }
        .critical-cell { background-color: rgba(192, 57, 43, 0.15); color: #c0392b; font-weight: 700; }
        .high-cell { background-color: rgba(243, 156, 18, 0.15); color: #f39c12; }
        .success-cell { background-color: rgba(39, 174, 96, 0.15); color: #27ae60; }
        .compliance-gauge { height: 10px; border-radius: 5px; }
        
        .metric-card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .metric-card .card-body { text-align: center; }
        .metric-value { font-size: 2.5rem; font-weight: 700; color: #2c3e50; }
        .metric-label { font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }
        
        .detailed-case-table th { background-color: #f8f9fa; font-weight: 600; }
        .owner-tag { background-color: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--primary-color);">
        <div class="container-fluid">
            <div class="logo-container d-flex align-items-center">
                <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" alt="Logo" style="height: 30px;" class="me-3">
                <a class="navbar-brand" href="#">
                    MSP Support Engineers - Daily Review Dashboard
                </a>
            </div>
            <div class="d-flex align-items-center text-white">
                <span id="last-updated" class="me-3 small"></span>
                <span id="total-cases" class="badge bg-light text-dark">0 Cases Loaded</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        
        <div class="row mb-4" id="upload-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="upload-area" id="drop-area" style="text-align:center; border: 2px dashed #ccc; padding: 30px; cursor:pointer;">
                            <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" alt="Logo" style="height: 40px; margin-bottom: 10px;">
                            <h4>Upload MSP Review Record</h4>
                            <p class="text-muted">Drag & Drop Excel/CSV or Click to Browse</p>
                            <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                        </div>
                        <div id="file-info" class="mt-3" style="display: none;">
                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                <div><i class="bi bi-file-earmark-spreadsheet me-2"></i><span id="file-name"></span> <span id="row-count" class="badge bg-secondary ms-2"></span></div>
                                <button class="btn btn-sm btn-outline-success" id="process-data-btn"><i class="bi bi-play-circle me-1"></i> Process Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-section" style="display: none;">
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="global-filters">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Global Filters</h6>
                            <button class="btn btn-sm btn-outline-secondary" id="clear-filters-btn">Clear All</button>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-2"><select class="form-select form-select-sm" id="global-filter-owner"><option value="">All Owners</option></select></div>
                            <div class="col-md-2"><select class="form-select form-select-sm" id="global-filter-submittedby"><option value="">All Submitted By</option></select></div>
                            <div class="col-md-2"><select class="form-select form-select-sm" id="global-filter-service"><option value="">All Service Types</option></select></div>
                            <div class="col-md-2"><select class="form-select form-select-sm" id="global-filter-status"><option value="">All Statuses</option></select></div>
                            <div class="col-md-2"><select class="form-select form-select-sm" id="global-filter-sla"><option value="">All SLA Status</option><option value="Violated">SLA Violated</option><option value="Non-Violated">SLA Non-Violated</option></select></div>
                            <div class="col-md-2"><button class="btn btn-sm btn-outline-primary w-100" onclick="exportFullData()">Export Filtered Data</button></div>
                        </div>
                        <div class="mt-2 small text-muted"><span id="active-filters-count">0 filters active</span></div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs main-view-tabs mb-0" id="mainViewTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="view-dashboard-tab" data-bs-toggle="tab" data-bs-target="#view-dashboard" type="button" role="tab">
                        <i class="bi bi-grid-1x2 me-2"></i>Dashboard View
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="view-detailed-tab" data-bs-toggle="tab" data-bs-target="#view-detailed" type="button" role="tab">
                        <i class="bi bi-list-columns-reverse me-2"></i>Detailed View
                    </button>
                </li>
            </ul>

            <div class="tab-content view-content" id="mainViewTabsContent">
                
                <div class="tab-pane fade show active" id="view-dashboard" role="tabpanel">
                    
                    <div class="accordion" id="kpiAccordion">
                    
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    <i class="bi bi-list-task me-2"></i>1. Overall Case Volume
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-total-card" onclick="openDrillDown('totalOpen', 'Total Open Cases')">
                                                <span class="kpi-status-tag bg-info-tag" id="kpi-total-tag">INFO</span>
                                                <div class="kpi-title">Total Open Cases</div>
                                                <div class="kpi-value" id="kpi-total">0</div>
                                                <div class="kpi-recommendation" id="kpi-total-rec">Total cases currently active in the system.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-sr-card" onclick="openDrillDown('totalSR', 'Total Service Requests (SR)')">
                                                <span class="kpi-status-tag bg-info-tag" id="kpi-sr-tag">INFO</span>
                                                <div class="kpi-title">Total SR</div>
                                                <div class="kpi-value" id="kpi-sr">0</div>
                                                <div class="kpi-recommendation" id="kpi-sr-rec">Breakdown of active Service Requests.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-inc-card" onclick="openDrillDown('totalINC', 'Total Incidents (INC)')">
                                                <span class="kpi-status-tag bg-info-tag" id="kpi-inc-tag">INFO</span>
                                                <div class="kpi-title">Total INC</div>
                                                <div class="kpi-value" id="kpi-inc">0</div>
                                                <div class="kpi-recommendation" id="kpi-inc-rec">Breakdown of active Incident Management cases.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                                    <i class="bi bi-alarm-fill me-2"></i>2. SLA Compliance
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse show" aria-labelledby="headingTwo">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sla-sr-card" onclick="openDrillDown('slaSR', 'SLA Violated - SR')">
                                                <span class="kpi-status-tag bg-good" id="kpi-sla-sr-tag">GOOD</span>
                                                <div class="kpi-title">SLA Violated – SR</div>
                                                <div class="kpi-value" id="kpi-sla-sr">0</div>
                                                <div class="kpi-recommendation" id="kpi-sla-sr-rec">No SR cases currently in violation.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sla-inc-card" onclick="openDrillDown('slaINC', 'SLA Violated - INC')">
                                                <span class="kpi-status-tag bg-good" id="kpi-sla-inc-tag">GOOD</span>
                                                <div class="kpi-title">SLA Violated – INC</div>
                                                <div class="kpi-value" id="kpi-sla-inc">0</div>
                                                <div class="kpi-recommendation" id="kpi-sla-inc-rec">No INC cases currently in violation.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
                                    <i class="bi bi-hourglass-split me-2"></i>3. Aging & Old Cases
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse show" aria-labelledby="headingThree">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-aging-15-card" onclick="openDrillDown('aging15', 'Aging > 15 Days')">
                                                <span class="kpi-status-tag bg-good" id="kpi-aging-15-tag">GOOD</span>
                                                <div class="kpi-title">Aging > 15 Days</div>
                                                <div class="kpi-value" id="kpi-aging-15">0</div>
                                                <div class="kpi-recommendation" id="kpi-aging-15-rec">No cases have crossed the 15-day warning threshold.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-aging-25-card" onclick="openDrillDown('oldest25', 'Oldest Cases (> 25 Days)')">
                                                <span class="kpi-status-tag bg-good" id="kpi-aging-25-tag">GOOD</span>
                                                <div class="kpi-title">Oldest Cases (> 25 Days)</div>
                                                <div class="kpi-value" id="kpi-aging-25">0</div>
                                                <div class="kpi-recommendation" id="kpi-aging-25-rec">No critical old cases requiring urgent action.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="true" aria-controls="collapseFour">
                                    <i class="bi bi-calendar-event me-2"></i>4. Follow-up & Response Misses
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse show" aria-labelledby="headingFour">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-followup-card" onclick="openDrillDown('followUpMissed', 'Follow-up Date Missed')">
                                                <span class="kpi-status-tag bg-good" id="kpi-followup-tag">GOOD</span>
                                                <div class="kpi-title">Follow-up Missed</div>
                                                <div class="kpi-value" id="kpi-followup">0</div>
                                                <div class="kpi-recommendation" id="kpi-followup-rec">All cases have a valid, upcoming follow-up date.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-email-followup-card" onclick="openDrillDown('emailNoFollowup', 'Email Follow-up Missed')">
                                                <span class="kpi-status-tag bg-good" id="kpi-email-followup-tag">GOOD</span>
                                                <div class="kpi-title">Email F/Up Missed</div>
                                                <div class="kpi-value" id="kpi-email-followup">0</div>
                                                <div class="kpi-recommendation" id="kpi-email-followup-rec">All email follow-ups are compliant.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-email-resp-card" onclick="openDrillDown('emailResponseMissed', 'Email Response Missed')">
                                                <span class="kpi-status-tag bg-good" id="kpi-email-resp-tag">GOOD</span>
                                                <div class="kpi-title">Email Resp Missed</div>
                                                <div class="kpi-value" id="kpi-email-resp">0</div>
                                                <div class="kpi-recommendation" id="kpi-email-resp-rec">No missed client responses reported.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFive">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="true" aria-controls="collapseFive">
                                    <i class="bi bi-arrow-repeat me-2"></i>5. Subsequent SLA & Response Tracking
                                </button>
                            </h2>
                            <div id="collapseFive" class="accordion-collapse collapse show" aria-labelledby="headingFive">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sub-resp-card" onclick="openDrillDown('subsequentResponseMissed', 'Subsequent Response Missed')">
                                                <span class="kpi-status-tag bg-good" id="kpi-sub-resp-tag">GOOD</span>
                                                <div class="kpi-title">Subsequent Resp Missed</div>
                                                <div class="kpi-value" id="kpi-sub-resp">0</div>
                                                <div class="kpi-recommendation" id="kpi-sub-resp-rec">All subsequent response dates are met or tracked.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sub-sla-card" onclick="openDrillDown('subsequentSLAMiss', 'Subsequent SLA Miss')">
                                                <span class="kpi-status-tag bg-good" id="kpi-sub-sla-tag">GOOD</span>
                                                <div class="kpi-title">Subsequent SLA Miss</div>
                                                <div class="kpi-value" id="kpi-sub-sla">0</div>
                                                <div class="kpi-recommendation" id="kpi-sub-sla-rec">No cases have breached the subsequent SLA threshold.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSix">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="true" aria-controls="collapseSix">
                                    <i class="bi bi-pause-circle me-2"></i>6. Idle Case Monitoring & SR-Specific Compliance (EDOC)
                                </button>
                            </h2>
                            <div id="collapseSix" class="accordion-collapse collapse show" aria-labelledby="headingSix">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-idle-1-card" onclick="openDrillDown('idle1', 'Idle > 1 Day')">
                                                <span class="kpi-status-tag bg-info-tag" id="kpi-idle-1-tag">INFO</span>
                                                <div class="kpi-title">Idle > 1 Day</div>
                                                <div class="kpi-value" id="kpi-idle-1">0</div>
                                                <div class="kpi-recommendation" id="kpi-idle-1-rec">Monitor these cases for potential stagnation.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-idle-3-card" onclick="openDrillDown('idle3', 'Idle > 3 Days')">
                                                <span class="kpi-status-tag bg-good" id="kpi-idle-3-tag">GOOD</span>
                                                <div class="kpi-title">Idle > 3 Days</div>
                                                <div class="kpi-value" id="kpi-idle-3">0</div>
                                                <div class="kpi-recommendation" id="kpi-idle-3-rec">No critical cases idle for more than 3 days.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-edoc-card" onclick="openDrillDown('edocBreach', 'SR EDOC Breach')">
                                                <span class="kpi-status-tag bg-good" id="kpi-edoc-tag">GOOD</span>
                                                <div class="kpi-title">SR EDOC Breach</div>
                                                <div class="kpi-value" id="kpi-edoc">0</div>
                                                <div class="kpi-recommendation" id="kpi-edoc-rec">No SR cases have breached their Expected Date of Closure.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <h5 class="mt-4 mb-2 text-primary"><i class="bi bi-person-lines-fill me-2"></i>Team Performance Scorecard</h5>
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-sm btn-success" onclick="exportScorecardToExcel()"><i class="bi bi-download me-1"></i> Export Scorecard</button>
                    </div>
                    <div class="card p-3 overflow-auto">
                        <table class="table table-sm table-striped scorecard-table" id="owner-scorecard-table" style="min-width: 1400px;">
                            <thead>
                                <tr>
                                    <th>Owner</th>
                                    <th>Overall SLA %</th>
                                    <th>Total Open Cases</th>
                                    <th>Total SR</th>
                                    <th>Total INC</th>
                                    <th>SLA Viol. – SR</th>
                                    <th>SLA Viol. – INC</th>
                                    <th>Aging >15 Days</th>
                                    <th>Oldest >25 Days</th>
                                    <th>F/Up Missed</th>
                                    <th>Email F/Up Missed</th>
                                    <th>Email Resp Missed</th>
                                    <th>Sub. Resp Missed</th>
                                    <th>Sub. SLA Miss</th>
                                    <th>Idle >1 Day</th>
                                    <th>Idle >3 Days</th>
                                    <th>SR EDOC Breach</th>
                                    <th>Risk Gauge</th>
                                </tr>
                            </thead>
                            <tbody id="owner-scorecard-body">
                                <tr><td colspan="18" class="text-center text-muted">Processing data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="view-detailed" role="tabpanel">
                    
                    <div class="row mb-4">
                        <div class="col-md-3"><div class="card metric-card"><div class="card-body"><div class="metric-value" id="total-open-cases">0</div><div class="metric-label">Total Open Cases</div></div></div></div>
                        <div class="col-md-3"><div class="card metric-card"><div class="card-body"><div class="metric-value" id="total-sr-detail">0</div><div class="metric-label">Service Requests</div></div></div></div>
                        <div class="col-md-3"><div class="card metric-card"><div class="card-body"><div class="metric-value" id="total-inc-detail">0</div><div class="metric-label">Incidents</div></div></div></div>
                        <div class="col-md-3"><div class="card metric-card" style="background: linear-gradient(135deg, #27ae60, #3498db);"><div class="card-body"><div class="metric-value" id="sla-compliance-rate">0%</div><div class="metric-label">Overall SLA Compliance</div></div></div></div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6"><div class="card"><div class="card-header"><h5 class="mb-0">Cases by Status</h5></div><div class="card-body"><canvas id="statusChart" height="250"></canvas></div></div></div>
                        <div class="col-md-6"><div class="card"><div class="card-header"><h5 class="mb-0">Aging Analysis</h5></div><div class="card-body"><canvas id="agingChart" height="250"></canvas></div></div></div>
                    </div>

                    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button"><i class="bi bi-lightning-fill text-danger me-1"></i>Today's Actions</button></li>
                        <li class="nav-item"><button class="nav-link" id="cases-tab" data-bs-toggle="tab" data-bs-target="#cases" type="button">All Cases</button></li>
                        <li class="nav-item"><button class="nav-link" id="sla-tab" data-bs-toggle="tab" data-bs-target="#sla" type="button">SLA Violations</button></li>
                        <li class="nav-item"><button class="nav-link" id="aging-tab" data-bs-toggle="tab" data-bs-target="#aging" type="button">Aging >15 Days</button></li>
                        <li class="nav-item"><button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button">Recommendations</button></li>
                        <li class="nav-item"><button class="nav-link" id="owners-tab" data-bs-toggle="tab" data-bs-target="#owners" type="button">Owner Analysis</button></li>
                    </ul>

                    <div class="tab-content" id="dashboardTabsContent">
                        
                        <div class="tab-pane fade show active" id="actions">
                            <div class="alert alert-danger"><i class="bi bi-exclamation-circle-fill me-2"></i>This list shows all cases requiring immediate owner action today (Follow-up Missed, EDOC Breached, Critical Aging).</div>
                            <div id="actions-container"></div>
                        </div>
                        
                        <div class="tab-pane fade" id="cases">
                            <div class="filter-section p-3 bg-light rounded mb-3">
                                <div class="row g-3">
                                    <div class="col-md-3"><select class="form-select" id="filter-service"><option value="">All Service Types</option></select></div>
                                    <div class="col-md-3"><select class="form-select" id="filter-owner"><option value="">All Owners</option></select></div>
                                    <div class="col-md-3"><select class="form-select" id="filter-status"><option value="">All Statuses</option></select></div>
                                    <div class="col-md-3"><button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('cases')">Clear Tab Filters</button></div>
                                </div>
                            </div>
                            <div id="cases-container"></div>
                        </div>

                        <div class="tab-pane fade" id="sla">
                             <div class="filter-section p-3 bg-light rounded mb-3">
                                <div class="row g-3">
                                    <div class="col-md-4"><select class="form-select" id="sla-filter-owner"><option value="">All Owners</option></select></div>
                                    <div class="col-md-4"><button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('sla')">Clear Tab Filters</button></div>
                                </div>
                            </div>
                            <div id="sla-violations-container"></div>
                        </div>

                        <div class="tab-pane fade" id="aging">
                            <div class="filter-section p-3 bg-light rounded mb-3">
                                <div class="row g-3">
                                    <div class="col-md-4"><select class="form-select" id="aging-filter-owner"><option value="">All Owners</option></select></div>
                                    <div class="col-md-4"><button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('aging')">Clear Tab Filters</button></div>
                                </div>
                            </div>
                            <div id="aging-cases-container"></div>
                        </div>

                        <div class="tab-pane fade" id="recommendations">
                            <div id="recommendations-container"></div>
                        </div>

                        <div class="tab-pane fade" id="owners">
                            <div class="row" id="owner-breakdown"></div>
                            <div class="card mt-4"><div class="card-header">SLA & Aging Breakdown by Owner</div><div class="card-body"><canvas id="ownerChart" height="300"></canvas></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="drillDownModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="drillDownTitle">Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span class="badge bg-secondary" id="drillDownCount">0 Cases</span>
                        <button class="btn btn-sm btn-success" onclick="exportDrillDownToExcel()"><i class="bi bi-download me-1"></i> Export List</button>
                    </div>
                    <table class="table table-sm table-hover table-bordered drilldown-table">
                        <thead><tr><th>Incident ID</th><th>Title</th><th>Owner</th><th>Status</th><th>Aging</th><th>SLA Status</th><th>Next Follow-up</th></tr></thead>
                        <tbody id="drillDownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="caseDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="caseDetailTitle">Case Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="case-detail-content">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let rawData = [];
        let processedData = [];
        let filteredData = [];
        let drillDownData = [];
        let drillDownTitleForExport = '';
        let globalFilters = { owner: '', submittedby: '', service: '', status: '', sla: '' };
        let charts = {};
        let scorecardData = [];

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');

            dropArea.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = '#3498db'; });
            dropArea.addEventListener('dragleave', () => { dropArea.style.borderColor = '#ccc'; });
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#ccc';
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            fileInput.onchange = (e) => { handleFileUpload(e.target.files[0]); };

            document.getElementById('process-data-btn').onclick = processData;
            document.getElementById('clear-filters-btn').onclick = clearAllFilters;

            // Set up filter event listeners PROPERLY
            document.getElementById('global-filter-service').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-owner').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-status').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-sla').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-submittedby').addEventListener('change', updateGlobalFilters);
            
            setupTabFilterListeners();
        }

        function setupTabFilterListeners() {
            ['filter-service', 'filter-owner', 'filter-status'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).addEventListener('change', () => filterCases());
            });
            ['sla-filter-owner'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).addEventListener('change', () => filterSLAViolations());
            });
            ['aging-filter-owner'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).addEventListener('change', () => filterAgingCases());
            });
        }

        function handleFileUpload(file) {
            const fileName = file.name;
            document.getElementById('file-name').textContent = fileName;
            document.getElementById('file-info').style.display = 'block';

            const reader = new FileReader();
            reader.onload = (e) => fileName.endsWith('.csv') ? parseCSV(e.target.result) : parseExcel(e.target.result);
            fileName.endsWith('.csv') ? reader.readAsText(file) : reader.readAsBinaryString(file);
        }

        function parseExcel(data) {
            const wb = XLSX.read(data, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            processExcelData(XLSX.utils.sheet_to_json(ws, { header: 1 }));
        }

        function parseCSV(data) {
            processExcelData(data.split('\n').map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim())));
        }

        function findColumn(headers, possibleNames) {
            for (const name of possibleNames) {
                const found = headers.find(h => h && h.toString().toLowerCase().includes(name.toLowerCase()));
                if (found) return found;
            }
            return possibleNames[0];
        }

        function processExcelData(data) {
            if (!data || data.length < 2) {
                alert("No data found or file format is incorrect.");
                return;
            }

            const headers = data[0].map(h => h ? h.trim() : '');
            rawData = data.slice(1).map(row => {
                const rowObj = {};
                headers.forEach((header, index) => {
                    rowObj[header] = row[index];
                });
                return rowObj;
            }).filter(row => Object.values(row).some(v => v));

            document.getElementById('row-count').textContent = `${rawData.length} rows loaded`;
            
            const parseNum = (val) => {
                if (val === null || val === undefined || val === '' || val === '--' || val === 'NULL') return 0;
                if (typeof val === 'string' && val.includes('Day(s)')) {
                    const dayMatch = val.match(/(\d+)\s*Day\(s\)/);
                    const hourMatch = val.match(/(\d+)\s*Hour\(s\)/);
                    const minMatch = val.match(/(\d+)\s*Min\(s\)/);
                    const days = dayMatch ? parseInt(dayMatch[1]) : 0;
                    const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
                    const mins = minMatch ? parseInt(minMatch[1]) : 0;
                    return days + (hours / 24) + (mins / 1440);
                }
                const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
                return isNaN(num) ? 0 : num;
            };
            
            const parseAgingDays = (val) => {
                const num = parseNum(val);
                return Math.round(num);
            };
            
            const isDateValid = (dStr) => {
                if (!dStr || dStr === '--' || dStr === 'NULL' || dStr === '0002-11-30 00:00' || dStr === 'Na' || dStr === 'NA') return false;
                const date = new Date(dStr);
                return !isNaN(date.getTime());
            };
            
            const isPast = (dStr) => isDateValid(dStr) && new Date(dStr) <= new Date();
            
            const findCol = (possibleNames) => {
                for (const name of possibleNames) {
                    const found = headers.find(h => h && h.toString().toLowerCase().includes(name.toLowerCase()));
                    if (found) return found;
                }
                return possibleNames[0];
            };

            const colMap = {
                incidentId: findCol(['Incident ID', 'Ticket ID', 'Case ID']),
                title: findCol(['Title', 'Subject', 'Description']),
                submittedBy: findCol(['SubmittedBy', 'Submitted By', 'Reporter']),
                currentStatus: findCol(['CurrentStatus', 'Status', 'State']),
                service: findCol(['Service', 'Service Type', 'Type']),
                owner: findCol(['Owner', 'Assigned To', 'Engineer']),
                aging15Status: findCol(['Aging >15 days Status', 'Aging Status', 'Aging >15']),
                expectedResponseTime: findCol(['Expected Response Time', 'Response Time']),
                expectedResolutionTime: findCol(['Expected Resolution Time', 'Resolution Time']),
                expectedSLAClosureTime: findCol(['Expected SLA Closure Time', 'SLA Closure']),
                srEDOC: findCol(['SR EDOC', 'EDOC', 'Expected Date of Closure']),
                slaStatus: findCol(['SLA Status', 'SLA']),
                slaViolationStatus: findCol(['SLA Violation Status', 'Violation Status']),
                agingRoundoff: findCol(['Aging(Roundoff)', 'Aging', 'Age (Days)']),
                nextFollowUpDate: findCol(['Next Follow-up Date', 'Follow-up Date', 'Next Followup']),
                emailResponseCompliance: findCol(['Email Response Compliance', 'Email Compliance']),
                updatePendingSupportCounter: findCol(['Update Pending From Support Counter', 'Pending Counter']),
                ageingLastModified: findCol(['Ageing from Last modified time', 'Last Modified Aging']),
                steps: findCol(['Steps to be followed', 'Steps', 'Resolution Steps'])
            };

            processedData = rawData.map(row => {
                const service = row[colMap.service] || '';
                const slaViolationStatus = row[colMap.slaViolationStatus] || 'Non-Violated';
                const agingRoundoff = row[colMap.agingRoundoff] || '0';
                const aging15Status = row[colMap.aging15Status] || 'Non-Violated';
                const emailCompliance = row[colMap.emailResponseCompliance] || '';
                const srEDOC = row[colMap.srEDOC] || '';
                const nextFollowUp = row[colMap.nextFollowUpDate] || '';
                const expectedResponseTime = row[colMap.expectedResponseTime] || '';
                
                const agingDays = parseAgingDays(agingRoundoff);
                const subsequentSLACount = parseNum(row[colMap.updatePendingSupportCounter] || '0');
                const agingFromLastModified = parseNum(row[colMap.ageingLastModified] || '0');

                const isSR = service === 'Service Request';
                const isINC = service === 'Incident Management';
                const isSlaViolated = slaViolationStatus === 'Violated';
                const isAging15Violated = aging15Status === 'Violated';
                const isFollowUpMissed = (!isDateValid(nextFollowUp) || isPast(nextFollowUp));
                const isSubsequentResponseMissed = (!isDateValid(expectedResponseTime) || isPast(expectedResponseTime));
                const isSubsequentSLABreach = subsequentSLACount > 0;
                const isEdocBreached = (isSR && isPast(srEDOC));
                const isOldest25 = agingDays > 25;
                const isIdle1 = agingFromLastModified > 0;
                const isIdle3 = agingFromLastModified > 1;

                return {
                    incidentId: row[colMap.incidentId] || 'N/A',
                    owner: row[colMap.owner] || 'Unassigned',
                    title: row[colMap.title] || 'No Title',
                    currentStatus: row[colMap.currentStatus] || 'Unknown',
                    service: service,
                    submittedBy: row[colMap.submittedBy] || 'Unknown',
                    agingDays: agingDays,
                    agingFromLastModified: agingFromLastModified,
                    slaViolationStatus: slaViolationStatus,
                    nextFollowUp: nextFollowUp,
                    subsequentResponse: expectedResponseTime,
                    emailCompliance: emailCompliance,
                    expectedResolution: srEDOC,
                    subsequentSLABreachCount: subsequentSLACount,
                    
                    isSR,
                    isINC,
                    isSlaViolated,
                    isAging15Violated,
                    isFollowUpMissed,
                    isSubsequentResponseMissed,
                    isSubsequentSLABreach,
                    isEdocBreached,
                    isOldest25,
                    isIdle1,
                    isIdle3,
                    
                    _raw: row
                };
            });

            filteredData = [...processedData];
            updateDashboard();
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('total-cases').textContent = `${processedData.length} Cases Loaded`;
            document.getElementById('last-updated').textContent = `Last Updated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;

            populateFilterDropdowns();
            renderDetailedDashboard();
        }

        function populateFilterDropdowns() {
            const getUniqueValues = (key) => [...new Set(processedData.map(d => d[key]).filter(Boolean).sort())];

            const dropdowns = {
                'global-filter-owner': getUniqueValues('owner'),
                'global-filter-submittedby': getUniqueValues('submittedBy'),
                'global-filter-service': getUniqueValues('service'),
                'global-filter-status': getUniqueValues('currentStatus'),
                'filter-owner': getUniqueValues('owner'),
                'filter-service': getUniqueValues('service'),
                'filter-status': getUniqueValues('currentStatus'),
                'sla-filter-owner': getUniqueValues('owner'),
                'aging-filter-owner': getUniqueValues('owner')
            };

            for (const id in dropdowns) {
                const select = document.getElementById(id);
                if (select) {
                    const originalValue = select.value;
                    select.innerHTML = `<option value="">All ${id.split('-').pop().replace('global', 'Owners').replace('service', 'Service Types').replace('status', 'Statuses')}</option>`;
                    dropdowns[id].forEach(value => {
                        select.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                    if (originalValue && dropdowns[id].includes(originalValue)) {
                        select.value = originalValue;
                    }
                }
            }
        }

        function updateGlobalFilters() {
            console.log("Filters updating...");
            
            globalFilters.owner = document.getElementById('global-filter-owner').value;
            globalFilters.submittedby = document.getElementById('global-filter-submittedby').value;
            globalFilters.service = document.getElementById('global-filter-service').value;
            globalFilters.status = document.getElementById('global-filter-status').value;
            globalFilters.sla = document.getElementById('global-filter-sla').value;

            filteredData = processedData.filter(d => {
                if (globalFilters.owner && d.owner !== globalFilters.owner) return false;
                if (globalFilters.submittedby && d.submittedBy !== globalFilters.submittedby) return false;
                if (globalFilters.service && d.service !== globalFilters.service) return false;
                if (globalFilters.status && d.currentStatus !== globalFilters.status) return false;
                if (globalFilters.sla === 'Violated' && !d.isSlaViolated) return false;
                if (globalFilters.sla === 'Non-Violated' && d.isSlaViolated) return false;
                return true;
            });

            console.log(`Filtered data: ${filteredData.length} cases`);
            
            // CRITICAL: Update both views
            renderKPIDashboard();
            renderDetailedDashboard();
            
            const activeCount = Object.values(globalFilters).filter(v => v).length;
            document.getElementById('active-filters-count').textContent = `${activeCount} filter${activeCount === 1 ? '' : 's'} active`;
        }

        function clearAllFilters() {
            console.log("Clearing all filters");
            
            document.getElementById('global-filter-owner').value = '';
            document.getElementById('global-filter-submittedby').value = '';
            document.getElementById('global-filter-service').value = '';
            document.getElementById('global-filter-status').value = '';
            document.getElementById('global-filter-sla').value = '';
            
            globalFilters.owner = '';
            globalFilters.submittedby = '';
            globalFilters.service = '';
            globalFilters.status = '';
            globalFilters.sla = '';
            
            filteredData = [...processedData];
            
            console.log(`Reset to ${filteredData.length} cases`);
            
            renderKPIDashboard();
            renderDetailedDashboard();
            
            document.getElementById('active-filters-count').textContent = '0 filters active';
        }

        function updateOwnerFilter(owner) {
            document.getElementById('global-filter-owner').value = owner;
            updateGlobalFilters();
        }

        function updateCard(kpiId, value, recommendation, drillDownFunction) {
            document.getElementById(kpiId).textContent = value;
            document.getElementById(`${kpiId}-tag`).textContent = recommendation.status;
            document.getElementById(`${kpiId}-tag`).className = `kpi-status-tag ${recommendation.tag}`;
            document.getElementById(`${kpiId}-rec`).textContent = recommendation.rec;
            document.getElementById(`${kpiId}-card`).onclick = drillDownFunction;
        }

        function renderKPIDashboard() {
            const m = {
                totalOpen: filteredData.length,
                totalSR: filteredData.filter(d => d.isSR).length,
                totalINC: filteredData.filter(d => d.isINC).length,
                slaSR: filteredData.filter(d => d.isSR && d.isSlaViolated).length,
                slaINC: filteredData.filter(d => d.isINC && d.isSlaViolated).length,
                aging15: filteredData.filter(d => d.isAging15Violated).length,
                oldest25: filteredData.filter(d => d.isOldest25).length,
                followUp: filteredData.filter(d => d.isFollowUpMissed).length,
                emailMiss: filteredData.filter(d => d.emailCompliance === 'No Followup').length,
                respMiss: filteredData.filter(d => d.emailCompliance === 'Email Response Missed').length,
                subRespMiss: filteredData.filter(d => d.isSubsequentResponseMissed).length,
                subSLAMiss: filteredData.filter(d => d.isSubsequentSLABreach).length,
                idle1: filteredData.filter(d => d.isIdle1).length,
                idle3: filteredData.filter(d => d.isIdle3).length,
                edoc: filteredData.filter(d => d.isEdocBreached).length,
            };

            const infoRec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Statistical count of active cases.' };
            const srRec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Breakdown of active Service Requests.' };
            const incRec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Breakdown of active Incident Management cases.' };

            let slaSRRec = { status: 'GOOD', tag: 'bg-good', rec: 'No SR cases currently in violation.' };
            if (m.slaSR > 0) slaSRRec = { status: 'URGENT', tag: 'bg-urgent', rec: `Immediate action required to resolve ${m.slaSR} violated SR cases.` };

            let slaINCRec = { status: 'GOOD', tag: 'bg-good', rec: 'No INC cases currently in violation.' };
            if (m.slaINC > 0) slaINCRec = { status: 'URGENT', tag: 'bg-urgent', rec: `Immediate action required to resolve ${m.slaINC} violated INC cases.` };

            let aging15Rec = { status: 'GOOD', tag: 'bg-good', rec: 'No cases have crossed the 15-day warning threshold.' };
            if (m.aging15 > 0) aging15Rec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `${m.aging15} cases are aging > 15 days. Prioritize these for closure.` };
            if (m.oldest25 > 0) aging15Rec = { status: 'URGENT', tag: 'bg-urgent', rec: `Contains ${m.oldest25} critical cases aged > 25 days. URGENT action.` };

            let oldest25Rec = { status: 'GOOD', tag: 'bg-good', rec: 'No critical old cases requiring urgent action.' };
            if (m.oldest25 > 0) oldest25Rec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.oldest25} cases are critically old (> 25 days). URGENT action.` };

            let fuRec = { status: 'GOOD', tag: 'bg-good', rec: 'All cases have a valid, upcoming follow-up date.' };
            if (m.followUp > 0) fuRec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.followUp} follow-up dates missed. Update immediately.` };

            let emailFURec = { status: 'GOOD', tag: 'bg-good', rec: 'All email follow-ups are compliant.' };
            if (m.emailMiss > 0) emailFURec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `${m.emailMiss} email follow-ups missed. Check last email action.` };

            let respMissRec = { status: 'GOOD', tag: 'bg-good', rec: 'No missed client responses reported.' };
            if (m.respMiss > 0) respMissRec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.respMiss} email responses missed. High risk of SLA breach.` };

            let subRespRec = { status: 'GOOD', tag: 'bg-good', rec: 'All subsequent response dates are met or tracked.' };
            if (m.subRespMiss > 0) subRespRec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `${m.subRespMiss} subsequent responses missed. Update case.` };

            let subSLARec = { status: 'GOOD', tag: 'bg-good', rec: 'No cases have breached the subsequent SLA threshold.' };
            if (m.subSLAMiss > 0) subSLARec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.subSLAMiss} subsequent SLA breaches. Root cause analysis needed.` };

            let idle1Rec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Monitor these cases for potential stagnation.' };
            if (m.idle1 > 0) {
                idle1Rec = { status: 'MONITOR', tag: 'bg-monitor', rec: `${m.idle1} cases idle > 1 day. Check last action and assign follow-up.` };
            }
            if (m.idle3 > 0) {
                idle1Rec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `Contains ${m.idle3} critical cases idle > 3 days. Focus on these.` };
            }
            
            let idle3Rec = { status: 'GOOD', tag: 'bg-good', rec: 'No critical cases idle for more than 3 days.' };
            if (m.idle3 > 0) { 
                idle3Rec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.idle3} cases are critically idle (> 3 days). URGENT follow-up.` }; 
            }

            let edocRec = { status: 'GOOD', tag: 'bg-good', rec: 'No SR cases have breached their Expected Date of Closure.' };
            if (m.edoc > 0) edocRec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.edoc} SR EDOC breaches. These must be resolved or re-scheduled immediately.` };

            updateCard('kpi-total', m.totalOpen, infoRec, () => openDrillDown('totalOpen', 'Total Open Cases'));
            updateCard('kpi-sr', m.totalSR, srRec, () => openDrillDown('totalSR', 'Total Service Requests (SR)'));
            updateCard('kpi-inc', m.totalINC, incRec, () => openDrillDown('totalINC', 'Total Incidents (INC)'));

            updateCard('kpi-sla-sr', m.slaSR, slaSRRec, () => openDrillDown('slaSR', 'SLA Violated - SR'));
            updateCard('kpi-sla-inc', m.slaINC, slaINCRec, () => openDrillDown('slaINC', 'SLA Violated - INC'));

            updateCard('kpi-aging-15', m.aging15, aging15Rec, () => openDrillDown('aging15', 'Aging > 15 Days'));
            updateCard('kpi-aging-25', m.oldest25, oldest25Rec, () => openDrillDown('oldest25', 'Oldest Cases (> 25 Days)'));

            updateCard('kpi-followup', m.followUp, fuRec, () => openDrillDown('followUpMissed', 'Follow-up Date Missed'));
            updateCard('kpi-email-followup', m.emailMiss, emailFURec, () => openDrillDown('emailNoFollowup', 'Email Follow-up Missed'));
            updateCard('kpi-email-resp', m.respMiss, respMissRec, () => openDrillDown('emailResponseMissed', 'Email Response Missed'));

            updateCard('kpi-sub-resp', m.subRespMiss, subRespRec, () => openDrillDown('subsequentResponseMissed', 'Subsequent Response Missed'));
            updateCard('kpi-sub-sla', m.subSLAMiss, subSLARec, () => openDrillDown('subsequentSLAMiss', 'Subsequent SLA Miss'));

            updateCard('kpi-idle-1', m.idle1, idle1Rec, () => openDrillDown('idle1', 'Idle > 1 Day'));
            updateCard('kpi-idle-3', m.idle3, idle3Rec, () => openDrillDown('idle3', 'Idle > 3 Days'));
            updateCard('kpi-edoc', m.edoc, edocRec, () => openDrillDown('edocBreach', 'SR EDOC Breach'));
            
            const slaViolatedCount = filteredData.filter(d => d.isSlaViolated).length;
            const overallSLACompliance = filteredData.length > 0 ? (((filteredData.length - slaViolatedCount) / filteredData.length) * 100).toFixed(1) : 100.0;
            renderOwnerScorecard(overallSLACompliance);
        }

        function renderOwnerScorecard(overallSLACompliance) {
            const counts = {};
            filteredData.forEach(d => {
                if(!counts[d.owner]) counts[d.owner] = { 
                    total: 0, 
                    violations: 0, 
                    sr: 0, 
                    inc: 0, 
                    slaSR: 0, 
                    slaINC: 0,
                    aging15: 0, 
                    oldest25: 0, 
                    followUpMissed: 0, 
                    emailFollowupMissed: 0,
                    emailResponseMissed: 0,
                    subsequentResponseMissed: 0,
                    subsequentSLABreach: 0,
                    idle1: 0,
                    idle3: 0,
                    edocBreach: 0,
                };
                counts[d.owner].total++;
                if(d.isSlaViolated) counts[d.owner].violations++;
                if(d.isSR) counts[d.owner].sr++;
                if(d.isINC) counts[d.owner].inc++;
                if(d.isSR && d.isSlaViolated) counts[d.owner].slaSR++;
                if(d.isINC && d.isSlaViolated) counts[d.owner].slaINC++;
                if(d.isAging15Violated) counts[d.owner].aging15++;
                if(d.isOldest25) counts[d.owner].oldest25++;
                if(d.isFollowUpMissed) counts[d.owner].followUpMissed++;
                if(d.emailCompliance === 'No Followup') counts[d.owner].emailFollowupMissed++;
                if(d.emailCompliance === 'Email Response Missed') counts[d.owner].emailResponseMissed++;
                if(d.isSubsequentResponseMissed) counts[d.owner].subsequentResponseMissed++;
                if(d.isSubsequentSLABreach) counts[d.owner].subsequentSLABreach++;
                if(d.isIdle1) counts[d.owner].idle1++;
                if(d.isIdle3) counts[d.owner].idle3++;
                if(d.isEdocBreached) counts[d.owner].edocBreach++;
            });

            scorecardData = [];
            const scorecardHtml = Object.keys(counts).sort().map(o => {
                const stats = counts[o];
                const complianceRate = stats.total > 0 ? (((stats.total - stats.violations) / stats.total) * 100).toFixed(1) : 100.0;
                let complianceColor = 'bg-success';
                if (complianceRate < 80) complianceColor = 'bg-danger';
                else if (complianceRate < 95) complianceColor = 'bg-warning';

                scorecardData.push({
                    'Owner': o,
                    'Overall SLA %': complianceRate,
                    'Total Open Cases': stats.total,
                    'Total SR': stats.sr,
                    'Total INC': stats.inc,
                    'SLA Viol. – SR': stats.slaSR,
                    'SLA Viol. – INC': stats.slaINC,
                    'Aging >15 Days': stats.aging15,
                    'Oldest >25 Days': stats.oldest25,
                    'F/Up Missed': stats.followUpMissed,
                    'Email F/Up Missed': stats.emailFollowupMissed,
                    'Email Resp Missed': stats.emailResponseMissed,
                    'Sub. Resp Missed': stats.subsequentResponseMissed,
                    'Sub. SLA Miss': stats.subsequentSLABreach,
                    'Idle >1 Day': stats.idle1,
                    'Idle >3 Days': stats.idle3,
                    'SR EDOC Breach': stats.edocBreach,
                });

                return `
                    <tr class="align-middle" onclick="updateOwnerFilter('${o}')" style="cursor: pointer;">
                        <td>${o}</td>
                        <td class="${complianceRate < 80 ? 'critical-cell' : complianceRate < 95 ? 'high-cell' : 'success-cell'}">${complianceRate}%</td>
                        <td>${stats.total}</td>
                        <td>${stats.sr}</td>
                        <td>${stats.inc}</td>
                        <td class="${stats.slaSR > 0 ? 'critical-cell' : ''}">${stats.slaSR}</td>
                        <td class="${stats.slaINC > 0 ? 'critical-cell' : ''}">${stats.slaINC}</td>
                        <td class="${stats.aging15 > 0 ? 'high-cell' : ''}">${stats.aging15}</td>
                        <td class="${stats.oldest25 > 0 ? 'critical-cell' : ''}">${stats.oldest25}</td>
                        <td class="${stats.followUpMissed > 0 ? 'high-cell' : ''}">${stats.followUpMissed}</td>
                        <td class="${stats.emailFollowupMissed > 0 ? 'high-cell' : ''}">${stats.emailFollowupMissed}</td>
                        <td class="${stats.emailResponseMissed > 0 ? 'critical-cell' : ''}">${stats.emailResponseMissed}</td>
                        <td class="${stats.subsequentResponseMissed > 0 ? 'critical-cell' : ''}">${stats.subsequentResponseMissed}</td>
                        <td class="${stats.subsequentSLABreach > 0 ? 'critical-cell' : ''}">${stats.subsequentSLABreach}</td>
                        <td class="${stats.idle1 > 0 ? 'high-cell' : ''}">${stats.idle1}</td>
                        <td class="${stats.idle3 > 0 ? 'critical-cell' : ''}">${stats.idle3}</td>
                        <td class="${stats.edocBreach > 0 ? 'critical-cell' : ''}">${stats.edocBreach}</td>
                        <td>
                            <div class="progress compliance-gauge">
                                <div class="progress-bar ${complianceColor}" role="progressbar" style="width: ${complianceRate}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('owner-scorecard-body').innerHTML = scorecardHtml || '<tr><td colspan="18" class="text-center text-muted">No data found for selected filters.</td></tr>';
        }

        function openDrillDown(kpi, title) {
            drillDownTitleForExport = title;
            document.getElementById('drillDownTitle').textContent = title;

            switch(kpi) {
                case 'totalOpen':
                    drillDownData = filteredData;
                    break;
                case 'totalSR':
                    drillDownData = filteredData.filter(d => d.isSR);
                    break;
                case 'totalINC':
                    drillDownData = filteredData.filter(d => d.isINC);
                    break;
                case 'slaSR':
                    drillDownData = filteredData.filter(d => d.isSR && d.isSlaViolated);
                    break;
                case 'slaINC':
                    drillDownData = filteredData.filter(d => d.isINC && d.isSlaViolated);
                    break;
                case 'aging15':
                    drillDownData = filteredData.filter(d => d.isAging15Violated);
                    break;
                case 'oldest25':
                    drillDownData = filteredData.filter(d => d.isOldest25);
                    break;
                case 'followUpMissed':
                    drillDownData = filteredData.filter(d => d.isFollowUpMissed);
                    break;
                case 'emailNoFollowup':
                    drillDownData = filteredData.filter(d => d.emailCompliance === 'No Followup');
                    break;
                case 'emailResponseMissed':
                    drillDownData = filteredData.filter(d => d.emailCompliance === 'Email Response Missed');
                    break;
                case 'subsequentResponseMissed':
                    drillDownData = filteredData.filter(d => d.isSubsequentResponseMissed);
                    break;
                case 'subsequentSLAMiss':
                    drillDownData = filteredData.filter(d => d.isSubsequentSLABreach);
                    break;
                case 'idle1':
                    drillDownData = filteredData.filter(d => d.isIdle1);
                    break;
                case 'idle3':
                    drillDownData = filteredData.filter(d => d.isIdle3);
                    break;
                case 'edocBreach':
                    drillDownData = filteredData.filter(d => d.isEdocBreached);
                    break;
                default:
                    drillDownData = [];
            }
            
            document.getElementById('drillDownCount').textContent = `${drillDownData.length} Cases`;

            const drillDownHtml = drillDownData.map((d, index) => `
                <tr onclick="viewCaseDetail(${processedData.findIndex(p => p.incidentId === d.incidentId)})" style="cursor: pointer;">
                    <td>${d.incidentId}</td>
                    <td><div style="max-width:350px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${d.title}">${d.title}</div></td>
                    <td>${d.owner}</td>
                    <td>${d.currentStatus}</td>
                    <td>${d.agingDays}</td>
                    <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaViolationStatus}</td>
                    <td>${d.nextFollowUp || '--'}</td>
                </tr>
            `).join('');

            document.getElementById('drillDownBody').innerHTML = drillDownHtml || '<tr><td colspan="7" class="text-center text-muted">No cases found.</td></tr>';

            new bootstrap.Modal(document.getElementById('drillDownModal')).show();
        }

        function renderDetailedDashboard() {
            const totalCases = filteredData.length;
            const slaViolatedCount = filteredData.filter(d => d.isSlaViolated).length;
            const slaComplianceRate = totalCases > 0 ? ((totalCases - slaViolatedCount) / totalCases * 100).toFixed(1) : 100.0;

            document.getElementById('total-open-cases').textContent = totalCases;
            document.getElementById('total-sr-detail').textContent = filteredData.filter(d => d.isSR).length;
            document.getElementById('total-inc-detail').textContent = filteredData.filter(d => d.isINC).length;
            document.getElementById('sla-compliance-rate').textContent = `${slaComplianceRate}%`;

            renderOriginalCharts();
            renderTodayActions();
            renderAllCases();
            renderSLAViolations();
            renderAgingCases();
            renderRecommendations();
            renderOwnerAnalysis();
        }

        function renderOriginalCharts() {
            Object.values(charts).forEach(chart => chart && chart.destroy());

            const statusCounts = {};
            filteredData.forEach(d => {
                statusCounts[d.currentStatus] = (statusCounts[d.currentStatus] || 0) + 1;
            });
            charts.statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#2c3e50', '#3498db', '#95a5a6', '#e74c3c', '#27ae60', '#f39c12']
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                }
            });

            const aCounts = { '0-5':0, '6-10':0, '11-15':0, '16+':0 };
            filteredData.forEach(d => {
                if(d.agingDays<=5) aCounts['0-5']++;
                else if(d.agingDays<=10) aCounts['6-10']++;
                else if(d.agingDays<=15) aCounts['11-15']++;
                else aCounts['16+']++;
            });
            charts.agingChart = new Chart(document.getElementById('agingChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(aCounts),
                    datasets: [{
                        label: 'Cases',
                        data: Object.values(aCounts),
                        backgroundColor: ['#27ae60', '#f39c12', '#e67e22', '#c0392b']
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const ownerCounts = {};
            filteredData.forEach(d => {
                if(!ownerCounts[d.owner]) ownerCounts[d.owner] = { total: 0, violations: 0, aging15: 0 };
                ownerCounts[d.owner].total++;
                if(d.isSlaViolated) ownerCounts[d.owner].violations++;
                if(d.isAging15Violated) ownerCounts[d.owner].aging15++;
            });

            const owners = Object.keys(ownerCounts).sort();
            const violationRates = owners.map(o => (ownerCounts[o].violations / ownerCounts[o].total * 100).toFixed(1));
            const aging15Counts = owners.map(o => ownerCounts[o].aging15);
            
            charts.ownerChart = new Chart(document.getElementById('ownerChart'), {
                type: 'bar',
                data: {
                    labels: owners,
                    datasets: [
                        {
                            label: 'SLA Violation Rate (%)',
                            data: violationRates,
                            backgroundColor: 'rgba(192, 57, 43, 0.7)',
                            yAxisID: 'y1',
                        },
                        {
                            label: 'Aging > 15 Days Count',
                            data: aging15Counts,
                            backgroundColor: 'rgba(243, 156, 18, 0.7)',
                            yAxisID: 'y2',
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        x: { stacked: false },
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left',
                            title: { display: true, text: 'Violation Rate (%)' },
                            beginAtZero: true,
                            max: 100
                        },
                        y2: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right',
                            title: { display: true, text: 'Aging Count' },
                            grid: { drawOnChartArea: false },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTodayActions() {
            const actionCases = filteredData.filter(d => 
                d.isSlaViolated || 
                d.isOldest25 || 
                d.isEdocBreached || 
                d.isFollowUpMissed || 
                d.isSubsequentResponseMissed || 
                d.isIdle3
            );
            renderFilteredCases(actionCases, 'actions-container', true);
        }

        function renderAllCases() {
            filterCases();
        }

        function renderSLAViolations() {
            filterSLAViolations();
        }

        function renderAgingCases() {
            filterAgingCases();
        }

        function filterCases() {
            const svc = document.getElementById('filter-service').value;
            const own = document.getElementById('filter-owner').value;
            const stat = document.getElementById('filter-status').value;

            let sub = filteredData.filter(d => 
                (!svc || d.service===svc) && 
                (!own || d.owner===own) && 
                (!stat || d.currentStatus===stat)
            );
            renderFilteredCases(sub, 'cases-container', false);
        }

        function filterSLAViolations() {
            const own = document.getElementById('sla-filter-owner').value;
            let sub = filteredData.filter(d => d.isSlaViolated && (!own || d.owner===own));
            renderFilteredCases(sub, 'sla-violations-container', false);
        }
        
        function filterAgingCases() {
            const own = document.getElementById('aging-filter-owner').value;
            let sub = filteredData.filter(d => d.isAging15Violated && (!own || d.owner===own));
            renderFilteredCases(sub, 'aging-cases-container', false);
        }

        function clearTabFilters(tabId) {
            if (tabId === 'cases') {
                document.getElementById('filter-service').value = '';
                document.getElementById('filter-owner').value = '';
                document.getElementById('filter-status').value = '';
                filterCases();
            } else if (tabId === 'sla') {
                document.getElementById('sla-filter-owner').value = '';
                filterSLAViolations();
            } else if (tabId === 'aging') {
                document.getElementById('aging-filter-owner').value = '';
                filterAgingCases();
            }
        }

        function renderFilteredCases(cases, containerId, isActionList = false) {
            const container = document.getElementById(containerId);
            if(!cases.length) {
                container.innerHTML = `<div class="alert alert-info mt-3">No cases matching the criteria found.</div>`;
                return;
            }

            const tableHtml = `
                <table class="table table-sm table-striped table-hover mt-3 detailed-case-table">
                    <thead>
                        <tr>
                            <th>Incident ID</th>
                            <th>Title</th>
                            <th>Owner</th>
                            <th>Status</th>
                            <th>Aging</th>
                            <th>SLA Status</th>
                            <th>Next Follow-up</th>
                            ${isActionList ? '<th>Action Reason</th>' : ''}
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cases.map(d => {
                            const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                            let actionReason = '';
                            if (isActionList) {
                                const reasons = [];
                                if (d.isSlaViolated) reasons.push('SLA Violated');
                                if (d.isOldest25) reasons.push('Aged > 25 Days');
                                if (d.isEdocBreached) reasons.push('EDOC Breached');
                                if (d.isFollowUpMissed) reasons.push('F/Up Missed');
                                if (d.isSubsequentResponseMissed) reasons.push('Sub. Resp Missed');
                                if (d.isIdle3) reasons.push('Idle > 3 Days');
                                actionReason = `<td class="text-danger fw-bold small">${reasons.join(', ')}</td>`;
                            }
                            return `
                                <tr class="align-middle" style="cursor: pointer;">
                                    <td>${d.incidentId}</td>
                                    <td><div style="max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${d.title}">${d.title}</div></td>
                                    <td>${d.owner}</td>
                                    <td>${d.currentStatus}</td>
                                    <td>${d.agingDays}</td>
                                    <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaViolationStatus}</td>
                                    <td>${d.nextFollowUp || '--'}</td>
                                    ${actionReason}
                                    <td><button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetail(${globalIndex})">View</button></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHtml;
        }

        function renderRecommendations() {
            const recommendations = [];
            filteredData.forEach(d => {
                const recs = [];
                if (d.isOldest25) recs.push({text: `Aged > 25 Days: Needs immediate action plan.`, color: 'text-danger'});
                if (d.isEdocBreached) recs.push({text: `SR EDOC Breach: Requires urgent resolution or EDOC change.`, color: 'text-danger'});
                if (d.isSlaViolated) recs.push({text: `SLA Violated: Check root cause and plan fix.`, color: 'text-danger'});
                if (d.isFollowUpMissed) recs.push({text: `Follow-up Date Missed: Update next follow-up date now.`, color: 'text-danger'});
                if (d.isSubsequentResponseMissed) recs.push({text: `Subsequent Response Missed: Update case action plan.`, color: 'text-danger'});
                if (d.isIdle3) recs.push({text: `Idle > 3 Days: Needs immediate follow-up to client or internal team.`, color: 'text-danger'});
                
                if(recs.length) recommendations.push({incidentId: d.incidentId, title: d.title, owner: d.owner, recs: recs});
            });

            const container = document.getElementById('recommendations-container');
            container.innerHTML = recommendations.length ? '' : '<div class="alert alert-success mt-3">No critical recommendations found. Good job!</div>';
            
            container.innerHTML += recommendations.map(rec => {
                const globalIndex = processedData.findIndex(d => d.incidentId === rec.incidentId);
                return `
                    <div class="card mb-3 border-start border-4 border-danger">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">${rec.incidentId} - ${rec.owner}</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">${rec.title}</p>
                            <ul>
                                ${rec.recs.map(r => `<li class="${r.color} fw-bold">${r.text}</li>`).join('')}
                            </ul>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetail(${globalIndex})">View Action Plan</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderOwnerAnalysis() {
            const counts = {};
            filteredData.forEach(d => {
                if(!counts[d.owner]) counts[d.owner] = { total: 0, violations: 0, aging15: 0, sr: 0, inc: 0 };
                counts[d.owner].total++;
                if(d.isSlaViolated) counts[d.owner].violations++;
                if(d.isAging15Violated) counts[d.owner].aging15++;
                if(d.isSR) counts[d.owner].sr++;
                if(d.isINC) counts[d.owner].inc++;
            });

            const owners = Object.keys(counts).sort((a,b) => counts[b].total - counts[a].total);
            const breakdownHtml = owners.map(o => {
                const stats = counts[o];
                const complianceRate = stats.total > 0 ? ((stats.total - stats.violations) / stats.total * 100).toFixed(1) : 100;
                return `
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body py-3">
                                <h5 class="mb-2">${o}</h5>
                                <div class="row small fw-bold">
                                    <div class="col-4">${stats.total}<br><span class="text-muted">Total</span></div>
                                    <div class="col-4 text-danger">${stats.violations}<br><span class="text-muted">Violations</span></div>
                                    <div class="col-4 text-warning">${stats.aging15}<br><span class="text-muted">Aging >15</span></div>
                                </div>
                                <h4 class="mt-3 ${complianceRate < 80 ? 'text-danger' : complianceRate < 95 ? 'text-warning' : 'text-success'}">${complianceRate}%</h4>
                                <p class="small text-muted mb-0">SLA Compliance Rate</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('owner-breakdown').innerHTML = breakdownHtml;
        }

        function viewCaseDetail(idx) {
            const d = processedData[idx];
            document.getElementById('caseDetailTitle').textContent = `${d.incidentId}: ${d.title}`;
            document.getElementById('case-detail-content').innerHTML = `
                <h5>${d.incidentId}: ${d.title}</h5>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Owner:</strong> <span class="owner-tag">${d.owner}</span></p>
                        <p><strong>Status:</strong> ${d.currentStatus}</p>
                        <p><strong>Service:</strong> ${d.service}</p>
                        <p><strong>SLA:</strong> <span class="fw-bold text-${d.isSlaViolated ? 'danger' : 'success'}">${d.slaViolationStatus}</span></p>
                        <p><strong>Submitted By:</strong> ${d.submittedBy}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Aging:</strong> ${d.agingDays} days</p>
                        <p><strong>Idle Since Last Modified:</strong> ${d.agingFromLastModified} days</p>
                        <p><strong>Next Follow-up (R:R):</strong> <span class="fw-bold text-${d.isFollowUpMissed ? 'danger' : 'success'}">${d.nextFollowUp || '--'}</span></p>
                        <p><strong>Subsequent Response (H:H):</strong> <span class="fw-bold text-${d.isSubsequentResponseMissed ? 'danger' : 'success'}">${d.subsequentResponse || '--'}</span></p>
                        <p><strong>Expected Resolution (K:K):</strong> <span class="fw-bold text-${d.isEdocBreached ? 'danger' : 'success'}">${d.expectedResolution || '--'}</span></p>
                    </div>
                </div>
                <hr>
                <h6>Compliance and Missed Actions (S:S)</h6>
                <p><strong>Email Compliance:</strong> <span class="fw-bold text-${d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup') ? 'danger' : 'success'}">${d.emailCompliance || 'Compliant'}</span></p>
                <p><strong>Subsequent SLA Miss Count (Y:Y):</strong> <span class="fw-bold text-${d.isSubsequentSLABreach ? 'danger' : 'success'}">${d.subsequentSLABreachCount}</span></p>
                <hr>
                <h6>Raw Data for Reference (Steps)</h6>
                <div class="alert alert-secondary small">${d._raw[Object.keys(d._raw).find(k => k && k.toString().toLowerCase().includes('steps'))] || 'N/A'}</div>
            `;
            new bootstrap.Modal(document.getElementById('caseDetailModal')).show();
        }

        function exportScorecardToExcel() {
            if(!scorecardData.length) return alert("Scorecard data not ready or filtered to zero results.");
            const ws = XLSX.utils.json_to_sheet(scorecardData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Scorecard_Export");
            XLSX.writeFile(wb, `MSP_Scorecard_Export_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function exportDrillDownToExcel() {
            if(!drillDownData.length) return alert("No data to export.");
            const ws = XLSX.utils.json_to_sheet(drillDownData.map(d => d._raw));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DrillDownExport");
            XLSX.writeFile(wb, `${drillDownTitleForExport.replace(/ /g,'_')}_Export.xlsx`);
        }
        
        function exportFullData() {
            if(!filteredData.length) return alert("No data to export.");
            const ws = XLSX.utils.json_to_sheet(filteredData.map(d => d._raw));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "FilteredData");
            XLSX.writeFile(wb, `MSP_Filtered_Data_Export.xlsx`);
        }

        function updateDashboard() {
            renderKPIDashboard();
        }
    </script>
</body>
</html>
