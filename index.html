<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Support Engineers - Daily Review Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --warning-color: #e74c3c;
            --success-color: #27ae60;
            --light-gray: #f8f9fa;
            --dark-gray: #7f8c8d;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .warning-card {
            border-left: 5px solid var(--warning-color);
        }
        
        .success-card {
            border-left: 5px solid var(--success-color);
        }
        
        .case-card {
            border-left: 5px solid var(--secondary-color);
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-violated {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .status-non-violated {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
        
        .priority-high {
            color: var(--warning-color);
            font-weight: 600;
        }
        
        .priority-medium {
            color: #f39c12;
            font-weight: 600;
        }
        
        .priority-low {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .recommendation-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .recommendation-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .tab-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
        }
        
        .nav-tabs .nav-link.active {
            background-color: white;
            border-bottom: 3px solid var(--secondary-color);
            font-weight: 600;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        
        .owner-tag {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: inline-block;
            margin: 2px;
        }
        
        .submittedby-tag {
            background-color: #e8f5e9;
            color: #388e3c;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: inline-block;
            margin: 2px;
        }
        
        .aging-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .aging-0-5 { background-color: var(--success-color); }
        .aging-6-10 { background-color: #f39c12; }
        .aging-11-15 { background-color: #e67e22; }
        .aging-16-plus { background-color: var(--warning-color); }
        
        .action-btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .action-btn-primary:hover {
            background-color: #2980b9;
        }
        
        .action-btn-secondary {
            background-color: #f8f9fa;
            color: var(--primary-color);
            border: 1px solid #dee2e6;
        }
        
        .action-btn-secondary:hover {
            background-color: #e9ecef;
        }
        
        .filter-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .global-filters {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        
        .logo-img {
            height: 40px;
            margin-right: 10px;
        }
        
        .review-info-badge {
            font-size: 0.9rem;
            padding: 8px 12px;
            margin-left: 10px;
        }
        
        .help-modal-content {
            border-radius: 15px;
        }
        
        .help-modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .help-step {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .help-step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--primary-color);">
        <div class="container-fluid">
            <div class="logo-container">
                <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" 
                     alt="SapphireIMS Logo" class="logo-img">
                <a class="navbar-brand" href="#">
                    MSP Support Engineers - Daily Review Dashboard
                </a>
            </div>
            <div class="d-flex align-items-center text-white">
                <span id="last-updated" class="me-3"></span>
                <span id="total-cases" class="badge bg-light text-dark"></span>
                <button class="btn btn-sm btn-outline-light ms-3" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-question-circle me-1"></i> Help
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Export Section -->
        <div class="row mb-3" id="export-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-download me-2"></i>Export Options</h5>
                        <div>
                            <span id="current-review-info" class="badge bg-info review-info-badge me-2"></span>
                            <span id="current-filters-info" class="badge bg-secondary review-info-badge"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-success w-100" onclick="exportToExcel()">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Export to Excel
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-danger w-100" onclick="exportToPDF()">
                                    <i class="bi bi-file-earmark-pdf me-2"></i>Export to PDF
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-primary w-100" onclick="exportActionPlanToPDF()">
                                    <i class="bi bi-file-text me-2"></i>Action Plan PDF
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-warning w-100" onclick="saveAsHTML()">
                                    <i class="bi bi-save me-2"></i>Save HTML Report
                                </button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info small">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Export Includes:</strong> All data with current filters applied. 
                                    Files are named as MSPReview_YYYY-MM-DD_HH-MM.pdf/excel/html
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row mb-4" id="upload-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Upload Data File</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <h6><i class="bi bi-question-circle me-2"></i>How to Use This Dashboard</h6>
                            <ol class="mb-0">
                                <li>Take a copy of MSP_Review_Record from the SapphireIMS Support portal</li>
                                <li>The file should be available under Public Profile section</li>
                                <li>Upload the downloaded file without changing its format</li>
                                <li>Review the performance metrics and case analysis</li>
                                <li>Use the export options to save reports in PDF, Excel, or HTML format</li>
                            </ol>
                            <div class="mt-2 small text-muted">
                                <strong>NOTE:</strong> Do not change the format of the downloaded file.
                            </div>
                        </div>
                        
                        <div class="upload-area" id="drop-area">
                            <i class="bi bi-cloud-arrow-up"></i>
                            <h4>Drag & Drop Excel/CSV File Here</h4>
                            <p class="text-muted">Or click to browse files</p>
                            <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                            <p class="small text-muted mt-3">Supports Excel (.xlsx, .xls) and CSV formats</p>
                        </div>
                        <div id="file-info" class="mt-3" style="display: none;">
                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                                    <span id="file-name"></span>
                                    <span id="row-count" class="badge bg-secondary ms-2"></span>
                                </div>
                                <button class="btn btn-sm btn-outline-success" id="process-data-btn">
                                    <i class="bi bi-play-circle me-1"></i> Process Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section (Initially Hidden) -->
        <div id="dashboard-section" style="display: none;">
            <!-- Global Filters -->
            <div class="row mb-4" id="global-filters-container">
                <div class="col-12">
                    <div class="global-filters">
                        <h6 class="mb-3"><i class="bi bi-funnel me-2"></i>Global Filters</h6>
                        <div class="row g-3">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="global-filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="global-filter-owner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="global-filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="global-filter-sla">
                                    <option value="">All SLA Status</option>
                                    <option value="Violated">SLA Violated</option>
                                    <option value="Non-Violated">SLA Non-Violated</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="global-filter-submittedby">
                                    <option value="">All Submitted By</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" id="clear-filters-btn">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 small text-muted">
                            <span id="active-filters-count">0 filters active</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card metric-card">
                        <div class="card-body">
                            <div class="metric-value" id="total-open-cases">0</div>
                            <div class="metric-label">Total Open Cases</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card metric-card">
                        <div class="card-body">
                            <div class="metric-value" id="total-sr">0</div>
                            <div class="metric-label">Service Requests</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card metric-card">
                        <div class="card-body">
                            <div class="metric-value" id="total-inc">0</div>
                            <div class="metric-label">Incidents</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card metric-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <div class="card-body">
                            <div class="metric-value" id="sla-violated">0</div>
                            <div class="metric-label">SLA Violations</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Cases by Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Aging Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="agingChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="cases-tab" data-bs-toggle="tab" data-bs-target="#cases" type="button" role="tab">
                        <i class="bi bi-list-task me-1"></i> All Cases
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sla-tab" data-bs-toggle="tab" data-bs-target="#sla" type="button" role="tab">
                        <i class="bi bi-exclamation-triangle me-1"></i> SLA Violations
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="aging-tab" data-bs-toggle="tab" data-bs-target="#aging" type="button" role="tab">
                        <i class="bi bi-clock-history me-1"></i> Aging >15 Days
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab">
                        <i class="bi bi-lightbulb me-1"></i> Recommendations
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="owners-tab" data-bs-toggle="tab" data-bs-target="#owners" type="button" role="tab">
                        <i class="bi bi-people me-1"></i> Owner Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="submittedby-tab" data-bs-toggle="tab" data-bs-target="#submittedby" type="button" role="tab">
                        <i class="bi bi-person-lines-fill me-1"></i> Submitted By Analysis
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="dashboardTabsContent">
                <!-- All Cases Tab -->
                <div class="tab-pane fade show active" id="cases" role="tabpanel">
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filter-owner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filter-sla">
                                    <option value="">All SLA Status</option>
                                    <option value="Violated">SLA Violated</option>
                                    <option value="Non-Violated">SLA Non-Violated</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filter-submittedby">
                                    <option value="">All Submitted By</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('cases')">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="cases-container">
                        <!-- Cases will be dynamically inserted here -->
                    </div>
                </div>

                <!-- SLA Violations Tab -->
                <div class="tab-pane fade" id="sla" role="tabpanel">
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="sla-filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sla-filter-owner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sla-filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sla-filter-submittedby">
                                    <option value="">All Submitted By</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('sla')">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="sla-violations-container"></div>
                </div>

                <!-- Aging Tab -->
                <div class="tab-pane fade" id="aging" role="tabpanel">
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="aging-filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="aging-filter-owner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="aging-filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="aging-filter-submittedby">
                                    <option value="">All Submitted By</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('aging')">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="aging-cases-container"></div>
                </div>

                <!-- Recommendations Tab -->
                <div class="tab-pane fade" id="recommendations" role="tabpanel">
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="rec-filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="rec-filter-owner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="rec-filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="rec-filter-submittedby">
                                    <option value="">All Submitted By</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('recommendations')">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="recommendations-container"></div>
                </div>

                <!-- Owner Analysis Tab -->
                <div class="tab-pane fade" id="owners" role="tabpanel">
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="owner-filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="owner-filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="owner-filter-sla">
                                    <option value="">All SLA Status</option>
                                    <option value="Violated">SLA Violated</option>
                                    <option value="Non-Violated">SLA Non-Violated</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="owner-filter-submittedby">
                                    <option value="">All Submitted By</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('owners')">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="ownerChart"></canvas>
                    </div>
                    <div id="owner-breakdown"></div>
                </div>

                <!-- Submitted By Analysis Tab -->
                <div class="tab-pane fade" id="submittedby" role="tabpanel">
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="sb-filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sb-filter-owner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sb-filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sb-filter-sla">
                                    <option value="">All SLA Status</option>
                                    <option value="Violated">SLA Violated</option>
                                    <option value="Non-Violated">SLA Non-Violated</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="clearTabFilters('submittedby')">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="submittedbyChart"></canvas>
                    </div>
                    <div id="submittedby-breakdown"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Detail Modal -->
    <div class="modal fade" id="caseDetailModal" tabindex="-1" aria-labelledby="caseDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="caseDetailModalLabel">Case Details & Action Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="case-detail-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="download-action-plan">
                        <i class="bi bi-download me-1"></i> Download Action Plan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content help-modal-content">
                <div class="modal-header help-modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="bi bi-question-circle me-2"></i>MSP Support Engineers Dashboard - Help Guide
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="help-step">
                        <div class="help-step-number">1</div>
                        <strong>Get Data Source</strong>
                        <p class="mb-0">Take a copy of MSP_Review_Record from the SapphireIMS Support portal, which is available under Public Profile.</p>
                    </div>
                    
                    <div class="help-step">
                        <div class="help-step-number">2</div>
                        <strong>Upload File</strong>
                        <p class="mb-0">Upload the downloaded file without changing its format. The system supports Excel (.xlsx, .xls) and CSV formats.</p>
                    </div>
                    
                    <div class="help-step">
                        <div class="help-step-number">3</div>
                        <strong>Review Performance</strong>
                        <p class="mb-0">Use the dashboard tabs to review all cases, SLA violations, aging cases, recommendations, owner analysis, and submitted by analysis.</p>
                    </div>
                    
                    <div class="help-step">
                        <div class="help-step-number">4</div>
                        <strong>Apply Filters</strong>
                        <p class="mb-0">Use global filters to focus on specific service types, owners, statuses, SLA status, or submitted by categories. The current review information is displayed in the export section.</p>
                    </div>
                    
                    <div class="help-step">
                        <div class="help-step-number">5</div>
                        <strong>Export Reports</strong>
                        <p class="mb-0">Export data in multiple formats:
                            <ul class="mb-0">
                                <li><strong>Excel:</strong> Complete dataset with current filters</li>
                                <li><strong>PDF:</strong> Dashboard overview and metrics</li>
                                <li><strong>Action Plan PDF:</strong> Detailed action items</li>
                                <li><strong>HTML Report:</strong> Self-contained presentation</li>
                            </ul>
                        </p>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>IMPORTANT:</strong> Do not change the format of the downloaded file from SapphireIMS.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        let rawData = [];
        let processedData = [];
        let filteredData = [];
        let recommendations = [];
        let charts = {
            statusChart: null,
            agingChart: null,
            ownerChart: null,
            submittedbyChart: null
        };

        let currentFilters = {
            service: '',
            owner: '',
            status: '',
            sla: '',
            submittedby: ''
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            // Show help modal on first visit
            if (!localStorage.getItem('helpShown')) {
                setTimeout(() => {
                    const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
                    helpModal.show();
                    localStorage.setItem('helpShown', 'true');
                }, 1000);
            }
        });

        function setupEventListeners() {
            const fileInput = document.getElementById('file-input');
            const dropArea = document.getElementById('drop-area');
            const processBtn = document.getElementById('process-data-btn');
            const downloadBtn = document.getElementById('download-action-plan');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            
            dropArea.addEventListener('click', () => fileInput.click());
            
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#3498db';
                dropArea.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.style.borderColor = '#ddd';
                dropArea.style.backgroundColor = 'white';
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#ddd';
                dropArea.style.backgroundColor = 'white';
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            processBtn.addEventListener('click', processData);
            if (downloadBtn) {
                downloadBtn.addEventListener('click', generateActionPlan);
            }
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearAllFilters);
            }
            
            // Setup global filter change listeners
            ['global-filter-service', 'global-filter-owner', 'global-filter-status', 'global-filter-sla', 'global-filter-submittedby'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateGlobalFilters);
            });
            
            setupTabFilterListeners();
        }

        function setupTabFilterListeners() {
            // All Cases tab filters
            ['filter-service', 'filter-owner', 'filter-status', 'filter-sla', 'filter-submittedby'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterCases);
                }
            });
            
            // SLA Violations tab filters
            ['sla-filter-service', 'sla-filter-owner', 'sla-filter-status', 'sla-filter-submittedby'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterSLAViolations);
                }
            });
            
            // Aging tab filters
            ['aging-filter-service', 'aging-filter-owner', 'aging-filter-status', 'aging-filter-submittedby'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterAgingCases);
                }
            });
            
            // Recommendations tab filters
            ['rec-filter-service', 'rec-filter-owner', 'rec-filter-status', 'rec-filter-submittedby'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterRecommendations);
                }
            });
            
            // Owner Analysis tab filters
            ['owner-filter-service', 'owner-filter-status', 'owner-filter-sla', 'owner-filter-submittedby'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterOwnerAnalysis);
                }
            });
            
            // Submitted By Analysis tab filters
            ['sb-filter-service', 'sb-filter-owner', 'sb-filter-status', 'sb-filter-sla'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterSubmittedByAnalysis);
                }
            });
        }

        function handleFileUpload(file) {
            const fileName = file.name;
            document.getElementById('file-name').textContent = fileName;
            document.getElementById('file-info').style.display = 'block';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                
                if (fileName.endsWith('.csv')) {
                    parseCSV(data);
                } else {
                    parseExcel(data);
                }
            };
            
            if (fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'binary' });
                
                let sheetName = 'OpenCases';
                if (!workbook.SheetNames.includes('OpenCases')) {
                    sheetName = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('open') || 
                        name.toLowerCase().includes('case')
                    ) || workbook.SheetNames[0];
                }
                
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                console.log(`Found sheet: ${sheetName} with ${jsonData.length} rows`);
                processExcelData(jsonData);
            } catch (error) {
                console.error('Error parsing Excel:', error);
                alert('Error parsing Excel file. Please check the file format.');
            }
        }

        function parseCSV(data) {
            try {
                const rows = data.split('\n').map(row => {
                    const regex = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
                    return row.split(regex).map(cell => cell.replace(/^"|"$/g, '').trim());
                });
                processExcelData(rows);
            } catch (error) {
                console.error('Error parsing CSV:', error);
                alert('Error parsing CSV file. Please check the file format.');
            }
        }

        function processExcelData(data) {
            if (!data || data.length < 2) {
                alert('No data found in the file.');
                return;
            }
            
            const headers = data[0].map(h => h.trim());
            rawData = [];
            
            console.log('Headers:', headers);
            
            for (let i = 1; i < data.length; i++) {
                if (data[i] && data[i].length > 0) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = data[i][index] || '';
                    });
                    
                    if (row['Incident ID'] && row['Incident ID'].toString().trim()) {
                        rawData.push(row);
                    }
                }
            }
            
            document.getElementById('row-count').textContent = `${rawData.length} cases found`;
            console.log(`Processed ${rawData.length} cases`);
        }

        function processData() {
            if (rawData.length === 0) {
                alert('Please upload a valid file first');
                return;
            }
            
            console.log('Processing data...');
            
            processedData = rawData.map(row => {
                let agingDays = 0;
                const agingValue = row['Aging(Roundoff)'];
                if (agingValue !== undefined && agingValue !== null && agingValue !== '') {
                    if (typeof agingValue === 'number') {
                        agingDays = Math.round(agingValue);
                    } else if (typeof agingValue === 'string') {
                        const num = parseFloat(agingValue);
                        agingDays = isNaN(num) ? 0 : Math.round(num);
                    }
                }
                
                let agingFromLastModified = 0;
                const agingModValue = row['Ageing from Last modified time'];
                if (agingModValue !== undefined && agingModValue !== null && agingModValue !== '') {
                    if (typeof agingModValue === 'number') {
                        agingFromLastModified = Math.round(agingModValue);
                    } else if (typeof agingModValue === 'string') {
                        const num = parseFloat(agingModValue);
                        agingFromLastModified = isNaN(num) ? 0 : Math.round(num);
                    }
                }
                
                return {
                    incidentId: row['Incident ID'] || row['IncidentID'] || '',
                    title: row['Title'] || '',
                    submittedBy: row['SubmittedBy'] || row['Submitted By'] || '',
                    currentStatus: row['CurrentStatus'] || row['Current Status'] || 'Assign',
                    service: row['Service'] || '',
                    owner: row['Owner'] || '',
                    agingStatus: row['Aging >15 days Status'] || row['Aging Status'] || 'Non-Violated',
                    expectedResolution: row['Expected Resolution Time'] || row['ExpectedResolutionTime'] || '',
                    sLAStatus: row['SLA Status'] || row['SLAStatus'] || 'Non-Violated',
                    slaViolationStatus: row['SLA Violation Status'] || row['SLAViolationStatus'] || 'Non-Violated',
                    agingDays: agingDays,
                    nextFollowUp: row['Next Follow-up Date'] || row['NextFollowupDate'] || '',
                    emailCompliance: row['Email Response Compliance'] || row['EmailCompliance'] || '',
                    steps: row['Steps to be followed to resolve this SR/INC'] || row['Steps'] || '',
                    lastModified: row['Last Modified Time'] || row['LastModifiedTime'] || '',
                    submitterEmail: row['Submitter Email'] || row['SubmitterEmail'] || '',
                    agingFromLastModified: agingFromLastModified
                };
            });
            
            filteredData = [...processedData];
            
            console.log('Processed data sample:', processedData[0]);
            
            // Generate recommendations
            generateRecommendations();
            
            // Update dashboard
            updateDashboard();
            
            // Show dashboard
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('upload-section').style.display = 'none';
            
            // Scroll to dashboard
            document.getElementById('dashboard-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updateDashboard() {
            // Destroy existing charts if they exist
            Object.values(charts).forEach(chart => {
                if (chart) {
                    try {
                        chart.destroy();
                    } catch (e) {
                        console.log('Error destroying chart:', e);
                    }
                }
            });
            
            // Reset charts object
            charts = {
                statusChart: null,
                agingChart: null,
                ownerChart: null,
                submittedbyChart: null
            };
            
            // Update metrics based on filtered data
            const totalCases = filteredData.length;
            const totalSR = filteredData.filter(d => d.service === 'Service Request').length;
            const totalINC = filteredData.filter(d => d.service === 'Incident Management').length;
            const slaViolated = filteredData.filter(d => d.slaViolationStatus === 'Violated').length;
            
            document.getElementById('total-open-cases').textContent = totalCases;
            document.getElementById('total-sr').textContent = totalSR;
            document.getElementById('total-inc').textContent = totalINC;
            document.getElementById('sla-violated').textContent = slaViolated;
            document.getElementById('last-updated').textContent = `Last Updated: ${new Date().toLocaleDateString()}`;
            document.getElementById('total-cases').textContent = `${totalCases} Open Cases`;
            
            // Show export section
            document.getElementById('export-section').style.display = 'block';
            
            // Update review info
            updateReviewInfo();
            
            // Update filters
            updateAllFilters();
            
            // Render charts with delay to ensure canvas is ready
            setTimeout(renderCharts, 100);
            
            // Render all tabs
            renderAllCases();
            renderSLAViolations();
            renderAgingCases();
            renderRecommendations();
            renderOwnerAnalysis();
            renderSubmittedByAnalysis();
            
            // Update active filters count
            updateActiveFiltersCount();
        }

        function updateReviewInfo() {
            const ownerFilter = document.getElementById('global-filter-owner').value;
            const submitterFilter = document.getElementById('global-filter-submittedby').value;
            
            let infoText = '';
            if (ownerFilter) {
                infoText += `Reviewing: ${ownerFilter}`;
            }
            if (submitterFilter) {
                if (infoText) infoText += ' | ';
                infoText += `Submitted by: ${submitterFilter}`;
            }
            
            if (!infoText) {
                infoText = 'Reviewing: All Data';
            }
            
            document.getElementById('current-review-info').textContent = infoText;
            
            // Update filters info
            const activeFilters = Object.values(currentFilters).filter(value => value).length;
            document.getElementById('current-filters-info').textContent = 
                `${activeFilters} active filter${activeFilters !== 1 ? 's' : ''}`;
        }

        function updateAllFilters() {
            // Get unique values from filtered data
            const services = [...new Set(filteredData.map(d => d.service).filter(Boolean))];
            const owners = [...new Set(filteredData.map(d => d.owner).filter(Boolean))];
            const statuses = [...new Set(filteredData.map(d => d.currentStatus).filter(Boolean))];
            const submittedBys = [...new Set(filteredData.map(d => d.submittedBy).filter(Boolean))];
            
            // Update global filters
            updateFilterSelect('global-filter-service', services, currentFilters.service);
            updateFilterSelect('global-filter-owner', owners, currentFilters.owner);
            updateFilterSelect('global-filter-status', statuses, currentFilters.status);
            updateFilterSelect('global-filter-submittedby', submittedBys, currentFilters.submittedby);
            
            // Update tab-specific filters
            updateFilterSelect('filter-service', services, '');
            updateFilterSelect('filter-owner', owners, '');
            updateFilterSelect('filter-status', statuses, '');
            updateFilterSelect('filter-submittedby', submittedBys, '');
            
            updateFilterSelect('sla-filter-service', services, '');
            updateFilterSelect('sla-filter-owner', owners, '');
            updateFilterSelect('sla-filter-status', statuses, '');
            updateFilterSelect('sla-filter-submittedby', submittedBys, '');
            
            updateFilterSelect('aging-filter-service', services, '');
            updateFilterSelect('aging-filter-owner', owners, '');
            updateFilterSelect('aging-filter-status', statuses, '');
            updateFilterSelect('aging-filter-submittedby', submittedBys, '');
            
            updateFilterSelect('rec-filter-service', services, '');
            updateFilterSelect('rec-filter-owner', owners, '');
            updateFilterSelect('rec-filter-status', statuses, '');
            updateFilterSelect('rec-filter-submittedby', submittedBys, '');
            
            updateFilterSelect('owner-filter-service', services, '');
            updateFilterSelect('owner-filter-status', statuses, '');
            updateFilterSelect('owner-filter-submittedby', submittedBys, '');
            
            updateFilterSelect('sb-filter-service', services, '');
            updateFilterSelect('sb-filter-owner', owners, '');
            updateFilterSelect('sb-filter-status', statuses, '');
        }

        function updateFilterSelect(selectId, options, selectedValue) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = `<option value="">All ${selectId.includes('service') ? 'Service Types' : 
                selectId.includes('owner') ? 'Owners' : 
                selectId.includes('status') ? 'Statuses' : 
                selectId.includes('sla') ? 'SLA Status' : 
                selectId.includes('submittedby') ? 'Submitted By' : 'Items'}</option>`;
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                if (selectedValue && option === selectedValue) {
                    optionElement.selected = true;
                }
                select.appendChild(optionElement);
            });
            
            // Restore current value if it exists in new options
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function updateGlobalFilters() {
            // Update current filters
            currentFilters = {
                service: document.getElementById('global-filter-service').value,
                owner: document.getElementById('global-filter-owner').value,
                status: document.getElementById('global-filter-status').value,
                sla: document.getElementById('global-filter-sla').value,
                submittedby: document.getElementById('global-filter-submittedby').value
            };
            
            // Apply filters to data
            applyGlobalFilters();
            
            // Update dashboard with filtered data
            updateDashboard();
        }

        function applyGlobalFilters() {
            filteredData = processedData.filter(d => {
                // Apply service filter
                if (currentFilters.service && d.service !== currentFilters.service) {
                    return false;
                }
                
                // Apply owner filter
                if (currentFilters.owner && d.owner !== currentFilters.owner) {
                    return false;
                }
                
                // Apply status filter
                if (currentFilters.status && d.currentStatus !== currentFilters.status) {
                    return false;
                }
                
                // Apply SLA filter
                if (currentFilters.sla) {
                    if (currentFilters.sla === 'Violated' && d.slaViolationStatus !== 'Violated') {
                        return false;
                    }
                    if (currentFilters.sla === 'Non-Violated' && d.slaViolationStatus !== 'Non-Violated') {
                        return false;
                    }
                }
                
                // Apply submitted by filter
                if (currentFilters.submittedby && d.submittedBy !== currentFilters.submittedby) {
                    return false;
                }
                
                return true;
            });
        }

        function updateActiveFiltersCount() {
            const activeFilters = Object.values(currentFilters).filter(value => value).length;
            document.getElementById('active-filters-count').textContent = 
                `${activeFilters} filter${activeFilters !== 1 ? 's' : ''} active`;
        }

        function clearAllFilters() {
            // Reset global filters
            document.getElementById('global-filter-service').value = '';
            document.getElementById('global-filter-owner').value = '';
            document.getElementById('global-filter-status').value = '';
            document.getElementById('global-filter-sla').value = '';
            document.getElementById('global-filter-submittedby').value = '';
            
            // Reset current filters
            currentFilters = {
                service: '',
                owner: '',
                status: '',
                sla: '',
                submittedby: ''
            };
            
            // Reset filtered data to all processed data
            filteredData = [...processedData];
            
            // Clear all tab filters
            clearAllTabFilters();
            
            // Update dashboard
            updateDashboard();
        }

        function clearAllTabFilters() {
            // Clear all tab-specific filters
            const filterSelects = [
                'filter-service', 'filter-owner', 'filter-status', 'filter-sla', 'filter-submittedby',
                'sla-filter-service', 'sla-filter-owner', 'sla-filter-status', 'sla-filter-submittedby',
                'aging-filter-service', 'aging-filter-owner', 'aging-filter-status', 'aging-filter-submittedby',
                'rec-filter-service', 'rec-filter-owner', 'rec-filter-status', 'rec-filter-submittedby',
                'owner-filter-service', 'owner-filter-status', 'owner-filter-sla', 'owner-filter-submittedby',
                'sb-filter-service', 'sb-filter-owner', 'sb-filter-status', 'sb-filter-sla'
            ];
            
            filterSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) select.value = '';
            });
        }

        function clearTabFilters(tabName) {
            const filterIds = {
                'cases': ['filter-service', 'filter-owner', 'filter-status', 'filter-sla', 'filter-submittedby'],
                'sla': ['sla-filter-service', 'sla-filter-owner', 'sla-filter-status', 'sla-filter-submittedby'],
                'aging': ['aging-filter-service', 'aging-filter-owner', 'aging-filter-status', 'aging-filter-submittedby'],
                'recommendations': ['rec-filter-service', 'rec-filter-owner', 'rec-filter-status', 'rec-filter-submittedby'],
                'owners': ['owner-filter-service', 'owner-filter-status', 'owner-filter-sla', 'owner-filter-submittedby'],
                'submittedby': ['sb-filter-service', 'sb-filter-owner', 'sb-filter-status', 'sb-filter-sla']
            };
            
            if (filterIds[tabName]) {
                filterIds[tabName].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) select.value = '';
                });
                
                // Re-render the tab
                switch(tabName) {
                    case 'cases': renderAllCases(); break;
                    case 'sla': renderSLAViolations(); break;
                    case 'aging': renderAgingCases(); break;
                    case 'recommendations': renderRecommendations(); break;
                    case 'owners': renderOwnerAnalysis(); break;
                    case 'submittedby': renderSubmittedByAnalysis(); break;
                }
            }
        }

        function renderCharts() {
            // Status Distribution Chart
            const statusData = filteredData.reduce((acc, d) => {
                const status = d.currentStatus || 'Unknown';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                charts.statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusData),
                        datasets: [{
                            data: Object.values(statusData),
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', 
                                '#9b59b6', '#1abc9c', '#d35400', '#34495e'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
            
            // Aging Analysis Chart
            const agingGroups = {
                '0-5 days': 0,
                '6-10 days': 0,
                '11-15 days': 0,
                '16+ days': 0
            };
            
            filteredData.forEach(d => {
                const days = d.agingDays || 0;
                if (days <= 5) agingGroups['0-5 days']++;
                else if (days <= 10) agingGroups['6-10 days']++;
                else if (days <= 15) agingGroups['11-15 days']++;
                else agingGroups['16+ days']++;
            });
            
            const agingCtx = document.getElementById('agingChart');
            if (agingCtx) {
                charts.agingChart = new Chart(agingCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(agingGroups),
                        datasets: [{
                            label: 'Number of Cases',
                            data: Object.values(agingGroups),
                            backgroundColor: [
                                '#27ae60', '#f39c12', '#e67e22', '#e74c3c'
                            ],
                            borderColor: [
                                '#219653', '#e67e22', '#d35400', '#c0392b'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Cases'
                                }
                            }
                        }
                    }
                });
            }
        }

        function filterCases() {
            const serviceFilter = document.getElementById('filter-service').value;
            const ownerFilter = document.getElementById('filter-owner').value;
            const statusFilter = document.getElementById('filter-status').value;
            const slaFilter = document.getElementById('filter-sla').value;
            const submittedbyFilter = document.getElementById('filter-submittedby').value;
            
            let filteredCases = filteredData;
            
            if (serviceFilter) {
                filteredCases = filteredCases.filter(d => d.service === serviceFilter);
            }
            
            if (ownerFilter) {
                filteredCases = filteredCases.filter(d => d.owner === ownerFilter);
            }
            
            if (statusFilter) {
                filteredCases = filteredCases.filter(d => d.currentStatus === statusFilter);
            }
            
            if (slaFilter) {
                if (slaFilter === 'Violated') {
                    filteredCases = filteredCases.filter(d => d.slaViolationStatus === 'Violated');
                } else if (slaFilter === 'Non-Violated') {
                    filteredCases = filteredCases.filter(d => d.slaViolationStatus === 'Non-Violated');
                }
            }
            
            if (submittedbyFilter) {
                filteredCases = filteredCases.filter(d => d.submittedBy === submittedbyFilter);
            }
            
            renderFilteredCases(filteredCases, 'cases-container');
        }

        function renderAllCases() {
            renderFilteredCases(filteredData, 'cases-container');
        }

        function renderFilteredCases(cases, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (cases.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No cases match the selected filters.
                    </div>
                `;
                return;
            }
            
            // Store the filtered cases with their original indices
            const casesWithIndices = cases.map((caseData, localIndex) => {
                // Find the original index in the filteredData array
                const originalIndex = filteredData.findIndex(d => d.incidentId === caseData.incidentId);
                return { caseData, originalIndex: originalIndex >= 0 ? originalIndex : localIndex };
            });
            
            casesWithIndices.forEach(({ caseData, originalIndex }) => {
                const priority = getPriority(caseData);
                const caseHtml = `
                    <div class="card case-card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <span class="aging-indicator aging-${getAgingClass(caseData.agingDays)}"></span>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">${caseData.title || 'No Title'}</h6>
                                            <div class="mb-2">
                                                <span class="badge bg-secondary me-2">${caseData.incidentId}</span>
                                                <span class="badge ${caseData.service === 'Service Request' ? 'bg-info' : 'bg-warning'} me-2">
                                                    ${caseData.service || 'Unknown'}
                                                </span>
                                                <span class="status-badge ${caseData.slaViolationStatus === 'Violated' ? 'status-violated' : 'status-non-violated'}">
                                                    ${caseData.slaViolationStatus || 'Unknown'}
                                                </span>
                                            </div>
                                            <div class="small text-muted">
                                                <span class="me-3"><i class="bi bi-person me-1"></i> ${caseData.owner || 'Unassigned'}</span>
                                                <span class="me-3"><i class="bi bi-building me-1"></i> ${caseData.submittedBy || 'Unknown'}</span>
                                                <span class="me-3"><i class="bi bi-calendar me-1"></i> ${caseData.agingDays} days</span>
                                                <span class="priority-${priority}">
                                                    <i class="bi bi-flag me-1"></i> ${priority.toUpperCase()} Priority
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-end align-items-center h-100">
                                        <span class="me-3 badge bg-light text-dark">${caseData.currentStatus || 'Unknown'}</span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetail(${originalIndex})">
                                            <i class="bi bi-eye me-1"></i> View Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += caseHtml;
            });
        }

        function filterSLAViolations() {
            const serviceFilter = document.getElementById('sla-filter-service').value;
            const ownerFilter = document.getElementById('sla-filter-owner').value;
            const statusFilter = document.getElementById('sla-filter-status').value;
            const submittedbyFilter = document.getElementById('sla-filter-submittedby').value;
            
            let filteredCases = filteredData.filter(d => d.slaViolationStatus === 'Violated');
            
            if (serviceFilter) {
                filteredCases = filteredCases.filter(d => d.service === serviceFilter);
            }
            
            if (ownerFilter) {
                filteredCases = filteredCases.filter(d => d.owner === ownerFilter);
            }
            
            if (statusFilter) {
                filteredCases = filteredCases.filter(d => d.currentStatus === statusFilter);
            }
            
            if (submittedbyFilter) {
                filteredCases = filteredCases.filter(d => d.submittedBy === submittedbyFilter);
            }
            
            renderSLAViolationsList(filteredCases);
        }

        function renderSLAViolations() {
            const violations = filteredData.filter(d => d.slaViolationStatus === 'Violated');
            renderSLAViolationsList(violations);
        }

        function renderSLAViolationsList(violations) {
            const container = document.getElementById('sla-violations-container');
            container.innerHTML = '';
            
            if (violations.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        No SLA violations found. Great job!
                    </div>
                `;
                return;
            }
            
            violations.forEach((violation, index) => {
                // Find original index in filteredData
                const originalIndex = filteredData.findIndex(d => d.incidentId === violation.incidentId);
                const violationHtml = `
                    <div class="card warning-card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-9">
                                    <h6 class="mb-1">${violation.title || 'No Title'}</h6>
                                    <div class="mb-2">
                                        <span class="badge bg-danger me-2">SLA VIOLATED</span>
                                        <span class="badge bg-secondary me-2">${violation.incidentId}</span>
                                        <span class="submittedby-tag me-2">
                                            <i class="bi bi-building me-1"></i> ${violation.submittedBy || 'Unknown'}
                                        </span>
                                    </div>
                                    <div class="small text-muted">
                                        <span class="me-3"><i class="bi bi-person me-1"></i> ${violation.owner || 'Unassigned'}</span>
                                        <span class="me-3"><i class="bi bi-clock me-1"></i> ${violation.agingDays} days old</span>
                                        <span><i class="bi bi-envelope me-1"></i> ${violation.emailCompliance || 'No compliance data'}</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex flex-column align-items-end h-100 justify-content-center">
                                        <span class="badge bg-warning text-dark mb-2">${violation.service || 'Unknown'}</span>
                                        <button class="btn btn-sm btn-outline-danger" onclick="viewCaseDetail(${originalIndex})">
                                            <i class="bi bi-exclamation-triangle me-1"></i> Take Action
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += violationHtml;
            });
        }

        function filterAgingCases() {
            const serviceFilter = document.getElementById('aging-filter-service').value;
            const ownerFilter = document.getElementById('aging-filter-owner').value;
            const statusFilter = document.getElementById('aging-filter-status').value;
            const submittedbyFilter = document.getElementById('aging-filter-submittedby').value;
            
            let filteredCases = filteredData.filter(d => d.agingDays > 15);
            
            if (serviceFilter) {
                filteredCases = filteredCases.filter(d => d.service === serviceFilter);
            }
            
            if (ownerFilter) {
                filteredCases = filteredCases.filter(d => d.owner === ownerFilter);
            }
            
            if (statusFilter) {
                filteredCases = filteredCases.filter(d => d.currentStatus === statusFilter);
            }
            
            if (submittedbyFilter) {
                filteredCases = filteredCases.filter(d => d.submittedBy === submittedbyFilter);
            }
            
            renderAgingCasesList(filteredCases);
        }

        function renderAgingCases() {
            const agingCases = filteredData.filter(d => d.agingDays > 15);
            renderAgingCasesList(agingCases);
        }

        function renderAgingCasesList(agingCases) {
            const container = document.getElementById('aging-cases-container');
            container.innerHTML = '';
            
            if (agingCases.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        No cases aging beyond 15 days.
                    </div>
                `;
                return;
            }
            
            agingCases.forEach((caseData, index) => {
                // Find original index in filteredData
                const originalIndex = filteredData.findIndex(d => d.incidentId === caseData.incidentId);
                const agingHtml = `
                    <div class="card mb-3" style="border-left: 5px solid #e74c3c;">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <span class="aging-indicator" style="background-color: #e74c3c;"></span>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">${caseData.title || 'No Title'}</h6>
                                            <div class="mb-2">
                                                <span class="badge bg-secondary me-2">${caseData.incidentId}</span>
                                                <span class="badge bg-danger me-2">${caseData.agingDays} DAYS OLD</span>
                                                <span class="submittedby-tag me-2">
                                                    <i class="bi bi-building me-1"></i> ${caseData.submittedBy || 'Unknown'}
                                                </span>
                                            </div>
                                            <div class="small text-muted">
                                                <span class="me-3"><i class="bi bi-person me-1"></i> ${caseData.owner || 'Unassigned'}</span>
                                                <span class="me-3">Status: ${caseData.currentStatus || 'Unknown'}</span>
                                                <span>SLA: ${caseData.slaViolationStatus || 'Unknown'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex flex-column align-items-end">
                                        <div class="mb-2">
                                            <span class="badge ${caseData.nextFollowUp ? 'bg-warning text-dark' : 'bg-secondary'}">
                                                <i class="bi bi-calendar-check me-1"></i>
                                                ${caseData.nextFollowUp || 'No follow-up'}
                                            </span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="viewCaseDetail(${originalIndex})">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Escalate
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += agingHtml;
            });
        }

        function generateRecommendations() {
            recommendations = [];
            
            filteredData.forEach((caseData, index) => {
                const caseRec = {
                    incidentId: caseData.incidentId,
                    title: caseData.title,
                    owner: caseData.owner,
                    submittedBy: caseData.submittedBy,
                    recommendations: []
                };
                
                // SLA Violation Recommendations
                if (caseData.slaViolationStatus === 'Violated') {
                    caseRec.recommendations.push({
                        type: 'critical',
                        text: `SLA Violation - Escalate immediately to ${caseData.owner}'s manager`,
                        action: `Contact ${caseData.owner} for immediate resolution plan`
                    });
                }
                
                // Aging Recommendations
                if (caseData.agingDays > 15) {
                    caseRec.recommendations.push({
                        type: 'high',
                        text: `Case aging ${caseData.agingDays} days - Review for possible closure or escalation`,
                        action: 'Schedule meeting with customer to discuss progress'
                    });
                }
                
                // Follow-up Recommendations
                if (!caseData.nextFollowUp || new Date(caseData.nextFollowUp) < new Date()) {
                    caseRec.recommendations.push({
                        type: 'medium',
                        text: 'Next follow-up date missing or overdue',
                        action: `Set next follow-up date with ${caseData.submitterEmail || 'customer'}`
                    });
                }
                
                // Email Compliance Recommendations
                if (caseData.emailCompliance && caseData.emailCompliance.includes('Missed')) {
                    caseRec.recommendations.push({
                        type: 'medium',
                        text: 'Email response compliance issue detected',
                        action: 'Review communication history and send update'
                    });
                }
                
                // Status-based Recommendations
                if (caseData.currentStatus === 'Assign') {
                    caseRec.recommendations.push({
                        type: 'low',
                        text: 'Case still in "Assign" status for extended period',
                        action: 'Reassign or update status based on current progress'
                    });
                }
                
                if (caseData.currentStatus === 'Waiting on Customer') {
                    const waitingDays = caseData.agingFromLastModified || caseData.agingDays;
                    if (waitingDays > 3) {
                        caseRec.recommendations.push({
                            type: 'medium',
                            text: `Waiting on customer for ${waitingDays} days`,
                            action: 'Send follow-up email to customer for update'
                        });
                    }
                }
                
                if (caseRec.recommendations.length > 0) {
                    recommendations.push(caseRec);
                }
            });
        }

        function filterRecommendations() {
            const serviceFilter = document.getElementById('rec-filter-service').value;
            const ownerFilter = document.getElementById('rec-filter-owner').value;
            const statusFilter = document.getElementById('rec-filter-status').value;
            const submittedbyFilter = document.getElementById('rec-filter-submittedby').value;
            
            // Filter recommendations based on filtered data
            let filteredRecs = recommendations.filter(rec => {
                // Find the case in filteredData
                const caseData = filteredData.find(d => d.incidentId === rec.incidentId);
                if (!caseData) return false;
                
                // Apply filters
                if (serviceFilter && caseData.service !== serviceFilter) return false;
                if (ownerFilter && caseData.owner !== ownerFilter) return false;
                if (statusFilter && caseData.currentStatus !== statusFilter) return false;
                if (submittedbyFilter && caseData.submittedBy !== submittedbyFilter) return false;
                
                return true;
            });
            
            renderRecommendationsList(filteredRecs);
        }

        function renderRecommendations() {
            renderRecommendationsList(recommendations);
        }

        function renderRecommendationsList(recs) {
            const container = document.getElementById('recommendations-container');
            container.innerHTML = '';
            
            if (recs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        No recommendations at this time.
                    </div>
                `;
                return;
            }
            
            recs.forEach(rec => {
                // Find original index in filteredData
                const originalIndex = filteredData.findIndex(d => d.incidentId === rec.incidentId);
                const recHtml = `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">${rec.incidentId} - ${(rec.title || '').substring(0, 50)}...</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap mb-2">
                                    <div class="owner-tag me-2">
                                        <i class="bi bi-person-circle me-1"></i> ${rec.owner || 'Unassigned'}
                                    </div>
                                    <div class="submittedby-tag">
                                        <i class="bi bi-building me-1"></i> ${rec.submittedBy || 'Unknown'}
                                    </div>
                                </div>
                                ${rec.recommendations.map(r => `
                                    <div class="recommendation-box mb-2">
                                        <div class="recommendation-title">
                                            <i class="bi bi-${getRecommendationIcon(r.type)} me-1 text-${getRecommendationColor(r.type)}"></i>
                                            ${r.text}
                                        </div>
                                        <div class="small text-muted">
                                            <strong>Action:</strong> ${r.action}
                                        </div>
                                    </div>
                                `).join('')}
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="viewCaseDetail(${originalIndex})">
                                    <i class="bi bi-gear me-1"></i> View Detailed Actions
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += recHtml;
            });
        }

        function filterOwnerAnalysis() {
            const serviceFilter = document.getElementById('owner-filter-service').value;
            const statusFilter = document.getElementById('owner-filter-status').value;
            const slaFilter = document.getElementById('owner-filter-sla').value;
            const submittedbyFilter = document.getElementById('owner-filter-submittedby').value;
            
            let filteredCases = filteredData;
            
            if (serviceFilter) {
                filteredCases = filteredCases.filter(d => d.service === serviceFilter);
            }
            
            if (statusFilter) {
                filteredCases = filteredCases.filter(d => d.currentStatus === statusFilter);
            }
            
            if (slaFilter) {
                if (slaFilter === 'Violated') {
                    filteredCases = filteredCases.filter(d => d.slaViolationStatus === 'Violated');
                } else if (slaFilter === 'Non-Violated') {
                    filteredCases = filteredCases.filter(d => d.slaViolationStatus === 'Non-Violated');
                }
            }
            
            if (submittedbyFilter) {
                filteredCases = filteredCases.filter(d => d.submittedBy === submittedbyFilter);
            }
            
            renderOwnerAnalysisData(filteredCases);
        }

        function renderOwnerAnalysis() {
            renderOwnerAnalysisData(filteredData);
        }

        function renderOwnerAnalysisData(data) {
            const ownerBreakdown = data.reduce((acc, d) => {
                const owner = d.owner || 'Unassigned';
                if (!acc[owner]) {
                    acc[owner] = {
                        total: 0,
                        sr: 0,
                        inc: 0,
                        violated: 0,
                        aging: 0
                    };
                }
                
                acc[owner].total++;
                if (d.service === 'Service Request') acc[owner].sr++;
                if (d.service === 'Incident Management') acc[owner].inc++;
                if (d.slaViolationStatus === 'Violated') acc[owner].violated++;
                if (d.agingDays > 15) acc[owner].aging++;
                
                return acc;
            }, {});
            
            const container = document.getElementById('owner-breakdown');
            container.innerHTML = '';
            
            Object.entries(ownerBreakdown).forEach(([owner, stats]) => {
                const ownerHtml = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>${owner}</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4">${stats.total}</div>
                                        <small class="text-muted">Total Cases</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 ${stats.violated > 0 ? 'text-danger' : 'text-success'}">${stats.violated}</div>
                                        <small class="text-muted">SLA Violations</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 ${stats.aging > 0 ? 'text-warning' : 'text-success'}">${stats.aging}</div>
                                        <small class="text-muted">Aging >15 days</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4">${stats.sr}/${stats.inc}</div>
                                        <small class="text-muted">SR/INC Ratio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += ownerHtml;
            });
            
            // Render owner chart
            const ownerChartCtx = document.getElementById('ownerChart');
            if (ownerChartCtx) {
                const sortedOwners = Object.entries(ownerBreakdown)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 10);
                
                if (charts.ownerChart) {
                    charts.ownerChart.destroy();
                }
                
                charts.ownerChart = new Chart(ownerChartCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedOwners.map(o => o[0]),
                        datasets: [{
                            label: 'Number of Cases',
                            data: sortedOwners.map(o => o[1].total),
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function filterSubmittedByAnalysis() {
            const serviceFilter = document.getElementById('sb-filter-service').value;
            const ownerFilter = document.getElementById('sb-filter-owner').value;
            const statusFilter = document.getElementById('sb-filter-status').value;
            const slaFilter = document.getElementById('sb-filter-sla').value;
            
            let filteredCases = filteredData;
            
            if (serviceFilter) {
                filteredCases = filteredCases.filter(d => d.service === serviceFilter);
            }
            
            if (ownerFilter) {
                filteredCases = filteredCases.filter(d => d.owner === ownerFilter);
            }
            
            if (statusFilter) {
                filteredCases = filteredCases.filter(d => d.currentStatus === statusFilter);
            }
            
            if (slaFilter) {
                if (slaFilter === 'Violated') {
                    filteredCases = filteredCases.filter(d => d.slaViolationStatus === 'Violated');
                } else if (slaFilter === 'Non-Violated') {
                    filteredCases = filteredCases.filter(d => d.slaViolationStatus === 'Non-Violated');
                }
            }
            
            renderSubmittedByAnalysisData(filteredCases);
        }

        function renderSubmittedByAnalysis() {
            renderSubmittedByAnalysisData(filteredData);
        }

        function renderSubmittedByAnalysisData(data) {
            const submittedByBreakdown = data.reduce((acc, d) => {
                const submittedBy = d.submittedBy || 'Unknown';
                if (!acc[submittedBy]) {
                    acc[submittedBy] = {
                        total: 0,
                        sr: 0,
                        inc: 0,
                        violated: 0,
                        aging: 0
                    };
                }
                
                acc[submittedBy].total++;
                if (d.service === 'Service Request') acc[submittedBy].sr++;
                if (d.service === 'Incident Management') acc[submittedBy].inc++;
                if (d.slaViolationStatus === 'Violated') acc[submittedBy].violated++;
                if (d.agingDays > 15) acc[submittedBy].aging++;
                
                return acc;
            }, {});
            
            const container = document.getElementById('submittedby-breakdown');
            container.innerHTML = '';
            
            Object.entries(submittedByBreakdown).forEach(([submittedBy, stats]) => {
                const submittedByHtml = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>${submittedBy}</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4">${stats.total}</div>
                                        <small class="text-muted">Total Cases</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 ${stats.violated > 0 ? 'text-danger' : 'text-success'}">${stats.violated}</div>
                                        <small class="text-muted">SLA Violations</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 ${stats.aging > 0 ? 'text-warning' : 'text-success'}">${stats.aging}</div>
                                        <small class="text-muted">Aging >15 days</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4">${stats.sr}/${stats.inc}</div>
                                        <small class="text-muted">SR/INC Ratio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += submittedByHtml;
            });
            
            // Render submitted by chart
            const submittedbyChartCtx = document.getElementById('submittedbyChart');
            if (submittedbyChartCtx) {
                const sortedSubmittedBys = Object.entries(submittedByBreakdown)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 10);
                
                if (charts.submittedbyChart) {
                    charts.submittedbyChart.destroy();
                }
                
                charts.submittedbyChart = new Chart(submittedbyChartCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedSubmittedBys.map(o => o[0]),
                        datasets: [{
                            label: 'Number of Cases',
                            data: sortedSubmittedBys.map(o => o[1].total),
                            backgroundColor: '#9b59b6',
                            borderColor: '#8e44ad',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function viewCaseDetail(index) {
            if (index < 0 || index >= filteredData.length) {
                alert('Case not found. Please try again.');
                return;
            }
            
            const caseData = filteredData[index];
            const modal = document.getElementById('caseDetailModal');
            const modalContent = document.getElementById('case-detail-content');
            
            const caseRecommendations = generateCaseRecommendations(caseData);
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h5>${caseData.title || 'No Title'}</h5>
                        <div class="mb-4">
                            <span class="badge bg-primary me-2">${caseData.incidentId}</span>
                            <span class="badge ${caseData.service === 'Service Request' ? 'bg-info' : 'bg-warning'} me-2">${caseData.service || 'Unknown'}</span>
                            <span class="badge ${caseData.slaViolationStatus === 'Violated' ? 'bg-danger' : 'bg-success'} me-2">${caseData.slaViolationStatus || 'Unknown'}</span>
                            <span class="badge bg-secondary">${caseData.agingDays} days</span>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-subtitle mb-2 text-muted">Case Details</h6>
                                        <p><strong>Owner:</strong> ${caseData.owner || 'Unassigned'}</p>
                                        <p><strong>Submitted By:</strong> ${caseData.submittedBy || 'Unknown'}</p>
                                        <p><strong>Status:</strong> ${caseData.currentStatus || 'Unknown'}</p>
                                        <p><strong>Last Modified:</strong> ${caseData.lastModified || 'Unknown'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-subtitle mb-2 text-muted">Compliance Details</h6>
                                        <p><strong>Email Compliance:</strong> ${caseData.emailCompliance || 'Not specified'}</p>
                                        <p><strong>Next Follow-up:</strong> ${caseData.nextFollowUp || 'Not scheduled'}</p>
                                        <p><strong>Expected Resolution:</strong> ${caseData.expectedResolution || 'Not specified'}</p>
                                        <p><strong>Aging from Last Modified:</strong> ${caseData.agingFromLastModified} days</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Steps to Resolve</h6>
                                <p>${caseData.steps || 'No steps provided'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Action Plan & Recommendations</h6>
                            </div>
                            <div class="card-body">
                                ${caseRecommendations.map(rec => `
                                    <div class="alert alert-${rec.type} mb-3">
                                        <h6><i class="bi bi-${rec.icon} me-1"></i> ${rec.title}</h6>
                                        <p class="mb-1 small">${rec.description}</p>
                                        ${rec.actions ? `
                                            <hr class="my-2">
                                            <strong>Actions:</strong>
                                            <ul class="small mb-0">
                                                ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                                            </ul>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                
                                <div class="mt-4">
                                    <h6>Immediate Actions</h6>
                                    <div class="list-group">
                                        <button class="list-group-item list-group-item-action" onclick="sendFollowUpEmail('${caseData.incidentId}', '${caseData.submitterEmail}')">
                                            <i class="bi bi-envelope me-2"></i> Send Follow-up Email
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="updateCaseStatus('${caseData.incidentId}')">
                                            <i class="bi bi-pencil-square me-2"></i> Update Case Status
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="escalateCase('${caseData.incidentId}')">
                                            <i class="bi bi-arrow-up-right me-2"></i> Escalate to Manager
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="scheduleFollowUp('${caseData.incidentId}')">
                                            <i class="bi bi-calendar-plus me-2"></i> Schedule Follow-up
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(modal).show();
        }

        function generateCaseRecommendations(caseData) {
            const recs = [];
            
            if (caseData.slaViolationStatus === 'Violated') {
                recs.push({
                    type: 'danger',
                    icon: 'exclamation-triangle',
                    title: 'CRITICAL: SLA Violation',
                    description: 'This case has already violated SLA. Immediate action required.',
                    actions: [
                        'Notify manager immediately',
                        'Contact customer with resolution timeline',
                        'Prepare escalation report'
                    ]
                });
            }
            
            if (caseData.agingDays > 10) {
                recs.push({
                    type: 'warning',
                    icon: 'clock-history',
                    title: 'High Aging Alert',
                    description: `Case is ${caseData.agingDays} days old. Review for potential closure or escalation.`,
                    actions: [
                        'Review case progress with team',
                        'Check for dependencies blocking resolution',
                        'Update customer with revised timeline'
                    ]
                });
            }
            
            if (caseData.currentStatus === 'Assign') {
                recs.push({
                    type: 'info',
                    icon: 'person-check',
                    title: 'Status Review Needed',
                    description: 'Case has been in "Assign" status. Consider updating status based on progress.',
                    actions: [
                        'Check if work has started',
                        'Update status to "Work InProgress" if applicable',
                        'Reassign if necessary'
                    ]
                });
            }
            
            if (!caseData.nextFollowUp) {
                recs.push({
                    type: 'info',
                    icon: 'calendar',
                    title: 'Follow-up Missing',
                    description: 'No follow-up date scheduled. Set one to ensure timely updates.',
                    actions: [
                        'Schedule follow-up within 48 hours',
                        'Set calendar reminder',
                        'Document follow-up plan'
                    ]
                });
            }
            
            return recs;
        }

        function getPriority(caseData) {
            if (caseData.slaViolationStatus === 'Violated') return 'high';
            if (caseData.agingDays > 15) return 'high';
            if (caseData.agingDays > 10) return 'medium';
            if (caseData.currentStatus === 'Waiting on Customer' && (caseData.agingFromLastModified || caseData.agingDays) > 5) return 'medium';
            return 'low';
        }

        function getAgingClass(days) {
            if (days <= 5) return '0-5';
            if (days <= 10) return '6-10';
            if (days <= 15) return '11-15';
            return '16-plus';
        }

        function getRecommendationIcon(type) {
            switch(type) {
                case 'critical': return 'exclamation-triangle-fill';
                case 'high': return 'exclamation-circle-fill';
                case 'medium': return 'info-circle-fill';
                case 'low': return 'info-circle';
                default: return 'info-circle';
            }
        }

        function getRecommendationColor(type) {
            switch(type) {
                case 'critical': return 'danger';
                case 'high': return 'warning';
                case 'medium': return 'info';
                case 'low': return 'secondary';
                default: return 'info';
            }
        }

        // Action Functions
        function sendFollowUpEmail(incidentId, email) {
            alert(`Follow-up email would be sent for ${incidentId} to ${email || 'customer'}`);
            // Implement email sending logic here
        }

        function updateCaseStatus(incidentId) {
            alert(`Update status dialog would open for ${incidentId}`);
            // Implement status update logic here
        }

        function escalateCase(incidentId) {
            alert(`Escalation process would start for ${incidentId}`);
            // Implement escalation logic here
        }

        function scheduleFollowUp(incidentId) {
            alert(`Schedule follow-up dialog would open for ${incidentId}`);
            // Implement scheduling logic here
        }

        function generateActionPlan() {
            // Create a simple action plan text
            const actionPlan = `Action Plan Generated: ${new Date().toLocaleString()}\n\n` +
                filteredData.map(d => 
                    `${d.incidentId} - ${d.title}\n` +
                    `Owner: ${d.owner}\n` +
                    `Submitted By: ${d.submittedBy}\n` +
                    `Status: ${d.slaViolationStatus === 'Violated' ? 'CRITICAL' : 'Normal'}\n` +
                    `Aging: ${d.agingDays} days\n` +
                    `Actions Needed: ${generateCaseRecommendations(d).map(r => r.title).join(', ')}\n` +
                    `---\n`
                ).join('\n');
            
            const blob = new Blob([actionPlan], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'action_plan.txt';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // ============================
        // EXPORT FUNCTIONS
        // ============================

        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const fileName = `MSPReview_${timestamp}.xlsx`;
            
            // Prepare data for export
            const exportData = filteredData.map(d => ({
                'Incident ID': d.incidentId,
                'Title': d.title,
                'Submitted By': d.submittedBy,
                'Status': d.currentStatus,
                'Service Type': d.service,
                'Owner': d.owner,
                'Aging Days': d.agingDays,
                'SLA Status': d.slaViolationStatus,
                'Next Follow-up': d.nextFollowUp,
                'Email Compliance': d.emailCompliance,
                'Last Modified': d.lastModified
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "MSP_Review");
            
            // Add metadata sheet
            const metadata = [
                ['MSP Support Engineers - Daily Review Dashboard'],
                ['Generated:', now.toLocaleString()],
                ['Total Cases:', filteredData.length],
                ['Service Requests:', filteredData.filter(d => d.service === 'Service Request').length],
                ['Incidents:', filteredData.filter(d => d.service === 'Incident Management').length],
                ['SLA Violations:', filteredData.filter(d => d.slaViolationStatus === 'Violated').length],
                ['Active Filters:', Object.values(currentFilters).filter(v => v).join(', ') || 'None']
            ];
            const wsMeta = XLSX.utils.aoa_to_sheet(metadata);
            XLSX.utils.book_append_sheet(wb, wsMeta, "Metadata");
            
            // Download file
            XLSX.writeFile(wb, fileName);
            
            alert(`Excel file "${fileName}" downloaded successfully!`);
        }

        function exportToPDF() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const fileName = `MSPReview_${timestamp}.pdf`;
            
            // Create PDF document
            const doc = new jsPDF('landscape');
            
            // Add header
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('MSP Support Engineers - Daily Review Dashboard', 15, 20);
            
            // Add logo (we'll use text as placeholder for logo)
            doc.setFontSize(12);
            doc.setTextColor(52, 152, 219);
            doc.text('SapphireIMS', 240, 20);
            
            // Add generation info
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${now.toLocaleString()}`, 15, 35);
            doc.text(`Filters: ${Object.values(currentFilters).filter(v => v).join(', ') || 'None'}`, 15, 42);
            
            // Add summary metrics
            doc.setFontSize(14);
            doc.setTextColor(44, 62, 80);
            doc.text('Summary Metrics', 15, 55);
            
            doc.setFontSize(11);
            const totalCases = filteredData.length;
            const totalSR = filteredData.filter(d => d.service === 'Service Request').length;
            const totalINC = filteredData.filter(d => d.service === 'Incident Management').length;
            const slaViolated = filteredData.filter(d => d.slaViolationStatus === 'Violated').length;
            
            doc.text(`Total Open Cases: ${totalCases}`, 15, 65);
            doc.text(`Service Requests: ${totalSR}`, 15, 72);
            doc.text(`Incidents: ${totalINC}`, 15, 79);
            doc.text(`SLA Violations: ${slaViolated}`, 15, 86);
            
            // Add aging distribution
            doc.setFontSize(14);
            doc.text('Aging Distribution', 150, 55);
            
            const agingGroups = {
                '0-5 days': filteredData.filter(d => d.agingDays <= 5).length,
                '6-10 days': filteredData.filter(d => d.agingDays > 5 && d.agingDays <= 10).length,
                '11-15 days': filteredData.filter(d => d.agingDays > 10 && d.agingDays <= 15).length,
                '16+ days': filteredData.filter(d => d.agingDays > 15).length
            };
            
            let yPos = 65;
            Object.entries(agingGroups).forEach(([group, count]) => {
                doc.setFontSize(11);
                doc.text(`${group}: ${count} cases`, 150, yPos);
                yPos += 7;
            });
            
            // Add top cases table
            doc.addPage();
            doc.setFontSize(16);
            doc.setTextColor(44, 62, 80);
            doc.text('Top Cases Requiring Attention', 15, 20);
            
            // Prepare table data
            const topCases = filteredData
                .filter(d => d.slaViolationStatus === 'Violated' || d.agingDays > 15)
                .slice(0, 15);
            
            if (topCases.length > 0) {
                const tableData = topCases.map((d, i) => [
                    i + 1,
                    d.incidentId,
                    d.title.substring(0, 40) + (d.title.length > 40 ? '...' : ''),
                    d.owner || 'Unassigned',
                    d.agingDays + ' days',
                    d.slaViolationStatus
                ]);
                
                // Simple table
                let tableY = 30;
                doc.setFontSize(10);
                
                // Table headers
                doc.setTextColor(255, 255, 255);
                doc.setFillColor(44, 62, 80);
                doc.rect(15, tableY, 260, 8, 'F');
                doc.text('#', 18, tableY + 6);
                doc.text('Incident ID', 30, tableY + 6);
                doc.text('Title', 70, tableY + 6);
                doc.text('Owner', 150, tableY + 6);
                doc.text('Aging', 190, tableY + 6);
                doc.text('SLA Status', 220, tableY + 6);
                
                tableY += 8;
                
                // Table rows
                doc.setTextColor(0, 0, 0);
                tableData.forEach((row, index) => {
                    if (tableY > 190) {
                        doc.addPage();
                        tableY = 20;
                    }
                    
                    // Alternate row colors
                    if (index % 2 === 0) {
                        doc.setFillColor(240, 240, 240);
                        doc.rect(15, tableY, 260, 8, 'F');
                    }
                    
                    doc.text(row[0], 18, tableY + 6);
                    doc.text(row[1], 30, tableY + 6);
                    doc.text(row[2], 70, tableY + 6);
                    doc.text(row[3], 150, tableY + 6);
                    doc.text(row[4], 190, tableY + 6);
                    
                    // Color code SLA status
                    if (row[5] === 'Violated') {
                        doc.setTextColor(231, 76, 60);
                    } else {
                        doc.setTextColor(39, 174, 96);
                    }
                    doc.text(row[5], 220, tableY + 6);
                    doc.setTextColor(0, 0, 0);
                    
                    tableY += 8;
                });
            }
            
            // Add footer on each page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${pageCount}`, 140, 205);
                doc.text('Confidential - MSP Internal Use Only', 15, 205);
                doc.text(`MSPReview_${timestamp}`, 240, 205);
            }
            
            // Save PDF
            doc.save(fileName);
            
            alert(`PDF report "${fileName}" downloaded successfully!`);
        }

        function exportActionPlanToPDF() {
            if (recommendations.length === 0) {
                alert('No action plan data to export');
                return;
            }
            
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const fileName = `MSP_ActionPlan_${timestamp}.pdf`;
            
            // Create PDF document
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('MSP Support - Action Plan', 15, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(52, 152, 219);
            doc.text('SapphireIMS', 170, 20);
            
            // Add generation info
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${now.toLocaleString()}`, 15, 35);
            
            // Add summary
            doc.setFontSize(14);
            doc.setTextColor(44, 62, 80);
            doc.text('Executive Summary', 15, 50);
            
            doc.setFontSize(11);
            const criticalItems = recommendations.reduce((count, rec) => 
                count + rec.recommendations.filter(r => r.type === 'critical').length, 0);
            const highItems = recommendations.reduce((count, rec) => 
                count + rec.recommendations.filter(r => r.type === 'high').length, 0);
            
            doc.text(`Total Cases with Recommendations: ${recommendations.length}`, 15, 60);
            doc.text(`Critical Action Items: ${criticalItems}`, 15, 67);
            doc.text(`High Priority Items: ${highItems}`, 15, 74);
            
            // Add detailed recommendations
            let yPos = 90;
            recommendations.forEach((rec, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(44, 62, 80);
                doc.text(`${index + 1}. ${rec.incidentId} - ${rec.title.substring(0, 50)}...`, 15, yPos);
                
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Owner: ${rec.owner || 'Unassigned'} | Submitted By: ${rec.submittedBy || 'Unknown'}`, 15, yPos);
                
                yPos += 8;
                
                // Add recommendations
                rec.recommendations.forEach((r, rIndex) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Set color based on priority
                    switch(r.type) {
                        case 'critical':
                            doc.setTextColor(231, 76, 60);
                            break;
                        case 'high':
                            doc.setTextColor(230, 126, 34);
                            break;
                        case 'medium':
                            doc.setTextColor(52, 152, 219);
                            break;
                        default:
                            doc.setTextColor(149, 165, 166);
                    }
                    
                    doc.text(`    ${r.text}`, 15, yPos);
                    yPos += 7;
                    
                    doc.setTextColor(100, 100, 100);
                    doc.text(`     Action: ${r.action}`, 20, yPos);
                    yPos += 7;
                });
                
                yPos += 5;
            });
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`MSP Action Plan - ${timestamp}`, 15, 290);
                doc.text(`Page ${i} of ${pageCount}`, 100, 290);
                doc.text('Confidential', 180, 290);
            }
            
            // Save PDF
            doc.save(fileName);
            
            alert(`Action Plan PDF "${fileName}" downloaded successfully!`);
        }

        function saveAsHTML() {
            if (filteredData.length === 0) {
                alert('No data to save');
                return;
            }
            
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const fileName = `MSP_Support_Daily_Review_${timestamp}.html`;
            
            // Create HTML content
            const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Support Daily Review - ${now.toLocaleDateString()}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .logo {
            height: 40px;
            margin-right: 15px;
            vertical-align: middle;
        }
        .summary-cards {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 200px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .critical {
            color: #e74c3c;
            font-weight: bold;
        }
        .high {
            color: #e67e22;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 20px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            MSP Support Engineers - Daily Review Dashboard
        </h1>
        <p>Report Generated: ${now.toLocaleString()}</p>
        <p>Filters Applied: ${Object.values(currentFilters).filter(v => v).join(', ') || 'None'}</p>
    </div>
    
    <div class="summary-cards">
        <div class="card">
            <div class="metric-value">${filteredData.length}</div>
            <div class="metric-label">Total Open Cases</div>
        </div>
        <div class="card">
            <div class="metric-value">${filteredData.filter(d => d.service === 'Service Request').length}</div>
            <div class="metric-label">Service Requests</div>
        </div>
        <div class="card">
            <div class="metric-value">${filteredData.filter(d => d.service === 'Incident Management').length}</div>
            <div class="metric-label">Incidents</div>
        </div>
        <div class="card">
            <div class="metric-value" style="color: #e74c3c;">${filteredData.filter(d => d.slaViolationStatus === 'Violated').length}</div>
            <div class="metric-label">SLA Violations</div>
        </div>
    </div>
    
    <div class="section">
        <h2>Aging Analysis</h2>
        <table>
            <tr>
                <th>Aging Range</th>
                <th>Number of Cases</th>
                <th>Percentage</th>
            </tr>
            ${(() => {
                const agingRanges = [
                    { range: '0-5 days', count: filteredData.filter(d => d.agingDays <= 5).length },
                    { range: '6-10 days', count: filteredData.filter(d => d.agingDays > 5 && d.agingDays <= 10).length },
                    { range: '11-15 days', count: filteredData.filter(d => d.agingDays > 10 && d.agingDays <= 15).length },
                    { range: '16+ days', count: filteredData.filter(d => d.agingDays > 15).length }
                ];
                return agingRanges.map(r => `
                    <tr>
                        <td>${r.range}</td>
                        <td>${r.count}</td>
                        <td>${((r.count / filteredData.length) * 100).toFixed(1)}%</td>
                    </tr>
                `).join('');
            })()}
        </table>
    </div>
    
    <div class="section">
        <h2>Top Cases Requiring Attention</h2>
        <table>
            <tr>
                <th>Incident ID</th>
                <th>Title</th>
                <th>Owner</th>
                <th>Aging</th>
                <th>SLA Status</th>
                <th>Priority</th>
            </tr>
            ${filteredData
                .filter(d => d.slaViolationStatus === 'Violated' || d.agingDays > 10)
                .slice(0, 10)
                .map(d => `
                    <tr>
                        <td>${d.incidentId}</td>
                        <td>${d.title.substring(0, 50)}${d.title.length > 50 ? '...' : ''}</td>
                        <td>${d.owner || 'Unassigned'}</td>
                        <td>${d.agingDays} days</td>
                        <td class="${d.slaViolationStatus === 'Violated' ? 'critical' : ''}">
                            ${d.slaViolationStatus}
                        </td>
                        <td class="${getPriority(d)}">
                            ${getPriority(d).toUpperCase()}
                        </td>
                    </tr>
                `).join('')}
        </table>
    </div>
    
    <div class="section">
        <h2>Owner Analysis</h2>
        <table>
            <tr>
                <th>Owner</th>
                <th>Total Cases</th>
                <th>SLA Violations</th>
                <th>Aging >15 days</th>
                <th>SR/INC</th>
            </tr>
            ${(() => {
                const ownerStats = {};
                filteredData.forEach(d => {
                    const owner = d.owner || 'Unassigned';
                    if (!ownerStats[owner]) {
                        ownerStats[owner] = { total: 0, violations: 0, aging: 0, sr: 0, inc: 0 };
                    }
                    ownerStats[owner].total++;
                    if (d.slaViolationStatus === 'Violated') ownerStats[owner].violations++;
                    if (d.agingDays > 15) ownerStats[owner].aging++;
                    if (d.service === 'Service Request') ownerStats[owner].sr++;
                    if (d.service === 'Incident Management') ownerStats[owner].inc++;
                });
                
                return Object.entries(ownerStats)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 10)
                    .map(([owner, stats]) => `
                        <tr>
                            <td>${owner}</td>
                            <td>${stats.total}</td>
                            <td class="${stats.violations > 0 ? 'critical' : ''}">${stats.violations}</td>
                            <td class="${stats.aging > 0 ? 'high' : ''}">${stats.aging}</td>
                            <td>${stats.sr}/${stats.inc}</td>
                        </tr>
                    `).join('');
            })()}
        </table>
    </div>
    
    <div class="footer">
        <p>MSP Support Daily Review - ${now.toLocaleDateString()}</p>
        <p>This is a self-contained HTML report that can be opened in any browser.</p>
        <p>Confidential - For Internal Use Only</p>
    </div>
</body>
</html>`;
            
            // Create and download the file
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            alert(`HTML report "${fileName}" saved successfully!`);
        }
		
		
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
    </script>
    </script>
</body>
</html>
