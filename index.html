<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Support Engineers - Daily Review Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #5F259F; /* PhonePe Purple */
            --secondary-color: #3D7FFF; /* PhonePe Blue */
            --accent-color: #00D4AA; /* PhonePe Teal */
            --warning-color: #FF9F00;
            --danger-color: #FF3B5C;
            --light-gray: #F5F7FF;
            --dark-gray: #6B7280;
            --success-color: #00B894;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #F8FAFF 0%, #F0F4FF 100%);
            min-height: 100vh;
            font-size: 0.9rem;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.3px;
        }
        
        .card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 6px 16px rgba(95, 37, 159, 0.08); 
            margin-bottom: 12px; 
            transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }
        
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 12px 24px rgba(95, 37, 159, 0.12);
        }
        
        .global-filters { 
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); 
            padding: 16px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            border-left: 5px solid var(--primary-color); 
            box-shadow: 0 4px 12px rgba(95, 37, 159, 0.06);
            border-top: 1px solid rgba(0,0,0,0.03);
        }
        
        .main-view-tabs .nav-link { 
            font-size: 0.95rem; 
            font-weight: 600;
            color: #6B7280; 
            margin-right: 6px; 
            border-radius: 10px 10px 0 0; 
            padding: 10px 16px;
            background-color: #f1f3f5;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .main-view-tabs .nav-link:hover {
            background-color: #e9ecef;
            color: var(--primary-color);
        }
        
        .main-view-tabs .nav-link.active { 
            background: linear-gradient(135deg, var(--primary-color) 0%, #7B3FD9 100%);
            color: white; 
            border-bottom: none;
            box-shadow: 0 4px 8px rgba(95, 37, 159, 0.15);
        }
        
        .view-content { 
            border: 1px solid #e0e6ed; 
            border-top: none; 
            background: white; 
            padding: 20px; 
            border-radius: 0 0 12px 12px; 
            min-height: 600px;
            box-shadow: 0 4px 12px rgba(95, 37, 159, 0.04);
        }
        
        .kpi-section-title { 
            font-size: 0.7rem; 
            font-weight: 700; 
            color: var(--primary-color); 
            border-bottom: 2px solid var(--light-gray); 
            padding-bottom: 6px; 
            margin-bottom: 10px; 
            margin-top: 12px; 
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .kpi-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 5px 12px rgba(95, 37, 159, 0.06); 
            padding: 16px; 
            border-left: 5px solid var(--primary-color); 
            cursor: pointer; 
            height: 100%; 
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: scaleX(0);
            transition: transform 0.25s ease;
        }
        
        .kpi-card:hover::before {
            transform: scaleX(1);
        }
        
        .kpi-card:hover { 
            background-color: #F8FAFF; 
            transform: translateY(-6px); 
            box-shadow: 0 12px 24px rgba(95, 37, 159, 0.12); 
        }
        
        .kpi-title { 
            font-size: 0.65rem; 
            color: var(--dark-gray); 
            font-weight: 700; 
            text-transform: uppercase; 
            margin-bottom: 4px; 
            opacity: 0.9; 
            line-height: 1.2;
            letter-spacing: 0.4px;
        }
        
        .kpi-value { 
            font-size: 1.8rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            margin: 6px 0;
            line-height: 1;
        }
        
        .kpi-status-tag { 
            font-size: 0.6rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            padding: 3px 8px; 
            border-radius: 16px; 
            margin-bottom: 6px;
            display: inline-block;
            letter-spacing: 0.4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .kpi-recommendation {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 8px;
            opacity: 0.85;
            line-height: 1.3;
            color: var(--dark-gray);
            border-top: 1px solid #f5f5f5;
            padding-top: 8px;
        }
        
        .bg-urgent { background: linear-gradient(135deg, #FF3B5C, #FF6B8B); color: white; }
        .bg-action-needed, .bg-monitor { background: linear-gradient(135deg, #FF9F00, #FFB74D); color: white; }
        .bg-good { background: linear-gradient(135deg, var(--accent-color), #00E6B8); color: white; }
        .bg-info-tag { background: linear-gradient(135deg, var(--secondary-color), #5D9CFF); color: white; }
        
        .accordion-item { 
            margin-bottom: 12px; 
            border-radius: 10px; 
            border: none; 
            box-shadow: 0 3px 8px rgba(95, 37, 159, 0.04); 
            overflow: hidden;
        }
        
        .accordion-header { border-radius: 10px 10px 0 0; }
        
        .accordion-button { 
            font-size: 0.95rem; 
            font-weight: 600; 
            color: var(--primary-color); 
            background-color: #F8FAFF; 
            border-bottom: 1px solid #e9ecef; 
            padding: 14px 16px;
        }
        
        .accordion-button:not(.collapsed) { 
            background: linear-gradient(135deg, var(--primary-color), #7B3FD9); 
            color: white; 
            box-shadow: inset 0 -1px 0 rgba(0,0,0,.125); 
        }
        
        .accordion-button:focus { 
            box-shadow: none; 
            border-color: var(--primary-color);
        }
        
        .accordion-body { padding: 16px; }
        
        .scorecard-table th { 
            background: linear-gradient(135deg, var(--primary-color), #7B3FD9); 
            color: white; 
            border: none; 
            font-size: 0.7rem; 
            vertical-align: middle; 
            padding: 10px 6px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        
        .scorecard-table td { 
            font-size: 0.75rem; 
            padding: 10px 6px; 
            vertical-align: middle;
            border-bottom: 1px solid #f5f5f5;
            white-space: nowrap;
        }
        
        .critical-cell { 
            background-color: rgba(255, 59, 92, 0.1); 
            color: #FF3B5C; 
            font-weight: 700;
            border-left: 3px solid #FF3B5C;
            font-size: 0.72rem;
        }
        
        .high-cell { 
            background-color: rgba(255, 159, 0, 0.1); 
            color: #FF9F00; 
            border-left: 3px solid #FF9F00;
            font-size: 0.72rem;
        }
        
        .success-cell { 
            background-color: rgba(0, 212, 170, 0.1); 
            color: var(--accent-color); 
            border-left: 3px solid var(--accent-color);
            font-size: 0.72rem;
        }
        
        .compliance-gauge { 
            height: 8px; 
            border-radius: 4px; 
            background-color: #f5f5f5;
            overflow: hidden;
        }
        
        .metric-card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 6px 16px rgba(95, 37, 159, 0.06); 
            background: white;
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(95, 37, 159, 0.1);
        }
        
        .metric-card .card-body { 
            text-align: center; 
            padding: 24px 12px;
        }
        
        .metric-value { 
            font-size: 2.2rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .metric-label { 
            font-size: 0.8rem; 
            color: var(--dark-gray); 
            text-transform: uppercase; 
            letter-spacing: 0.8px; 
            font-weight: 600;
        }
        
        .detailed-case-table th { 
            background-color: #F8FAFF; 
            font-weight: 600;
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.4px;
            white-space: nowrap;
        }
        
        .detailed-case-table td {
            font-size: 0.8rem;
            padding: 10px 8px;
            vertical-align: middle;
        }
        
        .owner-tag { 
            background: linear-gradient(135deg, #E8E6FF, #D6D1FF); 
            padding: 3px 10px; 
            border-radius: 16px; 
            font-size: 0.8rem; 
            font-weight: 600;
            color: var(--primary-color);
            display: inline-block;
            white-space: nowrap;
        }
        
        .upload-area {
            text-align: center; 
            border: 2px dashed #D1D5FF; 
            padding: 30px; 
            cursor: pointer;
            border-radius: 12px;
            background: linear-gradient(135deg, #F8FAFF 0%, #F0F4FF 100%);
            transition: all 0.25s;
        }
        
        .upload-area:hover {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, #F0F7FF 0%, #E8F1FF 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(61, 127, 255, 0.12);
        }
        
        .upload-area.dragover {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, #E8F7F0 0%, #D4F0E4 100%);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #7B3FD9);
            border: none;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #7B3FD9, var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(95, 37, 159, 0.15);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent-color), #00E6B8);
            border: none;
        }
        
        .filter-badge {
            background: linear-gradient(135deg, var(--secondary-color), #5D9CFF);
            color: white;
            padding: 3px 10px;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 4px;
            display: inline-flex;
            align-items: center;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            border: 1px solid #e0e6ed;
            border-top: none;
            padding: 20px;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e0e6ed;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
            font-weight: 500;
            color: var(--dark-gray);
            padding: 8px 16px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: #F8FAFF;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #7B3FD9);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 16px;
        }
        
        .progress-bar {
            border-radius: 4px;
        }
        
        .table-hover tbody tr:hover {
            background-color: #F8FAFF;
            cursor: pointer;
        }
        
        .badge {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        .form-select, .form-control {
            border-radius: 8px;
            border: 1px solid #D1D5FF;
            padding: 8px 10px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(95, 37, 159, 0.12);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 8px rgba(95, 37, 159, 0.04);
            font-size: 0.85rem;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-spinner.active {
            display: flex;
        }
        
        .spinner-border {
            width: 2.5rem;
            height: 2.5rem;
            color: var(--primary-color);
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            padding: 10px;
            background-color: #F8FAFF;
            border-radius: 8px;
        }
        
        .filter-tag {
            background: linear-gradient(135deg, var(--secondary-color), #5D9CFF);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(61, 127, 255, 0.15);
        }
        
        .filter-tag .close {
            color: white;
            opacity: 0.8;
            cursor: pointer;
            margin-left: 6px;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .filter-tag .close:hover {
            opacity: 1;
        }
        
        .drilldown-table th {
            background: linear-gradient(135deg, var(--primary-color), #7B3FD9);
            color: white;
            font-size: 0.75rem;
            padding: 10px 8px;
            white-space: nowrap;
        }
        
        .drilldown-table td {
            font-size: 0.8rem;
            padding: 10px 8px;
            vertical-align: middle;
        }
        
        .drilldown-table {
            font-size: 0.85rem;
        }
        
        .compact-view {
            font-size: 0.8rem;
        }
        
        .compact-view .table th,
        .compact-view .table td {
            padding: 8px 6px;
        }
        
        .compact-view .btn-sm {
            padding: 3px 8px;
            font-size: 0.75rem;
        }
        
        /* Grid View Styles */
        .grid-view-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .case-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(95, 37, 159, 0.06);
            padding: 16px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
            height: 100%;
        }
        
        .case-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(95, 37, 159, 0.12);
        }
        
        .case-card.critical {
            border-left-color: var(--danger-color);
        }
        
        .case-card.warning {
            border-left-color: var(--warning-color);
        }
        
        .case-card.success {
            border-left-color: var(--success-color);
        }
        
        .case-id {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .case-title {
            font-size: 0.85rem;
            color: var(--dark-gray);
            margin-bottom: 10px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .case-meta {
            font-size: 0.75rem;
            color: #6B7280;
            margin-bottom: 8px;
        }
        
        .case-meta-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .case-meta-item i {
            margin-right: 6px;
            width: 14px;
            color: var(--primary-color);
        }
        
        .case-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .case-tag {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .case-tag.urgent {
            background-color: rgba(255, 59, 92, 0.12);
            color: #FF3B5C;
        }
        
        .case-tag.warning {
            background-color: rgba(255, 159, 0, 0.12);
            color: #FF9F00;
        }
        
        .case-tag.info {
            background-color: rgba(61, 127, 255, 0.12);
            color: var(--secondary-color);
        }
        
        .case-tag.success {
            background-color: rgba(0, 212, 170, 0.12);
            color: var(--accent-color);
        }
        
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        
        .view-toggle-btn {
            background: #f1f3f5;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 0.8rem;
            color: #6B7280;
            transition: all 0.2s;
        }
        
        .view-toggle-btn:hover, .view-toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        @media (max-width: 1400px) {
            .scorecard-table th,
            .scorecard-table td {
                font-size: 0.68rem;
                padding: 8px 4px;
            }
            
            .kpi-value {
                font-size: 1.6rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 1200px) {
            .grid-view-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .scorecard-table th,
            .scorecard-table td {
                font-size: 0.65rem;
            }
        }
        
        @media (max-width: 768px) {
            .grid-view-container {
                grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            }
            
            .global-filters .col-md-2 {
                margin-bottom: 10px;
            }
            
            .view-content {
                padding: 15px;
            }
            
            .accordion-body {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark shadow" style="background: linear-gradient(135deg, var(--primary-color), #7B3FD9);">
        <div class="container-fluid">
            <div class="logo-container d-flex align-items-center">
                <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" alt="Logo" style="height: 30px;" class="me-3">
                <a class="navbar-brand" href="#">
                    MSP Support Engineers - Daily Review Dashboard
                </a>
            </div>
            <div class="d-flex align-items-center text-white">
                <span id="last-updated" class="me-3 small"></span>
                <span id="total-cases" class="badge bg-light text-dark shadow-sm">0 Cases Loaded</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        
        <div class="row mb-3" id="upload-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="upload-area" id="drop-area" style="text-align:center;">
                            <img src="https://framerusercontent.com/images/H68MYj3xIX7Xtb1HiwUah4O7xo.png?scale-down-to=512" alt="Logo" style="height: 40px; margin-bottom: 12px; opacity: 0.8;">
                            <h5 class="mb-2">Upload MSP Review Record</h5>
                            <p class="text-muted mb-3">Drag & Drop Excel/CSV or Click to Browse</p>
                            <button class="btn btn-lg btn-primary">
                                <i class="bi bi-cloud-upload me-2"></i>Select File
                            </button>
                            <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                        </div>
                        <div id="file-info" class="mt-3" style="display: none;">
                            <div class="alert alert-success d-flex justify-content-between align-items-center shadow-sm">
                                <div>
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                                    <span id="file-name" class="fw-bold"></span> 
                                    <span id="row-count" class="badge bg-secondary ms-2"></span>
                                </div>
                                <button class="btn btn-sm btn-success" id="process-data-btn">
                                    <i class="bi bi-play-circle me-1"></i> Process Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-section" style="display: none;">
            
            <div class="row mb-3">
                <div class="col-12">
                    <div class="global-filters">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-funnel-fill me-2" style="color: var(--primary-color);"></i>Global Filters</h6>
                            <button class="btn btn-sm btn-outline-danger" id="clear-filters-btn">
                                <i class="bi bi-x-circle me-1"></i>Clear All
                            </button>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold mb-1">Owner</label>
                                <select class="form-select form-select-sm" id="global-filter-owner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold mb-1">Submitted By</label>
                                <select class="form-select form-select-sm" id="global-filter-submittedby">
                                    <option value="">All Submitted By</option>
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold mb-1">Service Type</label>
                                <select class="form-select form-select-sm" id="global-filter-service">
                                    <option value="">All Service Types</option>
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold mb-1">Status</label>
                                <select class="form-select form-select-sm" id="global-filter-status">
                                    <option value="">All Statuses</option>
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold mb-1">SLA Status</label>
                                <select class="form-select form-select-sm" id="global-filter-sla">
                                    <option value="">All SLA Status</option>
                                    <option value="Violated">SLA Violated</option>
                                    <option value="Non-Violated">SLA Non-Violated</option>
                                </select>
                            </div>
                            <div class="col-md-2 col-6 d-flex align-items-end">
                                <button class="btn btn-sm btn-primary w-100" onclick="exportFullData()">
                                    <i class="bi bi-download me-1"></i> Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="filter-tags" id="active-filters-tags" style="display: none;">
                            <!-- Active filter tags will appear here -->
                        </div>
                        
                        <div class="mt-2 small text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            <span id="active-filters-count">0 filters active</span> | 
                            <span id="filtered-cases-count">Showing 0 of 0 cases</span>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs main-view-tabs mb-0" id="mainViewTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="view-dashboard-tab" data-bs-toggle="tab" data-bs-target="#view-dashboard" type="button" role="tab">
                        <i class="bi bi-grid-1x2 me-2"></i>Dashboard View
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="view-detailed-tab" data-bs-toggle="tab" data-bs-target="#view-detailed" type="button" role="tab">
                        <i class="bi bi-list-columns-reverse me-2"></i>Detailed View
                    </button>
                </li>
            </ul>

            <div class="tab-content view-content" id="mainViewTabsContent">
                
                <div class="tab-pane fade show active" id="view-dashboard" role="tabpanel">
                    
                    <div class="accordion" id="kpiAccordion">
                    
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    <i class="bi bi-list-task me-2"></i>1. Overall Case Volume
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-total-card">
                                                <span class="kpi-status-tag bg-info-tag" id="kpi-total-tag">INFO</span>
                                                <div class="kpi-title">Total Open Cases</div>
                                                <div class="kpi-value" id="kpi-total">0</div>
                                                <div class="kpi-recommendation" id="kpi-total-rec">Total cases currently active in the system.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-sr-card">
                                                <span class="kpi-status-tag bg-info-tag" id="kpi-sr-tag">INFO</span>
                                                <div class="kpi-title">Total SR</div>
                                                <div class="kpi-value" id="kpi-sr">0</div>
                                                <div class="kpi-recommendation" id="kpi-sr-rec">Breakdown of active Service Requests.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-inc-card">
                                                <span class="kpi-status-tag bg-info-tag" id="kpi-inc-tag">INFO</span>
                                                <div class="kpi-title">Total INC</div>
                                                <div class="kpi-value" id="kpi-inc">0</div>
                                                <div class="kpi-recommendation" id="kpi-inc-rec">Breakdown of active Incident Management cases.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                                    <i class="bi bi-alarm-fill me-2"></i>2. SLA Compliance
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse show" aria-labelledby="headingTwo">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sla-sr-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-sla-sr-tag">GOOD</span>
                                                <div class="kpi-title">SLA Violated – SR</div>
                                                <div class="kpi-value" id="kpi-sla-sr">0</div>
                                                <div class="kpi-recommendation" id="kpi-sla-sr-rec">No SR cases currently in violation.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sla-inc-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-sla-inc-tag">GOOD</span>
                                                <div class="kpi-title">SLA Violated – INC</div>
                                                <div class="kpi-value" id="kpi-sla-inc">0</div>
                                                <div class="kpi-recommendation" id="kpi-sla-inc-rec">No INC cases currently in violation.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
                                    <i class="bi bi-hourglass-split me-2"></i>3. Aging & Old Cases
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse show" aria-labelledby="headingThree">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-aging-15-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-aging-15-tag">GOOD</span>
                                                <div class="kpi-title">Aging > 15 Days</div>
                                                <div class="kpi-value" id="kpi-aging-15">0</div>
                                                <div class="kpi-recommendation" id="kpi-aging-15-rec">No cases have crossed the 15-day warning threshold.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-aging-25-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-aging-25-tag">GOOD</span>
                                                <div class="kpi-title">Oldest Cases (> 25 Days)</div>
                                                <div class="kpi-value" id="kpi-aging-25">0</div>
                                                <div class="kpi-recommendation" id="kpi-aging-25-rec">No critical old cases requiring urgent action.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="true" aria-controls="collapseFour">
                                    <i class="bi bi-calendar-event me-2"></i>4. Follow-up & Response Misses
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse show" aria-labelledby="headingFour">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-followup-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-followup-tag">GOOD</span>
                                                <div class="kpi-title">Follow-up Date Missed</div>
                                                <div class="kpi-value" id="kpi-followup">0</div>
                                                <div class="kpi-recommendation" id="kpi-followup-rec">All cases have a valid, upcoming follow-up date.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-email-followup-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-email-followup-tag">GOOD</span>
                                                <div class="kpi-title">Email F/Up Missed</div>
                                                <div class="kpi-value" id="kpi-email-followup">0</div>
                                                <div class="kpi-recommendation" id="kpi-email-followup-rec">All email follow-ups are compliant.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="kpi-card" id="kpi-email-resp-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-email-resp-tag">GOOD</span>
                                                <div class="kpi-title">Email Resp Missed</div>
                                                <div class="kpi-value" id="kpi-email-resp">0</div>
                                                <div class="kpi-recommendation" id="kpi-email-resp-rec">No missed client responses reported.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFive">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="true" aria-controls="collapseFive">
                                    <i class="bi bi-arrow-repeat me-2"></i>5. Subsequent SLA & Response Tracking
                                </button>
                            </h2>
                            <div id="collapseFive" class="accordion-collapse collapse show" aria-labelledby="headingFive">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sub-resp-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-sub-resp-tag">GOOD</span>
                                                <div class="kpi-title">Subsequent Resp Missed</div>
                                                <div class="kpi-value" id="kpi-sub-resp">0</div>
                                                <div class="kpi-recommendation" id="kpi-sub-resp-rec">All subsequent response dates are met or tracked.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-sub-sla-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-sub-sla-tag">GOOD</span>
                                                <div class="kpi-title">Subsequent SLA Miss</div>
                                                <div class="kpi-value" id="kpi-sub-sla">0</div>
                                                <div class="kpi-recommendation" id="kpi-sub-sla-rec">No cases have breached the subsequent SLA threshold.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSix">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="true" aria-controls="collapseSix">
                                    <i class="bi bi-pause-circle me-2"></i>6. Idle Case Monitoring & SR-Specific Compliance (EDOC)
                                </button>
                            </h2>
                            <div id="collapseSix" class="accordion-collapse collapse show" aria-labelledby="headingSix">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <!-- #1 CHANGE: Removed Idle > 1 Day card from this section -->
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-idle-3-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-idle-3-tag">GOOD</span>
                                                <div class="kpi-title">Idle > 3 Days</div>
                                                <div class="kpi-value" id="kpi-idle-3">0</div>
                                                <div class="kpi-recommendation" id="kpi-idle-3-rec">No critical cases idle for more than 3 days.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="kpi-card" id="kpi-edoc-card">
                                                <span class="kpi-status-tag bg-good" id="kpi-edoc-tag">GOOD</span>
                                                <div class="kpi-title">SR EDOC Breach</div>
                                                <div class="kpi-value" id="kpi-edoc">0</div>
                                                <div class="kpi-recommendation" id="kpi-edoc-rec">No SR cases have breached their Expected Date of Closure.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <h6 class="mt-4 mb-2" style="color: var(--primary-color);">
                        <i class="bi bi-person-lines-fill me-2"></i>Team Performance Scorecard
                    </h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">
                            Click on any row to filter by that owner
                        </div>
                        <button class="btn btn-sm btn-success" onclick="exportScorecardToExcel()">
                            <i class="bi bi-download me-1"></i> Export Scorecard
                        </button>
                    </div>
                    <div class="card p-2 overflow-auto">
                        <table class="table table-sm table-striped table-hover scorecard-table compact-view" id="owner-scorecard-table" style="min-width: 1400px;">
                            <thead>
                                <tr>
                                    <th>Owner</th>
                                    <th>Overall SLA %</th>
                                    <th>Total Open Cases</th>
                                    <th>Total SR</th>
                                    <th>Total INC</th>
                                    <th>SLA Viol. – SR</th>
                                    <th>SLA Viol. – INC</th>
                                    <th>Aging >15 Days</th>
                                    <th>Oldest >25 Days</th>
                                    <th>F/Up Date Missed</th>
                                    <th>Email F/Up Missed</th>
                                    <th>Email Resp Missed</th>
                                    <th>Sub. Resp Missed</th>
                                    <th>Sub. SLA Miss</th>
                                    <th>Idle >1 Day</th>
                                    <th>Idle >3 Days</th>
                                    <th>SR EDOC Breach</th>
                                    <th>Risk Gauge</th>
                                </tr>
                            </thead>
                            <tbody id="owner-scorecard-body">
                                <tr><td colspan="18" class="text-center text-muted py-3">Processing data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="view-detailed" role="tabpanel">
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body">
                                    <div class="metric-value" id="total-open-cases">0</div>
                                    <div class="metric-label">Total Open Cases</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body">
                                    <div class="metric-value" id="total-sr-detail">0</div>
                                    <div class="metric-label">Service Requests</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card">
                                <div class="card-body">
                                    <div class="metric-value" id="total-inc-detail">0</div>
                                    <div class="metric-label">Incidents</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card" style="background: linear-gradient(135deg, var(--accent-color), #00E6B8);">
                                <div class="card-body text-white">
                                    <div class="metric-value" id="sla-compliance-rate">0%</div>
                                    <div class="metric-label">Overall SLA Compliance</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-pie-chart-fill me-2" style="color: var(--primary-color);"></i>Cases by Status</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="statusChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-bar-chart-fill me-2" style="color: var(--primary-color);"></i>Aging Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="agingChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button">
                                <i class="bi bi-lightning-fill text-danger me-1"></i>Today's Actions
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="cases-tab" data-bs-toggle="tab" data-bs-target="#cases" type="button">
                                All Cases
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="sla-tab" data-bs-toggle="tab" data-bs-target="#sla" type="button">
                                SLA Violations
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="aging-tab" data-bs-toggle="tab" data-bs-target="#aging" type="button">
                                Aging >15 Days
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button">
                                Recommendations
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="owners-tab" data-bs-toggle="tab" data-bs-target="#owners" type="button">
                                Owner Analysis
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="dashboardTabsContent">
                        
                        <div class="tab-pane fade show active" id="actions">
                            <div class="alert alert-danger shadow-sm mb-2">
                                <i class="bi bi-exclamation-circle-fill me-2"></i>
                                This list shows all cases requiring immediate owner action today.
                            </div>
                            <div id="actions-container"></div>
                        </div>
                        
                        <div class="tab-pane fade" id="cases">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="filter-section p-3 bg-light rounded shadow-sm flex-grow-1 me-3">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Service Type</label>
                                            <select class="form-select form-select-sm" id="filter-service">
                                                <option value="">All Service Types</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Owner</label>
                                            <select class="form-select form-select-sm" id="filter-owner">
                                                <option value="">All Owners</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Status</label>
                                            <select class="form-select form-select-sm" id="filter-status">
                                                <option value="">All Statuses</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="list-view-btn">
                                        <i class="bi bi-list"></i> List
                                    </button>
                                    <button class="view-toggle-btn" id="grid-view-btn">
                                        <i class="bi bi-grid"></i> Grid
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearTabFilters('cases')">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </button>
                                <div id="cases-count" class="small text-muted">0 cases</div>
                            </div>
                            <div id="cases-list-container" class="compact-view"></div>
                            <div id="cases-grid-container" style="display: none;"></div>
                        </div>

                        <div class="tab-pane fade" id="sla">
                             <div class="filter-section p-3 bg-light rounded mb-3 shadow-sm">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold mb-1">Filter by Owner</label>
                                        <select class="form-select form-select-sm" id="sla-filter-owner">
                                            <option value="">All Owners</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8 d-flex align-items-end justify-content-end">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTabFilters('sla')">
                                            <i class="bi bi-x-circle me-1"></i> Clear Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="sla-violations-container" class="compact-view"></div>
                        </div>

                        <div class="tab-pane fade" id="aging">
                            <div class="filter-section p-3 bg-light rounded mb-3 shadow-sm">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold mb-1">Filter by Owner</label>
                                        <select class="form-select form-select-sm" id="aging-filter-owner">
                                            <option value="">All Owners</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8 d-flex align-items-end justify-content-end">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTabFilters('aging')">
                                            <i class="bi bi-x-circle me-1"></i> Clear Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="aging-cases-container" class="compact-view"></div>
                        </div>

                        <div class="tab-pane fade" id="recommendations">
                            <div id="recommendations-container"></div>
                        </div>

                        <div class="tab-pane fade" id="owners">
                            <div class="row" id="owner-breakdown"></div>
                            <div class="card mt-3 shadow-sm">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-graph-up me-2" style="color: var(--primary-color);"></i>SLA & Aging Breakdown by Owner</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="ownerChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border"></div>
        <div class="mt-2 fw-bold" style="color: var(--primary-color);">Processing data...</div>
    </div>

    <div class="modal fade" id="drillDownModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="drillDownTitle">Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge" style="background: linear-gradient(135deg, var(--primary-color), #7B3FD9); font-size: 0.9rem;" id="drillDownCount">0 Cases</span>
                        <button class="btn btn-sm btn-success" onclick="exportDrillDownToExcel()">
                            <i class="bi bi-download me-1"></i> Export List
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-bordered drilldown-table compact-view">
                            <thead>
                                <tr id="drillDownHeader">
                                    <!-- Headers will be dynamically populated -->
                                </tr>
                            </thead>
                            <tbody id="drillDownBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="caseDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="caseDetailTitle">Case Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="case-detail-content">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let rawData = [];
        let processedData = [];
        let filteredData = [];
        let drillDownData = [];
        let drillDownTitleForExport = '';
        let drillDownExportData = [];
        let globalFilters = { owner: '', submittedby: '', service: '', status: '', sla: '' };
        let charts = {};
        let scorecardData = [];
        let currentView = 'list'; // 'list' or 'grid'

        // Column mapping for drill-downs
        const drillDownColumns = {
            'aging15': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'aging15Status', label: 'Aging >15 days Status' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'oldest25': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'aging15Status', label: 'Aging >15 days Status' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'followUpMissed': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'emailNoFollowup': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'emailCompliance', label: 'Email Response Compliance' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'emailResponseMissed': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'emailCompliance', label: 'Email Response Compliance' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'subsequentResponseMissed': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'expectedResponseTime', label: 'Expected Response Time' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'edocBreach': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'expectedResolution', label: 'SR EDOC' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'subsequentSLAMiss': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'updatePendingSupportCounter', label: 'Update Pending From Support Counter' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'idle1': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'ageingLastModified', label: 'Ageing from Last modified time' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'idle3': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'submittedBy', label: 'SubmittedBy' },
                { key: 'currentStatus', label: 'CurrentStatus' },
                { key: 'service', label: 'Service' },
                { key: 'owner', label: 'Owner' },
                { key: 'agingRoundoff', label: 'Aging(Roundoff)' },
                { key: 'ageingLastModified', label: 'Ageing from Last modified time' },
                { key: 'slaStatus', label: 'SLA Status' }
            ],
            'totalOpen': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'slaViolationStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'totalSR': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'slaViolationStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'totalINC': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'slaViolationStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'slaSR': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'slaViolationStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ],
            'slaINC': [
                { key: 'incidentId', label: 'Incident ID' },
                { key: 'title', label: 'Title' },
                { key: 'owner', label: 'Owner' },
                { key: 'currentStatus', label: 'Status' },
                { key: 'agingDays', label: 'Aging' },
                { key: 'slaViolationStatus', label: 'SLA Status' },
                { key: 'nextFollowUp', label: 'Next Follow-up' }
            ]
        };

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const uploadButton = dropArea.querySelector('button');

            uploadButton.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('click', () => fileInput.click());
            
            dropArea.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                dropArea.classList.add('dragover');
                dropArea.style.borderColor = 'var(--accent-color)';
            });
            
            dropArea.addEventListener('dragleave', () => { 
                dropArea.classList.remove('dragover');
                dropArea.style.borderColor = '#D1D5FF'; 
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                dropArea.style.borderColor = '#D1D5FF';
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.onchange = (e) => { 
                if (e.target.files[0]) {
                    handleFileUpload(e.target.files[0]);
                }
            };

            document.getElementById('process-data-btn').onclick = processData;
            document.getElementById('clear-filters-btn').onclick = clearAllFilters;
            
            // View toggle buttons
            document.getElementById('list-view-btn').addEventListener('click', () => {
                setViewMode('list');
            });
            
            document.getElementById('grid-view-btn').addEventListener('click', () => {
                setViewMode('grid');
            });

            // Set up filter event listeners
            document.getElementById('global-filter-service').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-owner').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-status').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-sla').addEventListener('change', updateGlobalFilters);
            document.getElementById('global-filter-submittedby').addEventListener('change', updateGlobalFilters);
            
            setupTabFilterListeners();
        }
        
        function setViewMode(mode) {
            currentView = mode;
            
            // Update button states
            document.getElementById('list-view-btn').classList.toggle('active', mode === 'list');
            document.getElementById('grid-view-btn').classList.toggle('active', mode === 'grid');
            
            // Show/hide containers
            document.getElementById('cases-list-container').style.display = mode === 'list' ? 'block' : 'none';
            document.getElementById('cases-grid-container').style.display = mode === 'grid' ? 'block' : 'none';
            
            // Re-render if we have data
            if (filteredData.length > 0) {
                filterCases();
            }
        }

        function setupTabFilterListeners() {
            ['filter-service', 'filter-owner', 'filter-status'].forEach(id => {
                if(document.getElementById(id)) {
                    document.getElementById(id).addEventListener('change', () => {
                        if(id === 'filter-service' || id === 'filter-owner' || id === 'filter-status') {
                            filterCases();
                        }
                    });
                }
            });
            
            if(document.getElementById('sla-filter-owner')) {
                document.getElementById('sla-filter-owner').addEventListener('change', () => filterSLAViolations());
            }
            
            if(document.getElementById('aging-filter-owner')) {
                document.getElementById('aging-filter-owner').addEventListener('change', () => filterAgingCases());
            }
        }

        function handleFileUpload(file) {
            const fileName = file.name;
            document.getElementById('file-name').textContent = fileName;
            document.getElementById('file-info').style.display = 'block';

            showLoading(true);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                if(fileName.endsWith('.csv')) {
                    parseCSV(e.target.result);
                } else {
                    parseExcel(e.target.result);
                }
            };
            
            if(fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseExcel(data) {
            try {
                const wb = XLSX.read(data, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                processExcelData(XLSX.utils.sheet_to_json(ws, { header: 1 }));
            } catch (error) {
                showLoading(false);
                alert("Error parsing Excel file: " + error.message);
            }
        }

        function parseCSV(data) {
            try {
                processExcelData(data.split('\n').map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim())));
            } catch (error) {
                showLoading(false);
                alert("Error parsing CSV file: " + error.message);
            }
        }

        function processExcelData(data) {
            if (!data || data.length < 2) {
                showLoading(false);
                alert("No data found or file format is incorrect.");
                return;
            }

            const headers = data[0].map(h => h ? h.toString().trim() : '');
            rawData = data.slice(1).map(row => {
                const rowObj = {};
                headers.forEach((header, index) => {
                    rowObj[header] = row[index];
                });
                return rowObj;
            }).filter(row => Object.values(row).some(v => v && v.toString().trim() !== ''));

            document.getElementById('row-count').textContent = `${rawData.length} rows loaded`;
            
            const parseNum = (val) => {
                if (val === null || val === undefined || val === '' || val === '--' || val === 'NULL') return 0;
                if (typeof val === 'string' && val.includes('Day(s)')) {
                    const dayMatch = val.match(/(\d+)\s*Day\(s\)/);
                    const hourMatch = val.match(/(\d+)\s*Hour\(s\)/);
                    const minMatch = val.match(/(\d+)\s*Min\(s\)/);
                    const days = dayMatch ? parseInt(dayMatch[1]) : 0;
                    const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
                    const mins = minMatch ? parseInt(minMatch[1]) : 0;
                    return days + (hours / 24) + (mins / 1440);
                }
                const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
                return isNaN(num) ? 0 : num;
            };
            
            const parseAgingDays = (val) => {
                const num = parseNum(val);
                return Math.round(num);
            };
            
            const isDateValid = (dStr) => {
                if (!dStr || dStr === '--' || dStr === 'NULL' || dStr === '0002-11-30 00:00' || dStr === 'Na' || dStr === 'NA') return false;
                const date = new Date(dStr);
                return !isNaN(date.getTime());
            };
            
            const isPastOrToday = (dStr) => {
                if (!isDateValid(dStr)) return false;
                const date = new Date(dStr);
                const today = new Date();
                date.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                return date <= today;
            };
            
            const findCol = (possibleNames) => {
                for (const name of possibleNames) {
                    const found = headers.find(h => h && h.toString().toLowerCase().includes(name.toLowerCase()));
                    if (found) return found;
                }
                return possibleNames[0];
            };

            const colMap = {
                incidentId: findCol(['Incident ID', 'Ticket ID', 'Case ID']),
                title: findCol(['Title', 'Subject', 'Description']),
                submittedBy: findCol(['SubmittedBy', 'Submitted By', 'Reporter']),
                currentStatus: findCol(['CurrentStatus', 'Status', 'State']),
                service: findCol(['Service', 'Service Type', 'Type']),
                owner: findCol(['Owner', 'Assigned To', 'Engineer']),
                aging15Status: findCol(['Aging >15 days Status', 'Aging Status', 'Aging >15']),
                expectedResponseTime: findCol(['Expected Response Time', 'Response Time']),
                expectedResolutionTime: findCol(['Expected Resolution Time', 'Resolution Time']),
                expectedSLAClosureTime: findCol(['Expected SLA Closure Time', 'SLA Closure']),
                srEDOC: findCol(['SR EDOC', 'EDOC', 'Expected Date of Closure']),
                slaStatus: findCol(['SLA Status', 'SLA']),
                slaViolationStatus: findCol(['SLA Violation Status', 'Violation Status']),
                agingRoundoff: findCol(['Aging(Roundoff)', 'Aging', 'Age (Days)']),
                nextFollowUpDate: findCol(['Next Follow-up Date', 'Follow-up Date', 'Next Followup']),
                emailResponseCompliance: findCol(['Email Response Compliance', 'Email Compliance']),
                updatePendingSupportCounter: findCol(['Update Pending From Support Counter', 'Pending Counter']),
                ageingLastModified: findCol(['Ageing from Last modified time', 'Last Modified Aging']),
                steps: findCol(['Steps to be followed', 'Steps', 'Resolution Steps'])
            };

            processedData = rawData.map(row => {
                const service = row[colMap.service] || '';
                const slaViolationStatus = row[colMap.slaViolationStatus] || 'Non-Violated';
                const agingRoundoff = row[colMap.agingRoundoff] || '0';
                const aging15Status = row[colMap.aging15Status] || 'Non-Violated';
                const emailCompliance = row[colMap.emailResponseCompliance] || '';
                const srEDOC = row[colMap.srEDOC] || '';
                const nextFollowUp = row[colMap.nextFollowUpDate] || '';
                const expectedResponseTime = row[colMap.expectedResponseTime] || '';
                
                const agingDays = parseAgingDays(agingRoundoff);
                const subsequentSLACount = parseNum(row[colMap.updatePendingSupportCounter] || '0');
                const agingFromLastModified = parseNum(row[colMap.ageingLastModified] || '0');

                const isSR = service === 'Service Request';
                const isINC = service === 'Incident Management';
                const isSlaViolated = slaViolationStatus === 'Violated';
                const isAging15Violated = aging15Status === 'Violated';
                const isFollowUpMissed = (!isDateValid(nextFollowUp) || isPastOrToday(nextFollowUp));
                
                const isSubsequentResponseMissed = isDateValid(expectedResponseTime) && 
                                                   isPastOrToday(expectedResponseTime) && 
                                                   isINC;
                
                const isSubsequentSLABreach = subsequentSLACount > 0;
                const isEdocBreached = (isSR && isPastOrToday(srEDOC));
                const isOldest25 = agingDays > 25;
                const isIdle1 = agingFromLastModified > 0;
                const isIdle3 = agingFromLastModified > 1;

                return {
                    incidentId: row[colMap.incidentId] || 'N/A',
                    owner: row[colMap.owner] || 'Unassigned',
                    title: row[colMap.title] || 'No Title',
                    currentStatus: row[colMap.currentStatus] || 'Unknown',
                    service: service,
                    submittedBy: row[colMap.submittedBy] || 'Unknown',
                    agingDays: agingDays,
                    agingFromLastModified: agingFromLastModified,
                    slaViolationStatus: slaViolationStatus,
                    nextFollowUp: nextFollowUp,
                    subsequentResponse: expectedResponseTime,
                    emailCompliance: emailCompliance,
                    expectedResolution: srEDOC,
                    subsequentSLABreachCount: subsequentSLACount,
                    
                    // For drill-down exports
                    aging15Status: aging15Status,
                    agingRoundoff: agingRoundoff,
                    slaStatus: row[colMap.slaStatus] || 'N/A',
                    expectedResponseTime: expectedResponseTime,
                    updatePendingSupportCounter: row[colMap.updatePendingSupportCounter] || '0',
                    ageingLastModified: row[colMap.ageingLastModified] || '0',
                    
                    isSR,
                    isINC,
                    isSlaViolated,
                    isAging15Violated,
                    isFollowUpMissed,
                    isSubsequentResponseMissed,
                    isSubsequentSLABreach,
                    isEdocBreached,
                    isOldest25,
                    isIdle1,
                    isIdle3,
                    
                    _raw: row
                };
            });

            filteredData = [...processedData];
            showLoading(false);
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('total-cases').textContent = `${processedData.length} Cases Loaded`;
            document.getElementById('last-updated').textContent = `Last Updated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;

            populateFilterDropdowns();
            updateDashboard();
        }

        function populateFilterDropdowns() {
            const getUniqueValues = (key) => [...new Set(processedData.map(d => d[key]).filter(Boolean).sort())];

            const dropdowns = {
                'global-filter-owner': getUniqueValues('owner'),
                'global-filter-submittedby': getUniqueValues('submittedBy'),
                'global-filter-service': getUniqueValues('service'),
                'global-filter-status': getUniqueValues('currentStatus'),
                'filter-owner': getUniqueValues('owner'),
                'filter-service': getUniqueValues('service'),
                'filter-status': getUniqueValues('currentStatus'),
                'sla-filter-owner': getUniqueValues('owner'),
                'aging-filter-owner': getUniqueValues('owner')
            };

            for (const id in dropdowns) {
                const select = document.getElementById(id);
                if (select) {
                    const originalValue = select.value;
                    const label = id.split('-').pop();
                    const labelText = label === 'owner' ? 'Owners' : 
                                   label === 'service' ? 'Service Types' : 
                                   label === 'status' ? 'Statuses' : 
                                   label === 'submittedby' ? 'Submitted By' :
                                   'Options';
                    
                    select.innerHTML = `<option value="">All ${labelText}</option>`;
                    dropdowns[id].forEach(value => {
                        select.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                    if (originalValue && dropdowns[id].includes(originalValue)) {
                        select.value = originalValue;
                    }
                }
            }
        }

        function updateGlobalFilters() {
            showLoading(true);
            
            globalFilters.owner = document.getElementById('global-filter-owner').value;
            globalFilters.submittedby = document.getElementById('global-filter-submittedby').value;
            globalFilters.service = document.getElementById('global-filter-service').value;
            globalFilters.status = document.getElementById('global-filter-status').value;
            globalFilters.sla = document.getElementById('global-filter-sla').value;

            filteredData = processedData.filter(d => {
                if (globalFilters.owner && d.owner !== globalFilters.owner) return false;
                if (globalFilters.submittedby && d.submittedBy !== globalFilters.submittedby) return false;
                if (globalFilters.service && d.service !== globalFilters.service) return false;
                if (globalFilters.status && d.currentStatus !== globalFilters.status) return false;
                if (globalFilters.sla === 'Violated' && !d.isSlaViolated) return false;
                if (globalFilters.sla === 'Non-Violated' && d.isSlaViolated) return false;
                return true;
            });

            updateActiveFiltersDisplay();
            
            updateDashboard();
            showLoading(false);
        }

        function updateActiveFiltersDisplay() {
            const activeFilters = [];
            if (globalFilters.owner) activeFilters.push({key: 'owner', label: 'Owner', value: globalFilters.owner});
            if (globalFilters.submittedby) activeFilters.push({key: 'submittedby', label: 'Submitted By', value: globalFilters.submittedby});
            if (globalFilters.service) activeFilters.push({key: 'service', label: 'Service Type', value: globalFilters.service});
            if (globalFilters.status) activeFilters.push({key: 'status', label: 'Status', value: globalFilters.status});
            if (globalFilters.sla) activeFilters.push({key: 'sla', label: 'SLA Status', value: globalFilters.sla});

            const activeFiltersTags = document.getElementById('active-filters-tags');
            const activeFiltersCount = document.getElementById('active-filters-count');
            const filteredCasesCount = document.getElementById('filtered-cases-count');

            if (activeFilters.length > 0) {
                activeFiltersTags.innerHTML = activeFilters.map(filter => `
                    <div class="filter-tag">
                        <i class="bi bi-funnel"></i>
                        ${filter.label}: ${filter.value}
                        <span class="close" onclick="removeFilter('${filter.key}')">&times;</span>
                    </div>
                `).join('');
                activeFiltersTags.style.display = 'flex';
            } else {
                activeFiltersTags.style.display = 'none';
            }

            activeFiltersCount.textContent = `${activeFilters.length} filter${activeFilters.length !== 1 ? 's' : ''} active`;
            filteredCasesCount.textContent = `Showing ${filteredData.length} of ${processedData.length} cases`;
        }

        function removeFilter(filterKey) {
            document.getElementById(`global-filter-${filterKey}`).value = '';
            updateGlobalFilters();
        }

        function clearAllFilters() {
            document.getElementById('global-filter-owner').value = '';
            document.getElementById('global-filter-submittedby').value = '';
            document.getElementById('global-filter-service').value = '';
            document.getElementById('global-filter-status').value = '';
            document.getElementById('global-filter-sla').value = '';
            
            globalFilters.owner = '';
            globalFilters.submittedby = '';
            globalFilters.service = '';
            globalFilters.status = '';
            globalFilters.sla = '';
            
            filteredData = [...processedData];
            
            updateActiveFiltersDisplay();
            updateDashboard();
        }

        function updateOwnerFilter(owner) {
            document.getElementById('global-filter-owner').value = owner;
            updateGlobalFilters();
        }

        function updateCard(kpiId, value, recommendation) {
            document.getElementById(kpiId).textContent = value;
            document.getElementById(`${kpiId}-tag`).textContent = recommendation.status;
            document.getElementById(`${kpiId}-tag`).className = `kpi-status-tag ${recommendation.tag}`;
            document.getElementById(`${kpiId}-rec`).textContent = recommendation.rec;
            
            const card = document.getElementById(`${kpiId}-card`);
            card.onclick = function() {
                let drillDownKey;
                switch(kpiId) {
                    case 'kpi-total': drillDownKey = 'totalOpen'; break;
                    case 'kpi-sr': drillDownKey = 'totalSR'; break;
                    case 'kpi-inc': drillDownKey = 'totalINC'; break;
                    case 'kpi-sla-sr': drillDownKey = 'slaSR'; break;
                    case 'kpi-sla-inc': drillDownKey = 'slaINC'; break;
                    case 'kpi-aging-15': drillDownKey = 'aging15'; break;
                    case 'kpi-aging-25': drillDownKey = 'oldest25'; break;
                    case 'kpi-followup': drillDownKey = 'followUpMissed'; break;
                    case 'kpi-email-followup': drillDownKey = 'emailNoFollowup'; break;
                    case 'kpi-email-resp': drillDownKey = 'emailResponseMissed'; break;
                    case 'kpi-sub-resp': drillDownKey = 'subsequentResponseMissed'; break;
                    case 'kpi-sub-sla': drillDownKey = 'subsequentSLAMiss'; break;
                    case 'kpi-idle-1': drillDownKey = 'idle1'; break;
                    case 'kpi-idle-3': drillDownKey = 'idle3'; break;
                    case 'kpi-edoc': drillDownKey = 'edocBreach'; break;
                    default: drillDownKey = 'totalOpen';
                }
                openDrillDown(drillDownKey, recommendation.status);
            };
        }

        function updateDashboard() {
            renderKPIDashboard();
            renderDetailedDashboard();
        }

        function renderKPIDashboard() {
            if (!filteredData.length) {
                document.getElementById('owner-scorecard-body').innerHTML = '<tr><td colspan="18" class="text-center text-muted py-3">No data found for selected filters.</td></tr>';
                return;
            }

            const m = {
                totalOpen: filteredData.length,
                totalSR: filteredData.filter(d => d.isSR).length,
                totalINC: filteredData.filter(d => d.isINC).length,
                slaSR: filteredData.filter(d => d.isSR && d.isSlaViolated).length,
                slaINC: filteredData.filter(d => d.isINC && d.isSlaViolated).length,
                aging15: filteredData.filter(d => d.isAging15Violated).length,
                oldest25: filteredData.filter(d => d.isOldest25).length,
                followUp: filteredData.filter(d => d.isFollowUpMissed).length,
                emailMiss: filteredData.filter(d => d.emailCompliance === 'No Followup').length,
                respMiss: filteredData.filter(d => d.emailCompliance === 'Email Response Missed').length,
                subRespMiss: filteredData.filter(d => d.isSubsequentResponseMissed).length,
                subSLAMiss: filteredData.filter(d => d.isSubsequentSLABreach).length,
                idle1: filteredData.filter(d => d.isIdle1).length,
                idle3: filteredData.filter(d => d.isIdle3).length,
                edoc: filteredData.filter(d => d.isEdocBreached).length,
            };

            const infoRec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Statistical count of active cases.' };
            const srRec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Breakdown of active Service Requests.' };
            const incRec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Breakdown of active Incident Management cases.' };

            let slaSRRec = { status: 'GOOD', tag: 'bg-good', rec: 'No SR cases currently in violation.' };
            if (m.slaSR > 0) slaSRRec = { status: 'URGENT', tag: 'bg-urgent', rec: `Immediate action required to resolve ${m.slaSR} violated SR cases.` };

            let slaINCRec = { status: 'GOOD', tag: 'bg-good', rec: 'No INC cases currently in violation.' };
            if (m.slaINC > 0) slaINCRec = { status: 'URGENT', tag: 'bg-urgent', rec: `Immediate action required to resolve ${m.slaINC} violated INC cases.` };

            let aging15Rec = { status: 'GOOD', tag: 'bg-good', rec: 'No cases have crossed the 15-day warning threshold.' };
            if (m.aging15 > 0) aging15Rec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `${m.aging15} cases are aging > 15 days. Prioritize these for closure.` };
            if (m.oldest25 > 0) aging15Rec = { status: 'URGENT', tag: 'bg-urgent', rec: `Contains ${m.oldest25} critical cases aged > 25 days. URGENT action.` };

            let oldest25Rec = { status: 'GOOD', tag: 'bg-good', rec: 'No critical old cases requiring urgent action.' };
            if (m.oldest25 > 0) oldest25Rec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.oldest25} cases are critically old (> 25 days). URGENT action.` };

            let fuRec = { status: 'GOOD', tag: 'bg-good', rec: 'All cases have a valid, upcoming follow-up date.' };
            if (m.followUp > 0) fuRec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.followUp} follow-up dates missed. Update immediately.` };

            let emailFURec = { status: 'GOOD', tag: 'bg-good', rec: 'All email follow-ups are compliant.' };
            if (m.emailMiss > 0) emailFURec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `${m.emailMiss} email follow-ups missed. Check last email action.` };

            let respMissRec = { status: 'GOOD', tag: 'bg-good', rec: 'No missed client responses reported.' };
            if (m.respMiss > 0) respMissRec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.respMiss} email responses missed. High risk of SLA breach.` };

            let subRespRec = { status: 'GOOD', tag: 'bg-good', rec: 'All subsequent response dates are met or tracked.' };
            if (m.subRespMiss > 0) subRespRec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `${m.subRespMiss} Incident Management cases have missed subsequent response dates (including today).` };

            let subSLARec = { status: 'GOOD', tag: 'bg-good', rec: 'No cases have breached the subsequent SLA threshold.' };
            if (m.subSLAMiss > 0) subSLARec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.subSLAMiss} subsequent SLA breaches. Root cause analysis needed.` };

            let idle1Rec = { status: 'INFO', tag: 'bg-info-tag', rec: 'Monitor these cases for potential stagnation.' };
            if (m.idle1 > 0) {
                idle1Rec = { status: 'MONITOR', tag: 'bg-monitor', rec: `${m.idle1} cases idle > 1 day. Check last action and assign follow-up.` };
            }
            if (m.idle3 > 0) {
                idle1Rec = { status: 'ACTION NEEDED', tag: 'bg-action-needed', rec: `Contains ${m.idle3} critical cases idle > 3 days. Focus on these.` };
            }
            
            let idle3Rec = { status: 'GOOD', tag: 'bg-good', rec: 'No critical cases idle for more than 3 days.' };
            if (m.idle3 > 0) { 
                idle3Rec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.idle3} cases are critically idle (> 3 days). URGENT follow-up.` }; 
            }

            let edocRec = { status: 'GOOD', tag: 'bg-good', rec: 'No SR cases have breached their Expected Date of Closure.' };
            if (m.edoc > 0) edocRec = { status: 'URGENT', tag: 'bg-urgent', rec: `${m.edoc} SR EDOC breaches. These must be resolved or re-scheduled immediately.` };

            updateCard('kpi-total', m.totalOpen, infoRec);
            updateCard('kpi-sr', m.totalSR, srRec);
            updateCard('kpi-inc', m.totalINC, incRec);

            updateCard('kpi-sla-sr', m.slaSR, slaSRRec);
            updateCard('kpi-sla-inc', m.slaINC, slaINCRec);

            updateCard('kpi-aging-15', m.aging15, aging15Rec);
            updateCard('kpi-aging-25', m.oldest25, oldest25Rec);

            updateCard('kpi-followup', m.followUp, fuRec);
            updateCard('kpi-email-followup', m.emailMiss, emailFURec);
            updateCard('kpi-email-resp', m.respMiss, respMissRec);

            updateCard('kpi-sub-resp', m.subRespMiss, subRespRec);
            updateCard('kpi-sub-sla', m.subSLAMiss, subSLARec);

            // #1 CHANGE: Only showing idle3 and edoc cards in section 6
            updateCard('kpi-idle-3', m.idle3, idle3Rec);
            updateCard('kpi-edoc', m.edoc, edocRec);
            
            renderOwnerScorecard();
        }

        function renderOwnerScorecard() {
            const counts = {};
            filteredData.forEach(d => {
                if(!counts[d.owner]) counts[d.owner] = { 
                    total: 0, 
                    violations: 0, 
                    sr: 0, 
                    inc: 0, 
                    slaSR: 0, 
                    slaINC: 0,
                    aging15: 0, 
                    oldest25: 0, 
                    followUpMissed: 0, 
                    emailFollowupMissed: 0,
                    emailResponseMissed: 0,
                    subsequentResponseMissed: 0,
                    subsequentSLABreach: 0,
                    idle1: 0,
                    idle3: 0,
                    edocBreach: 0,
                };
                counts[d.owner].total++;
                if(d.isSlaViolated) counts[d.owner].violations++;
                if(d.isSR) counts[d.owner].sr++;
                if(d.isINC) counts[d.owner].inc++;
                if(d.isSR && d.isSlaViolated) counts[d.owner].slaSR++;
                if(d.isINC && d.isSlaViolated) counts[d.owner].slaINC++;
                if(d.isAging15Violated) counts[d.owner].aging15++;
                if(d.isOldest25) counts[d.owner].oldest25++;
                if(d.isFollowUpMissed) counts[d.owner].followUpMissed++;
                if(d.emailCompliance === 'No Followup') counts[d.owner].emailFollowupMissed++;
                if(d.emailCompliance === 'Email Response Missed') counts[d.owner].emailResponseMissed++;
                if(d.isSubsequentResponseMissed) counts[d.owner].subsequentResponseMissed++;
                if(d.isSubsequentSLABreach) counts[d.owner].subsequentSLABreach++;
                if(d.isIdle1) counts[d.owner].idle1++;
                if(d.isIdle3) counts[d.owner].idle3++;
                if(d.isEdocBreached) counts[d.owner].edocBreach++;
            });

            scorecardData = [];
            const scorecardHtml = Object.keys(counts).sort().map(o => {
                const stats = counts[o];
                const complianceRate = stats.total > 0 ? (((stats.total - stats.violations) / stats.total) * 100).toFixed(1) : 100.0;

                scorecardData.push({
                    'Owner': o,
                    'Overall SLA %': complianceRate,
                    'Total Open Cases': stats.total,
                    'Total SR': stats.sr,
                    'Total INC': stats.inc,
                    'SLA Viol. – SR': stats.slaSR,
                    'SLA Viol. – INC': stats.slaINC,
                    'Aging >15 Days': stats.aging15,
                    'Oldest >25 Days': stats.oldest25,
                    'F/Up Date Missed': stats.followUpMissed,
                    'Email F/Up Missed': stats.emailFollowupMissed,
                    'Email Resp Missed': stats.emailResponseMissed,
                    'Sub. Resp Missed': stats.subsequentResponseMissed,
                    'Sub. SLA Miss': stats.subsequentSLABreach,
                    'Idle >1 Day': stats.idle1,
                    'Idle >3 Days': stats.idle3,
                    'SR EDOC Breach': stats.edocBreach,
                });

                return `
                    <tr class="align-middle" onclick="updateOwnerFilter('${o}')" style="cursor: pointer;">
                        <td class="fw-bold">${o}</td>
                        <td class="${complianceRate < 80 ? 'critical-cell' : complianceRate < 95 ? 'high-cell' : 'success-cell'} fw-bold">${complianceRate}%</td>
                        <td>${stats.total}</td>
                        <td>${stats.sr}</td>
                        <td>${stats.inc}</td>
                        <td class="${stats.slaSR > 0 ? 'critical-cell' : ''}">${stats.slaSR}</td>
                        <td class="${stats.slaINC > 0 ? 'critical-cell' : ''}">${stats.slaINC}</td>
                        <td class="${stats.aging15 > 0 ? 'high-cell' : ''}">${stats.aging15}</td>
                        <td class="${stats.oldest25 > 0 ? 'critical-cell' : ''}">${stats.oldest25}</td>
                        <td class="${stats.followUpMissed > 0 ? 'high-cell' : ''}">${stats.followUpMissed}</td>
                        <td class="${stats.emailFollowupMissed > 0 ? 'high-cell' : ''}">${stats.emailFollowupMissed}</td>
                        <td class="${stats.emailResponseMissed > 0 ? 'critical-cell' : ''}">${stats.emailResponseMissed}</td>
                        <td class="${stats.subsequentResponseMissed > 0 ? 'critical-cell' : ''}">${stats.subsequentResponseMissed}</td>
                        <td class="${stats.subsequentSLABreach > 0 ? 'critical-cell' : ''}">${stats.subsequentSLABreach}</td>
                        <td class="${stats.idle1 > 0 ? 'high-cell' : ''}">${stats.idle1}</td>
                        <td class="${stats.idle3 > 0 ? 'critical-cell' : ''}">${stats.idle3}</td>
                        <td class="${stats.edocBreach > 0 ? 'critical-cell' : ''}">${stats.edocBreach}</td>
                        <td>
                            <div class="progress compliance-gauge">
                                <div class="progress-bar ${complianceRate < 80 ? 'bg-danger' : complianceRate < 95 ? 'bg-warning' : 'bg-success'}" role="progressbar" style="width: ${complianceRate}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('owner-scorecard-body').innerHTML = scorecardHtml || '<tr><td colspan="18" class="text-center text-muted py-3">No data found for selected filters.</td></tr>';
        }

        function openDrillDown(kpi, title) {
            drillDownTitleForExport = title;
            document.getElementById('drillDownTitle').textContent = title;

            switch(kpi) {
                case 'totalOpen':
                    drillDownData = filteredData;
                    break;
                case 'totalSR':
                    drillDownData = filteredData.filter(d => d.isSR);
                    break;
                case 'totalINC':
                    drillDownData = filteredData.filter(d => d.isINC);
                    break;
                case 'slaSR':
                    drillDownData = filteredData.filter(d => d.isSR && d.isSlaViolated);
                    break;
                case 'slaINC':
                    drillDownData = filteredData.filter(d => d.isINC && d.isSlaViolated);
                    break;
                case 'aging15':
                    drillDownData = filteredData.filter(d => d.isAging15Violated);
                    break;
                case 'oldest25':
                    drillDownData = filteredData.filter(d => d.isOldest25);
                    break;
                case 'followUpMissed':
                    drillDownData = filteredData.filter(d => d.isFollowUpMissed);
                    break;
                case 'emailNoFollowup':
                    drillDownData = filteredData.filter(d => d.emailCompliance === 'No Followup');
                    break;
                case 'emailResponseMissed':
                    drillDownData = filteredData.filter(d => d.emailCompliance === 'Email Response Missed');
                    break;
                case 'subsequentResponseMissed':
                    drillDownData = filteredData.filter(d => d.isSubsequentResponseMissed);
                    break;
                case 'subsequentSLAMiss':
                    drillDownData = filteredData.filter(d => d.isSubsequentSLABreach);
                    break;
                case 'idle1':
                    drillDownData = filteredData.filter(d => d.isIdle1);
                    break;
                case 'idle3':
                    drillDownData = filteredData.filter(d => d.isIdle3);
                    break;
                case 'edocBreach':
                    drillDownData = filteredData.filter(d => d.isEdocBreached);
                    break;
                default:
                    drillDownData = [];
            }
            
            document.getElementById('drillDownCount').textContent = `${drillDownData.length} Cases`;
            
            // Prepare export data
            drillDownExportData = drillDownData.map(d => {
                const exportRow = {};
                if (drillDownColumns[kpi]) {
                    drillDownColumns[kpi].forEach(col => {
                        exportRow[col.label] = d[col.key] || '';
                    });
                } else {
                    // Default columns for other KPIs
                    exportRow['Incident ID'] = d.incidentId;
                    exportRow['Title'] = d.title;
                    exportRow['Owner'] = d.owner;
                    exportRow['Status'] = d.currentStatus;
                    exportRow['Aging'] = d.agingDays;
                    exportRow['SLA Status'] = d.slaViolationStatus;
                    exportRow['Next Follow-up'] = d.nextFollowUp || '--';
                }
                return exportRow;
            });
            
            // Update table headers
            const header = document.getElementById('drillDownHeader');
            if (drillDownColumns[kpi]) {
                header.innerHTML = drillDownColumns[kpi].map(col => 
                    `<th>${col.label}</th>`
                ).join('');
            } else {
                header.innerHTML = `
                    <th>Incident ID</th>
                    <th>Title</th>
                    <th>Owner</th>
                    <th>Status</th>
                    <th>Aging</th>
                    <th>SLA Status</th>
                    <th>Next Follow-up</th>
                `;
            }
            
            // Update table body
            const drillDownHtml = drillDownData.map((d, index) => {
                const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                
                if (drillDownColumns[kpi]) {
                    const cells = drillDownColumns[kpi].map(col => {
                        const value = d[col.key] || '';
                        let cellClass = '';
                        
                        // Add styling based on value
                        if (col.key === 'agingDays' || col.key === 'agingRoundoff') {
                            const agingValue = parseInt(value) || 0;
                            if (agingValue > 25) cellClass = 'text-danger fw-bold';
                            else if (agingValue > 15) cellClass = 'text-warning';
                        } else if (col.key === 'slaStatus' || col.key === 'slaViolationStatus') {
                            if (value === 'Violated') cellClass = 'text-danger fw-bold';
                            else cellClass = 'text-success';
                        } else if (col.key === 'emailCompliance') {
                            if (value.includes('Missed') || value.includes('No Followup')) cellClass = 'text-danger';
                        }
                        
                        return `<td class="${cellClass}" title="${value}">${value.length > 30 ? value.substring(0, 30) + '...' : value}</td>`;
                    }).join('');
                    
                    return `<tr onclick="viewCaseDetail(${globalIndex})" style="cursor: pointer;">${cells}</tr>`;
                } else {
                    // Default view
                    return `
                        <tr onclick="viewCaseDetail(${globalIndex})" style="cursor: pointer;">
                            <td class="fw-bold" title="${d.incidentId}">${d.incidentId.length > 15 ? d.incidentId.substring(0, 15) + '...' : d.incidentId}</td>
                            <td title="${d.title}">${d.title.length > 40 ? d.title.substring(0, 40) + '...' : d.title}</td>
                            <td><span class="owner-tag">${d.owner}</span></td>
                            <td>${d.currentStatus}</td>
                            <td class="${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</td>
                            <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaViolationStatus}</td>
                            <td class="${d.isFollowUpMissed ? 'text-danger fw-bold' : ''}" title="${d.nextFollowUp || '--'}">${d.nextFollowUp ? (d.nextFollowUp.length > 20 ? d.nextFollowUp.substring(0, 20) + '...' : d.nextFollowUp) : '--'}</td>
                        </tr>
                    `;
                }
            }).join('');

            document.getElementById('drillDownBody').innerHTML = drillDownHtml || '<tr><td colspan="7" class="text-center text-muted py-3">No cases found.</td></tr>';

            new bootstrap.Modal(document.getElementById('drillDownModal')).show();
        }

        function renderDetailedDashboard() {
            const totalCases = filteredData.length;
            const slaViolatedCount = filteredData.filter(d => d.isSlaViolated).length;
            const slaComplianceRate = totalCases > 0 ? ((totalCases - slaViolatedCount) / totalCases * 100).toFixed(1) : 100.0;

            document.getElementById('total-open-cases').textContent = totalCases;
            document.getElementById('total-sr-detail').textContent = filteredData.filter(d => d.isSR).length;
            document.getElementById('total-inc-detail').textContent = filteredData.filter(d => d.isINC).length;
            document.getElementById('sla-compliance-rate').textContent = `${slaComplianceRate}%`;

            updateDetailedViewFilters();
            renderOriginalCharts();
            renderTodayActions();
            renderAllCases();
            renderSLAViolations();
            renderAgingCases();
            renderRecommendations();
            renderOwnerAnalysis();
        }

        function updateDetailedViewFilters() {
            const getUniqueValues = (key) => [...new Set(filteredData.map(d => d[key]).filter(Boolean).sort())];
            
            const detailedDropdowns = {
                'filter-owner': getUniqueValues('owner'),
                'filter-service': getUniqueValues('service'),
                'filter-status': getUniqueValues('currentStatus'),
                'sla-filter-owner': getUniqueValues('owner'),
                'aging-filter-owner': getUniqueValues('owner')
            };

            for (const id in detailedDropdowns) {
                const select = document.getElementById(id);
                if (select) {
                    const originalValue = select.value;
                    const label = id.split('-').pop();
                    const labelText = label === 'owner' ? 'Owners' : 
                                   label === 'service' ? 'Service Types' : 
                                   label === 'status' ? 'Statuses' : 
                                   'Options';
                    
                    select.innerHTML = `<option value="">All ${labelText}</option>`;
                    detailedDropdowns[id].forEach(value => {
                        select.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                    if (originalValue && detailedDropdowns[id].includes(originalValue)) {
                        select.value = originalValue;
                    }
                }
            }
        }

        function renderOriginalCharts() {
            Object.values(charts).forEach(chart => chart && chart.destroy());

            const statusCounts = {};
            filteredData.forEach(d => {
                statusCounts[d.currentStatus] = (statusCounts[d.currentStatus] || 0) + 1;
            });
            
            const statusColors = ['#5F259F', '#3D7FFF', '#00D4AA', '#FF9F00', '#FF3B5C', '#9B46C9', '#2CD5C4'];
            charts.statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: statusColors.slice(0, Object.keys(statusCounts).length),
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            const aCounts = { '0-5':0, '6-10':0, '11-15':0, '16+':0 };
            filteredData.forEach(d => {
                if(d.agingDays<=5) aCounts['0-5']++;
                else if(d.agingDays<=10) aCounts['6-10']++;
                else if(d.agingDays<=15) aCounts['11-15']++;
                else aCounts['16+']++;
            });
            
            charts.agingChart = new Chart(document.getElementById('agingChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(aCounts),
                    datasets: [{
                        label: 'Number of Cases',
                        data: Object.values(aCounts),
                        backgroundColor: ['#00D4AA', '#3D7FFF', '#FF9F00', '#FF3B5C'],
                        borderColor: ['#00D4AA', '#3D7FFF', '#FF9F00', '#FF3B5C'],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            const ownerCounts = {};
            filteredData.forEach(d => {
                if(!ownerCounts[d.owner]) ownerCounts[d.owner] = { total: 0, violations: 0, aging15: 0 };
                ownerCounts[d.owner].total++;
                if(d.isSlaViolated) ownerCounts[d.owner].violations++;
                if(d.isAging15Violated) ownerCounts[d.owner].aging15++;
            });

            const owners = Object.keys(ownerCounts).sort();
            const violationRates = owners.map(o => (ownerCounts[o].violations / ownerCounts[o].total * 100).toFixed(1));
            const aging15Counts = owners.map(o => ownerCounts[o].aging15);
            
            charts.ownerChart = new Chart(document.getElementById('ownerChart'), {
                type: 'bar',
                data: {
                    labels: owners,
                    datasets: [
                        {
                            label: 'SLA Violation Rate (%)',
                            data: violationRates,
                            backgroundColor: 'rgba(255, 59, 92, 0.7)',
                            borderColor: 'rgba(255, 59, 92, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1',
                        },
                        {
                            label: 'Aging > 15 Days Count',
                            data: aging15Counts,
                            backgroundColor: 'rgba(255, 159, 0, 0.7)',
                            borderColor: 'rgba(255, 159, 0, 1)',
                            borderWidth: 1,
                            yAxisID: 'y2',
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        x: { 
                            stacked: false,
                            ticks: {
                                maxRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left',
                            title: { 
                                display: true, 
                                text: 'Violation Rate (%)',
                                font: {
                                    weight: 'bold',
                                    size: 11
                                }
                            },
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 9
                                }
                            }
                        },
                        y2: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right',
                            title: { 
                                display: true, 
                                text: 'Aging Count',
                                font: {
                                    weight: 'bold',
                                    size: 11
                                }
                            },
                            grid: { drawOnChartArea: false },
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 9
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTodayActions() {
            // #2 CHANGE: Removed d.isFollowUpMissed condition from Today's Actions filter
            const actionCases = filteredData.filter(d => 
                d.isSlaViolated || 
                d.isOldest25 || 
                d.isEdocBreached || 
                // Removed: d.isFollowUpMissed || 
                d.isSubsequentResponseMissed || 
                d.isIdle3
            );
            renderFilteredCases(actionCases, 'actions-container', true);
        }

        function renderAllCases() {
            filterCases();
        }

        function renderSLAViolations() {
            filterSLAViolations();
        }

        function renderAgingCases() {
            filterAgingCases();
        }

        function filterCases() {
            const svc = document.getElementById('filter-service').value;
            const own = document.getElementById('filter-owner').value;
            const stat = document.getElementById('filter-status').value;

            let sub = filteredData.filter(d => 
                (!svc || d.service===svc) && 
                (!own || d.owner===own) && 
                (!stat || d.currentStatus===stat)
            );
            
            document.getElementById('cases-count').textContent = `${sub.length} cases`;
            
            if (currentView === 'list') {
                renderFilteredCasesList(sub, 'cases-list-container');
            } else {
                renderFilteredCasesGrid(sub, 'cases-grid-container');
            }
        }

        function filterSLAViolations() {
            const own = document.getElementById('sla-filter-owner').value;
            let sub = filteredData.filter(d => d.isSlaViolated && (!own || d.owner===own));
            renderFilteredCases(sub, 'sla-violations-container', false);
        }
        
        function filterAgingCases() {
            const own = document.getElementById('aging-filter-owner').value;
            let sub = filteredData.filter(d => d.isAging15Violated && (!own || d.owner===own));
            renderFilteredCases(sub, 'aging-cases-container', false);
        }

        function clearTabFilters(tabId) {
            if (tabId === 'cases') {
                document.getElementById('filter-service').value = '';
                document.getElementById('filter-owner').value = '';
                document.getElementById('filter-status').value = '';
                filterCases();
            } else if (tabId === 'sla') {
                document.getElementById('sla-filter-owner').value = '';
                filterSLAViolations();
            } else if (tabId === 'aging') {
                document.getElementById('aging-filter-owner').value = '';
                filterAgingCases();
            }
        }

        function renderFilteredCases(cases, containerId, isActionList = false) {
            const container = document.getElementById(containerId);
            if(!cases.length) {
                container.innerHTML = `<div class="alert alert-info mt-3 shadow-sm">No cases matching the criteria found.</div>`;
                return;
            }

            // #3 CHANGE: Added "Submitted By" column to Today's Actions table
            const tableHtml = `
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-striped table-hover detailed-case-table compact-view">
                        <thead>
                            <tr>
                                <th>Incident ID</th>
                                <th>Title</th>
                                <th>Owner</th>
                                <th>Status</th>
                                ${isActionList ? '<th>Submitted By</th>' : ''}
                                <th>Aging</th>
                                <th>SLA Status</th>
                                <th>Next Follow-up</th>
                                ${isActionList ? '<th>Action Reason</th>' : ''}
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cases.map(d => {
                                const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                                let actionReason = '';
                                if (isActionList) {
                                    const reasons = [];
                                    if (d.isSlaViolated) reasons.push('SLA Violated');
                                    if (d.isOldest25) reasons.push('Aged > 25 Days');
                                    if (d.isEdocBreached) reasons.push('EDOC Breached');
                                    // Removed: if (d.isFollowUpMissed) reasons.push('F/Up Date Missed');
                                    if (d.isSubsequentResponseMissed) reasons.push('Sub. Resp Missed');
                                    if (d.isIdle3) reasons.push('Idle > 3 Days');
                                    actionReason = `<td><span class="badge bg-danger">${reasons.join(', ')}</span></td>`;
                                }
                                return `
                                    <tr class="align-middle" style="cursor: pointer;">
                                        <td class="fw-bold truncate-text" title="${d.incidentId}">${d.incidentId}</td>
                                        <td class="truncate-text" title="${d.title}">${d.title}</td>
                                        <td><span class="owner-tag">${d.owner}</span></td>
                                        <td>${d.currentStatus}</td>
                                        ${isActionList ? `<td>${d.submittedBy}</td>` : ''}
                                        <td class="${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</td>
                                        <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaViolationStatus}</td>
                                        <td class="${d.isFollowUpMissed ? 'text-danger fw-bold' : ''} truncate-text" title="${d.nextFollowUp || '--'}">${d.nextFollowUp || '--'}</td>
                                        ${actionReason}
                                        <td><button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetail(${globalIndex}); event.stopPropagation();">View</button></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-2 small text-muted">
                    Showing ${cases.length} case${cases.length !== 1 ? 's' : ''}
                </div>
            `;
            container.innerHTML = tableHtml;
        }
        
        function renderFilteredCasesList(cases, containerId) {
            const container = document.getElementById(containerId);
            if(!cases.length) {
                container.innerHTML = `<div class="alert alert-info mt-3 shadow-sm">No cases matching the criteria found.</div>`;
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover detailed-case-table">
                        <thead>
                            <tr>
                                <th>Incident ID</th>
                                <th>Title</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>Aging</th>
                                <th>SLA Status</th>
                                <th>Next Follow-up</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cases.map(d => {
                                const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                                return `
                                    <tr class="align-middle" style="cursor: pointer;" onclick="viewCaseDetail(${globalIndex})">
                                        <td class="fw-bold truncate-text" title="${d.incidentId}">${d.incidentId}</td>
                                        <td class="truncate-text" title="${d.title}">${d.title}</td>
                                        <td><span class="owner-tag">${d.owner}</span></td>
                                        <td>${d.currentStatus}</td>
                                        <td class="${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</td>
                                        <td class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">${d.slaViolationStatus}</td>
                                        <td class="${d.isFollowUpMissed ? 'text-danger fw-bold' : ''} truncate-text" title="${d.nextFollowUp || '--'}">${d.nextFollowUp || '--'}</td>
                                        <td><button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetail(${globalIndex}); event.stopPropagation();">View</button></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }
        
        function renderFilteredCasesGrid(cases, containerId) {
            const container = document.getElementById(containerId);
            if(!cases.length) {
                container.innerHTML = `<div class="alert alert-info mt-3 shadow-sm">No cases matching the criteria found.</div>`;
                return;
            }

            const gridHtml = `
                <div class="grid-view-container">
                    ${cases.map(d => {
                        const globalIndex = processedData.findIndex(p => p.incidentId === d.incidentId);
                        
                        // Determine card type based on severity
                        let cardType = '';
                        if (d.isSlaViolated || d.isOldest25 || d.isEdocBreached) {
                            cardType = 'critical';
                        } else if (d.isAging15Violated || d.isFollowUpMissed) {
                            cardType = 'warning';
                        } else {
                            cardType = 'success';
                        }
                        
                        // Get tags for this case
                        const tags = [];
                        if (d.isSlaViolated) tags.push({text: 'SLA Violated', type: 'urgent'});
                        if (d.isOldest25) tags.push({text: 'Aged > 25 Days', type: 'urgent'});
                        if (d.isAging15Violated) tags.push({text: 'Aged > 15 Days', type: 'warning'});
                        if (d.isFollowUpMissed) tags.push({text: 'F/Up Missed', type: 'warning'});
                        if (d.isEdocBreached) tags.push({text: 'EDOC Breach', type: 'urgent'});
                        if (d.isSubsequentResponseMissed) tags.push({text: 'Sub. Resp Missed', type: 'warning'});
                        if (d.isSubsequentSLABreach) tags.push({text: 'Sub. SLA Miss', type: 'urgent'});
                        if (d.isIdle3) tags.push({text: 'Idle > 3 Days', type: 'warning'});
                        
                        return `
                            <div class="case-card ${cardType}" onclick="viewCaseDetail(${globalIndex})" style="cursor: pointer;">
                                <div class="case-id">${d.incidentId}</div>
                                <div class="case-title" title="${d.title}">${d.title}</div>
                                <div class="case-meta">
                                    <div class="case-meta-item">
                                        <i class="bi bi-person"></i>
                                        <span>${d.owner}</span>
                                    </div>
                                    <div class="case-meta-item">
                                        <i class="bi bi-tag"></i>
                                        <span>${d.service}</span>
                                    </div>
                                    <div class="case-meta-item">
                                        <i class="bi bi-clock"></i>
                                        <span class="${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">
                                            ${d.agingDays} days
                                        </span>
                                    </div>
                                    <div class="case-meta-item">
                                        <i class="bi ${d.isSlaViolated ? 'bi-exclamation-triangle text-danger' : 'bi-check-circle text-success'}"></i>
                                        <span class="${d.isSlaViolated ? 'text-danger fw-bold' : 'text-success'}">
                                            ${d.slaViolationStatus}
                                        </span>
                                    </div>
                                </div>
                                ${tags.length ? `
                                    <div class="case-tags">
                                        ${tags.map(tag => `
                                            <span class="case-tag ${tag.type}">${tag.text}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                <div class="text-end mt-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetail(${globalIndex}); event.stopPropagation();">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="text-center mt-3 small text-muted">
                    Showing ${cases.length} case${cases.length !== 1 ? 's' : ''}
                </div>
            `;
            container.innerHTML = gridHtml;
        }

        function renderRecommendations() {
            const recommendations = [];
            filteredData.forEach(d => {
                const recs = [];
                if (d.isOldest25) recs.push({text: `Aged > 25 Days: Needs immediate action plan.`, color: 'text-danger'});
                if (d.isEdocBreached) recs.push({text: `SR EDOC Breach: Requires urgent resolution or EDOC change.`, color: 'text-danger'});
                if (d.isSlaViolated) recs.push({text: `SLA Violated: Check root cause and plan fix.`, color: 'text-danger'});
                if (d.isFollowUpMissed) recs.push({text: `Follow-up Date Missed: Update next follow-up date now.`, color: 'text-danger'});
                if (d.isSubsequentResponseMissed) recs.push({text: `Subsequent Response Missed (including today): Update case action plan.`, color: 'text-danger'});
                if (d.isIdle3) recs.push({text: `Idle > 3 Days: Needs immediate follow-up to client or internal team.`, color: 'text-danger'});
                
                if(recs.length) recommendations.push({incidentId: d.incidentId, title: d.title, owner: d.owner, recs: recs});
            });

            const container = document.getElementById('recommendations-container');
            container.innerHTML = recommendations.length ? '' : '<div class="alert alert-success mt-3 shadow-sm">No critical recommendations found. Good job!</div>';
            
            if (recommendations.length) {
                container.innerHTML = recommendations.map(rec => {
                    const globalIndex = processedData.findIndex(d => d.incidentId === rec.incidentId);
                    return `
                        <div class="card mb-3 border-start border-4 border-danger shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold">${rec.incidentId} - ${rec.owner}</h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetail(${globalIndex}); event.stopPropagation();">View Details</button>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-3">${rec.title}</p>
                                <ul class="mb-0">
                                    ${rec.recs.map(r => `<li class="${r.color} fw-bold mb-2"><i class="bi bi-exclamation-triangle me-2"></i>${r.text}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderOwnerAnalysis() {
            const counts = {};
            filteredData.forEach(d => {
                if(!counts[d.owner]) counts[d.owner] = { total: 0, violations: 0, aging15: 0, sr: 0, inc: 0 };
                counts[d.owner].total++;
                if(d.isSlaViolated) counts[d.owner].violations++;
                if(d.isAging15Violated) counts[d.owner].aging15++;
                if(d.isSR) counts[d.owner].sr++;
                if(d.isINC) counts[d.owner].inc++;
            });

            const owners = Object.keys(counts).sort((a,b) => counts[b].total - counts[a].total);
            const breakdownHtml = owners.map(o => {
                const stats = counts[o];
                const complianceRate = stats.total > 0 ? ((stats.total - stats.violations) / stats.total * 100).toFixed(1) : 100;
                return `
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100 shadow-sm">
                            <div class="card-body py-4">
                                <h6 class="mb-3 fw-bold">${o}</h6>
                                <div class="row small fw-bold mb-3">
                                    <div class="col-4">
                                        <div class="fs-6">${stats.total}</div>
                                        <div class="text-muted small">Total</div>
                                    </div>
                                    <div class="col-4 text-danger">
                                        <div class="fs-6">${stats.violations}</div>
                                        <div class="text-muted small">Violations</div>
                                    </div>
                                    <div class="col-4 text-warning">
                                        <div class="fs-6">${stats.aging15}</div>
                                        <div class="text-muted small">Aging >15</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h4 class="${complianceRate < 80 ? 'text-danger' : complianceRate < 95 ? 'text-warning' : 'text-success'} fw-bold">${complianceRate}%</h4>
                                    <p class="small text-muted mb-0">SLA Compliance Rate</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('owner-breakdown').innerHTML = breakdownHtml;
        }

        function viewCaseDetail(idx) {
            const d = processedData[idx];
            document.getElementById('caseDetailTitle').textContent = `${d.incidentId}: ${d.title}`;
            document.getElementById('case-detail-content').innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>${d.incidentId}: ${d.title}</h6>
                        <p class="text-muted">${d.service} | Submitted by: ${d.submittedBy}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="owner-tag">${d.owner}</span>
                        <span class="badge ${d.isSlaViolated ? 'bg-danger' : 'bg-success'} ms-2">${d.slaViolationStatus}</span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>Basic Information</h6>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Status:</strong></div>
                            <div class="col-6">${d.currentStatus}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Service Type:</strong></div>
                            <div class="col-6">${d.service}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Submitted By:</strong></div>
                            <div class="col-6">${d.submittedBy}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Email Compliance:</strong></div>
                            <div class="col-6"><span class="fw-bold ${d.emailCompliance.includes('Missed') || d.emailCompliance.includes('No Followup') ? 'text-danger' : 'text-success'}">${d.emailCompliance || 'Compliant'}</span></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-clock-history me-2" style="color: var(--primary-color);"></i>Timeline & Compliance</h6>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Aging (Days):</strong></div>
                            <div class="col-6 ${d.agingDays > 25 ? 'text-danger fw-bold' : d.agingDays > 15 ? 'text-warning' : ''}">${d.agingDays}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Idle Since Modified:</strong></div>
                            <div class="col-6 ${d.agingFromLastModified > 1 ? 'text-danger fw-bold' : ''}">${d.agingFromLastModified} days</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Next Follow-up:</strong></div>
                            <div class="col-6 ${d.isFollowUpMissed ? 'text-danger fw-bold' : 'text-success'}">${d.nextFollowUp || '--'}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Expected Resolution:</strong></div>
                            <div class="col-6 ${d.isEdocBreached ? 'text-danger fw-bold' : 'text-success'}">${d.expectedResolution || '--'}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>Sub. SLA Miss Count:</strong></div>
                            <div class="col-6 ${d.isSubsequentSLABreach ? 'text-danger fw-bold' : 'text-success'}">${d.subsequentSLABreachCount}</div>
                        </div>
                    </div>
                </div>
                <hr>
                <h6><i class="bi bi-card-checklist me-2" style="color: var(--primary-color);"></i>Risk Indicators</h6>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            ${d.isOldest25 ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Aged > 25 Days</li>' : ''}
                            ${d.isEdocBreached ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>EDOC Breached</li>' : ''}
                            ${d.isSlaViolated ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>SLA Violated</li>' : ''}
                            ${d.isFollowUpMissed ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Follow-up Date Missed</li>' : ''}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            ${d.isSubsequentResponseMissed ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Subsequent Response Missed (including today)</li>' : ''}
                            ${d.isSubsequentSLABreach ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Subsequent SLA Breach</li>' : ''}
                            ${d.isIdle3 ? '<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Idle > 3 Days</li>' : ''}
                            ${d.isAging15Violated ? '<li class="text-warning"><i class="bi bi-exclamation-triangle-fill me-2"></i>Aging > 15 Days</li>' : ''}
                        </ul>
                    </div>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('caseDetailModal')).show();
        }

        function exportScorecardToExcel() {
            if(!scorecardData.length) {
                alert("Scorecard data not ready or filtered to zero results.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(scorecardData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Scorecard_Export");
            XLSX.writeFile(wb, `MSP_Scorecard_Export_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function exportDrillDownToExcel() {
            if(!drillDownExportData.length) {
                alert("No data to export.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(drillDownExportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DrillDownExport");
            XLSX.writeFile(wb, `${drillDownTitleForExport.replace(/[^a-zA-Z0-9]/g,'_')}_Export_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }
        
        function exportFullData() {
            if(!filteredData.length) {
                alert("No data to export.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(filteredData.map(d => d._raw));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "FilteredData");
            XLSX.writeFile(wb, `MSP_Filtered_Data_Export_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.add('active');
            } else {
                spinner.classList.remove('active');
            }
        }

        function processData() {
            if (rawData.length === 0) {
                alert("No data loaded. Please upload a file first.");
                return;
            }
            showLoading(true);
            setTimeout(() => {
                processedData = processedData || [];
                filteredData = [...processedData];
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('total-cases').textContent = `${processedData.length} Cases Loaded`;
                updateDashboard();
                showLoading(false);
            }, 500);
        }
    </script>
</body>
</html>
